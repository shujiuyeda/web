<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1B4332">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cash Flow">
  <title>ğŸ’° Cash Flow</title>
  <link rel="manifest" href="finance-manifest.json">
  <link rel="apple-touch-icon" href="finance-icon.svg">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green-dark: #1B4332;
      --green-mid: #2D6A4F;
      --green-light: #52B788;
      --green-pale: #D8F3DC;
      --bg: #F0F4F0;
      --card: #FFFFFF;
      --text: #1A1A2E;
      --text-muted: #6C757D;
      --border: #DEE2E6;
      --danger: #DC3545;
      --warning: #E5A020;
      --amber: #F59E0B;
      --success: #28A745;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--green-dark);
      color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      padding-top: var(--safe-top);
      height: calc(52px + var(--safe-top));
      z-index: 100;
    }
    .header h1 { font-size: 16px; font-weight: 700; }
    .header-sub { font-size: 12px; opacity: 0.75; }
    .header-reload {
      background: none; border: none; color: white; opacity: 0.75;
      font-size: 22px; padding: 6px 8px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s;
      display: inline-block; line-height: 1;
    }
    .header-reload:active { opacity: 0.4; }
    .header-reload.spinning { animation: hdr-spin 0.7s linear infinite; }
    @keyframes hdr-spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Main â”€â”€ */
    .main {
      padding-top: calc(52px + var(--safe-top));
      padding-bottom: calc(24px + var(--safe-bottom));
    }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: var(--card); border-radius: 14px;
      padding: 14px 16px; margin: 8px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 11px; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.6px; margin-bottom: 12px;
    }

    /* â”€â”€ Hero (dark gradient) â”€â”€ */
    .hero-card {
      background: linear-gradient(135deg, var(--green-dark) 0%, var(--green-mid) 100%);
      border-radius: 18px;
      padding: 20px 20px 22px;
      margin: 10px 12px 8px;
      color: white;
      box-shadow: 0 4px 16px rgba(27,67,50,0.35);
    }
    .hero-label {
      font-size: 11px; font-weight: 700;
      opacity: 0.75; text-transform: uppercase;
      letter-spacing: 0.8px; margin-bottom: 6px;
    }
    .hero-amount {
      font-size: 52px; font-weight: 800;
      line-height: 1; letter-spacing: -2px;
    }
    .hero-amount span { font-size: 22px; font-weight: 600; margin-left: 3px; }
    .hero-progress-wrap { margin: 14px 0 10px; }
    .hero-progress-bar {
      background: rgba(255,255,255,0.2);
      border-radius: 8px; height: 10px;
      overflow: hidden;
    }
    .hero-progress-fill {
      height: 100%; border-radius: 8px;
      transition: width 0.6s ease;
    }
    .hero-progress-labels {
      display: flex; justify-content: space-between;
      font-size: 11px; opacity: 0.75; margin-top: 5px;
    }
    .hero-gap {
      font-size: 14px; font-weight: 600;
      opacity: 0.9; margin-top: 4px;
    }
    .hero-gap.danger { color: #FCA5A5; }
    .hero-gap.warning { color: #FCD34D; }
    .hero-gap.ok { color: #86EFAC; }

    /* â”€â”€ Next Payment â”€â”€ */
    .payment-card .countdown {
      font-size: 32px; font-weight: 800;
      color: var(--danger);
      line-height: 1;
    }
    .payment-card .countdown.ok { color: var(--success); }
    .payment-card .payment-amount {
      font-size: 26px; font-weight: 800;
      color: var(--text); margin-top: 4px;
    }
    .payment-card .payment-label {
      font-size: 13px; color: var(--text-muted); margin-top: 2px;
    }
    .payment-card .payment-date {
      font-size: 13px; font-weight: 600; color: var(--text-muted);
      margin-top: 8px;
    }
    .expand-btn {
      background: none; border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 12px;
      font-size: 13px; color: var(--text-muted);
      cursor: pointer; width: 100%; text-align: left;
      margin-top: 12px;
      -webkit-tap-highlight-color: transparent;
      display: flex; align-items: center; justify-content: space-between;
    }
    .expand-btn:active { opacity: 0.7; }
    .expand-icon { transition: transform 0.2s; }
    .expand-icon.open { transform: rotate(180deg); }
    .items-list { display: none; margin-top: 10px; }
    .items-list.open { display: block; }
    .item-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 7px 0; border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .item-row:last-child { border-bottom: none; }
    .item-amount { font-weight: 600; }

    /* â”€â”€ All Payments List â”€â”€ */
    .payment-timeline { margin-top: 4px; }
    .payment-item {
      display: flex; align-items: flex-start;
      padding: 10px 0; border-bottom: 1px solid var(--border);
      gap: 12px;
    }
    .payment-item:last-child { border-bottom: none; }
    .payment-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--danger); flex-shrink: 0; margin-top: 5px;
    }
    .payment-dot.paid { background: var(--success); }
    .payment-item-info { flex: 1; }
    .payment-item-date { font-size: 12px; color: var(--text-muted); }
    .payment-item-label { font-size: 14px; font-weight: 600; margin-top: 1px; }
    .payment-item-amount { font-size: 16px; font-weight: 700; white-space: nowrap; }
    .payment-item-amount.paid { text-decoration: line-through; color: var(--success); }
    .paid-badge {
      font-size: 10px; background: #D1FAE5; color: #065F46;
      border-radius: 4px; padding: 2px 6px; margin-left: 6px;
      font-weight: 600;
    }

    /* â”€â”€ Income Pipeline â”€â”€ */
    .pipeline-item {
      display: flex; align-items: center;
      padding: 9px 0; border-bottom: 1px solid var(--border);
      gap: 10px;
    }
    .pipeline-item:last-child { border-bottom: none; }
    .status-badge {
      font-size: 10px; font-weight: 700;
      border-radius: 5px; padding: 3px 7px;
      white-space: nowrap; flex-shrink: 0;
    }
    .status-confirmed { background: #D1FAE5; color: #065F46; }
    .status-likely { background: #FEF3C7; color: #92400E; }
    .status-estimating { background: #FFF7ED; color: #C2410C; }
    .status-pipeline { background: #FED7AA; color: #9A3412; }
    .status-received { background: #F0FDF4; color: #15803D; text-decoration: line-through; }
    .pipeline-name { flex: 1; font-size: 14px; font-weight: 600; }
    .pipeline-name.received { text-decoration: line-through; color: var(--text-muted); }
    .pipeline-right { text-align: right; }
    .pipeline-amount { font-size: 16px; font-weight: 700; }
    .pipeline-timing { font-size: 11px; color: var(--text-muted); }
    .pipeline-summary {
      display: flex; justify-content: space-between;
      padding-top: 12px; margin-top: 4px;
      border-top: 1.5px solid var(--border);
      font-size: 13px;
    }
    .pipeline-summary .confirmed { color: var(--success); font-weight: 700; }
    .pipeline-summary .total { color: var(--text-muted); }

    /* â”€â”€ SVG Chart â”€â”€ */
    .chart-wrap {
      overflow: hidden; position: relative;
    }
    .chart-wrap svg { display: block; width: 100%; }
    .chart-legend {
      display: flex; gap: 12px; flex-wrap: wrap;
      margin-top: 10px;
    }
    .legend-item {
      display: flex; align-items: center; gap: 5px;
      font-size: 11px; color: var(--text-muted);
    }
    .legend-dot {
      width: 8px; height: 8px; border-radius: 50%;
    }

    /* â”€â”€ Debt â”€â”€ */
    .debt-header {
      display: flex; justify-content: space-between;
      align-items: flex-start; margin-bottom: 14px;
    }
    .debt-total { font-size: 32px; font-weight: 800; color: var(--text); }
    .debt-total span { font-size: 16px; font-weight: 600; color: var(--text-muted); margin-left: 2px; }
    .debt-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .debt-meta { text-align: right; }
    .debt-meta .monthly { font-size: 16px; font-weight: 700; color: var(--danger); }
    .debt-meta .interest { font-size: 12px; color: var(--text-muted); }
    .debt-stack-wrap { margin: 4px 0 12px; }
    .debt-stack-bar {
      height: 14px; border-radius: 8px;
      overflow: hidden; display: flex;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .debt-stack-seg { height: 100%; }
    .debt-accounts { margin-top: 10px; }
    .debt-account-row {
      display: flex; align-items: center;
      padding: 5px 0; font-size: 13px; gap: 8px;
    }
    .debt-account-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
    .debt-account-name { flex: 1; }
    .debt-account-balance { font-weight: 600; }
    .debt-account-rate { font-size: 11px; color: var(--text-muted); margin-left: 4px; }
    .debt-milestone {
      margin-top: 12px; padding: 10px 12px;
      background: var(--green-pale); border-radius: 10px;
      font-size: 13px; color: var(--green-dark); font-weight: 600;
    }

    /* â”€â”€ Target Footer â”€â”€ */
    .target-card {
      background: var(--green-dark);
      border-radius: 14px;
      padding: 16px 20px;
      margin: 8px 12px;
      color: white;
      text-align: center;
    }
    .target-card .main-target {
      font-size: 18px; font-weight: 800; margin-bottom: 4px;
    }
    .target-card .sub-target {
      font-size: 13px; opacity: 0.75;
    }

    /* â”€â”€ Pull to refresh â”€â”€ */
    .ptr-indicator {
      text-align: center; padding: 12px;
      font-size: 13px; color: var(--text-muted);
      opacity: 0; transition: opacity 0.2s;
      position: fixed; top: calc(52px + var(--safe-top)); left: 0; right: 0;
      background: var(--bg); z-index: 50;
      pointer-events: none;
    }
    .ptr-indicator.visible { opacity: 1; }

    /* â”€â”€ Loading â”€â”€ */
    .loading-wrap {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 60px 20px;
      color: var(--text-muted); font-size: 14px;
    }
    .loading-spinner {
      width: 32px; height: 32px; border-radius: 50%;
      border: 3px solid var(--border);
      border-top-color: var(--green-light);
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ All Payments toggle â”€â”€ */
    .all-payments-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0 0;
      font-size: 13px; color: var(--green-mid); font-weight: 600;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .all-payments-section { display: none; margin-top: 8px; }
    .all-payments-section.open { display: block; }

    /* â”€â”€ Budget â”€â”€ */
    .budget-summary {
      display: flex; align-items: baseline; gap: 8px;
      margin-bottom: 10px;
    }
    .budget-summary .b-label { font-size: 22px; font-weight: 800; }
    .budget-summary .b-arrow { font-size: 14px; color: var(--text-muted); }
    .budget-summary .b-actual { font-size: 22px; font-weight: 800; }
    .budget-input-bar {
      background: var(--border); border-radius: 6px; height: 6px;
      overflow: hidden; margin-bottom: 6px;
    }
    .budget-input-fill {
      height: 100%; border-radius: 6px;
      background: var(--green-light); transition: width 0.4s ease;
    }
    .budget-input-label {
      font-size: 12px; color: var(--text-muted); margin-bottom: 12px;
    }
    .budget-row {
      display: flex; align-items: center;
      padding: 7px 0; border-bottom: 1px solid var(--border);
      font-size: 14px; gap: 8px;
    }
    .budget-row:last-child { border-bottom: none; }
    .budget-row .b-icon { font-size: 16px; flex-shrink: 0; width: 22px; }
    .budget-row .b-name { flex: 1; }
    .budget-row .b-budget { color: var(--text-muted); font-size: 13px; }
    .budget-row .b-arrow-sm { color: var(--text-muted); font-size: 11px; }
    .budget-row .b-actual-val { font-weight: 600; min-width: 54px; text-align: right; }
    .b-actual-val.pending { color: var(--text-muted); font-weight: 400; font-size: 12px; }
    .b-actual-val.over { color: var(--danger); }
    .b-actual-val.ok { color: var(--success); }
    .b-variance { font-size: 11px; margin-left: 2px; }
    .b-variance.over { color: var(--danger); }
    .b-variance.ok { color: var(--success); }
    .budget-subtotals {
      display: flex; justify-content: space-between;
      padding-top: 10px; margin-top: 6px;
      border-top: 1.5px solid var(--border);
      font-size: 13px;
    }
    .budget-subtotals .b-sub-item { display: flex; flex-direction: column; gap: 2px; }
    .budget-subtotals .b-sub-label { color: var(--text-muted); font-size: 11px; }
    .budget-subtotals .b-sub-val { font-weight: 700; }
    .budget-subtotals .b-diff { font-size: 12px; }
    .budget-subtotals .b-diff.over { color: var(--danger); }
    .budget-subtotals .b-diff.ok { color: var(--success); }

    /* â”€â”€ Section spacer â”€â”€ */
    .section-gap { height: 4px; }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div>
    <h1>ğŸ’° Cash Flow</h1>
    <div class="header-sub" id="updatedAt">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
  <button class="header-reload" id="reloadBtn" onclick="reload()" title="æ›´æ–°">â†»</button>
</div>

<!-- Pull to Refresh -->
<div class="ptr-indicator" id="ptrIndicator">â†“ å¼•ã£å¼µã£ã¦æ›´æ–°</div>

<!-- Main -->
<div class="main" id="mainContent">
  <div class="loading-wrap" id="loadingWrap">
    <div class="loading-spinner"></div>
    <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
  </div>
</div>

<script>
const DATA_BASE_URL = 'https://shujiuyeda.github.io/web/data/finance.json';
const CACHE_KEY = 'finance_cache';
const CACHE_TS_KEY = 'finance_cache_ts';

let financeData = null;

// â”€â”€ Debt account colors (high-rate = red â†’ low-rate = green) â”€â”€
const DEBT_COLORS = ['#DC3545','#E85D04','#F7931E','#F59E0B','#8BC34A','#52B788','#2D6A4F'];

// â”€â”€ Status labels â”€â”€
const STATUS_LABEL = {
  confirmed: 'âœ… ç¢ºå®š',
  likely: 'ğŸŸ¡ æœ‰åŠ›',
  estimating: 'ğŸŸ  è¦‹è¾¼',
  pipeline: 'ğŸ”µ å€™è£œ',
  received: 'âœ… å—å–æ¸ˆ'
};
const STATUS_CLASS = {
  confirmed: 'status-confirmed',
  likely: 'status-likely',
  estimating: 'status-estimating',
  pipeline: 'status-pipeline',
  received: 'status-received'
};

// â”€â”€ Date helpers â”€â”€
function parseDate(str) { return new Date(str + 'T00:00:00'); }
function fmtDate(str) {
  const d = parseDate(str);
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  return `${d.getMonth()+1}/${d.getDate()}ï¼ˆ${days[d.getDay()]}ï¼‰`;
}
function daysUntil(dateStr) {
  const now = new Date(); now.setHours(0,0,0,0);
  const target = parseDate(dateStr);
  return Math.round((target - now) / 86400000);
}
function fmtUpdated(str) {
  const d = new Date(str);
  return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')} æ›´æ–°`;
}
function fmtMan(v) {
  if (v === null || v === undefined) return 'â€”';
  return v % 1 === 0 ? `${v}ä¸‡` : `${v}ä¸‡`;
}

// â”€â”€ Load data â”€â”€
async function loadData(force = false) {
  if (!force) {
    const cached = localStorage.getItem(CACHE_KEY);
    const ts = parseInt(localStorage.getItem(CACHE_TS_KEY) || '0');
    if (cached && Date.now() - ts < 300000) {
      try { return JSON.parse(cached); } catch(e) {}
    }
  }
  const res = await fetch(DATA_BASE_URL + '?t=' + Date.now());
  if (!res.ok) throw new Error('fetch failed');
  const data = await res.json();
  localStorage.setItem(CACHE_KEY, JSON.stringify(data));
  localStorage.setItem(CACHE_TS_KEY, String(Date.now()));
  return data;
}

// â”€â”€ Reload â”€â”€
async function reload() {
  const btn = document.getElementById('reloadBtn');
  btn.classList.add('spinning');
  try {
    financeData = await loadData(true);
    render(financeData);
  } catch(e) {
    console.error(e);
  } finally {
    btn.classList.remove('spinning');
  }
}

// â”€â”€ Main render â”€â”€
function render(d) {
  document.getElementById('updatedAt').textContent = fmtUpdated(d.updated);

  const main = document.getElementById('mainContent');
  main.innerHTML = '';

  // B: Hero
  main.appendChild(renderHero(d));

  // B2: Budget vs Actual
  main.appendChild(renderBudget(d));

  // C: Next Payment
  main.appendChild(renderNextPayment(d));

  // D: Income Pipeline
  main.appendChild(renderPipeline(d));

  // E: Cash Flow Chart
  main.appendChild(renderChart(d));

  // F: Debt
  main.appendChild(renderDebt(d));

  // G: Target
  main.appendChild(renderTarget(d));
}

// â”€â”€ B: Hero â”€â”€
function renderHero(d) {
  const projection = d.cashflow[d.cashflow.length - 1].balance;
  const pct = Math.min(100, Math.round(projection / d.safetyLine * 100));
  const gap = d.safetyLine - projection;

  let fillColor, gapClass;
  if (gap > 30) { fillColor = '#EF4444'; gapClass = 'danger'; }
  else if (gap > 0) { fillColor = '#F59E0B'; gapClass = 'warning'; }
  else { fillColor = '#52B788'; gapClass = 'ok'; }

  const el = document.createElement('div');
  el.className = 'hero-card';
  el.innerHTML = `
    <div class="hero-label">3æœˆæœ«äºˆæ¸¬</div>
    <div class="hero-amount">${projection}<span>ä¸‡</span></div>
    <div class="hero-progress-wrap">
      <div class="hero-progress-bar">
        <div class="hero-progress-fill" style="width:${pct}%;background:${fillColor}"></div>
      </div>
      <div class="hero-progress-labels">
        <span>0ä¸‡</span><span>å®‰å…¨ãƒ©ã‚¤ãƒ³ ${d.safetyLine}ä¸‡</span>
      </div>
    </div>
    <div class="hero-gap ${gapClass}">
      ${gap > 0 ? `ã‚ã¨ ${gap.toFixed(1)}ä¸‡ ã®ä¸Šç©ã¿ãŒå¿…è¦` : `å®‰å…¨ãƒ©ã‚¤ãƒ³é”æˆ ğŸ‰`}
    </div>
  `;
  return el;
}

// â”€â”€ B2: Budget vs Actual â”€â”€
function renderBudget(d) {
  if (!d.budget) return document.createElement('div');

  const el = document.createElement('div');
  el.className = 'card';

  const cats = d.budget.categories;
  const totalBudget = cats.reduce((s, c) => s + c.budget, 0);
  const filledCats = cats.filter(c => c.actual !== null);
  const totalActual = filledCats.reduce((s, c) => s + c.actual, 0);
  const inputRate = filledCats.length / cats.length;

  // Card budget/actual subtotals
  const cardCats = cats.filter(c => c.type === 'card');
  const cashCats = cats.filter(c => c.type === 'cash');
  const cardBudget = cardCats.reduce((s, c) => s + c.budget, 0);
  const cashBudget = cashCats.reduce((s, c) => s + c.budget, 0);
  const cardActual = cardCats.filter(c => c.actual !== null).reduce((s, c) => s + c.actual, 0);
  const cashActual = cashCats.filter(c => c.actual !== null).reduce((s, c) => s + c.actual, 0);
  const cardFilledCount = cardCats.filter(c => c.actual !== null).length;
  const cashFilledCount = cashCats.filter(c => c.actual !== null).length;

  // Month display
  const [yr, mo] = d.budget.month.split('-');
  const moLabel = `${parseInt(mo)}æœˆ`;

  // Actual summary display
  const actualDisplay = filledCats.length > 0 ? `${totalActual.toFixed(2).replace(/\.?0+$/, '')}ä¸‡` : 'â€”ä¸‡';
  const budgetDisplay = `${totalBudget.toFixed(2).replace(/\.?0+$/, '')}ä¸‡`;

  // Category rows
  const rowsHtml = cats.map(c => {
    let actualHtml, varianceHtml = '';
    if (c.actual === null) {
      actualHtml = `<span class="b-actual-val pending">æœªå…¥åŠ›</span>`;
    } else {
      const diff = c.actual - c.budget;
      const pct = Math.abs(diff) / c.budget;
      let cls = 'neutral', varCls = '', varText = '';
      if (pct > 0.05 && diff > 0) {
        cls = 'over'; varCls = 'over'; varText = `â–²${diff.toFixed(2).replace(/\.?0+$/, '')}`;
      } else if (pct > 0.05 && diff < 0) {
        cls = 'ok'; varCls = 'ok'; varText = `â–½${Math.abs(diff).toFixed(2).replace(/\.?0+$/, '')}`;
      }
      actualHtml = `<span class="b-actual-val ${cls}">${c.actual}ä¸‡</span>`;
      varianceHtml = varText ? `<span class="b-variance ${varCls}">${varText}</span>` : '';
    }
    return `
      <div class="budget-row">
        <span class="b-icon">${c.icon}</span>
        <span class="b-name">${c.name}</span>
        <span class="b-budget">${c.budget}ä¸‡</span>
        <span class="b-arrow-sm">â†’</span>
        ${actualHtml}${varianceHtml}
      </div>
    `;
  }).join('');

  // Subtotals
  function subActualStr(filled, budget, count, total) {
    return count > 0 ? `${filled.toFixed(2).replace(/\.?0+$/, '')}ä¸‡` : 'â€”';
  }
  function diffStr(actual, budget, count) {
    if (count === 0) return '';
    const d = actual - budget;
    const cls = d > 0 ? 'over' : 'ok';
    const sign = d > 0 ? 'â–²' : 'â–½';
    return `<span class="b-diff ${cls}">${sign}${Math.abs(d).toFixed(2).replace(/\.?0+$/, '')}ä¸‡</span>`;
  }

  el.innerHTML = `
    <div class="card-title">æ”¯å‡ºç®¡ç†  ${moLabel}</div>
    <div class="budget-summary">
      <span class="b-label">${budgetDisplay}</span>
      <span class="b-arrow">â†’</span>
      <span class="b-actual">${actualDisplay}</span>
    </div>
    <div class="budget-input-bar">
      <div class="budget-input-fill" style="width:${Math.round(inputRate * 100)}%"></div>
    </div>
    <div class="budget-input-label">${filledCats.length}/${cats.length} å…¥åŠ›æ¸ˆã¿</div>
    <button class="expand-btn" onclick="toggleBudgetDetail(this)">
      <span>â–¶ ã‚«ãƒ†ã‚´ãƒªè©³ç´° (${cats.length})</span>
      <span class="expand-icon">â–¼</span>
    </button>
    <div class="items-list" id="budgetDetail">
      ${rowsHtml}
    </div>
    <div class="budget-subtotals">
      <div class="b-sub-item">
        <span class="b-sub-label">ğŸ’³ ã‚«ãƒ¼ãƒ‰</span>
        <span class="b-sub-val">${cardBudget}ä¸‡ â†’ ${subActualStr(cardActual, cardBudget, cardFilledCount)}</span>
        ${diffStr(cardActual, cardBudget, cardFilledCount)}
      </div>
      <div class="b-sub-item" style="text-align:right">
        <span class="b-sub-label">ğŸ’µ ç¾é‡‘</span>
        <span class="b-sub-val">${cashBudget}ä¸‡ â†’ ${subActualStr(cashActual, cashBudget, cashFilledCount)}</span>
        ${diffStr(cashActual, cashBudget, cashFilledCount)}
      </div>
    </div>
  `;
  return el;
}

function toggleBudgetDetail(btn) {
  const detail = document.getElementById('budgetDetail');
  const icon = btn.querySelector('.expand-icon');
  const label = btn.querySelector('span:first-child');
  if (detail.classList.toggle('open')) {
    icon.classList.add('open');
    label.textContent = 'â–¼ ã‚«ãƒ†ã‚´ãƒªè©³ç´°ã‚’é–‰ã˜ã‚‹';
  } else {
    icon.classList.remove('open');
    label.textContent = `â–¶ ã‚«ãƒ†ã‚´ãƒªè©³ç´° (${document.querySelectorAll('.budget-row').length})`;
  }
}

// â”€â”€ C: Next Payment â”€â”€
function renderNextPayment(d) {
  const unpaid = d.payments.filter(p => !p.paid);

  const section = document.createElement('div');

  if (unpaid.length === 0) {
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `<div class="card-title">NEXT PAYMENT</div><div style="color:var(--success);font-weight:700;font-size:16px;">âœ… ä»Šæœˆã®æ”¯æ‰•ã„ã¯å…¨ã¦å®Œäº†</div>`;
    section.appendChild(el);
    return section;
  }

  const next = unpaid[0];
  const days = daysUntil(next.date);
  const isUrgent = days <= 3;

  const card = document.createElement('div');
  card.className = 'card payment-card';

  let daysText, daysColor;
  if (days < 0) { daysText = `${Math.abs(days)}æ—¥è¶…é`; daysColor = '#DC3545'; }
  else if (days === 0) { daysText = 'ä»Šæ—¥ï¼'; daysColor = '#DC3545'; }
  else if (days === 1) { daysText = 'æ˜æ—¥ï¼'; daysColor = '#DC3545'; }
  else { daysText = `ã‚ã¨${days}æ—¥`; daysColor = days <= 5 ? '#E5A020' : 'var(--text)'; }

  card.innerHTML = `
    <div class="card-title">NEXT PAYMENT</div>
    <div style="font-size:13px;color:var(--text-muted);">${fmtDate(next.date)}</div>
    <div style="display:flex;align-items:baseline;gap:10px;margin-top:6px;">
      <div class="countdown" style="color:${daysColor}">${daysText}</div>
    </div>
    <div class="payment-amount">${next.amount}ä¸‡å††</div>
    <div class="payment-label">${next.label}</div>
    <button class="expand-btn" onclick="toggleItems(this)" data-id="${next.id}">
      <span>â–¶ å†…è¨³ã‚’è¦‹ã‚‹</span>
      <span class="expand-icon">â–¼</span>
    </button>
    <div class="items-list" id="items-${next.id}">
      ${next.items.map(it => `
        <div class="item-row">
          <span>${it.name}</span>
          <span class="item-amount">${it.amount}ä¸‡</span>
        </div>
      `).join('')}
    </div>
  `;

  // All payments toggle
  if (unpaid.length > 1) {
    const allWrap = document.createElement('div');
    allWrap.innerHTML = `
      <div class="all-payments-toggle" onclick="toggleAllPayments(this)">
        <span>å…¨æ”¯æ‰•ã„ã‚’è¦‹ã‚‹ï¼ˆæ®‹ã‚Š${unpaid.length}ä»¶ï¼‰</span>
        <span>â–¼</span>
      </div>
      <div class="all-payments-section" id="allPaymentsSection">
        <div class="payment-timeline">
          ${unpaid.slice(1).map(p => `
            <div class="payment-item">
              <div class="payment-dot ${p.paid ? 'paid' : ''}"></div>
              <div class="payment-item-info">
                <div class="payment-item-date">${fmtDate(p.date)}</div>
                <div class="payment-item-label">${p.label}</div>
              </div>
              <div class="payment-item-amount ${p.paid ? 'paid' : ''}">${p.amount}ä¸‡${p.paid ? '<span class="paid-badge">æ¸ˆ</span>' : ''}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    card.appendChild(allWrap);
  }

  section.appendChild(card);
  return section;
}

function toggleItems(btn) {
  const id = btn.dataset.id;
  const list = document.getElementById('items-' + id);
  const icon = btn.querySelector('.expand-icon');
  const label = btn.querySelector('span:first-child');
  if (list.classList.toggle('open')) {
    icon.classList.add('open');
    label.textContent = 'â–¼ å†…è¨³ã‚’é–‰ã˜ã‚‹';
  } else {
    icon.classList.remove('open');
    label.textContent = 'â–¶ å†…è¨³ã‚’è¦‹ã‚‹';
  }
}

function toggleAllPayments(el) {
  const section = document.getElementById('allPaymentsSection');
  const arrow = el.querySelector('span:last-child');
  if (section.classList.toggle('open')) {
    arrow.textContent = 'â–²';
  } else {
    arrow.textContent = 'â–¼';
  }
}

// â”€â”€ D: Income Pipeline â”€â”€
function renderPipeline(d) {
  const el = document.createElement('div');
  el.className = 'card';

  const confirmedTotal = d.income.filter(i => i.status === 'confirmed').reduce((s,i) => s + i.amount, 0);
  const total = d.income.reduce((s,i) => s + i.amount, 0);

  el.innerHTML = `
    <div class="card-title">INCOME PIPELINE</div>
    ${d.income.map(i => {
      const st = i.received ? 'received' : i.status;
      return `
        <div class="pipeline-item">
          <span class="status-badge ${STATUS_CLASS[st]}">${STATUS_LABEL[st]}</span>
          <span class="pipeline-name ${i.received ? 'received' : ''}">${i.name}</span>
          <div class="pipeline-right">
            <div class="pipeline-amount">${i.amount}ä¸‡</div>
            <div class="pipeline-timing">${i.timing}</div>
          </div>
        </div>
      `;
    }).join('')}
    <div class="pipeline-summary">
      <span class="confirmed">ç¢ºå®š: ${confirmedTotal}ä¸‡</span>
      <span class="total">åˆè¨ˆ: ${total}ä¸‡</span>
    </div>
  `;
  return el;
}

// â”€â”€ E: Cash Flow SVG Chart â”€â”€
function renderChart(d) {
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `<div class="card-title">CASH FLOW</div><div class="chart-wrap" id="chartWrap"></div>
    <div class="chart-legend">
      <div class="legend-item"><div class="legend-dot" style="background:#52B788"></div>å…¥é‡‘</div>
      <div class="legend-item"><div class="legend-dot" style="background:#DC3545"></div>æ”¯æ‰•ã„</div>
      <div class="legend-item"><div class="legend-dot" style="background:#F59E0B"></div>ç”Ÿæ´»è²»</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(82,183,136,0.3);border:1px dashed #52B788"></div>å®‰å…¨ãƒ©ã‚¤ãƒ³</div>
    </div>
  `;

  // Build SVG after element is appended
  setTimeout(() => {
    const wrap = el.querySelector('#chartWrap');
    const W = wrap.clientWidth || 320;
    const H = 160;
    const PAD = { top: 14, right: 16, bottom: 36, left: 34 };
    const innerW = W - PAD.left - PAD.right;
    const innerH = H - PAD.top - PAD.bottom;

    const pts = d.cashflow;
    const balances = pts.map(p => p.balance);
    const maxB = Math.max(...balances, d.safetyLine) * 1.1;
    const minB = Math.min(...balances, 0);
    const range = maxB - minB;

    function xPos(i) { return PAD.left + (i / (pts.length - 1)) * innerW; }
    function yPos(v) { return PAD.top + innerH - ((v - minB) / range) * innerH; }

    // Build path
    const linePts = pts.map((p, i) => `${xPos(i)},${yPos(p.balance)}`).join(' ');
    const areaPath = `M ${xPos(0)},${yPos(0)} L ${pts.map((p,i) => `${xPos(i)},${yPos(p.balance)}`).join(' L ')} L ${xPos(pts.length-1)},${yPos(0)} Z`;

    // Safety line y
    const safeY = yPos(d.safetyLine);

    // X axis labels (show dates)
    const labelIndices = [0, 2, 4, 7, 9]; // cherry-picked for readability
    const xLabels = labelIndices.map(i => {
      const p = pts[i];
      const d2 = new Date(p.date + 'T00:00:00');
      const label = `${d2.getMonth()+1}/${d2.getDate()}`;
      return `<text x="${xPos(i)}" y="${H - PAD.bottom + 14}" text-anchor="middle" font-size="9" fill="#9CA3AF">${label}</text>`;
    }).join('');

    // Y axis labels
    const ySteps = [0, 40, 80];
    const yLabels = ySteps.map(v => {
      if (v < minB || v > maxB) return '';
      return `<text x="${PAD.left - 6}" y="${yPos(v) + 3}" text-anchor="end" font-size="9" fill="#9CA3AF">${v}</text>`;
    }).join('');

    // Event dots
    const dots = pts.map((p, i) => {
      let color = '#9CA3AF';
      if (p.type === 'income') color = '#52B788';
      else if (p.type === 'payment') color = '#DC3545';
      else if (p.type === 'expense') color = '#F59E0B';
      else if (p.type === 'current') color = '#60A5FA';
      return `<circle cx="${xPos(i)}" cy="${yPos(p.balance)}" r="4" fill="${color}" stroke="white" stroke-width="1.5"/>`;
    }).join('');

    // Event labels for key points
    const keyLabels = pts.map((p, i) => {
      if (!['current','income','payment'].includes(p.type)) return '';
      const x = xPos(i);
      const y = yPos(p.balance);
      const above = y > PAD.top + 20;
      const ly = above ? y - 7 : y + 14;
      // Only label a few to avoid clutter
      if (i !== 0 && i !== 1 && i !== 4 && i !== 7 && i !== 9) return '';
      return `<text x="${x}" y="${ly}" text-anchor="middle" font-size="8.5" fill="#374151" font-weight="600">${p.balance}ä¸‡</text>`;
    }).join('');

    const svg = `<svg viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#52B788" stop-opacity="0.35"/>
          <stop offset="100%" stop-color="#52B788" stop-opacity="0.05"/>
        </linearGradient>
      </defs>
      <!-- Grid line at 0 -->
      <line x1="${PAD.left}" y1="${yPos(0)}" x2="${W - PAD.right}" y2="${yPos(0)}" stroke="#E5E7EB" stroke-width="1"/>
      <!-- Safety line -->
      <line x1="${PAD.left}" y1="${safeY}" x2="${W - PAD.right}" y2="${safeY}" stroke="#52B788" stroke-width="1.5" stroke-dasharray="5,4" opacity="0.7"/>
      <text x="${W - PAD.right - 2}" y="${safeY - 4}" text-anchor="end" font-size="8" fill="#52B788">å®‰å…¨ãƒ©ã‚¤ãƒ³</text>
      <!-- Area fill -->
      <path d="${areaPath}" fill="url(#areaGrad)"/>
      <!-- Line -->
      <polyline points="${linePts}" fill="none" stroke="#2D6A4F" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
      <!-- Y labels -->
      ${yLabels}
      <!-- X labels -->
      ${xLabels}
      <!-- Dots -->
      ${dots}
      <!-- Balance labels -->
      ${keyLabels}
    </svg>`;

    wrap.innerHTML = svg;
  }, 0);

  return el;
}

// â”€â”€ F: Debt â”€â”€
function renderDebt(d) {
  const el = document.createElement('div');
  el.className = 'card';

  // Stack bar segments
  const sortedAccounts = [...d.debt.accounts].sort((a,b) => b.rate - a.rate);
  const segments = sortedAccounts.map((acc, i) => {
    const pct = (acc.balance / d.debt.total * 100).toFixed(2);
    return `<div class="debt-stack-seg" style="width:${pct}%;background:${DEBT_COLORS[i % DEBT_COLORS.length]}"></div>`;
  }).join('');

  // Account rows
  const rows = sortedAccounts.map((acc, i) => {
    const rateText = acc.rate > 0 ? `${acc.rate}%` : '0%';
    return `
      <div class="debt-account-row">
        <div class="debt-account-dot" style="background:${DEBT_COLORS[i % DEBT_COLORS.length]}"></div>
        <div class="debt-account-name">${acc.name}</div>
        <div class="debt-account-balance">${acc.balance}ä¸‡</div>
        <div class="debt-account-rate">${rateText}</div>
      </div>
    `;
  }).join('');

  el.innerHTML = `
    <div class="card-title">DEBT</div>
    <div class="debt-header">
      <div>
        <div class="debt-total">${d.debt.total}<span>ä¸‡</span></div>
        <div class="debt-sub">é«˜é‡‘åˆ©è² å‚µç·é¡</div>
      </div>
      <div class="debt-meta">
        <div class="monthly">${d.debt.monthlyPayment}ä¸‡/æœˆ</div>
        <div class="interest">åˆ©æ¯ ${d.debt.monthlyInterest}ä¸‡/æœˆ</div>
      </div>
    </div>
    <div class="debt-stack-wrap">
      <div class="debt-stack-bar">${segments}</div>
    </div>
    <div class="debt-accounts">${rows}</div>
    <div class="debt-milestone">ğŸ¯ æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³: ${d.debt.nextMilestone}</div>
  `;
  return el;
}

// â”€â”€ G: Target â”€â”€
function renderTarget(d) {
  const el = document.createElement('div');
  el.className = 'target-card';
  el.innerHTML = `
    <div class="main-target">å¹´å ${d.targetAnnual}ä¸‡ = æœˆ ${d.targetMonthly}ä¸‡</div>
    <div class="sub-target">é«˜é‡‘åˆ© ${d.debt.total}ä¸‡ã‚’è‡ªåŠ›ã§è¿”ã™</div>
  `;
  return el;
}

// â”€â”€ Init â”€â”€
async function init() {
  try {
    financeData = await loadData();
    render(financeData);
  } catch(e) {
    // Try cache fallback
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
      try {
        financeData = JSON.parse(cached);
        render(financeData);
        return;
      } catch(e2) {}
    }
    document.getElementById('loadingWrap').innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:var(--text-muted);">
        <div style="font-size:32px;margin-bottom:8px;">âš ï¸</div>
        <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>
        <button onclick="reload()" style="margin-top:16px;padding:10px 24px;background:var(--green-mid);color:white;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;">å†è©¦è¡Œ</button>
      </div>
    `;
  }
}

// â”€â”€ Pull to Refresh â”€â”€
(function setupPTR() {
  let startY = 0, pulling = false, threshold = 60;
  const indicator = document.getElementById('ptrIndicator');

  document.addEventListener('touchstart', e => {
    if (window.scrollY === 0) { startY = e.touches[0].clientY; pulling = true; }
  }, { passive: true });

  document.addEventListener('touchmove', e => {
    if (!pulling) return;
    const dy = e.touches[0].clientY - startY;
    if (dy > 10) indicator.classList.add('visible');
    if (dy > threshold) indicator.textContent = 'âœ“ é›¢ã—ã¦æ›´æ–°';
    else indicator.textContent = 'â†“ å¼•ã£å¼µã£ã¦æ›´æ–°';
  }, { passive: true });

  document.addEventListener('touchend', async e => {
    if (!pulling) return;
    pulling = false;
    const dy = e.changedTouches[0].clientY - startY;
    indicator.classList.remove('visible');
    indicator.textContent = 'â†“ å¼•ã£å¼µã£ã¦æ›´æ–°';
    if (dy > threshold) await reload();
  });
})();

// â”€â”€ Service Worker â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

init();
</script>
</body>
</html>
