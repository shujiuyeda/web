<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1B4332">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cash Flow">
  <title>üí∞ Cash Flow</title>
  <link rel="manifest" href="finance-manifest.json">
  <link rel="apple-touch-icon" href="finance-icon.svg">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green-dark: #1B4332;
      --green-mid: #2D6A4F;
      --green-light: #52B788;
      --green-pale: #D8F3DC;
      --bg: #F0F4F0;
      --card: #FFFFFF;
      --text: #1A1A2E;
      --text-muted: #6C757D;
      --border: #DEE2E6;
      --danger: #DC3545;
      --warning: #E5A020;
      --amber: #F59E0B;
      --success: #28A745;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --nav-height: 52px;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--green-dark);
      color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      padding-top: var(--safe-top);
      height: calc(52px + var(--safe-top));
      z-index: 100;
    }
    .header h1 { font-size: 16px; font-weight: 700; }
    .header-sub { font-size: 12px; opacity: 0.75; }
    .header-reload {
      background: none; border: none; color: white; opacity: 0.75;
      font-size: 22px; padding: 6px 8px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s;
      display: inline-block; line-height: 1;
    }
    .header-reload:active { opacity: 0.4; }
    .header-reload.spinning { animation: hdr-spin 0.7s linear infinite; }
    @keyframes hdr-spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .main {
      padding-top: calc(52px + var(--safe-top));
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 16px);
    }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    .card {
      background: var(--card); border-radius: 14px;
      padding: 14px 16px; margin: 8px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 11px; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.6px; margin-bottom: 12px;
    }

    /* ‚îÄ‚îÄ Hero (dark gradient) ‚îÄ‚îÄ */
    .hero-card {
      background: linear-gradient(135deg, var(--green-dark) 0%, var(--green-mid) 100%);
      border-radius: 18px;
      padding: 20px 20px 22px;
      margin: 10px 12px 8px;
      color: white;
      box-shadow: 0 4px 16px rgba(27,67,50,0.35);
    }
    .hero-label {
      font-size: 11px; font-weight: 700;
      opacity: 0.75; text-transform: uppercase;
      letter-spacing: 0.8px; margin-bottom: 6px;
    }
    .hero-amount {
      font-size: 52px; font-weight: 800;
      line-height: 1; letter-spacing: -2px;
    }
    .hero-amount span { font-size: 22px; font-weight: 600; margin-left: 3px; }
    .hero-progress-wrap { margin: 14px 0 10px; }
    .hero-progress-bar {
      background: rgba(255,255,255,0.2);
      border-radius: 8px; height: 10px;
      overflow: hidden;
    }
    .hero-progress-fill {
      height: 100%; border-radius: 8px;
      transition: width 0.6s ease;
    }
    .hero-progress-labels {
      display: flex; justify-content: space-between;
      font-size: 11px; opacity: 0.75; margin-top: 5px;
    }
    .hero-gap {
      font-size: 14px; font-weight: 600;
      opacity: 0.9; margin-top: 4px;
    }
    .hero-gap.danger { color: #FCA5A5; }
    .hero-gap.warning { color: #FCD34D; }
    .hero-gap.ok { color: #86EFAC; }

    /* ‚îÄ‚îÄ Next Payment ‚îÄ‚îÄ */
    .payment-card .countdown {
      font-size: 32px; font-weight: 800;
      color: var(--danger);
      line-height: 1;
    }
    .payment-card .countdown.ok { color: var(--success); }
    .payment-card .payment-amount {
      font-size: 26px; font-weight: 800;
      color: var(--text); margin-top: 4px;
    }
    .payment-card .payment-label {
      font-size: 13px; color: var(--text-muted); margin-top: 2px;
    }
    .payment-card .payment-date {
      font-size: 13px; font-weight: 600; color: var(--text-muted);
      margin-top: 8px;
    }
    .expand-btn {
      background: none; border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 12px;
      font-size: 13px; color: var(--text-muted);
      cursor: pointer; width: 100%; text-align: left;
      margin-top: 12px;
      -webkit-tap-highlight-color: transparent;
      display: flex; align-items: center; justify-content: space-between;
    }
    .expand-btn:active { opacity: 0.7; }
    .expand-icon { transition: transform 0.2s; }
    .expand-icon.open { transform: rotate(180deg); }
    .items-list { display: none; margin-top: 10px; }
    .items-list.open { display: block; }
    .item-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 7px 0; border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .item-row:last-child { border-bottom: none; }
    .item-amount { font-weight: 600; }

    /* ‚îÄ‚îÄ All Payments List ‚îÄ‚îÄ */
    .payment-timeline { margin-top: 4px; }
    .payment-item {
      display: flex; align-items: flex-start;
      padding: 10px 0; border-bottom: 1px solid var(--border);
      gap: 12px;
    }
    .payment-item:last-child { border-bottom: none; }
    .payment-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--danger); flex-shrink: 0; margin-top: 5px;
    }
    .payment-dot.paid { background: var(--success); }
    .payment-item-info { flex: 1; }
    .payment-item-date { font-size: 12px; color: var(--text-muted); }
    .payment-item-label { font-size: 14px; font-weight: 600; margin-top: 1px; }
    .payment-item-amount { font-size: 16px; font-weight: 700; white-space: nowrap; }
    .payment-item-amount.paid { text-decoration: line-through; color: var(--success); }
    .paid-badge {
      font-size: 10px; background: #D1FAE5; color: #065F46;
      border-radius: 4px; padding: 2px 6px; margin-left: 6px;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Income Pipeline ‚îÄ‚îÄ */
    .pipeline-item {
      display: flex; align-items: center;
      padding: 9px 0; border-bottom: 1px solid var(--border);
      gap: 10px;
    }
    .pipeline-item:last-child { border-bottom: none; }
    .status-badge {
      font-size: 10px; font-weight: 700;
      border-radius: 5px; padding: 3px 7px;
      white-space: nowrap; flex-shrink: 0;
    }
    .status-confirmed { background: #D1FAE5; color: #065F46; }
    .status-likely { background: #FEF3C7; color: #92400E; }
    .status-estimating { background: #FFF7ED; color: #C2410C; }
    .status-pipeline { background: #FED7AA; color: #9A3412; }
    .status-received { background: #F0FDF4; color: #15803D; text-decoration: line-through; }
    .pipeline-name { flex: 1; font-size: 14px; font-weight: 600; }
    .pipeline-name.received { text-decoration: line-through; color: var(--text-muted); }
    .pipeline-right { text-align: right; }
    .pipeline-amount { font-size: 16px; font-weight: 700; }
    .pipeline-timing { font-size: 11px; color: var(--text-muted); }
    .pipeline-summary {
      display: flex; justify-content: space-between;
      padding-top: 12px; margin-top: 4px;
      border-top: 1.5px solid var(--border);
      font-size: 13px;
    }
    .pipeline-summary .confirmed { color: var(--success); font-weight: 700; }
    .pipeline-summary .total { color: var(--text-muted); }

    /* ‚îÄ‚îÄ SVG Chart ‚îÄ‚îÄ */
    .chart-wrap {
      overflow: hidden; position: relative;
    }
    .chart-wrap svg { display: block; width: 100%; }
    .chart-legend {
      display: flex; gap: 12px; flex-wrap: wrap;
      margin-top: 10px;
    }
    .legend-item {
      display: flex; align-items: center; gap: 5px;
      font-size: 11px; color: var(--text-muted);
    }
    .legend-dot {
      width: 8px; height: 8px; border-radius: 50%;
    }

    /* ‚îÄ‚îÄ Debt ‚îÄ‚îÄ */
    .debt-header {
      display: flex; justify-content: space-between;
      align-items: flex-start; margin-bottom: 14px;
    }
    .debt-total { font-size: 32px; font-weight: 800; color: var(--text); }
    .debt-total span { font-size: 16px; font-weight: 600; color: var(--text-muted); margin-left: 2px; }
    .debt-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .debt-meta { text-align: right; }
    .debt-meta .monthly { font-size: 16px; font-weight: 700; color: var(--danger); }
    .debt-meta .interest { font-size: 12px; color: var(--text-muted); }
    .debt-stack-wrap { margin: 4px 0 12px; }
    .debt-stack-bar {
      height: 14px; border-radius: 8px;
      overflow: hidden; display: flex;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .debt-stack-seg { height: 100%; }
    .debt-accounts { margin-top: 10px; }
    .debt-account-row {
      display: flex; align-items: center;
      padding: 5px 0; font-size: 13px; gap: 8px;
    }
    .debt-account-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
    .debt-account-name { flex: 1; }
    .debt-account-balance { font-weight: 600; }
    .debt-account-rate { font-size: 11px; color: var(--text-muted); margin-left: 4px; }
    .debt-milestone {
      margin-top: 12px; padding: 10px 12px;
      background: var(--green-pale); border-radius: 10px;
      font-size: 13px; color: var(--green-dark); font-weight: 600;
    }

    /* ‚îÄ‚îÄ Target Footer ‚îÄ‚îÄ */
    .target-card {
      background: var(--green-dark);
      border-radius: 14px;
      padding: 16px 20px;
      margin: 8px 12px;
      color: white;
      text-align: center;
    }
    .target-card .main-target {
      font-size: 18px; font-weight: 800; margin-bottom: 4px;
    }
    .target-card .sub-target {
      font-size: 13px; opacity: 0.75;
    }

    /* ‚îÄ‚îÄ Pull to refresh ‚îÄ‚îÄ */
    .ptr-indicator {
      text-align: center; padding: 12px;
      font-size: 13px; color: var(--text-muted);
      opacity: 0; transition: opacity 0.2s;
      position: fixed; top: calc(52px + var(--safe-top)); left: 0; right: 0;
      background: var(--bg); z-index: 50;
      pointer-events: none;
    }
    .ptr-indicator.visible { opacity: 1; }

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    .loading-wrap {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 60px 20px;
      color: var(--text-muted); font-size: 14px;
    }
    .loading-spinner {
      width: 32px; height: 32px; border-radius: 50%;
      border: 3px solid var(--border);
      border-top-color: var(--green-light);
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ All Payments toggle ‚îÄ‚îÄ */
    .all-payments-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0 0;
      font-size: 13px; color: var(--green-mid); font-weight: 600;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .all-payments-section { display: none; margin-top: 8px; }
    .all-payments-section.open { display: block; }

    /* ‚îÄ‚îÄ Budget ‚îÄ‚îÄ */
    .budget-summary {
      display: flex; align-items: baseline; gap: 8px;
      margin-bottom: 10px;
    }
    .budget-summary .b-label { font-size: 22px; font-weight: 800; }
    .budget-summary .b-arrow { font-size: 14px; color: var(--text-muted); }
    .budget-summary .b-actual { font-size: 22px; font-weight: 800; }
    .budget-input-bar {
      background: var(--border); border-radius: 6px; height: 6px;
      overflow: hidden; margin-bottom: 6px;
    }
    .budget-input-fill {
      height: 100%; border-radius: 6px;
      background: var(--green-light); transition: width 0.4s ease;
    }
    .budget-input-label {
      font-size: 12px; color: var(--text-muted); margin-bottom: 12px;
    }
    .budget-row {
      display: flex; align-items: center;
      padding: 7px 0; border-bottom: 1px solid var(--border);
      font-size: 14px; gap: 8px;
    }
    .budget-row:last-child { border-bottom: none; }
    .budget-row .b-icon { font-size: 16px; flex-shrink: 0; width: 22px; }
    .budget-row .b-name { flex: 1; }
    .budget-row .b-budget { color: var(--text-muted); font-size: 13px; }
    .budget-row .b-arrow-sm { color: var(--text-muted); font-size: 11px; }
    .budget-row .b-actual-val { font-weight: 600; min-width: 54px; text-align: right; }
    .b-actual-val.pending { color: var(--text-muted); font-weight: 400; font-size: 12px; }
    .b-actual-val.over { color: var(--danger); }
    .b-actual-val.ok { color: var(--success); }
    .b-variance { font-size: 11px; margin-left: 2px; }
    .b-variance.over { color: var(--danger); }
    .b-variance.ok { color: var(--success); }
    .budget-subtotals {
      display: flex; justify-content: space-between;
      padding-top: 10px; margin-top: 6px;
      border-top: 1.5px solid var(--border);
      font-size: 13px;
    }
    .budget-subtotals .b-sub-item { display: flex; flex-direction: column; gap: 2px; }
    .budget-subtotals .b-sub-label { color: var(--text-muted); font-size: 11px; }
    .budget-subtotals .b-sub-val { font-weight: 700; }
    .budget-subtotals .b-diff { font-size: 12px; }
    .budget-subtotals .b-diff.over { color: var(--danger); }
    .budget-subtotals .b-diff.ok { color: var(--success); }

    /* ‚îÄ‚îÄ Budget Month Nav ‚îÄ‚îÄ */
    .budget-month-nav {
      display: flex; align-items: center; gap: 8px;
    }
    .month-nav-btn {
      background: none; border: 1px solid var(--border);
      border-radius: 6px; padding: 3px 8px;
      font-size: 13px; color: var(--text-muted);
      cursor: pointer; line-height: 1.2;
      -webkit-tap-highlight-color: transparent;
    }
    .month-nav-btn:disabled { opacity: 0.3; cursor: default; }
    .month-nav-btn:active:not(:disabled) { background: var(--border); }
    .month-nav-label { font-size: 13px; font-weight: 700; min-width: 34px; text-align: center; }

    /* ‚îÄ‚îÄ Specials ‚îÄ‚îÄ */
    .specials-section {
      margin-top: 12px; padding-top: 12px;
      border-top: 1.5px solid var(--border);
    }
    .specials-label {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 8px;
    }
    .specials-row {
      display: flex; align-items: center;
      padding: 6px 0; border-bottom: 1px solid var(--border);
      font-size: 14px; gap: 8px;
    }
    .specials-row:last-child { border-bottom: none; }
    .sp-icon { font-size: 16px; flex-shrink: 0; width: 22px; }
    .sp-name { flex: 1; }
    .sp-note { font-size: 12px; color: var(--text-muted); margin-right: 4px; }
    .sp-amount { font-weight: 600; }
    .specials-total {
      display: flex; justify-content: flex-end;
      padding-top: 8px; font-size: 13px; color: var(--text-muted); font-weight: 600;
    }

    /* ‚îÄ‚îÄ Hero Outlook ‚îÄ‚îÄ */
    .hero-outlook {
      margin-top: 16px; padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,0.2);
      display: flex; gap: 0; justify-content: space-between;
    }
    .outlook-item {
      flex: 1; text-align: center;
    }
    .outlook-label {
      font-size: 11px; opacity: 0.7; margin-bottom: 4px;
    }
    .outlook-value {
      font-size: 18px; font-weight: 800; line-height: 1.2;
    }
    .outlook-value.negative { color: #FCA5A5; }
    .outlook-value.warning { color: #FCD34D; }
    .outlook-value.ok { color: #86EFAC; }
    .outlook-estimated {
      font-size: 10px; opacity: 0.5; font-style: italic;
    }
    .outlook-bar {
      height: 4px; border-radius: 2px;
      background: rgba(255,255,255,0.15);
      margin: 6px auto 0; width: 60%;
      overflow: hidden;
    }
    .outlook-bar-fill {
      height: 100%; border-radius: 2px;
    }
    .outlook-need {
      font-size: 10px; opacity: 0.7; margin-top: 4px;
    }
    .outlook-summary {
      margin-top: 12px; padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,0.15);
      text-align: center;
      font-size: 11px; opacity: 0.7;
    }
    .outlook-summary strong {
      font-size: 14px; opacity: 1; color: #FCA5A5;
    }

    /* ‚îÄ‚îÄ Section spacer ‚îÄ‚îÄ */
    .section-gap { height: 4px; }

    /* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: calc(var(--nav-height) + var(--safe-bottom));
      background: var(--green-dark);
      border-top: 1px solid rgba(255,255,255,0.15);
      display: flex; z-index: 100;
      padding-bottom: var(--safe-bottom);
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 2px;
      border: none; background: none;
      color: rgba(255,255,255,0.5); font-size: 9px;
      cursor: pointer; padding: 6px 2px;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-btn.active { color: #86EFAC; }
    .nav-btn svg { width: 22px; height: 22px; }

    /* ‚îÄ‚îÄ Business Tab ‚îÄ‚îÄ */
    .biz-progress {
      height: 8px; border-radius: 4px;
      background: rgba(255,255,255,0.15); margin: 6px 0 3px;
    }
    .biz-progress-fill {
      height: 100%; border-radius: 4px;
      transition: width 0.5s ease;
    }
    .biz-pipeline-status {
      font-size: 13px; font-weight: 700;
      margin-top: 14px; margin-bottom: 4px;
      color: var(--text);
    }
    .biz-pipeline-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 6px 0; border-bottom: 1px solid var(--border);
      font-size: 13px;
    }
    .biz-pipeline-item:last-of-type { border-bottom: none; }
    .biz-pipeline-name { flex: 1; }
    .biz-pipeline-amount { font-weight: 700; font-size: 14px; }
    .biz-pipeline-timing { font-size: 11px; color: var(--text-muted); }
    .biz-pipeline-divider {
      border-top: 1.5px dashed var(--border); margin: 12px 0 8px;
    }
    .biz-pipeline-total-row {
      display: flex; justify-content: space-between; align-items: baseline;
      font-size: 13px;
    }

    /* ‚îÄ‚îÄ Roadmap ‚îÄ‚îÄ */
    .roadmap-timeline {
      display: flex; align-items: center; justify-content: space-between;
      padding: 4px 0 12px;
    }
    .roadmap-node { display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 0 0 auto; }
    .roadmap-dot {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2.5px solid var(--green-light);
      background: transparent;
    }
    .roadmap-dot.active {
      background: var(--green-light);
      box-shadow: 0 0 0 4px rgba(82,183,136,0.25);
    }
    .roadmap-dot.future { border-color: var(--border); }
    .roadmap-node-amount { font-size: 14px; font-weight: 800; color: var(--text); }
    .roadmap-node-label { font-size: 10px; color: var(--text-muted); }
    .roadmap-node-now { font-size: 9px; font-weight: 700; color: var(--green-mid); letter-spacing: 0.3px; margin-top: 1px; }
    .roadmap-line { flex: 1; height: 2px; margin: 0 4px; margin-bottom: 22px; }
    .roadmap-line.solid { background: var(--green-light); }
    .roadmap-line.dashed {
      background: repeating-linear-gradient(90deg, var(--border) 0 5px, transparent 5px 10px);
    }
    .roadmap-progress-section {
      background: var(--green-pale); border-radius: 10px;
      padding: 10px 12px; margin-top: 4px;
    }
    .roadmap-progress-label {
      display: flex; justify-content: space-between;
      font-size: 12px; margin-bottom: 6px; font-weight: 600;
    }
    .roadmap-progress-bar {
      height: 8px; border-radius: 4px;
      background: rgba(27,67,50,0.12); overflow: hidden;
    }
    .roadmap-progress-fill {
      height: 100%; border-radius: 4px;
      background: var(--green-mid);
      transition: width 0.5s ease;
    }
    .roadmap-progress-pct { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    .roadmap-note { font-size: 12px; color: var(--text-muted); margin-top: 8px; }

    /* ‚îÄ‚îÄ Biz Model Mix ‚îÄ‚îÄ */
    .biz-mix-actual-label { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
    .biz-mix-stack {
      display: flex; border-radius: 6px; overflow: hidden;
      height: 32px; margin-bottom: 4px;
    }
    .biz-mix-segment {
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; color: white;
      min-width: 0; overflow: hidden;
      transition: width 0.5s ease;
    }
    .biz-mix-segment.sub { background: var(--green-mid); }
    .biz-mix-segment.self { background: var(--amber); }
    .biz-mix-stack-legend {
      display: flex; gap: 12px; margin-bottom: 14px;
    }
    .biz-mix-legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-muted); }
    .biz-mix-legend-dot { width: 8px; height: 8px; border-radius: 50%; }
    .biz-mix-phase-title { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .biz-mix-phase-row {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 8px;
    }
    .biz-mix-phase-label { font-size: 12px; font-weight: 600; width: 32px; flex-shrink: 0; color: var(--text); }
    .biz-mix-phase-bar-wrap { flex: 1; height: 6px; border-radius: 3px; background: var(--border); overflow: hidden; }
    .biz-mix-phase-bar-fill { height: 100%; border-radius: 3px; background: var(--green-mid); transition: width 0.5s ease; }
    .biz-mix-phase-ratio { font-size: 11px; color: var(--text-muted); width: 40px; flex-shrink: 0; text-align: right; }
    .biz-mix-phase-now { font-size: 9px; font-weight: 700; color: var(--green-mid); margin-left: 2px; }
    .biz-mix-insight {
      background: #FFF3CD; border-left: 3px solid var(--amber);
      border-radius: 6px; padding: 8px 10px;
      font-size: 12px; color: #856404; margin-top: 10px;
      line-height: 1.5;
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div>
    <h1>üí∞ Cash Flow</h1>
    <div class="header-sub" id="updatedAt">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
  </div>
  <button class="header-reload" id="reloadBtn" onclick="reload()" title="Êõ¥Êñ∞">‚Üª</button>
</div>

<!-- Pull to Refresh -->
<div class="ptr-indicator" id="ptrIndicator">‚Üì Âºï„Å£Âºµ„Å£„Å¶Êõ¥Êñ∞</div>

<!-- Main -->
<div class="main" id="mainContent">
  <div class="loading-wrap" id="loadingWrap">
    <div class="loading-spinner"></div>
    <div>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>
  </div>
</div>

<!-- Bottom Nav -->
<nav class="bottom-nav">
  <button class="nav-btn active" data-tab="cashflow" onclick="switchTab('cashflow')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
    </svg>
    „Ç≠„É£„ÉÉ„Ç∑„É•„Éï„É≠„Éº
  </button>
  <button class="nav-btn" data-tab="business" onclick="switchTab('business')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/>
      <line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/>
    </svg>
    „Éì„Ç∏„Éç„Çπ
  </button>
</nav>

<script>
const DATA_BASE_URL = 'https://shujiuyeda.github.io/web/data/finance.json';
const CACHE_KEY = 'finance_cache';
const CACHE_TS_KEY = 'finance_cache_ts';

let financeData = null;
let budgetActiveMonth = null;

const TABS = ['cashflow', 'business'];
let currentTab = 'cashflow';

// ‚îÄ‚îÄ Debt account colors (high-rate = red ‚Üí low-rate = green) ‚îÄ‚îÄ
const DEBT_COLORS = ['#DC3545','#E85D04','#F7931E','#F59E0B','#8BC34A','#52B788','#2D6A4F'];

// ‚îÄ‚îÄ Status labels ‚îÄ‚îÄ
const STATUS_LABEL = {
  confirmed: '‚úÖ Á¢∫ÂÆö',
  likely: 'üü° ÊúâÂäõ',
  estimating: 'üü† Ë¶ãËæº',
  pipeline: 'üîµ ÂÄôË£ú',
  received: '‚úÖ ÂèóÂèñÊ∏à'
};
const STATUS_CLASS = {
  confirmed: 'status-confirmed',
  likely: 'status-likely',
  estimating: 'status-estimating',
  pipeline: 'status-pipeline',
  received: 'status-received'
};

// ‚îÄ‚îÄ Date helpers ‚îÄ‚îÄ
function parseDate(str) { return new Date(str + 'T00:00:00'); }
function fmtDate(str) {
  const d = parseDate(str);
  const days = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
  return `${d.getMonth()+1}/${d.getDate()}Ôºà${days[d.getDay()]}Ôºâ`;
}
function daysUntil(dateStr) {
  const now = new Date(); now.setHours(0,0,0,0);
  const target = parseDate(dateStr);
  return Math.round((target - now) / 86400000);
}
function fmtUpdated(str) {
  const d = new Date(str);
  return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')} Êõ¥Êñ∞`;
}
function fmtMan(v) {
  if (v === null || v === undefined) return '‚Äî';
  return v % 1 === 0 ? `${v}‰∏á` : `${v}‰∏á`;
}

// ‚îÄ‚îÄ Load data ‚îÄ‚îÄ
async function loadData(force = false) {
  if (!force) {
    const cached = localStorage.getItem(CACHE_KEY);
    const ts = parseInt(localStorage.getItem(CACHE_TS_KEY) || '0');
    if (cached && Date.now() - ts < 300000) {
      try { return JSON.parse(cached); } catch(e) {}
    }
  }
  const res = await fetch(DATA_BASE_URL + '?t=' + Date.now());
  if (!res.ok) throw new Error('fetch failed');
  const data = await res.json();
  localStorage.setItem(CACHE_KEY, JSON.stringify(data));
  localStorage.setItem(CACHE_TS_KEY, String(Date.now()));
  return data;
}

// ‚îÄ‚îÄ Reload ‚îÄ‚îÄ
async function reload() {
  const btn = document.getElementById('reloadBtn');
  btn.classList.add('spinning');
  try {
    financeData = await loadData(true);
    render(financeData);
  } catch(e) {
    console.error(e);
  } finally {
    btn.classList.remove('spinning');
  }
}

// ‚îÄ‚îÄ Tab switch ‚îÄ‚îÄ
function switchTab(tab) {
  if (tab === currentTab) return;
  const prevIdx = TABS.indexOf(currentTab);
  const nextIdx = TABS.indexOf(tab);
  currentTab = tab;
  location.hash = tab;

  document.querySelectorAll('.nav-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.tab === tab)
  );

  const main = document.getElementById('mainContent');
  main.innerHTML = '';
  if (tab === 'cashflow') renderCashflowTab(financeData);
  else if (tab === 'business') renderBusinessTab(financeData);

  const dir = nextIdx > prevIdx ? 1 : -1;
  main.style.transform = `translateX(${dir * window.innerWidth}px)`;
  requestAnimationFrame(() => requestAnimationFrame(() => {
    main.style.transition = 'transform 0.28s cubic-bezier(0.25,0.46,0.45,0.94)';
    main.style.transform = '';
    setTimeout(() => { main.style.transition = ''; }, 300);
  }));
}

// ‚îÄ‚îÄ Cashflow tab render ‚îÄ‚îÄ
function renderCashflowTab(d) {
  const main = document.getElementById('mainContent');
  main.appendChild(renderHero(d));
  main.appendChild(renderBudget(d));
  main.appendChild(renderNextPayment(d));
  main.appendChild(renderPipeline(d));
  main.appendChild(renderChart(d));
  main.appendChild(renderDebt(d));
  main.appendChild(renderTarget(d));
}

// ‚îÄ‚îÄ Main render ‚îÄ‚îÄ
function render(d) {
  document.getElementById('updatedAt').textContent = fmtUpdated(d.updated);
  const main = document.getElementById('mainContent');
  main.innerHTML = '';
  if (currentTab === 'cashflow') renderCashflowTab(d);
  else if (currentTab === 'business') renderBusinessTab(d);
}

// ‚îÄ‚îÄ B: Hero ‚îÄ‚îÄ
function renderHero(d) {
  // Use outlook[0] as primary if available, otherwise fall back to last cashflow entry
  const hasOutlook = d.outlook && d.outlook.length > 0;
  const projection = hasOutlook ? d.outlook[0].balance : d.cashflow[d.cashflow.length - 1].balance;
  const heroLabel = hasOutlook
    ? `${parseInt(d.outlook[0].month.split('-')[1])}ÊúàÊú´‰∫àÊ∏¨`
    : '3ÊúàÊú´‰∫àÊ∏¨';

  const pct = Math.min(100, Math.round(projection / d.safetyLine * 100));
  const gap = d.safetyLine - projection;

  let fillColor, gapClass;
  if (gap > 30) { fillColor = '#EF4444'; gapClass = 'danger'; }
  else if (gap > 0) { fillColor = '#F59E0B'; gapClass = 'warning'; }
  else { fillColor = '#52B788'; gapClass = 'ok'; }

  // Build outlook section HTML if more than 1 month available
  let outlookHtml = '';
  if (hasOutlook && d.outlook.length > 1) {
    const items = d.outlook.map(o => {
      const monthLabel = `${parseInt(o.month.split('-')[1])}ÊúàÊú´`;
      const valStr = o.balance === null ? '‚Äî' : `${o.balance}‰∏á`;
      const estimateMark = o.estimated ? '~' : '';
      let valClass = 'ok';
      if (o.balance === null) valClass = '';
      else if (o.balance <= 0) valClass = 'negative';
      else if (o.balance < d.safetyLine) valClass = 'warning';
      const barPct = o.balance === null ? 0 : Math.max(0, Math.min(100, Math.round(o.balance / d.safetyLine * 100)));
      const barColor = valClass === 'ok' ? '#86EFAC' : valClass === 'warning' ? '#FCD34D' : '#FCA5A5';
      return `
        <div class="outlook-item">
          <div class="outlook-label">${monthLabel}</div>
          <div class="outlook-value ${valClass}">${estimateMark}${valStr}</div>
          ${o.estimated ? '<div class="outlook-estimated">Êé®ÂÆö</div>' : '<div class="outlook-estimated">&nbsp;</div>'}
          <div class="outlook-bar"><div class="outlook-bar-fill" style="width:${barPct}%;background:${barColor}"></div></div>
          ${(() => {
            if (o.balance === null || o.balance >= d.safetyLine) return '';
            const need = Math.round(d.safetyLine - o.balance);
            const tilde = o.estimated ? '~' : '';
            return `<div class="outlook-need">+${need}‰∏áÂøÖË¶Å${tilde}</div>`;
          })()}
        </div>`;
    }).join('');
    outlookHtml = `<div class="hero-outlook">${items}</div>`;

    // ÊúàÈñìÂøÖË¶ÅÂ£≤‰∏ä„Çµ„Éû„É™„Éº
    const p27 = d.payments.filter(p => p.date.slice(-2) === '27').pop();
    const p10 = d.payments.filter(p => p.date.slice(-2) === '10').pop();
    const monthlyExp = (p27 ? p27.amount : 0) + (p10 ? p10.amount : 0) + (d.livingExpense || 0);
    outlookHtml += `<div class="outlook-summary">ÊúàÈñìÂøÖË¶ÅÂ£≤‰∏ä <strong>${Math.round(monthlyExp)}‰∏á</strong>/Êúà</div>`;
  }

  const el = document.createElement('div');
  el.className = 'hero-card';
  el.innerHTML = `
    <div class="hero-label">${heroLabel}</div>
    <div class="hero-amount">${projection}<span>‰∏á</span></div>
    <div class="hero-progress-wrap">
      <div class="hero-progress-bar">
        <div class="hero-progress-fill" style="width:${pct}%;background:${fillColor}"></div>
      </div>
      <div class="hero-progress-labels">
        <span>0‰∏á</span><span>ÂÆâÂÖ®„É©„Ç§„É≥ ${d.safetyLine}‰∏á</span>
      </div>
    </div>
    <div class="hero-gap ${gapClass}">
      ${gap > 0 ? `„ÅÇ„Å® ${gap.toFixed(1)}‰∏á „ÅÆ‰∏äÁ©ç„Åø„ÅåÂøÖË¶Å` : `ÂÆâÂÖ®„É©„Ç§„É≥ÈÅîÊàê üéâ`}
    </div>
    ${outlookHtml}
  `;
  return el;
}

// ‚îÄ‚îÄ B2: Budget vs Actual ‚îÄ‚îÄ
function renderBudget(d) {
  if (!d.budget) return document.createElement('div');

  // Detect month-keyed format (new) vs legacy flat format
  const isMonthKeyed = !('month' in d.budget) && !('categories' in d.budget);

  let monthKeys, activeMonth, monthData;
  if (isMonthKeyed) {
    monthKeys = Object.keys(d.budget).sort();
    if (!budgetActiveMonth || !d.budget[budgetActiveMonth]) {
      budgetActiveMonth = monthKeys[monthKeys.length - 1];
    }
    activeMonth = budgetActiveMonth;
    monthData = d.budget[activeMonth];
  } else {
    activeMonth = d.budget.month;
    monthData = { categories: d.budget.categories, specials: [] };
    monthKeys = [activeMonth];
  }

  const el = document.createElement('div');
  el.className = 'card';
  el.id = 'budgetCard';

  const cats = monthData.categories;
  const specials = monthData.specials || [];
  const totalBudget = cats.reduce((s, c) => s + c.budget, 0);
  const filledCats = cats.filter(c => c.actual !== null);
  const totalActual = filledCats.reduce((s, c) => s + c.actual, 0);
  const inputRate = filledCats.length / cats.length;

  // Card/cash subtotals
  const cardCats = cats.filter(c => c.type === 'card');
  const cashCats = cats.filter(c => c.type === 'cash');
  const cardBudget = cardCats.reduce((s, c) => s + c.budget, 0);
  const cashBudget = cashCats.reduce((s, c) => s + c.budget, 0);
  const cardActual = cardCats.filter(c => c.actual !== null).reduce((s, c) => s + c.actual, 0);
  const cashActual = cashCats.filter(c => c.actual !== null).reduce((s, c) => s + c.actual, 0);
  const cardFilledCount = cardCats.filter(c => c.actual !== null).length;
  const cashFilledCount = cashCats.filter(c => c.actual !== null).length;

  // Month nav
  const moIdx = monthKeys.indexOf(activeMonth);
  const [, mo] = activeMonth.split('-');
  const moLabel = `${parseInt(mo)}Êúà`;
  const hasPrev = moIdx > 0;
  const hasNext = moIdx < monthKeys.length - 1;
  const navHtml = monthKeys.length > 1 ? `
    <div class="budget-month-nav">
      <button class="month-nav-btn" onclick="changeBudgetMonth(-1)" ${hasPrev ? '' : 'disabled'}>‚óÄ</button>
      <span class="month-nav-label">${moLabel}</span>
      <button class="month-nav-btn" onclick="changeBudgetMonth(1)" ${hasNext ? '' : 'disabled'}>‚ñ∂</button>
    </div>` : `<span style="font-size:13px;font-weight:700;color:var(--text-muted)">${moLabel}</span>`;

  // Displays
  const actualDisplay = filledCats.length > 0 ? `${totalActual.toFixed(2).replace(/\.?0+$/, '')}‰∏á` : '‚Äî‰∏á';
  const budgetDisplay = `${totalBudget.toFixed(2).replace(/\.?0+$/, '')}‰∏á`;

  // Category rows
  const rowsHtml = cats.map(c => {
    let actualHtml, varianceHtml = '';
    if (c.actual === null) {
      actualHtml = `<span class="b-actual-val pending">Êú™ÂÖ•Âäõ</span>`;
    } else {
      const diff = c.actual - c.budget;
      const pct = Math.abs(diff) / c.budget;
      let cls = 'neutral', varCls = '', varText = '';
      if (pct > 0.05 && diff > 0) {
        cls = 'over'; varCls = 'over'; varText = `‚ñ≤${diff.toFixed(2).replace(/\.?0+$/, '')}`;
      } else if (pct > 0.05 && diff < 0) {
        cls = 'ok'; varCls = 'ok'; varText = `‚ñΩ${Math.abs(diff).toFixed(2).replace(/\.?0+$/, '')}`;
      }
      actualHtml = `<span class="b-actual-val ${cls}">${c.actual}‰∏á</span>`;
      varianceHtml = varText ? `<span class="b-variance ${varCls}">${varText}</span>` : '';
    }
    return `
      <div class="budget-row">
        <span class="b-icon">${c.icon}</span>
        <span class="b-name">${c.name}</span>
        <span class="b-budget">${c.budget}‰∏á</span>
        <span class="b-arrow-sm">‚Üí</span>
        ${actualHtml}${varianceHtml}
      </div>`;
  }).join('');

  // Subtotals helpers
  function subActualStr(actual, count) {
    return count > 0 ? `${actual.toFixed(2).replace(/\.?0+$/, '')}‰∏á` : '‚Äî';
  }
  function diffStr(actual, budget, count) {
    if (count === 0) return '';
    const diff = actual - budget;
    const cls = diff > 0 ? 'over' : 'ok';
    const sign = diff > 0 ? '‚ñ≤' : '‚ñΩ';
    return `<span class="b-diff ${cls}">${sign}${Math.abs(diff).toFixed(2).replace(/\.?0+$/, '')}‰∏á</span>`;
  }

  // Specials section
  let specialsHtml = '';
  if (specials.length > 0) {
    const specialsTotal = specials.filter(s => s.amount !== null).reduce((sum, s) => sum + s.amount, 0);
    const hasTotaled = specials.some(s => s.amount !== null);
    const specialRows = specials.map(s => `
      <div class="specials-row">
        <span class="sp-icon">${s.icon}</span>
        <span class="sp-name">${s.name}</span>
        ${s.note ? `<span class="sp-note">${s.note}</span>` : ''}
        <span class="sp-amount">${s.amount !== null ? s.amount + '‰∏á' : '‚Äî'}</span>
      </div>`).join('');
    specialsHtml = `
      <div class="specials-section">
        <div class="specials-label">ÁâπÂà•Âá∫Ë≤ª</div>
        ${specialRows}
        ${hasTotaled ? `<div class="specials-total">Ë®à: ${specialsTotal}‰∏á</div>` : ''}
      </div>`;
  }

  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:0">ÊîØÂá∫ÁÆ°ÁêÜ</div>
      ${navHtml}
    </div>
    <div class="budget-summary">
      <span class="b-label">${budgetDisplay}</span>
      <span class="b-arrow">‚Üí</span>
      <span class="b-actual">${actualDisplay}</span>
    </div>
    <div class="budget-input-bar">
      <div class="budget-input-fill" style="width:${Math.round(inputRate * 100)}%"></div>
    </div>
    <div class="budget-input-label">${filledCats.length}/${cats.length} ÂÖ•ÂäõÊ∏à„Åø</div>
    <button class="expand-btn" onclick="toggleBudgetDetail(this)">
      <span>‚ñ∂ „Ç´„ÉÜ„Ç¥„É™Ë©≥Á¥∞ (${cats.length})</span>
      <span class="expand-icon">‚ñº</span>
    </button>
    <div class="items-list" id="budgetDetail">
      ${rowsHtml}
    </div>
    <div class="budget-subtotals">
      <div class="b-sub-item">
        <span class="b-sub-label">üí≥ „Ç´„Éº„Éâ</span>
        <span class="b-sub-val">${cardBudget}‰∏á ‚Üí ${subActualStr(cardActual, cardFilledCount)}</span>
        ${diffStr(cardActual, cardBudget, cardFilledCount)}
      </div>
      <div class="b-sub-item" style="text-align:right">
        <span class="b-sub-label">üíµ ÁèæÈáë</span>
        <span class="b-sub-val">${cashBudget}‰∏á ‚Üí ${subActualStr(cashActual, cashFilledCount)}</span>
        ${diffStr(cashActual, cashBudget, cashFilledCount)}
      </div>
    </div>
    ${specialsHtml}
  `;
  return el;
}

function changeBudgetMonth(delta) {
  const monthKeys = Object.keys(financeData.budget).sort();
  const idx = monthKeys.indexOf(budgetActiveMonth);
  const newIdx = idx + delta;
  if (newIdx < 0 || newIdx >= monthKeys.length) return;
  budgetActiveMonth = monthKeys[newIdx];
  const oldCard = document.getElementById('budgetCard');
  if (oldCard) {
    const newCard = renderBudget(financeData);
    oldCard.parentNode.replaceChild(newCard, oldCard);
  }
}

function toggleBudgetDetail(btn) {
  const detail = document.getElementById('budgetDetail');
  const icon = btn.querySelector('.expand-icon');
  const label = btn.querySelector('span:first-child');
  const count = detail.querySelectorAll('.budget-row').length;
  if (detail.classList.toggle('open')) {
    icon.classList.add('open');
    label.textContent = '‚ñº „Ç´„ÉÜ„Ç¥„É™Ë©≥Á¥∞„ÇíÈñâ„Åò„Çã';
  } else {
    icon.classList.remove('open');
    label.textContent = `‚ñ∂ „Ç´„ÉÜ„Ç¥„É™Ë©≥Á¥∞ (${count})`;
  }
}

// ‚îÄ‚îÄ C: Next Payment ‚îÄ‚îÄ
function renderNextPayment(d) {
  const unpaid = d.payments.filter(p => !p.paid);

  const section = document.createElement('div');

  if (unpaid.length === 0) {
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `<div class="card-title">NEXT PAYMENT</div><div style="color:var(--success);font-weight:700;font-size:16px;">‚úÖ ‰ªäÊúà„ÅÆÊîØÊâï„ÅÑ„ÅØÂÖ®„Å¶ÂÆå‰∫Ü</div>`;
    section.appendChild(el);
    return section;
  }

  const next = unpaid[0];
  const days = daysUntil(next.date);
  const isUrgent = days <= 3;

  const card = document.createElement('div');
  card.className = 'card payment-card';

  let daysText, daysColor;
  if (days < 0) { daysText = `${Math.abs(days)}Êó•Ë∂ÖÈÅé`; daysColor = '#DC3545'; }
  else if (days === 0) { daysText = '‰ªäÊó•ÔºÅ'; daysColor = '#DC3545'; }
  else if (days === 1) { daysText = 'ÊòéÊó•ÔºÅ'; daysColor = '#DC3545'; }
  else { daysText = `„ÅÇ„Å®${days}Êó•`; daysColor = days <= 5 ? '#E5A020' : 'var(--text)'; }

  card.innerHTML = `
    <div class="card-title">NEXT PAYMENT</div>
    <div style="font-size:13px;color:var(--text-muted);">${fmtDate(next.date)}</div>
    <div style="display:flex;align-items:baseline;gap:10px;margin-top:6px;">
      <div class="countdown" style="color:${daysColor}">${daysText}</div>
    </div>
    <div class="payment-amount">${next.amount}‰∏áÂÜÜ</div>
    <div class="payment-label">${next.label}</div>
    <button class="expand-btn" onclick="toggleItems(this)" data-id="${next.id}">
      <span>‚ñ∂ ÂÜÖË®≥„ÇíË¶ã„Çã</span>
      <span class="expand-icon">‚ñº</span>
    </button>
    <div class="items-list" id="items-${next.id}">
      ${next.items.map(it => `
        <div class="item-row">
          <span>${it.name}</span>
          <span class="item-amount">${it.amount}‰∏á</span>
        </div>
      `).join('')}
    </div>
  `;

  // All payments toggle
  if (unpaid.length > 1) {
    const allWrap = document.createElement('div');
    allWrap.innerHTML = `
      <div class="all-payments-toggle" onclick="toggleAllPayments(this)">
        <span>ÂÖ®ÊîØÊâï„ÅÑ„ÇíË¶ã„ÇãÔºàÊÆã„Çä${unpaid.length}‰ª∂Ôºâ</span>
        <span>‚ñº</span>
      </div>
      <div class="all-payments-section" id="allPaymentsSection">
        <div class="payment-timeline">
          ${unpaid.slice(1).map(p => `
            <div class="payment-item">
              <div class="payment-dot ${p.paid ? 'paid' : ''}"></div>
              <div class="payment-item-info">
                <div class="payment-item-date">${fmtDate(p.date)}</div>
                <div class="payment-item-label">${p.label}</div>
              </div>
              <div class="payment-item-amount ${p.paid ? 'paid' : ''}">${p.amount}‰∏á${p.paid ? '<span class="paid-badge">Ê∏à</span>' : ''}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    card.appendChild(allWrap);
  }

  section.appendChild(card);
  return section;
}

function toggleItems(btn) {
  const id = btn.dataset.id;
  const list = document.getElementById('items-' + id);
  const icon = btn.querySelector('.expand-icon');
  const label = btn.querySelector('span:first-child');
  if (list.classList.toggle('open')) {
    icon.classList.add('open');
    label.textContent = '‚ñº ÂÜÖË®≥„ÇíÈñâ„Åò„Çã';
  } else {
    icon.classList.remove('open');
    label.textContent = '‚ñ∂ ÂÜÖË®≥„ÇíË¶ã„Çã';
  }
}

function toggleAllPayments(el) {
  const section = document.getElementById('allPaymentsSection');
  const arrow = el.querySelector('span:last-child');
  if (section.classList.toggle('open')) {
    arrow.textContent = '‚ñ≤';
  } else {
    arrow.textContent = '‚ñº';
  }
}

// ‚îÄ‚îÄ D: Income Pipeline ‚îÄ‚îÄ
function renderPipeline(d) {
  const el = document.createElement('div');
  el.className = 'card';

  const confirmedTotal = d.income.filter(i => i.status === 'confirmed').reduce((s,i) => s + i.amount, 0);
  const total = d.income.reduce((s,i) => s + i.amount, 0);

  el.innerHTML = `
    <div class="card-title">INCOME PIPELINE</div>
    ${d.income.map(i => {
      const st = i.received ? 'received' : i.status;
      return `
        <div class="pipeline-item">
          <span class="status-badge ${STATUS_CLASS[st]}">${STATUS_LABEL[st]}</span>
          <span class="pipeline-name ${i.received ? 'received' : ''}">${i.name}</span>
          <div class="pipeline-right">
            <div class="pipeline-amount">${i.amount}‰∏á</div>
            <div class="pipeline-timing">${i.timing}</div>
          </div>
        </div>
      `;
    }).join('')}
    <div class="pipeline-summary">
      <span class="confirmed">Á¢∫ÂÆö: ${confirmedTotal}‰∏á</span>
      <span class="total">ÂêàË®à: ${total}‰∏á</span>
    </div>
  `;
  return el;
}

// ‚îÄ‚îÄ E: Cash Flow SVG Chart ‚îÄ‚îÄ
function renderChart(d) {
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `<div class="card-title">CASH FLOW</div><div class="chart-wrap" id="chartWrap"></div>
    <div class="chart-legend">
      <div class="legend-item"><div class="legend-dot" style="background:#52B788"></div>ÂÖ•Èáë</div>
      <div class="legend-item"><div class="legend-dot" style="background:#DC3545"></div>ÊîØÊâï„ÅÑ</div>
      <div class="legend-item"><div class="legend-dot" style="background:#F59E0B"></div>ÁîüÊ¥ªË≤ª</div>
      <div class="legend-item"><div class="legend-dot" style="background:rgba(82,183,136,0.3);border:1px dashed #52B788"></div>ÂÆâÂÖ®„É©„Ç§„É≥</div>
    </div>
  `;

  // Build SVG after element is appended
  setTimeout(() => {
    const wrap = el.querySelector('#chartWrap');
    const W = wrap.clientWidth || 320;
    const H = 160;
    const PAD = { top: 14, right: 16, bottom: 36, left: 34 };
    const innerW = W - PAD.left - PAD.right;
    const innerH = H - PAD.top - PAD.bottom;

    const pts = d.cashflow;
    const balances = pts.map(p => p.balance);
    const maxB = Math.max(...balances, d.safetyLine) * 1.1;
    const minB = Math.min(...balances, 0);
    const range = maxB - minB;

    function xPos(i) { return PAD.left + (i / (pts.length - 1)) * innerW; }
    function yPos(v) { return PAD.top + innerH - ((v - minB) / range) * innerH; }

    // Build path
    const linePts = pts.map((p, i) => `${xPos(i)},${yPos(p.balance)}`).join(' ');
    const areaPath = `M ${xPos(0)},${yPos(0)} L ${pts.map((p,i) => `${xPos(i)},${yPos(p.balance)}`).join(' L ')} L ${xPos(pts.length-1)},${yPos(0)} Z`;

    // Safety line y
    const safeY = yPos(d.safetyLine);

    // X axis labels (show dates)
    const labelIndices = [0, 2, 4, 7, 9]; // cherry-picked for readability
    const xLabels = labelIndices.map(i => {
      const p = pts[i];
      const d2 = new Date(p.date + 'T00:00:00');
      const label = `${d2.getMonth()+1}/${d2.getDate()}`;
      return `<text x="${xPos(i)}" y="${H - PAD.bottom + 14}" text-anchor="middle" font-size="9" fill="#9CA3AF">${label}</text>`;
    }).join('');

    // Y axis labels
    const ySteps = [0, 40, 80];
    const yLabels = ySteps.map(v => {
      if (v < minB || v > maxB) return '';
      return `<text x="${PAD.left - 6}" y="${yPos(v) + 3}" text-anchor="end" font-size="9" fill="#9CA3AF">${v}</text>`;
    }).join('');

    // Event dots
    const dots = pts.map((p, i) => {
      let color = '#9CA3AF';
      if (p.type === 'income') color = '#52B788';
      else if (p.type === 'payment') color = '#DC3545';
      else if (p.type === 'expense') color = '#F59E0B';
      else if (p.type === 'current') color = '#60A5FA';
      return `<circle cx="${xPos(i)}" cy="${yPos(p.balance)}" r="4" fill="${color}" stroke="white" stroke-width="1.5"/>`;
    }).join('');

    // Event labels for key points
    const keyLabels = pts.map((p, i) => {
      if (!['current','income','payment'].includes(p.type)) return '';
      const x = xPos(i);
      const y = yPos(p.balance);
      const above = y > PAD.top + 20;
      const ly = above ? y - 7 : y + 14;
      // Only label a few to avoid clutter
      if (i !== 0 && i !== 1 && i !== 4 && i !== 7 && i !== 9) return '';
      return `<text x="${x}" y="${ly}" text-anchor="middle" font-size="8.5" fill="#374151" font-weight="600">${p.balance}‰∏á</text>`;
    }).join('');

    const svg = `<svg viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#52B788" stop-opacity="0.35"/>
          <stop offset="100%" stop-color="#52B788" stop-opacity="0.05"/>
        </linearGradient>
      </defs>
      <!-- Grid line at 0 -->
      <line x1="${PAD.left}" y1="${yPos(0)}" x2="${W - PAD.right}" y2="${yPos(0)}" stroke="#E5E7EB" stroke-width="1"/>
      <!-- Safety line -->
      <line x1="${PAD.left}" y1="${safeY}" x2="${W - PAD.right}" y2="${safeY}" stroke="#52B788" stroke-width="1.5" stroke-dasharray="5,4" opacity="0.7"/>
      <text x="${W - PAD.right - 2}" y="${safeY - 4}" text-anchor="end" font-size="8" fill="#52B788">ÂÆâÂÖ®„É©„Ç§„É≥</text>
      <!-- Area fill -->
      <path d="${areaPath}" fill="url(#areaGrad)"/>
      <!-- Line -->
      <polyline points="${linePts}" fill="none" stroke="#2D6A4F" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
      <!-- Y labels -->
      ${yLabels}
      <!-- X labels -->
      ${xLabels}
      <!-- Dots -->
      ${dots}
      <!-- Balance labels -->
      ${keyLabels}
    </svg>`;

    wrap.innerHTML = svg;
  }, 0);

  return el;
}

// ‚îÄ‚îÄ F: Debt ‚îÄ‚îÄ
function renderDebt(d) {
  const el = document.createElement('div');
  el.className = 'card';

  // Stack bar segments
  const sortedAccounts = [...d.debt.accounts].sort((a,b) => b.rate - a.rate);
  const segments = sortedAccounts.map((acc, i) => {
    const pct = (acc.balance / d.debt.total * 100).toFixed(2);
    return `<div class="debt-stack-seg" style="width:${pct}%;background:${DEBT_COLORS[i % DEBT_COLORS.length]}"></div>`;
  }).join('');

  // Account rows
  const rows = sortedAccounts.map((acc, i) => {
    const rateText = acc.rate > 0 ? `${acc.rate}%` : '0%';
    return `
      <div class="debt-account-row">
        <div class="debt-account-dot" style="background:${DEBT_COLORS[i % DEBT_COLORS.length]}"></div>
        <div class="debt-account-name">${acc.name}</div>
        <div class="debt-account-balance">${acc.balance}‰∏á</div>
        <div class="debt-account-rate">${rateText}</div>
      </div>
    `;
  }).join('');

  el.innerHTML = `
    <div class="card-title">DEBT</div>
    <div class="debt-header">
      <div>
        <div class="debt-total">${d.debt.total}<span>‰∏á</span></div>
        <div class="debt-sub">È´òÈáëÂà©Ë≤†ÂÇµÁ∑èÈ°ç</div>
      </div>
      <div class="debt-meta">
        <div class="monthly">${d.debt.monthlyPayment}‰∏á/Êúà</div>
        <div class="interest">Âà©ÊÅØ ${d.debt.monthlyInterest}‰∏á/Êúà</div>
      </div>
    </div>
    <div class="debt-stack-wrap">
      <div class="debt-stack-bar">${segments}</div>
    </div>
    <div class="debt-accounts">${rows}</div>
    <div class="debt-milestone">üéØ Ê¨°„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥: ${d.debt.nextMilestone}</div>
  `;
  return el;
}

// ‚îÄ‚îÄ G: Target ‚îÄ‚îÄ
function renderTarget(d) {
  const el = document.createElement('div');
  el.className = 'target-card';
  el.innerHTML = `
    <div class="main-target">Âπ¥Âèé ${d.targetAnnual}‰∏á = Êúà ${d.targetMonthly}‰∏á</div>
    <div class="sub-target">È´òÈáëÂà© ${d.debt.total}‰∏á„ÇíËá™Âäõ„ÅßËøî„Åô</div>
  `;
  return el;
}

// ‚îÄ‚îÄ Roadmap ‚îÄ‚îÄ
function renderRoadmap(d) {
  const el = document.createElement('div');
  el.className = 'card';

  // Fallback: build single milestone from targetMonthly if no roadmap data
  const milestones = (d.roadmap && d.roadmap.milestones) ? d.roadmap.milestones : [
    { id: 'ms1', label: 'ÁõÆÊ®ô', monthlyTarget: d.targetMonthly || 125, status: 'current', note: '' }
  ];

  const currentMs = milestones.find(m => m.status === 'current') || milestones[0];

  // Confirmed income for progress (received + confirmed)
  const confirmedIncome = d.income
    .filter(i => i.received || i.status === 'received' || i.status === 'confirmed')
    .reduce((s, i) => s + i.amount, 0);
  const progressPct = Math.min(100, Math.round(confirmedIncome / currentMs.monthlyTarget * 100));

  // Build timeline nodes
  function nodeHTML(ms, isLast) {
    const dotClass = ms.status === 'current' ? 'active' : ms.status === 'future' ? 'future' : '';
    const nowTag = ms.status === 'current' ? `<div class="roadmap-node-now">‚ñº NOW</div>` : '';
    return `<div class="roadmap-node">
      <div class="roadmap-dot ${dotClass}"></div>
      <div class="roadmap-node-amount">${ms.monthlyTarget}‰∏á</div>
      <div class="roadmap-node-label">${ms.label}</div>
      ${nowTag}
    </div>`;
  }

  let timelineHTML = '';
  milestones.forEach((ms, idx) => {
    timelineHTML += nodeHTML(ms);
    if (idx < milestones.length - 1) {
      const lineType = milestones[idx + 1].status === 'future' ? 'dashed' : 'solid';
      timelineHTML += `<div class="roadmap-line ${lineType}"></div>`;
    }
  });

  // Next milestone label
  const nextMs = milestones.find(m => m.status === 'next');
  const nextLabel = nextMs ? `Ê¨°„ÅÆÂ£Å: ÊúàÂèé${nextMs.monthlyTarget}‰∏áÔºà${nextMs.label}Ôºâ` : '';

  el.innerHTML = `
    <div class="card-title">üìç ÂèéÂÖ•„É≠„Éº„Éâ„Éû„ÉÉ„Éó</div>
    <div class="roadmap-timeline">${timelineHTML}</div>
    <div class="roadmap-progress-section">
      <div class="roadmap-progress-label">
        <span>‰ªäÊúà„ÅÆÈÄ≤Êçó</span>
        <span>${confirmedIncome}‰∏á / ${currentMs.monthlyTarget}‰∏á</span>
      </div>
      <div class="roadmap-progress-bar">
        <div class="roadmap-progress-fill" style="width:${progressPct}%"></div>
      </div>
      <div class="roadmap-progress-pct">${progressPct}%${nextLabel ? ' ‚Äî ' + nextLabel : ''}</div>
    </div>
    ${currentMs.note ? `<div class="roadmap-note">üí° ${currentMs.note}</div>` : ''}
  `;
  return el;
}

// ‚îÄ‚îÄ Biz Model Mix ‚îÄ‚îÄ
function renderBizModelMix(d) {
  const el = document.createElement('div');
  el.className = 'card';

  const phases = (d.roadmap && d.roadmap.bizModel && d.roadmap.bizModel.phases)
    ? d.roadmap.bizModel.phases
    : [{ id: 'ph1', label: 'ÂΩìÈù¢', subscription: 30, selfWork: 70, status: 'current' }];

  // Aggregate actual income by type
  const subTotal = d.income
    .filter(i => (i.type || 'project') === 'subscription')
    .reduce((s, i) => s + i.amount, 0);
  const nonSubTotal = d.income
    .filter(i => (i.type || 'project') !== 'subscription')
    .reduce((s, i) => s + i.amount, 0);
  const grandTotal = subTotal + nonSubTotal;

  const subPct = grandTotal > 0 ? Math.round(subTotal / grandTotal * 100) : 0;
  const selfPct = 100 - subPct;

  // Actual stack bar
  const subWidth = grandTotal > 0 ? subPct : 0;
  const selfWidth = grandTotal > 0 ? selfPct : 100;

  // Target phase (current)
  const currentPhase = phases.find(p => p.status === 'current') || phases[0];
  const targetSubPct = currentPhase.subscription;
  const neededSubRevenue = grandTotal > 0
    ? Math.round(grandTotal * targetSubPct / 100 - subTotal)
    : Math.round((d.targetMonthly || 125) * targetSubPct / 100 - subTotal);
  const gap = Math.max(0, neededSubRevenue);

  const stackBar = grandTotal > 0
    ? `<div class="biz-mix-stack">
        <div class="biz-mix-segment sub" style="width:${subWidth}%">${subPct >= 15 ? subPct + '%' : ''}</div>
        <div class="biz-mix-segment self" style="width:${selfWidth}%">${selfPct >= 15 ? selfPct + '%' : ''}</div>
      </div>
      <div class="biz-mix-stack-legend">
        <div class="biz-mix-legend-item"><div class="biz-mix-legend-dot" style="background:var(--green-mid)"></div>„Çµ„Éñ„Çπ„ÇØ ${subTotal}‰∏á</div>
        <div class="biz-mix-legend-item"><div class="biz-mix-legend-dot" style="background:var(--amber)"></div>Ëá™Âäõ ${nonSubTotal}‰∏á</div>
      </div>`
    : `<div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Ôºà‰ªäÊúà„ÅÆÂèéÂÖ•„Éá„Éº„Çø„Å™„ÅóÔºâ</div>`;

  // Phase bars
  const phaseBars = phases.map(p => {
    const nowTag = p.status === 'current' ? `<span class="biz-mix-phase-now">‚óÄNOW</span>` : '';
    return `<div class="biz-mix-phase-row">
      <div class="biz-mix-phase-label">${p.label}</div>
      <div class="biz-mix-phase-bar-wrap">
        <div class="biz-mix-phase-bar-fill" style="width:${p.subscription}%"></div>
      </div>
      <div class="biz-mix-phase-ratio">${p.subscription}:${p.selfWork}${nowTag}</div>
    </div>`;
  }).join('');

  // Gap insight
  const insightHTML = `<div class="biz-mix-insight">
    üí° „Çµ„Éñ„Çπ„ÇØÊØîÁéá ${subPct}% ‚Üí ÁõÆÊ®ô ${targetSubPct}%<br>
    ${gap > 0 ? `ÊúàÈ°ç +${gap}‰∏á „ÅÆ„Çµ„Éñ„Çπ„ÇØÂèéÂÖ•„ÅåÂøÖË¶Å` : '„Çµ„Éñ„Çπ„ÇØÁõÆÊ®ôÊØîÁéá„ÇíÈÅîÊàê‰∏≠ÔºÅ'}
  </div>`;

  el.innerHTML = `
    <div class="card-title">üîÑ „Éì„Ç∏„Éç„Çπ„É¢„Éá„É´„Éü„ÉÉ„ÇØ„Çπ</div>
    <div class="biz-mix-actual-label">‰ªäÊúà„ÅÆÂÆüÁ∏æÔºà„Çµ„Éñ„Çπ„ÇØ:Ëá™ÂäõÔºâ</div>
    ${stackBar}
    <div class="biz-mix-phase-title">ÁõÆÊ®ôÊØîÁéáÔºà„Çµ„Éñ„Çπ„ÇØ:Ëá™ÂäõÔºâ</div>
    ${phaseBars}
    ${insightHTML}
  `;
  return el;
}

// ‚îÄ‚îÄ Business Tab ‚îÄ‚îÄ
function renderBusinessTab(d) {
  const main = document.getElementById('mainContent');

  // Determine display month from outlook or current date
  const displayMonth = (d.outlook && d.outlook.length > 0)
    ? parseInt(d.outlook[0].month.split('-')[1]) + 'Êúà'
    : (() => { const n = new Date(); return (n.getMonth()+1) + 'Êúà'; })();

  // Group income items by status
  const receivedItems = d.income.filter(i => i.received || i.status === 'received');
  const confirmedItems = d.income.filter(i => !i.received && i.status === 'confirmed');
  const likelyItems   = d.income.filter(i => !i.received && i.status === 'likely');
  const estimatingItems = d.income.filter(i => !i.received && i.status === 'estimating');
  const pipelineItems = d.income.filter(i => !i.received && i.status === 'pipeline');

  const receivedTotal   = receivedItems.reduce((s,i) => s + i.amount, 0);
  const confirmedTotal  = confirmedItems.reduce((s,i) => s + i.amount, 0);
  const likelyTotal     = likelyItems.reduce((s,i) => s + i.amount, 0);
  const estimatingTotal = estimatingItems.reduce((s,i) => s + i.amount, 0);
  const pipelineTotal   = pipelineItems.reduce((s,i) => s + i.amount, 0);

  const confirmedFixed = receivedTotal + confirmedTotal;
  const withLikely = confirmedFixed + likelyTotal;
  const target = d.targetMonthly;
  const confirmedPct = Math.min(100, Math.round(confirmedFixed / target * 100));
  const likelyPct    = Math.min(100, Math.round(withLikely / target * 100));

  // A: Sales Hero card
  const heroEl = document.createElement('div');
  heroEl.className = 'hero-card';
  heroEl.innerHTML = `
    <div class="hero-label">${displayMonth} Â£≤‰∏ä</div>
    <div style="margin-top:14px;">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px;">
        <span style="font-size:13px;opacity:0.8;">Á¢∫ÂÆö</span>
        <span style="font-size:20px;font-weight:800;">${confirmedFixed}‰∏á
          <span style="font-size:13px;font-weight:400;opacity:0.7;">/ ÁõÆÊ®ô ${target}‰∏á</span>
        </span>
      </div>
      <div class="biz-progress">
        <div class="biz-progress-fill" style="width:${confirmedPct}%;background:${confirmedPct>=100?'#86EFAC':'#52B788'};"></div>
      </div>
      <div style="font-size:11px;opacity:0.6;margin-bottom:16px;">${confirmedPct}%</div>

      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px;">
        <span style="font-size:13px;opacity:0.8;">Ë¶ãËæº„ÅøÂê´„ÇÄ</span>
        <span style="font-size:20px;font-weight:800;">${withLikely}‰∏á
          <span style="font-size:13px;font-weight:400;opacity:0.7;">/ ÁõÆÊ®ô ${target}‰∏á</span>
        </span>
      </div>
      <div class="biz-progress">
        <div class="biz-progress-fill" style="width:${likelyPct}%;background:${likelyPct>=100?'#86EFAC':'#FCD34D'};"></div>
      </div>
      <div style="font-size:11px;opacity:0.6;">${likelyPct}%</div>
    </div>
  `;
  main.appendChild(heroEl);

  // B: Pipeline card
  function pipelineGroup(emoji, label, items, total) {
    if (items.length === 0 && label !== 'ÂÖ•ÈáëÊ∏à„Åø') return '';
    const rows = items.length === 0
      ? `<div style="color:var(--text-muted);font-size:13px;padding:4px 0;">ÔºàË©≤ÂΩì„Å™„ÅóÔºâ</div>`
      : items.map(i => `
          <div class="biz-pipeline-item">
            <span class="biz-pipeline-name">${i.name}</span>
            <div style="text-align:right;">
              <div class="biz-pipeline-amount">${i.amount}‰∏á</div>
              <div class="biz-pipeline-timing">${i.timing}</div>
            </div>
          </div>`).join('');
    const subtotal = items.length > 1
      ? `<div style="text-align:right;font-size:12px;color:var(--text-muted);margin-top:2px;">Â∞èË®à ${total}‰∏á</div>` : '';
    return `
      <div class="biz-pipeline-status">${emoji} ${label}${items.length===1?' ‚Äî '+total+'‰∏á':''}</div>
      ${rows}${subtotal}`;
  }

  const allTotal = receivedTotal + confirmedTotal + likelyTotal + estimatingTotal + pipelineTotal;
  const pipelineEl = document.createElement('div');
  pipelineEl.className = 'card';
  pipelineEl.innerHTML = `
    <div class="card-title">Ê°à‰ª∂„Éë„Ç§„Éó„É©„Ç§„É≥</div>
    ${pipelineGroup('‚úÖ', 'ÂÖ•ÈáëÊ∏à„Åø', receivedItems, receivedTotal)}
    ${pipelineGroup('üü¢', 'Á¢∫ÂÆö', confirmedItems, confirmedTotal)}
    ${pipelineGroup('üü°', 'Ë¶ãËæº„Åø', likelyItems, likelyTotal)}
    ${pipelineGroup('üü†', 'Ë¶ãÁ©ç‰∏≠', estimatingItems, estimatingTotal)}
    ${pipelineGroup('üîµ', '„Éë„Ç§„Éó„É©„Ç§„É≥', pipelineItems, pipelineTotal)}
    <div class="biz-pipeline-divider"></div>
    <div class="biz-pipeline-total-row">
      <span style="font-weight:700;">ÂêàË®à ${allTotal}‰∏á</span>
      <span style="color:var(--text-muted);font-size:12px;">Á¢∫ÂÆö${confirmedFixed} + Ë¶ãËæº‰ªñ${allTotal - confirmedFixed}</span>
    </div>
  `;
  main.appendChild(pipelineEl);

  // C: Roadmap (NEW)
  main.appendChild(renderRoadmap(d));

  // D: Biz Model Mix (NEW)
  main.appendChild(renderBizModelMix(d));

  // E: Annual target
  main.appendChild(renderTarget(d));
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
  // Hash-based tab routing
  const hash = location.hash.replace('#', '');
  if (TABS.includes(hash)) currentTab = hash;
  document.querySelectorAll('.nav-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.tab === currentTab)
  );

  try {
    financeData = await loadData();
    render(financeData);
  } catch(e) {
    // Try cache fallback
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
      try {
        financeData = JSON.parse(cached);
        render(financeData);
        return;
      } catch(e2) {}
    }
    document.getElementById('loadingWrap').innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:var(--text-muted);">
        <div style="font-size:32px;margin-bottom:8px;">‚ö†Ô∏è</div>
        <div>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü</div>
        <button onclick="reload()" style="margin-top:16px;padding:10px 24px;background:var(--green-mid);color:white;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;">ÂÜçË©¶Ë°å</button>
      </div>
    `;
  }
}

// ‚îÄ‚îÄ Pull to Refresh ‚îÄ‚îÄ
(function setupPTR() {
  let startY = 0, pulling = false, threshold = 60;
  const indicator = document.getElementById('ptrIndicator');

  document.addEventListener('touchstart', e => {
    if (window.scrollY === 0) { startY = e.touches[0].clientY; pulling = true; }
  }, { passive: true });

  document.addEventListener('touchmove', e => {
    if (!pulling) return;
    const dy = e.touches[0].clientY - startY;
    if (dy > 10) indicator.classList.add('visible');
    if (dy > threshold) indicator.textContent = '‚úì Èõ¢„Åó„Å¶Êõ¥Êñ∞';
    else indicator.textContent = '‚Üì Âºï„Å£Âºµ„Å£„Å¶Êõ¥Êñ∞';
  }, { passive: true });

  document.addEventListener('touchend', async e => {
    if (!pulling) return;
    pulling = false;
    const dy = e.changedTouches[0].clientY - startY;
    indicator.classList.remove('visible');
    indicator.textContent = '‚Üì Âºï„Å£Âºµ„Å£„Å¶Êõ¥Êñ∞';
    if (dy > threshold) await reload();
  });
})();

// ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

init();
</script>
</body>
</html>
