<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1B4332">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Health Hub">
  <title>„Åó„ÇÖ„ÅÜ„Åó„ÇÖ„ÅÜ Health Hub</title>
  <link rel="manifest" href="manifest.json">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green-dark: #1B4332;
      --green-mid: #2D6A4F;
      --green-light: #52B788;
      --green-pale: #D8F3DC;
      --bg: #F0F4F0;
      --card: #FFFFFF;
      --text: #1A1A2E;
      --text-muted: #6C757D;
      --border: #DEE2E6;
      --danger: #DC3545;
      --warning: #E5A020;
      --success: #28A745;
      --nav-height: 62px;
      --header-height: 52px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--header-height);
      background: var(--green-dark);
      color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      z-index: 100;
      padding-top: env(safe-area-inset-top, 0px);
    }
    .header h1 { font-size: 16px; font-weight: 700; }
    .header-date { font-size: 13px; opacity: 0.75; }
    .header-reload {
      background: none; border: none; color: white; opacity: 0.75;
      font-size: 20px; padding: 6px 8px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .header-reload:active { opacity: 0.4; }
    .main {
      padding-top: var(--header-height);
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 8px);
      min-height: 100vh;
    }
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: calc(var(--nav-height) + var(--safe-bottom));
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 100;
      padding-bottom: var(--safe-bottom);
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 3px;
      border: none; background: none;
      color: var(--text-muted); font-size: 10px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      padding: 6px 0;
      transition: color 0.15s;
    }
    .nav-btn.active { color: var(--green-mid); }
    .nav-btn svg { width: 22px; height: 22px; }
    .card {
      background: var(--card); border-radius: 14px;
      padding: 14px 16px; margin: 8px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 11px; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.6px; margin-bottom: 12px;
    }
    .kcal-display {
      display: flex; align-items: baseline; gap: 4px;
      justify-content: center; padding: 4px 0 8px;
    }
    .kcal-num {
      font-size: 48px; font-weight: 700;
      color: var(--green-dark); line-height: 1;
      transition: color 0.2s;
    }
    .kcal-num.over { color: var(--danger); }
    .kcal-unit { font-size: 16px; color: var(--text-muted); }
    .kcal-target { font-size: 13px; color: var(--text-muted); }
    .remaining {
      text-align: center; font-size: 13px;
      color: var(--text-muted); margin-bottom: 14px;
    }
    .macros-row { display: flex; gap: 8px; }
    .macro-card {
      flex: 1; background: var(--bg);
      border-radius: 10px; padding: 10px 6px; text-align: center;
    }
    .macro-name { font-size: 10px; color: var(--text-muted); margin-bottom: 2px; }
    .macro-value { font-size: 18px; font-weight: 700; line-height: 1.1; }
    .macro-value .unit { font-size: 11px; font-weight: 400; }
    .macro-target { font-size: 10px; color: var(--text-muted); margin-top: 1px; }
    .macro-value.over { color: var(--danger); }
    .macro-value.warn { color: var(--warning); }
    .macro-value.ok { color: var(--green-mid); }
    .date-nav {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px; background: white;
      border-bottom: 1px solid var(--border);
    }
    .date-nav-btn {
      width: 38px; height: 38px; border: none; background: none;
      font-size: 22px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; color: var(--green-mid);
      -webkit-tap-highlight-color: transparent;
    }
    .date-nav-btn:active { background: var(--bg); }
    .date-nav-btn.disabled { opacity: 0.25; pointer-events: none; }
    .date-nav-label { font-size: 15px; font-weight: 600; }
    .today-badge {
      display: inline-block; margin-left: 6px;
      background: var(--green-pale); color: var(--green-mid);
      font-size: 10px; font-weight: 700; padding: 1px 6px;
      border-radius: 8px; vertical-align: middle;
    }
    .meal-list { display: flex; flex-direction: column; gap: 1px; }
    .meal-item {
      display: flex; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border); gap: 8px;
    }
    .meal-item:last-child { border-bottom: none; }
    .meal-time { font-size: 11px; color: var(--text-muted); width: 38px; flex-shrink: 0; }
    .meal-info { flex: 1; min-width: 0; }
    .meal-name { font-size: 14px; line-height: 1.3; }
    .meal-macros { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .meal-kcal { font-size: 13px; font-weight: 700; color: var(--green-mid); flex-shrink: 0; }
    .meal-del {
      width: 30px; height: 30px; border: none; background: none;
      color: #CCC; font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .meal-del:active { background: #f0f0f0; color: var(--danger); }
    .summary-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-top: 1.5px solid var(--border); margin-top: 4px;
    }
    .summary-label { font-size: 14px; font-weight: 700; }
    .summary-val { font-size: 15px; font-weight: 700; color: var(--green-mid); }
    .empty-state {
      text-align: center; padding: 28px 20px; color: var(--text-muted);
    }
    .empty-icon { font-size: 36px; margin-bottom: 8px; }
    .empty-text { font-size: 14px; line-height: 1.5; }
    .fab {
      position: fixed;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + 14px);
      right: 18px;
      width: 56px; height: 56px; border-radius: 50%;
      background: var(--green-mid); color: white;
      border: none;
      box-shadow: 0 4px 14px rgba(45,106,79,0.4);
      font-size: 26px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 90; -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .fab:active { transform: scale(0.92); box-shadow: 0 2px 8px rgba(45,106,79,0.3); }
    .fab.hidden { display: none; }
    .export-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px; border: 1.5px dashed var(--border);
      border-radius: 10px; background: none;
      color: var(--text-muted); font-size: 14px; cursor: pointer;
      width: calc(100% - 24px); margin: 0 12px 8px;
      -webkit-tap-highlight-color: transparent;
    }
    .export-btn:active { background: var(--bg); }
    .import-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px; border: 1.5px dashed #74C69D;
      border-radius: 10px; background: none;
      color: var(--green-mid); font-size: 14px; cursor: pointer;
      width: calc(100% - 24px); margin: 0 12px 4px;
      -webkit-tap-highlight-color: transparent;
    }
    .import-btn:active { background: var(--green-pale); }
    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 200; display: flex; align-items: flex-end; justify-content: center;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: white; border-radius: 20px 20px 0 0;
      width: 100%; max-height: 92vh; overflow-y: auto;
      padding: 20px 16px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    }
    .modal-handle {
      width: 40px; height: 4px; background: var(--border);
      border-radius: 2px; margin: -8px auto 16px; display: block;
    }
    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 16px; text-align: center; }
    .search-wrap { position: relative; margin-bottom: 10px; }
    .search-input {
      width: 100%; padding: 13px 14px;
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 16px; background: #F8F9FA; outline: none;
      -webkit-appearance: none;
    }
    .search-input:focus { border-color: var(--green-light); background: white; }
    .ac-list {
      position: absolute; top: calc(100% + 4px); left: 0; right: 0;
      background: white; border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      max-height: 220px; overflow-y: auto; z-index: 300;
    }
    .ac-list.hidden { display: none; }
    .ac-item {
      padding: 12px 14px; cursor: pointer;
      border-bottom: 1px solid var(--border); font-size: 14px;
    }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:active { background: var(--green-pale); }
    .ac-unit { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .ac-kcal { float: right; font-size: 12px; color: var(--green-mid); font-weight: 600; }
    .selected-food-box {
      background: var(--green-pale); padding: 12px 14px;
      border-radius: 10px; margin-bottom: 12px;
    }
    .sel-name { font-weight: 600; font-size: 15px; }
    .sel-unit { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .sel-stats { display: flex; gap: 12px; margin-top: 6px; font-size: 13px; }
    .sel-kcal { color: var(--green-mid); font-weight: 700; }
    .sel-pfc { color: var(--text-muted); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .form-field { display: flex; flex-direction: column; gap: 4px; }
    .form-field.full { grid-column: 1 / -1; }
    .form-label { font-size: 12px; color: var(--text-muted); font-weight: 600; }
    .form-input {
      padding: 11px 12px; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 15px; background: #F8F9FA;
      outline: none; -webkit-appearance: none;
    }
    .form-input:focus { border-color: var(--green-light); background: white; }
    .btn {
      padding: 14px 20px; border-radius: 12px; border: none;
      font-size: 16px; font-weight: 700; cursor: pointer; width: 100%;
      margin-top: 10px; -webkit-tap-highlight-color: transparent;
      transition: opacity 0.1s;
    }
    .btn:active { opacity: 0.8; }
    .btn-primary { background: var(--green-mid); color: white; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .custom-section {
      margin-top: 14px; padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .custom-section-label {
      font-size: 13px; color: var(--text-muted); margin-bottom: 10px;
    }
    .fish-toggle {
      display: flex; align-items: center; gap: 10px;
      margin-top: 12px; font-size: 14px; cursor: pointer;
    }
    .fish-toggle input { width: 20px; height: 20px; cursor: pointer; }
    .fish-note {
      font-size: 11px; color: var(--text-muted);
      background: var(--green-pale); padding: 7px 10px;
      border-radius: 8px; margin-top: 8px; line-height: 1.5;
    }
    /* Supplements */
    .suppl-timing {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      padding: 10px 0 6px; letter-spacing: 0.3px;
    }
    .suppl-item {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 0; border-bottom: 1px solid var(--border);
    }
    .suppl-item:last-child { border-bottom: none; }
    .suppl-check {
      width: 26px; height: 26px; border: 2px solid var(--border);
      border-radius: 7px; flex-shrink: 0; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      -webkit-tap-highlight-color: transparent; transition: all 0.15s;
    }
    .suppl-check.checked { background: var(--green-mid); border-color: var(--green-mid); }
    .suppl-check.checked::after { content: "‚úì"; color: white; font-size: 15px; font-weight: 800; }
    .suppl-check.skipped { background: #E9ECEF; border-color: #CCC; }
    .suppl-check.skipped::after { content: "‚àí"; color: #999; font-size: 20px; font-weight: 700; line-height: 1; }
    .suppl-label { flex: 1; }
    .suppl-name { font-size: 14px; transition: color 0.15s; }
    .suppl-name.checked { text-decoration: line-through; color: var(--text-muted); }
    .suppl-name.skipped { color: var(--text-muted); }
    .suppl-note { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .suppl-skip-btn {
      font-size: 11px; color: var(--text-muted); background: #F0F0F0;
      border: 1px solid #DDD; border-radius: 10px; padding: 3px 8px;
      cursor: pointer; white-space: nowrap; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .suppl-skip-btn.active { background: #FFF3CD; border-color: #FFC107; color: #856404; }
    .compliance-bar {
      height: 10px; background: #E9ECEF;
      border-radius: 5px; overflow: hidden; margin: 8px 0 4px;
    }
    .compliance-fill {
      height: 100%; border-radius: 5px; background: var(--green-light);
      transition: width 0.3s;
    }
    .compliance-fill.full { background: var(--green-mid); }
    /* Weight */
    .weight-hero {
      text-align: center; padding: 8px 0 12px;
    }
    .weight-big {
      font-size: 56px; font-weight: 700;
      color: var(--green-dark); line-height: 1;
    }
    .weight-big .wunit { font-size: 20px; color: var(--text-muted); }
    .weight-sub { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .weight-input-row {
      display: flex; gap: 10px; align-items: center; margin-top: 12px;
    }
    .progress-main {
      height: 14px; background: #E9ECEF;
      border-radius: 7px; overflow: hidden; margin: 8px 0 4px;
    }
    .progress-fill {
      height: 100%; border-radius: 7px;
      background: linear-gradient(90deg, var(--green-light), var(--green-mid));
      transition: width 0.4s;
    }
    .milestone-list { display: flex; flex-direction: column; gap: 10px; }
    .milestone-item {
      display: flex; align-items: center; gap: 10px; font-size: 14px;
    }
    .milestone-dot {
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; flex-shrink: 0;
    }
    .milestone-dot.done { background: var(--green-pale); color: var(--green-mid); font-size: 15px; }
    .milestone-dot.next { background: #FFF3CD; color: #856404; font-weight: 700; }
    .milestone-dot.future { background: #E9ECEF; color: var(--text-muted); font-size: 10px; }
    .milestone-info { flex: 1; }
    .milestone-name { font-size: 14px; }
    .milestone-date { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .milestone-weight {
      font-size: 14px; font-weight: 700; color: var(--text-muted);
    }
    .milestone-weight.achieved { color: var(--green-mid); }
    .milestone-weight.next-weight { color: var(--warning); }
    /* Chart */
    .chart-scroll { overflow-x: auto; }
    /* Toast */
    .toast {
      position: fixed;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + 74px);
      left: 50%; transform: translateX(-50%);
      background: rgba(27,67,50,0.92); color: white;
      padding: 11px 20px; border-radius: 22px;
      font-size: 14px; z-index: 1000; white-space: nowrap;
      animation: toast-in 0.2s ease;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(8px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .spacer { height: 20px; }
    .hidden { display: none !important; }
    /* Qty input in modal */
    .qty-row {
      display: flex; align-items: center; gap: 10px; margin-top: 8px;
    }
    .qty-row label { font-size: 13px; color: var(--text-muted); white-space: nowrap; }
    .qty-input {
      flex: 1; padding: 10px 12px; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 16px; background: #F8F9FA;
      outline: none; -webkit-appearance: none; text-align: center;
    }
    .qty-input:focus { border-color: var(--green-light); }
    /* Import section */
    .import-section {
      margin: 0 12px 8px;
    }
    .import-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 11px; border: 1.5px dashed #ADB5BD;
      border-radius: 10px; background: none;
      color: var(--text-muted); font-size: 13px; cursor: pointer;
      width: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    .import-btn:active { background: var(--bg); }
    /* Nutrition bar */
    .nutr-bar { margin-bottom: 10px; }
    .nutr-bar-header { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px; }
    .nutr-bar-label { color: var(--text-muted); }
    .nutr-bar-val { font-weight: 600; }
    .nutr-bar-track { height: 6px; background: #E9ECEF; border-radius: 3px; overflow: hidden; }
    .nutr-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
    .nutr-bar-fill.ok { background: var(--green-light); }
    .nutr-bar-fill.warn { background: var(--warning); }
    .nutr-bar-fill.over { background: var(--danger); }
  </style>
</head>
<body>
<div id="app">
  <header class="header">
    <h1>üåø Health Hub</h1>
    <div style="display:flex;align-items:center;gap:4px;">
      <span class="header-date" id="header-date"></span>
      <button class="header-reload" onclick="location.reload()" title="„É™„É≠„Éº„Éâ">‚Üª</button>
    </div>
  </header>

  <main class="main" id="main-content"></main>

  <button class="fab hidden" id="fab-add" onclick="openModal()">Ôºã</button>

  <nav class="bottom-nav">
    <button class="nav-btn active" data-tab="meals" onclick="switchTab('meals')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3"/>
      </svg>
      È£ü‰∫ã
    </button>
    <button class="nav-btn" data-tab="supplements" onclick="switchTab('supplements')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
      </svg>
      „Çµ„Éó„É™
    </button>
    <button class="nav-btn" data-tab="weight" onclick="switchTab('weight')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      ‰ΩìÈáç
    </button>
  </nav>
</div>

<!-- Add Food Modal -->
<div class="modal-overlay hidden" id="modal-overlay" onclick="onOverlayClick(event)">
  <div class="modal">
    <span class="modal-handle"></span>
    <div class="modal-title">È£ü‰∫ã„ÇíË®òÈå≤</div>

    <div class="search-wrap">
      <input type="search" class="search-input" id="food-search"
             placeholder="È£üÂìÅÂêç„ÇíÊ§úÁ¥¢..."
             oninput="onFoodSearch(this.value)"
             autocomplete="off" autocorrect="off"
             spellcheck="false">
      <div class="ac-list hidden" id="ac-list"></div>
    </div>

    <div id="selected-box" class="hidden">
      <div class="selected-food-box">
        <div class="sel-name" id="sel-name"></div>
        <div class="sel-unit" id="sel-unit"></div>
        <div class="sel-stats">
          <span class="sel-kcal" id="sel-kcal"></span>
          <span class="sel-pfc" id="sel-pfc"></span>
        </div>
      </div>
      <div class="qty-row">
        <label>ÂÄãÊï∞„ÉªÈáè</label>
        <input type="number" class="qty-input" id="food-qty" value="1" min="0.1" max="99" step="0.5">
      </div>
    </div>

    <div id="custom-form" class="hidden">
      <div class="custom-section">
        <div class="custom-section-label">„Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Å™„ÅÑÈ£üÂìÅ„ÇíÊâãÂãï„ÅßÂÖ•Âäõ</div>
        <div class="form-grid">
          <div class="form-field full">
            <label class="form-label">È£üÂìÅÂêç</label>
            <input type="text" class="form-input" id="c-name" placeholder="‰æã: „ÇÜ„ÅßÂçµ">
          </div>
          <div class="form-field">
            <label class="form-label">„Ç´„É≠„É™„Éº (kcal)</label>
            <input type="number" class="form-input" id="c-kcal" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">„Åü„Çì„Å±„ÅèË≥™ P (g)</label>
            <input type="number" class="form-input" id="c-p" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">ËÑÇË≥™ F (g)</label>
            <input type="number" class="form-input" id="c-f" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">ÁÇ≠Ê∞¥ÂåñÁâ© C (g)</label>
            <input type="number" class="form-input" id="c-c" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">„Éû„Ç∞„Éç„Ç∑„Ç¶„É† Mg (mg)</label>
            <input type="number" class="form-input" id="c-mg" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">È£üÁâ©ÁπäÁ∂≠ (g)</label>
            <input type="number" class="form-input" id="c-fiber" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">Âçò‰Ωç</label>
            <input type="text" class="form-input" id="c-unit" placeholder="‰æã: 1ÂÄã">
          </div>
        </div>
        <label class="fish-toggle">
          <input type="checkbox" id="is-fish">
          üêü È≠ö„ÅÆËÑÇË≥™„Éú„Éº„Éä„ÇπÈÅ©Áî®Ôºà„Ç´„É≠„É™„Éº√ó0.7Ôºâ
        </label>
        <div class="fish-note">ÈùíÈ≠ö„ÉªÈÆ≠„Å™„Å©È≠ö„ÅÆËÑÇË≥™„Ç´„É≠„É™„Éº„ÅØ√ó0.7„ÅßË®àÁÆóÔºà„Ç™„É°„Ç¨3„ÅØ‰ΩìËÑÇËÇ™„Å´„Å™„Çä„Å´„Åè„ÅÑÔºâ</div>
      </div>
    </div>

    <button class="btn btn-primary" id="btn-record" onclick="addFoodRecord()">Ë®òÈå≤„Åô„Çã</button>
    <button class="btn btn-secondary" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
  </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="file-picker" accept=".md,text/plain,text/markdown"
       style="display:none" onchange="onFilePicked(event)">

<script>
// ======== FOOD DATABASE ========
const BUILT_IN_FOODS = [
  // ‰∏ªÈ£ü
  { id:1, name:"„Éë„Çπ„Ç≥ È∫¶„ÅÆ„ÇÅ„Åê„Åø ÂÖ®Á≤íÁ≤â„Ç§„É≥„Ç∞„É™„ÉÉ„Ç∑„É•„Éû„Éï„Ç£„É≥", unit:"1ÂÄã", kcal:152, p:5.7, f:1.3, c:30.5, mg:20, fiber:2.3, cat:"‰∏ªÈ£ü" },
  // Ëá™ÁÇä
  { id:2, name:"ÁÑ°Ê∞¥„Ç´„É¨„ÉºÔºàÂ∞èÁöø1ÊùØ 1/6Ôºâ", unit:"1ÊùØ", kcal:165, p:21, f:6, c:9, mg:40, fiber:3.0, cat:"Ëá™ÁÇä" },
  { id:3, name:"Áâõ„Åô„ÅòÁÑ°Ê∞¥„Ç´„É¨„ÉºÔºà1ÊùØ ËÇâ170g+„ÇΩ„Éº„ÇπÔºâ", unit:"1ÊùØ", kcal:385, p:53.5, f:6.1, c:31.6, mg:50, fiber:2.5, cat:"Ëá™ÁÇä" },
  { id:4, name:"Áâõ„Åô„ÅòÁÑ°Ê∞¥„Ç´„É¨„ÉºÔºàÈÅ©Èáè ËÇâ120g+ÁôΩÁ±≥150gÔºâ", unit:"1È£ü", kcal:525, p:42, f:5, c:78, mg:45, fiber:2.0, cat:"Ëá™ÁÇä" },
  { id:5, name:"Áâõ„Åô„ÅòÁÑ°Ê∞¥„Ç´„É¨„ÉºÔºàËÇâ119g+„ÇΩ„Éº„Çπ226g+ÁôΩÁ±≥114gÔºâ", unit:"1È£ü", kcal:502, p:46, f:5.2, c:67.8, mg:50, fiber:2.5, cat:"Ëá™ÁÇä" },
  { id:6, name:"Âë≥ÂôåÊ±ÅÔºàË±ÜËÖê„ÉªÁéâ„Å≠„Åé„Éª„Åò„ÇÉ„Åå„ÅÑ„ÇÇÔºâ", unit:"„ÅäÊ§Ä1ÊùØ", kcal:196, p:13, f:8.3, c:16.3, mg:50, fiber:2.0, cat:"Ëá™ÁÇä" },
  { id:7, name:"„Éñ„É´„Éº„Éô„É™„Éº„É®„Éº„Ç∞„É´„ÉàÔºà„Ç™„Éº„Éê„Éº„Éä„Ç§„Éà„Ç™„Éº„ÉÑÔºâ", unit:"ÂÖ®Èáè", kcal:510, p:28, f:17, c:73.7, mg:60, fiber:5.0, cat:"Ëá™ÁÇä" },
  { id:8, name:"È∂è„ÇÄ„Å≠„Ç≠„É£„Éô„ÉÑÈçã 1/3Èáè", unit:"1È£ü", kcal:246, p:33, f:6, c:17, mg:30, fiber:3.0, cat:"Ëá™ÁÇä" },
  // „Ç≥„É≥„Éì„Éã
  { id:10, name:"„Çª„Éñ„É≥ „Çè„Åã„ÇÅ„Åù„Å∞", unit:"1È£ü", kcal:278, p:16, f:1.5, c:54.2, mg:20, fiber:2.0, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:11, name:"„É≠„Éº„ÇΩ„É≥ „Ç≠„É£„É≥„Éá„Ç£„Éº„ÉÅ„Éº„Ç∫ „Éñ„É©„ÉÉ„ÇØ„Éö„ÉÉ„Éë„Éº", unit:"5Á≤í", kcal:87, p:5, f:7.2, c:0.5, mg:5, fiber:0, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:12, name:"„É≠„Éº„ÇΩ„É≥ „Çµ„É©„ÉÄ„ÉÅ„Ç≠„É≥„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ „Ç™„É™„Éº„Éñ&„ÉÅ„Éº„Ç∫", unit:"1Êú¨(60g)", kcal:98, p:11.1, f:4.4, c:3.5, mg:8, fiber:0, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:13, name:"„É≠„Éº„ÇΩ„É≥ ÁÇ≠ÁÅ´ÁÑº„Å™„Çì„Åì„Å§„Å§„Åè„Å≠ Èùí„Åò„Åù", unit:"1Ë¢ã(80g)", kcal:128, p:13.9, f:6.2, c:4.5, mg:8, fiber:0.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:14, name:"„É≠„Éº„ÇΩ„É≥ ÁÇô„ÇäÁÜüÊàêÁ¥ÖÈÆ≠„Åä„Å´„Åé„Çä", unit:"1ÂÄã", kcal:174, p:4.6, f:1.7, c:35.7, mg:8, fiber:0.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:15, name:"„Çª„Éñ„É≥ ÊâãÂ∑ª„Åä„Å´„Åé„Çä È∂è„Åù„Åº„Çç", unit:"1ÂÄã", kcal:192, p:6.2, f:1.9, c:38.4, mg:8, fiber:0.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:16, name:"„Çª„Éñ„É≥ Á†ÇËÇù„ÅÆÁÇ≠ÁÅ´ÁÑº", unit:"1Ë¢ã(70g)", kcal:101, p:20.4, f:1.7, c:0.9, mg:10, fiber:0, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:17, name:"„Çª„Éñ„É≥ „Çπ„É≥„Éâ„Ç•„Éñ„ÉÅ„Ç≤", unit:"1È£ü", kcal:190, p:18.6, f:9.7, c:8.6, mg:20, fiber:1.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:18, name:"„Çª„Éñ„É≥ Â§ßÂÖ•„ÇäË±ö„Åæ„Çì", unit:"1ÂÄã", kcal:340, p:11.5, f:12.4, c:46.5, mg:15, fiber:1.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:19, name:"Â∞èÊûù„Éë„Ç§Ôºà„Çª„Éñ„É≥Ôºâ", unit:"1Êú¨(58g)", kcal:296, p:3, f:21.9, c:22.3, mg:15, fiber:1.0, cat:"„Ç≥„É≥„Éì„Éã" },
  // „Åä„ÇÑ„Å§
  { id:20, name:"ÂçóÈÉ®„Åõ„Çì„Åπ„ÅÑ ËêΩËä±Áîü", unit:"1Êûö", kcal:81, p:2.6, f:2.3, c:12.4, mg:15, fiber:0.5, cat:"„Åä„ÇÑ„Å§" },
  { id:21, name:"„ÅÜ„Åæ„ÅÑ„Åõ„Çì„Åπ„ÅÑ", unit:"1Êûö", kcal:80, p:1.8, f:0.2, c:17.8, mg:5, fiber:0.2, cat:"„Åä„ÇÑ„Å§" },
  { id:22, name:"„É≠„ÉÉ„ÉÜ „É™„ÉÉ„ÉÅ„Ç¢„Éº„É¢„É≥„Éâ„ÉÅ„Éß„Ç≥ „Éù„ÉÉ„Éó„Ç∏„Éß„Ç§", unit:"1Ë¢ã", kcal:203, p:3.8, f:13.5, c:16.5, mg:20, fiber:1.5, cat:"„Åä„ÇÑ„Å§" },
  { id:23, name:"„É≠„ÉÉ„ÉÜ „ÇØ„É©„É≥„Ç≠„Éº„Éù„ÉÉ„Éó„Ç∏„Éß„Ç§", unit:"1Ë¢ã(44g)", kcal:248, p:3, f:15.3, c:24.6, mg:15, fiber:1.0, cat:"„Åä„ÇÑ„Å§" },
  { id:24, name:"„Çπ„Éã„ÉÉ„Ç´„Éº„Ç∫", unit:"1Êú¨(51g)", kcal:248, p:4.4, f:12.2, c:29.5, mg:15, fiber:1.0, cat:"„Åä„ÇÑ„Å§" },
  // „Éï„É´„Éº„ÉÑ
  { id:30, name:"„Çπ„Ç¶„Ç£„Éº„ÉÜ„Ç£„Ç™ „Éë„Ç§„Éä„ÉÉ„Éó„É´Ôºà„ÅÑ„Å§„ÇÇ„ÅÆÈáèÔºâ", unit:"140g", kcal:75, p:1, f:0, c:19, mg:15, fiber:2.0, cat:"„Éï„É´„Éº„ÉÑ" },
  // Ë™øÂë≥Êñô
  { id:40, name:"„Éê„Çø„ÉºÔºàËñÑÂ°ó„ÇäÔºâ", unit:"Á¥Ñ5g", kcal:37, p:0, f:4.1, c:0, mg:0, fiber:0, cat:"Ë™øÂë≥Êñô" },
];

// ======== SUPPLEMENTS ========
const SUPPLEMENTS = [
  { id:"m1", timing:"morning",   name:"„É¶„É™„Çπ",               note:"Âá¶ÊñπËñ¨ÔºàÂ∞øÈÖ∏ÂÄ§Ôºâ",         catchup:true },
  { id:"m2", timing:"morning",   name:"„Éû„É´„ÉÅ„Éì„Çø„Éü„É≥",         note:"",                        catchup:true },
  { id:"m3", timing:"morning",   name:"CoQ10",                note:"",                        catchup:true },
  { id:"m4", timing:"morning",   name:"„Ç®„Éì„Ç™„Çπ 10Èå†",          note:"",                        catchup:false },
  { id:"m5", timing:"morning",   name:"Align or „Éì„Ç™„Çπ„É™„Éº",    note:"„Å©„Å°„Çâ„Åã1„Å§",              catchup:false },
  { id:"m6", timing:"morning",   name:"The Daily Power",      note:"È£≤„Åø„Åç„Çã„Åæ„Åß",              catchup:true },
  { id:"a1", timing:"afternoon", name:"„Çµ„Ç§„É™„Ç¶„É† 1ÂõûÁõÆÔºà5Á≤íÔºâ", note:"12:30„Åî„Çç ‚Äî „É¶„É™„Çπ„Åã„Çâ2hÂæå", catchup:false },
  { id:"a2", timing:"afternoon", name:"„Çµ„Ç§„É™„Ç¶„É† 2ÂõûÁõÆÔºà5Á≤íÔºâ", note:"15:00„Åî„Çç ‚Äî Â§ïÈ£ü„ÅÆËñ¨„Åæ„Åß3h", catchup:false },
  { id:"a3", timing:"afternoon", name:"„Çµ„Ç§„É™„Ç¶„É† 3ÂõûÁõÆÔºà5Á≤íÔºâ", note:"20:00„Åî„Çç ‚Äî „É≠„Çπ„Éê„Çπ„Çø„ÉÅ„É≥„Åã„Çâ2hÂæå", catchup:false },
  { id:"e1", timing:"evening",   name:"„É≠„Çπ„Éê„Çπ„Çø„ÉÅ„É≥",          note:"Âá¶ÊñπËñ¨Ôºà„Ç≥„É¨„Çπ„ÉÜ„É≠„Éº„É´ÔºâÂ§ïÈ£üÂæå", catchup:true },
  { id:"e2", timing:"evening",   name:"‰∫úÈâõ (THORNE)",         note:"",                        catchup:true },
  { id:"e3", timing:"evening",   name:"„Ç®„Éì„Ç™„Çπ 10Èå†",           note:"",                        catchup:false },
  { id:"e4", timing:"evening",   name:"„Éì„Ç™„Çπ„É™„Éº 2Èå†",          note:"",                        catchup:false },
  { id:"b1", timing:"bedtime",   name:"„Éû„Ç∞„Éç„Ç∑„Ç¶„É†",            note:"1„Ç´„Éó„Çª„É´‚âí87.5mg„ÄÅÊúÄÂ§ß4„Ç´„Éó„Çª„É´", catchup:false },
];
const TIMING_LABELS = {
  morning:   "‚òÄÔ∏è ÊúùÔºà1È£üÁõÆÂæå„Éª10ÊôÇ„Åî„ÇçÔºâ",
  afternoon: "üïê È£üÈñìÔºàÊòº„ÄúÂçàÂæåÔºâ",
  evening:   "üåô Â§úÔºà2È£üÁõÆÂæå„Éª18ÊôÇ„Åî„ÇçÔºâ",
  bedtime:   "üõè Â∞±ÂØùÂâçÔºàÂ§ïÈ£ü2ÊôÇÈñìÂæåÔºâ",
};

// ======== TARGETS & MILESTONES ========
const TARGETS = { kcalMin:1700, kcalMax:1800, pMin:80, pMax:100, fMax:50, cMax:220, mgTarget:370, fiberTarget:21 };
const MILESTONES = [
  { label:"10Êó•Âæå„ÉÅ„Çß„ÉÉ„ÇØ",   weight:87.7, date:"2026-02-23" },
  { label:"20Êó•Âæå„ÉÅ„Çß„ÉÉ„ÇØ",   weight:87.0, date:"2026-03-05" },
  { label:"30Êó•Âæå„ÉÅ„Çß„ÉÉ„ÇØ",   weight:86.3, date:"2026-03-15" },
  { label:"60Êó•Âæå„ÉÅ„Çß„ÉÉ„ÇØ",   weight:84.25, date:"2026-04-14" },
  { label:"ËÑÇËÇ™ËÇùÊîπÂñÑÔºà7%Ê∏õÔºâ", weight:82.2, date:"2026-05-14" },
  { label:"80„ÅÆÂ£Å„ÇíÂàá„Çã",     weight:79.9, date:"2026-12-31" },
  { label:"ÊúÄÁµÇÁõÆÊ®ô 75kg",    weight:75.0, date:"2027-03-31" },
];
const START_WEIGHT = 88.0;
const GOAL_WEIGHT = 75.0;
const SUPPL_DOSING = {
  mg: { perCapsule: 87.5, maxCapsules: 4 },
  psyllium: { fiberPerCapsule: 0.55, capPerServing: 5, maxServings: 3 }
};

// ======== STATE ========
let currentTab = 'meals';
let currentDate = todayStr();
let searchResults = [];
let selectedFood = null;

function todayStr() {
  const d = new Date();
  return fmtDate(d);
}
function fmtDate(d) {
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function pad(n) { return String(n).padStart(2,'0'); }

function formatDateLabel(ds) {
  const [y,m,d] = ds.split('-').map(Number);
  const dow = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][new Date(y,m-1,d).getDay()];
  return `${m}/${d}Ôºà${dow}Ôºâ`;
}

// ======== STORAGE ========
function ls(key, val) {
  if (val === undefined) {
    try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
  }
  localStorage.setItem(key, JSON.stringify(val));
}

function getMeals(ds) { return ls(`meals_${ds}`) || []; }
function saveMeals(ds, meals) { ls(`meals_${ds}`, meals); }
function getWeights()      { return ls('weights')  || {}; }
function saveWeights(w)   { ls('weights', w); }
function getBodyFat()     { return ls('bodyFat')  || {}; }
function saveBodyFat(bf)  { ls('bodyFat', bf); }
function getSuppl(ds) { return ls(`suppl_${ds}`) || {}; }
function saveSuppl(ds, s) { ls(`suppl_${ds}`, s); }
function getCustomFoods() { return ls('custom_foods') || []; }
function saveCustomFoods(foods) { ls('custom_foods', foods); }
function getAllFoods() { return [...BUILT_IN_FOODS, ...getCustomFoods()]; }

// ======== SERVER SYNC ========
const DATA_BASE_URL = 'https://shujiuyeda.github.io/web/data/';

async function tryFetchMeals(ds) {
  const existing = getMeals(ds);
  // mg/fiber„ÅåÊú™ÂÆöÁæ©„ÅÆÂè§„ÅÑ„Éá„Éº„Çø„ÅØ„Çµ„Éº„Éê„Éº„Åã„Çâ‰∏äÊõ∏„ÅçÂèñÂæó„Åô„Çã
  const needsRefresh = existing.some(m => m.mg === undefined);
  if (existing.length > 0 && !needsRefresh) return;
  try {
    const res = await fetch(`${DATA_BASE_URL}meals-${ds}.json`, { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json();
    if (!data.meals || data.meals.length === 0) return;
    saveMeals(ds, data.meals);
    if (ds === currentDate) switchTab(currentTab); // Ë°®Á§∫„ÇíÊõ¥Êñ∞
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}

async function tryFetchSuppl(ds) {
  const existing = getSuppl(ds);
  if (Object.keys(existing).length > 0) return; // Êó¢„Å´„Éá„Éº„Çø„ÅÇ„Çä
  try {
    const res = await fetch(`${DATA_BASE_URL}suppl-${ds}.json`, { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json();
    if (!data.checks || Object.keys(data.checks).length === 0) return;
    saveSuppl(ds, data.checks);
    if (ds === currentDate && currentTab === 'supplements') switchTab(currentTab);
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}

async function tryFetchWeights() {
  try {
    const res = await fetch(`${DATA_BASE_URL}weights.json`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    let updated = false;

    // ‰ΩìÈáç„Éû„Éº„Ç∏Ôºàlocal„ÅåÂÑ™ÂÖàÔºâ
    const localW = getWeights();
    const remoteW = remote.weights || remote; // Êóß„Éï„Ç©„Éº„Éû„ÉÉ„Éà‰∫íÊèõ
    Object.entries(remoteW).forEach(([ds, w]) => {
      if (localW[ds] == null) { localW[ds] = w; updated = true; }
    });
    if (updated) saveWeights(localW);

    // ‰ΩìËÑÇËÇ™„Éû„Éº„Ç∏Ôºàlocal„ÅåÂÑ™ÂÖàÔºâ
    if (remote.bodyFat) {
      const localBF = getBodyFat();
      let bfUpdated = false;
      Object.entries(remote.bodyFat).forEach(([ds, bf]) => {
        if (localBF[ds] == null) { localBF[ds] = bf; bfUpdated = true; }
      });
      if (bfUpdated) saveBodyFat(localBF);
      updated = updated || bfUpdated;
    }

    if (updated && currentTab === 'weight') switchTab('weight');
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}

// ======== INIT ========
function init() {
  document.getElementById('header-date').textContent = formatDateLabel(currentDate);
  const hash = location.hash.replace('#', '');
  const startTab = ['meals','supplements','weight'].includes(hash) ? hash : 'meals';
  switchTab(startTab);
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/web/sw.js').catch(() => {});
  }
  // ‰ªäÊó•„ÉªÊò®Êó•„ÅÆ„Éá„Éº„Çø„Çí„Çµ„Éº„Éê„Éº„Åã„ÇâËá™Âãï„É≠„Éº„Éâ
  const yesterday = fmtDate(new Date(new Date().setDate(new Date().getDate() - 1)));
  tryFetchMeals(currentDate);
  tryFetchMeals(yesterday);
  tryFetchSuppl(currentDate);
  tryFetchSuppl(yesterday);
  tryFetchWeights();
}

// ======== TABS ========
function switchTab(tab) {
  currentTab = tab;
  location.hash = tab;
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById('fab-add').classList.toggle('hidden', tab !== 'meals');
  const main = document.getElementById('main-content');
  main.innerHTML = '';
  if (tab === 'meals') renderMeals(main);
  else if (tab === 'supplements') renderSuppl(main);
  else if (tab === 'weight') renderWeight(main);
}

function changeDate(delta) {
  const d = new Date(currentDate);
  d.setDate(d.getDate() + delta);
  const nd = fmtDate(d);
  if (nd > todayStr()) return;
  currentDate = nd;
  document.getElementById('header-date').textContent = formatDateLabel(currentDate);
  switchTab(currentTab);
  tryFetchMeals(nd);
  tryFetchSuppl(nd);
}

// ======== MEALS TAB ========
function renderMeals(container) {
  const meals = getMeals(currentDate);
  const t = totals(meals);
  const isToday = currentDate === todayStr();
  const kcalOver = t.kcal > TARGETS.kcalMax;
  const remaining = TARGETS.kcalMax - t.kcal;

  // Date nav
  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
  `;

  // Kcal summary card
  container.innerHTML += `
    <div class="card">
      <div class="kcal-display">
        <span class="kcal-num ${kcalOver ? 'over' : ''}">${Math.round(t.kcal)}</span>
        <span class="kcal-unit">kcal</span>
        <span class="kcal-target">/ ${TARGETS.kcalMin}„Äú${TARGETS.kcalMax}</span>
      </div>
      <div class="remaining">
        ${remaining >= 0
          ? `„ÅÇ„Å® <strong>${Math.round(remaining)}</strong> kcal`
          : `<span style="color:var(--danger)">Ë∂ÖÈÅé <strong>${Math.round(-remaining)}</strong> kcal</span>`
        }
      </div>
      <div class="macros-row">
        ${macroCard('„Åü„Çì„Å±„ÅèË≥™', t.p, `${TARGETS.pMin}-${TARGETS.pMax}g`, t.p > TARGETS.pMax ? 'over' : t.p >= TARGETS.pMin ? 'ok' : 'warn')}
        ${macroCard('ËÑÇË≥™', t.f, `„Äú${TARGETS.fMax}g`, t.f > TARGETS.fMax ? 'over' : 'ok')}
        ${macroCard('ÁÇ≠Ê∞¥ÂåñÁâ©', t.c, `„Äú${TARGETS.cMax}g`, t.c > TARGETS.cMax ? 'over' : 'ok')}
      </div>
    </div>
  `;

  // Supplement guide card
  container.innerHTML += supplGuideHtml(t);

  // Nutrion progress bars
  container.innerHTML += `
    <div class="card">
      <div class="card-title">Ê†ÑÈ§ä„Éê„É©„É≥„Çπ</div>
      ${nutrBar('„Ç´„É≠„É™„Éº', t.kcal, TARGETS.kcalMax, 'kcal', t.kcal > TARGETS.kcalMax ? 'over' : t.kcal > TARGETS.kcalMin ? 'ok' : 'warn')}
      ${nutrBar('„Åü„Çì„Å±„ÅèË≥™', t.p, TARGETS.pMax, 'g', t.p > TARGETS.pMax ? 'over' : t.p >= TARGETS.pMin ? 'ok' : 'warn')}
      ${nutrBar('ËÑÇË≥™', t.f, TARGETS.fMax, 'g', t.f > TARGETS.fMax ? 'over' : 'ok')}
      ${nutrBar('ÁÇ≠Ê∞¥ÂåñÁâ©', t.c, TARGETS.cMax, 'g', t.c > TARGETS.cMax ? 'over' : 'ok')}
      ${nutrBar('È£üÁâ©ÁπäÁ∂≠', t.fiber, TARGETS.fiberTarget, 'g', t.fiber >= TARGETS.fiberTarget ? 'ok' : 'warn')}
      ${nutrBar('„Éû„Ç∞„Éç„Ç∑„Ç¶„É†', t.mg, TARGETS.mgTarget, 'mg', t.mg >= TARGETS.mgTarget ? 'ok' : 'warn')}
    </div>
  `;

  // Meal list card
  let mealHtml = `<div class="card"><div class="card-title">È£ü‰∫ãË®òÈå≤</div>`;
  if (meals.length === 0) {
    mealHtml += `<div class="empty-state">
      <div class="empty-icon">üçΩÔ∏è</div>
      <div class="empty-text">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>Âè≥‰∏ã„ÅÆ Ôºã „ÅßËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>`;
  } else {
    mealHtml += `<div class="meal-list">`;
    meals.forEach((m, i) => {
      mealHtml += `
        <div class="meal-item">
          <span class="meal-time">${m.time}</span>
          <div class="meal-info">
            <div class="meal-name">${esc(m.name)}</div>
            <div class="meal-macros">P${m.p.toFixed(1)} F${m.f.toFixed(1)} C${m.c.toFixed(1)}</div>
          </div>
          <span class="meal-kcal">${Math.round(m.kcal)}</span>
          <button class="meal-del" onclick="deleteMeal(${i})">√ó</button>
        </div>`;
    });
    mealHtml += `</div>
      <div class="summary-row">
        <span class="summary-label">ÂêàË®à</span>
        <span class="summary-val">${Math.round(t.kcal)} kcal</span>
      </div>`;
  }
  mealHtml += `</div>`;
  container.innerHTML += mealHtml;

  // Import / Export buttons
  container.innerHTML += `
    <button class="import-btn" onclick="triggerFilePicker()">
      üì• ‰ªäÊó•„ÅÆË®òÈå≤„ÇíÂèñ„ÇäËæº„ÇÄÔºà01_ÂÅ•Â∫∑„É°„É¢.mdÔºâ
    </button>
    <button class="export-btn" onclick="exportMarkdown()">
      üìã ObsidianÁî®„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Çí„Ç≥„Éî„Éº
    </button>
    <div class="spacer"></div>
  `;
}

function macroCard(name, val, target, status) {
  return `
    <div class="macro-card">
      <div class="macro-name">${name}</div>
      <div class="macro-value ${status}">${val.toFixed(1)}<span class="unit">g</span></div>
      <div class="macro-target">ÁõÆÊ®ô: ${target}</div>
    </div>`;
}

function nutrBar(label, val, max, unit, status) {
  const pct = Math.min((val / max) * 100, 100);
  return `
    <div class="nutr-bar">
      <div class="nutr-bar-header">
        <span class="nutr-bar-label">${label}</span>
        <span class="nutr-bar-val">${label === '„Ç´„É≠„É™„Éº' ? Math.round(val) : val.toFixed(1)}${unit} / ${label === '„Ç´„É≠„É™„Éº' ? max : max}${unit}</span>
      </div>
      <div class="nutr-bar-track">
        <div class="nutr-bar-fill ${status}" style="width:${pct.toFixed(1)}%"></div>
      </div>
    </div>`;
}

function supplGuideHtml(t) {
  const fiberPct = Math.min(t.fiber / TARGETS.fiberTarget * 100, 100).toFixed(1);
  const mgPct    = Math.min(t.mg    / TARGETS.mgTarget    * 100, 100).toFixed(1);

  // --- È£üÁâ©ÁπäÁ∂≠ ---
  let fiberMsg;
  if (t.fiber >= TARGETS.fiberTarget) {
    fiberMsg = `<span style="color:var(--success);font-size:13px;">‚úÖ ÁõÆÊ®ôÈÅîÊàêÔºÅ„Çµ„Ç§„É™„Ç¶„É†‰∏çË¶Å</span>`;
  } else {
    const deficit = (TARGETS.fiberTarget - t.fiber).toFixed(1);
    const totalCapsNeeded = Math.ceil((TARGETS.fiberTarget - t.fiber) / SUPPL_DOSING.psyllium.fiberPerCapsule);
    const dailyMax = SUPPL_DOSING.psyllium.capPerServing * SUPPL_DOSING.psyllium.maxServings; // 15Á≤í
    if (totalCapsNeeded > dailyMax) {
      fiberMsg = `<span style="font-size:13px;color:var(--text-muted);">‰∏çË∂≥ <strong style="color:var(--text);">${deficit}g</strong> ‚Üí „ÅÇ„Å®<strong style="color:var(--accent);">${totalCapsNeeded}Á≤í</strong>ÂàÜÔºà‰ªäÊó•„ÅÆ‰∏äÈôê: ${dailyMax}Á≤íÔºâ</span>`;
    } else {
      fiberMsg = `<span style="font-size:13px;color:var(--text-muted);">‰∏çË∂≥ <strong style="color:var(--text);">${deficit}g</strong> ‚Üí „ÅÇ„Å®<strong style="color:var(--accent);">${totalCapsNeeded}Á≤í</strong></span>`;
    }
  }

  // --- „Éû„Ç∞„Éç„Ç∑„Ç¶„É† ---
  let mgMsg;
  if (t.mg >= TARGETS.mgTarget) {
    mgMsg = `<span style="color:var(--success);font-size:13px;">‚úÖ ÁõÆÊ®ôÈÅîÊàêÔºÅMg‰∏çË¶Å</span>`;
  } else {
    const deficitMg = Math.round(TARGETS.mgTarget - t.mg);
    const capsNeeded = Math.min(Math.ceil(deficitMg / SUPPL_DOSING.mg.perCapsule), SUPPL_DOSING.mg.maxCapsules);
    mgMsg = `<span style="font-size:13px;color:var(--text-muted);">‰∏çË∂≥ <strong style="color:var(--text);">${deficitMg}mg</strong> ‚Üí Â∞±ÂØùÂâç„Å´<strong style="color:var(--accent);">${capsNeeded}Á≤í</strong></span>`;
  }

  return `
    <div class="card">
      <div class="card-title">üíä „Çµ„Éó„É™Èáè„Ç¨„Ç§„Éâ</div>
      <div style="margin-bottom:14px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span style="font-size:13px;">üåæ È£üÁâ©ÁπäÁ∂≠</span>
          <span style="font-size:13px;font-weight:600;">${t.fiber.toFixed(1)}g / ${TARGETS.fiberTarget}g</span>
        </div>
        <div class="nutr-bar-track" style="margin-bottom:6px;"><div class="nutr-bar-fill ${t.fiber >= TARGETS.fiberTarget ? 'ok' : 'warn'}" style="width:${fiberPct}%"></div></div>
        ${fiberMsg}
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span style="font-size:13px;">üß≤ „Éû„Ç∞„Éç„Ç∑„Ç¶„É†</span>
          <span style="font-size:13px;font-weight:600;">${Math.round(t.mg)}mg / ${TARGETS.mgTarget}mg</span>
        </div>
        <div class="nutr-bar-track" style="margin-bottom:6px;"><div class="nutr-bar-fill ${t.mg >= TARGETS.mgTarget ? 'ok' : 'warn'}" style="width:${mgPct}%"></div></div>
        ${mgMsg}
      </div>
    </div>`;
}

function totals(meals) {
  return meals.reduce((a, m) => ({
    kcal: a.kcal + m.kcal, p: a.p + m.p, f: a.f + m.f, c: a.c + m.c,
    mg: a.mg + (m.mg || 0), fiber: a.fiber + (m.fiber || 0)
  }), {kcal:0, p:0, f:0, c:0, mg:0, fiber:0});
}

function deleteMeal(idx) {
  const meals = getMeals(currentDate);
  meals.splice(idx, 1);
  saveMeals(currentDate, meals);
  switchTab('meals');
}

function exportMarkdown() {
  const meals = getMeals(currentDate);
  if (!meals.length) { showToast('Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
  const t = totals(meals);
  const [,m,d] = currentDate.split('-').map(Number);
  let md = `### ${m}/${d}\n| ÊôÇÂàª | ÂÜÖÂÆπ | kcal | P | F | C |\n|------|------|------|---|---|---|\n`;
  meals.forEach(ml => {
    md += `| ${ml.time} | ${ml.name} | ${Math.round(ml.kcal)} | ${ml.p.toFixed(1)}g | ${ml.f.toFixed(1)}g | ${ml.c.toFixed(1)}g |\n`;
  });
  md += `| **ÂêàË®à** | | **${Math.round(t.kcal)}** | **${t.p.toFixed(1)}g** | **${t.f.toFixed(1)}g** | **${t.c.toFixed(1)}g** |\n`;
  md += `| **ÁõÆÊ®ô** | 1,700-1,800kcal | | **80-100g** | **„Äú50g** | **„Äú220g** |`;
  navigator.clipboard.writeText(md)
    .then(() => showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'))
    .catch(() => { const ta = document.createElement('textarea'); ta.value = md; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'); });
}

// ======== MODAL ========
function openModal() {
  selectedFood = null;
  searchResults = [];
  document.getElementById('modal-overlay').classList.remove('hidden');
  document.getElementById('food-search').value = '';
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('selected-box').classList.add('hidden');
  document.getElementById('custom-form').classList.add('hidden');
  setTimeout(() => document.getElementById('food-search').focus(), 150);
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
  selectedFood = null;
}

function onOverlayClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

function onFoodSearch(query) {
  const ac = document.getElementById('ac-list');
  if (!query.trim()) {
    ac.classList.add('hidden');
    document.getElementById('selected-box').classList.add('hidden');
    document.getElementById('custom-form').classList.add('hidden');
    return;
  }
  const q = query.toLowerCase();
  searchResults = getAllFoods().filter(f => f.name.toLowerCase().includes(q)).slice(0, 8);

  let html = '';
  searchResults.forEach((f, i) => {
    html += `<div class="ac-item" onclick="selectByIndex(${i})">
      <div><span>${esc(f.name)}</span><span class="ac-kcal">${f.kcal}kcal</span></div>
      <div class="ac-unit">${esc(f.unit)} / P${f.p}g F${f.f}g C${f.c}g</div>
    </div>`;
  });
  html += `<div class="ac-item" style="color:var(--text-muted);" onclick="showCustom()">üìù ÊâãÂãï„ÅßÂÖ•Âäõ...</div>`;
  ac.innerHTML = html;
  ac.classList.remove('hidden');
}

function selectByIndex(i) {
  const food = searchResults[i];
  if (!food) return;
  selectedFood = food;
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('custom-form').classList.add('hidden');
  document.getElementById('sel-name').textContent = food.name;
  document.getElementById('sel-unit').textContent = 'Âçò‰Ωç: ' + food.unit;
  document.getElementById('sel-kcal').textContent = food.kcal + 'kcal';
  document.getElementById('sel-pfc').textContent = `P${food.p}g F${food.f}g C${food.c}g`;
  document.getElementById('food-qty').value = 1;
  document.getElementById('selected-box').classList.remove('hidden');
  document.getElementById('food-search').value = food.name;
}

function showCustom() {
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('selected-box').classList.add('hidden');
  document.getElementById('custom-form').classList.remove('hidden');
  document.getElementById('c-name').value = document.getElementById('food-search').value;
  selectedFood = null;
}

function addFoodRecord() {
  const now = new Date();
  const time = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  let record;

  if (selectedFood) {
    const qty = parseFloat(document.getElementById('food-qty').value) || 1;
    record = {
      time,
      name: selectedFood.name + (qty !== 1 ? ` √ó${qty}` : ''),
      kcal: selectedFood.kcal * qty,
      p: selectedFood.p * qty,
      f: selectedFood.f * qty,
      c: selectedFood.c * qty,
      mg: (selectedFood.mg || 0) * qty,
      fiber: (selectedFood.fiber || 0) * qty,
    };
  } else {
    const name = document.getElementById('c-name').value.trim();
    if (!name) { showToast('È£üÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
    let kcal = parseFloat(document.getElementById('c-kcal').value) || 0;
    const p = parseFloat(document.getElementById('c-p').value) || 0;
    const f = parseFloat(document.getElementById('c-f').value) || 0;
    const c = parseFloat(document.getElementById('c-c').value) || 0;
    const unit = document.getElementById('c-unit').value || '1È£ü';
    const isFish = document.getElementById('is-fish').checked;
    if (isFish) kcal = kcal - (f * 9 * 0.3);
    const mg = parseFloat(document.getElementById('c-mg').value) || 0;
    const fiber = parseFloat(document.getElementById('c-fiber').value) || 0;
    record = { time, name: name + (isFish ? ' üêü' : ''), kcal, p, f, c, mg, fiber };
    // Save to custom DB
    const customs = getCustomFoods();
    if (!customs.find(x => x.name === name)) {
      customs.push({ id: Date.now(), name, unit, kcal: parseFloat(document.getElementById('c-kcal').value)||0, p, f, c, mg, fiber, cat:'„Ç´„Çπ„Çø„É†' });
      saveCustomFoods(customs);
    }
  }

  const meals = getMeals(currentDate);
  meals.push(record);
  saveMeals(currentDate, meals);
  closeModal();
  showToast('Ë®òÈå≤„Åó„Åæ„Åó„Åü ‚úì');
  switchTab('meals');
}

// ======== SUPPLEMENTS TAB ========
function renderSuppl(container) {
  const checks = getSuppl(currentDate);
  const isToday = currentDate === todayStr();
  const done    = SUPPLEMENTS.filter(s => checks[s.id] === true).length;
  const skipped = SUPPLEMENTS.filter(s => checks[s.id] === 'skip').length;
  const pct = Math.round((done / SUPPLEMENTS.length) * 100);

  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div class="card-title" style="margin-bottom:0;">‰ªäÊó•„ÅÆÊúçËñ¨„Éª„Çµ„Éó„É™</div>
        <div id="pct-display" style="font-size:24px;font-weight:700;color:${pct===100?'var(--green-mid)':'var(--text-muted)'};">${pct}%</div>
      </div>
      <div class="compliance-bar">
        <div class="compliance-fill ${pct===100?'full':''}" id="comp-fill" style="width:${pct}%;"></div>
      </div>
      <div id="comp-count" style="font-size:12px;color:var(--text-muted);text-align:center;">${done} / ${SUPPLEMENTS.length} ÂÆå‰∫Ü${skipped > 0 ? `„ÄÄ<span style="color:#856404;">ÔºàÈ£≤„ÅøÂøò„Çå ${skipped}‰ª∂Ôºâ</span>` : ''}</div>
    </div>
  `;

  let html = `<div class="card">`;
  const timings = ['morning','afternoon','evening','bedtime'];
  timings.forEach(t => {
    const items = SUPPLEMENTS.filter(s => s.timing === t);
    html += `<div class="suppl-timing">${TIMING_LABELS[t]}</div>`;
    items.forEach(s => {
      const state = checks[s.id]; // true | 'skip' | falsy
      const isChecked = state === true;
      const isSkipped = state === 'skip';
      html += `
        <div class="suppl-item">
          <div class="suppl-check ${isChecked ? 'checked' : isSkipped ? 'skipped' : ''}" id="sc-${s.id}" onclick="toggleSuppl('${s.id}')"></div>
          <div class="suppl-label">
            <div class="suppl-name ${isChecked ? 'checked' : isSkipped ? 'skipped' : ''}" id="sn-${s.id}">${esc(s.name)}</div>
            ${s.note ? `<div class="suppl-note">${esc(s.note)}</div>` : ''}
          </div>
          ${!s.catchup ? `<div class="suppl-skip-btn ${isSkipped ? 'active' : ''}" id="ss-${s.id}" onclick="skipSuppl('${s.id}')">È£≤„ÅøÂøò„Çå</div>` : ''}
        </div>`;
    });
  });
  html += `</div><div class="spacer"></div>`;
  container.innerHTML += html;
}

function toggleSuppl(id) {
  const checks = getSuppl(currentDate);
  checks[id] = checks[id] === true ? false : true; // skipÁä∂ÊÖã„Åã„Çâ„Åß„ÇÇ„ÄåÈ£≤„Çì„Å†„Äç„Å´„Åß„Åç„Çã
  saveSuppl(currentDate, checks);
  const sc = document.getElementById(`sc-${id}`);
  const sn = document.getElementById(`sn-${id}`);
  const ss = document.getElementById(`ss-${id}`);
  if (sc) { sc.className = 'suppl-check' + (checks[id] ? ' checked' : ''); }
  if (sn) { sn.className = 'suppl-name'  + (checks[id] ? ' checked' : ''); }
  if (ss) ss.classList.remove('active');
  updateCompliance(checks);
}

function skipSuppl(id) {
  const checks = getSuppl(currentDate);
  checks[id] = checks[id] === 'skip' ? false : 'skip';
  saveSuppl(currentDate, checks);
  const sc = document.getElementById(`sc-${id}`);
  const sn = document.getElementById(`sn-${id}`);
  const ss = document.getElementById(`ss-${id}`);
  if (sc) { sc.className = 'suppl-check' + (checks[id] === 'skip' ? ' skipped' : ''); }
  if (sn) { sn.className = 'suppl-name'  + (checks[id] === 'skip' ? ' skipped' : ''); }
  if (ss) ss.classList.toggle('active', checks[id] === 'skip');
  updateCompliance(checks);
}

function updateCompliance(checks) {
  const done    = SUPPLEMENTS.filter(s => checks[s.id] === true).length;
  const skipped = SUPPLEMENTS.filter(s => checks[s.id] === 'skip').length;
  const pct = Math.round((done / SUPPLEMENTS.length) * 100);
  const fill  = document.getElementById('comp-fill');
  const pctEl = document.getElementById('pct-display');
  const cntEl = document.getElementById('comp-count');
  if (fill)  { fill.style.width = pct + '%'; fill.classList.toggle('full', pct===100); }
  if (pctEl) { pctEl.textContent = pct + '%'; pctEl.style.color = pct===100 ? 'var(--green-mid)' : 'var(--text-muted)'; }
  if (cntEl) { cntEl.innerHTML = `${done} / ${SUPPLEMENTS.length} ÂÆå‰∫Ü${skipped > 0 ? `„ÄÄ<span style="color:#856404;">ÔºàÈ£≤„ÅøÂøò„Çå ${skipped}‰ª∂Ôºâ</span>` : ''}`; }
}

// ======== WEIGHT TAB ========
function renderWeight(container) {
  const weights  = getWeights();
  const bodyFat  = getBodyFat();
  const isToday  = currentDate === todayStr();
  const todayW   = weights[currentDate]  ?? null;
  const todayBF  = bodyFat[currentDate]  ?? null;

  // Last 10 days
  const chartData = [];
  for (let i = 9; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    chartData.push({ ds, w: weights[ds] ?? null, bf: bodyFat[ds] ?? null });
  }

  // ÂâçÊó•ÊëÇÂèñ„Ç´„É≠„É™„Éº„Çí‰ªòÂä†
  chartData.forEach(row => {
    const prevD = new Date(row.ds + 'T12:00:00'); prevD.setDate(prevD.getDate() - 1);
    const prevMeals = getMeals(fmtDate(prevD));
    const kcal = prevMeals.reduce((s, m) => s + (m.kcal || 0), 0);
    row.prevKcal = kcal > 0 ? kcal : null;
  });

  // 7Êó•Âπ≥Âùá„ÉªÂâçÈÄ±ÊØî„ÉªÂà§ÂÆö„ÇíË®àÁÆóÔºàÂÖ®‰ΩìÈáç„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
  chartData.forEach(row => {
    // 7Êó•Âπ≥ÂùáÔºà„Åù„ÅÆÊó•„ÇíÂê´„ÇÄÈÅéÂéª7Êó•Ôºâ
    let s = 0, c = 0;
    for (let j = 6; j >= 0; j--) {
      const d2 = new Date(row.ds + 'T12:00:00'); d2.setDate(d2.getDate() - j);
      const w = weights[fmtDate(d2)];
      if (w != null) { s += w; c++; }
    }
    row.avg7 = c > 0 ? s / c : null;

    // ÂâçÈÄ±ÊØîÁî®: 7Êó•Ââç„ÅÆ7Êó•Âπ≥Âùá
    let s2 = 0, c2 = 0;
    for (let j = 13; j >= 7; j--) {
      const d2 = new Date(row.ds + 'T12:00:00'); d2.setDate(d2.getDate() - j);
      const w = weights[fmtDate(d2)];
      if (w != null) { s2 += w; c2++; }
    }
    const prevAvg = c2 >= 4 ? s2 / c2 : null;

    if (row.avg7 != null && prevAvg != null) {
      row.weekDiff = row.avg7 - prevAvg;
      row.judge = row.weekDiff <= -0.25 ? '‚úÖ' : row.weekDiff < 0 ? '‚ñ≥' : '√ó';
    } else {
      row.weekDiff = null;
      row.judge = null;
    }
  });

  const latestW = todayW ?? chartData.slice().reverse().find(d => d.w != null)?.w ?? null;
  const progressPct = latestW
    ? Math.max(0, Math.min(100, ((START_WEIGHT - latestW) / (START_WEIGHT - GOAL_WEIGHT)) * 100))
    : 0;
  const nextMS = latestW ? MILESTONES.find(m => m.weight < latestW) : MILESTONES[0];

  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
  `;

  // Weight entry card
  let wHtml = `<div class="card"><div class="card-title">‰ΩìÈáç„ÇíË®òÈå≤</div>`;
  if (todayW) {
    wHtml += `<div class="weight-hero">
      <div class="weight-big">${todayW.toFixed(2)}<span class="wunit">kg</span></div>
      ${todayBF != null ? `<div style="font-size:15px;color:var(--text-muted);margin-top:2px;">‰ΩìËÑÇËÇ™Áéá ${todayBF.toFixed(1)}%</div>` : ''}
      <div class="weight-sub">${formatDateLabel(currentDate)}„ÅÆË®òÈå≤</div>
    </div>`;
  }
  wHtml += `<div class="weight-input-row">
    <input type="number" id="weight-input" class="form-input" style="flex:1;"
           placeholder="${todayW ?? '88.0'}" step="0.05" min="50" max="300"
           value="${todayW ?? ''}">
    <span style="font-size:14px;color:var(--text-muted);white-space:nowrap;">kg</span>
  </div>
  <div class="weight-input-row" style="margin-top:8px;">
    <input type="number" id="bf-input" class="form-input" style="flex:1;"
           placeholder="${todayBF ?? '31.0'}" step="0.1" min="5" max="60"
           value="${todayBF ?? ''}">
    <span style="font-size:14px;color:var(--text-muted);white-space:nowrap;">% ‰ΩìËÑÇËÇ™</span>
  </div>
  <button class="btn btn-primary" style="margin-top:10px;"
          onclick="saveWeight()">‰øùÂ≠ò</button>
  </div>`;
  container.innerHTML += wHtml;

  // Goal progress
  if (latestW) {
    container.innerHTML += `
      <div class="card">
        <div class="card-title">75kg„Å∏„ÅÆÈÅì„ÅÆ„Çä</div>
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);margin-bottom:6px;">
          <span>ÈñãÂßã: ${START_WEIGHT}kg</span>
          <span>ÁèæÂú®: <strong style="color:var(--text);">${latestW.toFixed(2)}kg</strong></span>
          <span>ÁõÆÊ®ô: ${GOAL_WEIGHT}kg</span>
        </div>
        <div class="progress-main">
          <div class="progress-fill" style="width:${progressPct.toFixed(1)}%;"></div>
        </div>
        <div style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:4px;">
          ÁõÆÊ®ô„Åæ„Åß „ÅÇ„Å® <strong>${(latestW - GOAL_WEIGHT).toFixed(2)}kg</strong>ÔºàÈÄ≤Êçó ${progressPct.toFixed(1)}%Ôºâ
        </div>
        ${nextMS ? `
        <div style="margin-top:12px;padding:10px;background:var(--green-pale);border-radius:10px;">
          <div style="font-size:13px;font-weight:700;color:var(--green-mid);">üéØ Ê¨°„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥</div>
          <div style="font-size:14px;margin-top:2px;">${nextMS.label}: <strong>${nextMS.weight}kg</strong></div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">„ÅÇ„Å® ${(latestW - nextMS.weight).toFixed(2)}kg Ôºè ${nextMS.date}„Åæ„Åß</div>
        </div>` : `
        <div style="margin-top:12px;padding:10px;background:var(--green-pale);border-radius:10px;text-align:center;font-size:15px;font-weight:700;color:var(--green-mid);">
          üéâ ÂÖ®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÅîÊàêÔºÅ
        </div>`}
      </div>`;
  }

  // Chart + 10-day table
  {
    let histHtml = `<div class="card"><div class="card-title">‰ΩìÈáçÊé®ÁßªÔºàÁõ¥Ëøë10Êó•Ôºâ</div>`;
    if (chartData.filter(d => d.w != null).length >= 2) {
      histHtml += buildWeightChart(chartData);
    }
    // 10-day tableÔºàÊñ∞‚ÜíÂè§ „ÅÆÈ†Ü„ÅßË°®Á§∫Ôºâ
    const th = (label, align='right') =>
      `<th style="text-align:${align};padding:4px 4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);white-space:nowrap;">${label}</th>`;
    histHtml += `<table style="width:100%;border-collapse:collapse;margin-top:12px;font-size:12px;">
      <thead><tr>
        ${th('Êó•‰ªò','left')}${th('ÂâçÊó•kcal')}${th('‰ΩìÈáç')}${th('‰ΩìËÑÇËÇ™')}${th('7Êó•Âπ≥Âùá')}${th('Âà§ÂÆö')}
      </tr></thead><tbody>`;
    [...chartData].reverse().forEach(row => {
      const isToday2 = row.ds === todayStr();
      const judgeColor = row.judge === '‚úÖ' ? 'var(--green-mid)' : row.judge === '‚ñ≥' ? '#E5A020' : row.judge === '√ó' ? '#C0392B' : 'var(--text-muted)';
      const judgeStr = row.judge != null
        ? `<span style="color:${judgeColor};font-weight:700;">${row.judge}</span><br><span style="font-size:10px;color:var(--text-muted);">${row.weekDiff > 0 ? '+' : ''}${row.weekDiff.toFixed(2)}</span>`
        : '‚Äî';
      histHtml += `<tr style="${isToday2 ? 'background:var(--green-pale);' : ''}">
        <td style="padding:5px 4px;white-space:nowrap;">${row.ds.slice(5).replace('-','/')}${isToday2 ? '&nbsp;<span style="font-size:9px;color:var(--green-mid);">TODAY</span>' : ''}</td>
        <td style="text-align:right;padding:5px 4px;color:var(--text-muted);">${row.prevKcal != null ? row.prevKcal.toLocaleString() : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;font-weight:${row.w ? '600' : '400'}">${row.w != null ? row.w.toFixed(2) : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;color:var(--text-muted);">${row.bf != null ? row.bf.toFixed(1) + '%' : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;">${row.avg7 != null ? row.avg7.toFixed(2) : '‚Äî'}</td>
        <td style="text-align:center;padding:5px 4px;line-height:1.3;">${judgeStr}</td>
      </tr>`;
    });
    histHtml += `</tbody></table>
    <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">Âà§ÂÆö: ‚úÖ -0.25kg‰ª•‰∏äÊ∏õ Ôºè ‚ñ≥ ÂæÆÊ∏õ Ôºè √ó Â¢óÂä†Ôºà7Êó•Âπ≥Âùá„ÅÆÂâçÈÄ±ÊØîÔºâ</div>
    </div>`;
    container.innerHTML += histHtml;
  }

  // Milestones
  let msHtml = `<div class="card"><div class="card-title">„Éû„Ç§„É´„Çπ„Éà„Éº„É≥</div><div class="milestone-list">`;
  MILESTONES.forEach(m => {
    const achieved = latestW != null && latestW <= m.weight;
    const isNext = m === nextMS;
    const cls = achieved ? 'done' : isNext ? 'next' : 'future';
    const icon = achieved ? '‚úÖ' : isNext ? '‚Üí' : '‚óã';
    msHtml += `
      <div class="milestone-item">
        <div class="milestone-dot ${cls}">${icon}</div>
        <div class="milestone-info">
          <div class="milestone-name">${m.label}</div>
          <div class="milestone-date">${m.date}</div>
        </div>
        <div class="milestone-weight ${achieved ? 'achieved' : isNext ? 'next-weight' : ''}">${m.weight}kg</div>
      </div>`;
  });
  msHtml += `</div></div><div class="spacer"></div>`;
  container.innerHTML += msHtml;
}

function buildWeightChart(data) {
  const W = 320, H = 150;
  const PAD = {t:20, r:44, b:26, l:40};
  const pw = W - PAD.l - PAD.r;
  const ph = H - PAD.t - PAD.b;
  const n  = data.length;
  const xS = i => PAD.l + (i / (n - 1)) * pw;

  // ‰ΩìÈáç„Çπ„Ç±„Éº„É´ÔºàÂ∑¶YËª∏„ÉªÁ∑ëÔºâ
  const wVals = data.map(d => d.w).filter(v => v != null);
  const minW = Math.min(...wVals) - 0.5;
  const maxW = Math.max(...wVals) + 0.5;
  const yW = v => PAD.t + ph - ((v - minW) / (maxW - minW)) * ph;

  // ‰ΩìËÑÇËÇ™„Çπ„Ç±„Éº„É´ÔºàÂè≥YËª∏„Éª„Ç™„É¨„É≥„Ç∏Ôºâ
  const bfVals = data.map(d => d.bf).filter(v => v != null);
  const hasBF = bfVals.length >= 2;
  let yBF, minBF, maxBF;
  if (hasBF) {
    minBF = Math.min(...bfVals) - 1;
    maxBF = Math.max(...bfVals) + 1;
    yBF = v => PAD.t + ph - ((v - minBF) / (maxBF - minBF)) * ph;
  }

  // ‰ΩìÈáç„É©„Ç§„É≥„Éª„Éâ„ÉÉ„Éà
  const wPts  = data.filter(d => d.w != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yW(d.w).toFixed(1)}`).join(' ');
  const wDots = data.map((d,i) => d.w != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yW(d.w).toFixed(1)}" r="3" fill="white" stroke="#2D6A4F" stroke-width="2"/>`
    : '').join('');

  // ‰ΩìËÑÇËÇ™„É©„Ç§„É≥„Éª„Éâ„ÉÉ„Éà
  let bfPts = '', bfDots = '';
  if (hasBF) {
    bfPts  = data.filter(d => d.bf != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yBF(d.bf).toFixed(1)}`).join(' ');
    bfDots = data.map((d,i) => d.bf != null
      ? `<circle cx="${xS(i).toFixed(1)}" cy="${yBF(d.bf).toFixed(1)}" r="2.5" fill="white" stroke="#E5A020" stroke-width="2"/>`
      : '').join('');
  }

  // Â∑¶YËª∏„É©„Éô„É´Ôºà‰ΩìÈáçÔºâ
  const wLabels = [minW, (minW+maxW)/2, maxW].map(v =>
    `<line x1="${PAD.l}" y1="${yW(v).toFixed(1)}" x2="${W-PAD.r}" y2="${yW(v).toFixed(1)}" stroke="#E9ECEF" stroke-width="1"/>
     <text x="${PAD.l-5}" y="${(yW(v)+4).toFixed(1)}" text-anchor="end" font-size="9" fill="#2D6A4F">${v.toFixed(1)}</text>`
  ).join('');

  // Âè≥YËª∏„É©„Éô„É´Ôºà‰ΩìËÑÇËÇ™Ôºâ
  const bfLabels = hasBF ? [minBF, (minBF+maxBF)/2, maxBF].map(v =>
    `<text x="${W-PAD.r+5}" y="${(yBF(v)+4).toFixed(1)}" text-anchor="start" font-size="9" fill="#E5A020">${v.toFixed(1)}%</text>`
  ).join('') : '';

  // XËª∏Êó•‰ªò„É©„Éô„É´
  const firstDs = data[0].ds.slice(5).replace('-','/');
  const lastDs  = data[n-1].ds.slice(5).replace('-','/');

  // Âá°‰æã
  const legend = `
    <line x1="${PAD.l}" y1="10" x2="${PAD.l+16}" y2="10" stroke="#2D6A4F" stroke-width="2"/>
    <text x="${PAD.l+18}" y="14" font-size="9" fill="#555">‰ΩìÈáç</text>
    ${hasBF ? `<line x1="${PAD.l+46}" y1="10" x2="${PAD.l+62}" y2="10" stroke="#E5A020" stroke-width="1.5" stroke-dasharray="4,2"/>
    <text x="${PAD.l+64}" y="14" font-size="9" fill="#555">‰ΩìËÑÇËÇ™%</text>` : ''}`;

  return `<div class="chart-scroll">
    <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
      ${wLabels}${bfLabels}
      <polyline points="${wPts}" fill="none" stroke="#2D6A4F" stroke-width="2"/>
      ${hasBF ? `<polyline points="${bfPts}" fill="none" stroke="#E5A020" stroke-width="1.5" stroke-dasharray="4,2"/>` : ''}
      ${wDots}${bfDots}
      <text x="${PAD.l}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${firstDs}</text>
      <text x="${W-PAD.r}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${lastDs}</text>
      ${legend}
    </svg>
  </div>`;
}

function saveWeight() {
  const wInp  = document.getElementById('weight-input');
  const bfInp = document.getElementById('bf-input');
  const wVal  = parseFloat(wInp.value);
  const bfVal = parseFloat(bfInp?.value);
  if (!wVal || wVal < 30 || wVal > 300) { showToast('Ê≠£„Åó„ÅÑ‰ΩìÈáç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  const w = getWeights();
  w[currentDate] = wVal;
  saveWeights(w);
  if (!isNaN(bfVal) && bfVal > 0) {
    const bf = getBodyFat();
    bf[currentDate] = bfVal;
    saveBodyFat(bf);
  }
  showToast(`${wVal}kg${!isNaN(bfVal) && bfVal > 0 ? ' / ' + bfVal + '%' : ''} „ÇíË®òÈå≤„Åó„Åæ„Åó„Åü ‚úì`);
  switchTab('weight');
}

// ======== IMPORT ========
// File System Access API (desktop Chrome/Safari) + fallback to <input type="file"> (iOS)
const supportsFileSystemAccess = 'showOpenFilePicker' in window;

// IndexedDB helpers for persisting FileSystemFileHandle
function idbOpen() {
  return new Promise((res, rej) => {
    const req = indexedDB.open('health-hub', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('handles');
    req.onsuccess = e => res(e.target.result);
    req.onerror = () => rej();
  });
}
async function idbGet(key) {
  try {
    const db = await idbOpen();
    return new Promise(res => {
      const tx = db.transaction('handles', 'readonly');
      const req = tx.objectStore('handles').get(key);
      req.onsuccess = () => res(req.result ?? null);
      req.onerror = () => res(null);
    });
  } catch { return null; }
}
async function idbPut(key, val) {
  try {
    const db = await idbOpen();
    return new Promise(res => {
      const tx = db.transaction('handles', 'readwrite');
      tx.objectStore('handles').put(val, key);
      tx.oncomplete = res;
    });
  } catch {}
}

async function triggerFilePicker() {
  if (supportsFileSystemAccess) {
    await loadWithFSA();
  } else {
    // iOS fallback
    const fp = document.getElementById('file-picker');
    fp.value = '';
    fp.click();
  }
}

async function loadWithFSA() {
  // Try saved handle first
  let handle = await idbGet('health-memo-handle');

  if (handle) {
    try {
      let perm = await handle.queryPermission({ mode: 'read' });
      if (perm !== 'granted') {
        perm = await handle.requestPermission({ mode: 'read' });
      }
      if (perm === 'granted') {
        showToast('Ë™≠„ÅøËæº„Åø‰∏≠...');
        const file = await handle.getFile();
        const text = await file.text();
        importFromMarkdown(text, handle.name);
        return;
      }
    } catch (e) {
      // Saved handle is stale (file moved/renamed) ‚Äî fall through to picker
      await idbPut('health-memo-handle', null);
    }
  }

  // First time or stale handle ‚Äî show file picker
  try {
    [handle] = await window.showOpenFilePicker({
      types: [{ description: 'Markdown / Text', accept: { 'text/*': ['.md', '.txt'] } }],
      multiple: false,
    });
  } catch (e) {
    if (e.name !== 'AbortError') showToast('„Éï„Ç°„Ç§„É´„ÇíÈñã„Åë„Åæ„Åõ„Çì„Åß„Åó„Åü: ' + e.message);
    return;
  }

  try {
    await idbPut('health-memo-handle', handle);
    showToast('Ë™≠„ÅøËæº„Åø‰∏≠...');
    const file = await handle.getFile();
    const text = await file.text();
    importFromMarkdown(text, handle.name);
    updateImportBtnLabel(handle.name);
  } catch (e) {
    showToast('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + e.message);
  }
}

function onFilePicked(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => importFromMarkdown(e.target.result, file.name);
  reader.readAsText(file, 'UTF-8');
}

function updateImportBtnLabel(filename) {
  const btn = document.querySelector('.import-btn');
  if (btn) btn.innerHTML = `üì• Âèñ„ÇäËæº„ÇÄ <span style="font-size:11px;opacity:0.7;">Ôºà${filename}Ôºâ</span>`;
}

// On page load: show saved filename on button if handle exists
async function initImportBtn() {
  if (!supportsFileSystemAccess) return;
  const handle = await idbGet('health-memo-handle');
  if (handle) updateImportBtnLabel(handle.name);
}

function importFromMarkdown(text, filename) {
  // Parse ALL date sections from the file
  // Supported formats: ### 2026/02/20  ### 2026/2/20  ### 2/20  ### 02/20
  const DATE_RE = /^#{1,4}\s.*?(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})|^#{1,4}\s.*?(\d{1,2})[\/\-](\d{1,2})(?!\d)/;

  const lines = text.split('\n');
  // Map: dateStr ("YYYY-MM-DD") ‚Üí meal[]
  const byDate = {};
  let currentDs = null;

  for (const rawLine of lines) {
    const line = rawLine.trim();

    if (/^#{1,4}\s/.test(line)) {
      const m = line.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
      if (m) {
        // Full year format: 2026/02/20
        currentDs = `${m[1]}-${pad(+m[2])}-${pad(+m[3])}`;
        if (!byDate[currentDs]) byDate[currentDs] = [];
        continue;
      }
      const m2 = line.match(/(\d{1,2})[\/\-](\d{1,2})(?!\d)/);
      if (m2) {
        // Month/day only: infer year from currentDate's year
        const yr = currentDate.split('-')[0];
        currentDs = `${yr}-${pad(+m2[1])}-${pad(+m2[2])}`;
        if (!byDate[currentDs]) byDate[currentDs] = [];
        continue;
      }
      // Non-date heading ‚Äî stop collecting for current date
      currentDs = null;
      continue;
    }

    if (!currentDs) continue;
    if (!line.startsWith('|')) continue;
    if (line.includes('---')) continue;
    if (/ÂêàË®à|ÁõÆÊ®ô|ÊôÇÂàª/.test(line)) continue;

    const cells = line.split('|').map(c => c.trim()).filter(c => c !== '');
    if (cells.length < 4) continue;

    const time = cells[0];
    const name = cells[1];
    const kcal = parseNum(cells[2]);
    const p    = parseNum(cells[3]);
    const f    = parseNum(cells.length > 4 ? cells[4] : '0');
    const c    = parseNum(cells.length > 5 ? cells[5] : '0');

    if (!/^\d{1,2}:\d{2}$/.test(time) || !name || kcal <= 0) continue;
    byDate[currentDs].push({ time, name, kcal, p, f, c });
  }

  // Remove dates with no meals
  const dates = Object.keys(byDate).filter(ds => byDate[ds].length > 0);

  if (dates.length === 0) {
    showToast('È£ü‰∫ãË®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
    return;
  }

  // Merge into localStorage for each date
  let totalAdded = 0;
  let datesUpdated = 0;
  dates.forEach(ds => {
    const existing = getMeals(ds);
    let added = 0;
    byDate[ds].forEach(item => {
      if (!existing.find(e => e.time === item.time && e.name === item.name)) {
        existing.push(item);
        added++;
      }
    });
    if (added > 0) {
      saveMeals(ds, existing);
      totalAdded += added;
      datesUpdated++;
    }
  });

  showToast(`${datesUpdated}Êó•ÂàÜ„Éª${totalAdded}‰ª∂ Âèñ„ÇäËæº„Åø„Åæ„Åó„Åü ‚úì`);
  switchTab('meals');
}

function parseNum(s) {
  return parseFloat(String(s).replace(/[^0-9.]/g, '')) || 0;
}

// ======== UTIL ========
function showToast(msg) {
  const ex = document.querySelector('.toast');
  if (ex) ex.remove();
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 0.2s'; setTimeout(() => el.remove(), 200); }, 2500);
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ======== START ========
init();
initImportBtn();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/web/sw.js').catch(() => {});
}
</script>
</body>
</html>
