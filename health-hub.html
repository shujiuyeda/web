<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1B4332">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Health Hub">
  <title>„Åó„ÇÖ„ÅÜ„Åó„ÇÖ„ÅÜ Health Hub</title>
  <link rel="manifest" href="manifest.json">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green-dark: #1B4332;
      --green-mid: #2D6A4F;
      --green-light: #52B788;
      --green-pale: #D8F3DC;
      --bg: #F0F4F0;
      --card: #FFFFFF;
      --text: #1A1A2E;
      --text-muted: #6C757D;
      --border: #DEE2E6;
      --accent: #52B788;
      --danger: #DC3545;
      --warning: #E5A020;
      --success: #28A745;
      --nav-height: 62px;
      --header-height: 52px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      overscroll-behavior-y: none;
      -webkit-font-smoothing: antialiased;
    }
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--header-height);
      background: var(--green-dark);
      color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      z-index: 100;
      padding-top: env(safe-area-inset-top, 0px);
    }
    .header h1 { font-size: 16px; font-weight: 700; }
    .header-date { font-size: 13px; opacity: 0.75; }
    .header-clock { font-size: 14px; font-weight: 700; opacity: 0.9; letter-spacing: 0.05em; }
    .header-reload {
      background: none; border: none; color: white; opacity: 0.75;
      font-size: 20px; padding: 6px 8px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .header-reload:active { opacity: 0.4; }
    .main {
      padding-top: var(--header-height);
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 8px);
      min-height: 100vh;
    }
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: calc(var(--nav-height) + var(--safe-bottom));
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 100;
      padding-bottom: var(--safe-bottom);
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 3px;
      border: none; background: none;
      color: var(--text-muted); font-size: 10px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      padding: 6px 0;
      transition: color 0.15s;
    }
    .nav-btn.active { color: var(--green-mid); }
    .nav-btn svg { width: 22px; height: 22px; }
    .card {
      background: var(--card); border-radius: 14px;
      padding: 14px 16px; margin: 8px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 11px; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.6px; margin-bottom: 12px;
    }
    .kcal-display {
      display: flex; align-items: baseline; gap: 4px;
      justify-content: center; padding: 4px 0 8px;
    }
    .kcal-num {
      font-size: 48px; font-weight: 700;
      color: var(--green-dark); line-height: 1;
      transition: color 0.2s;
    }
    .kcal-num.over { color: var(--danger); }
    .kcal-unit { font-size: 16px; color: var(--text-muted); }
    .kcal-target { font-size: 13px; color: var(--text-muted); }
    .remaining {
      text-align: center; font-size: 13px;
      color: var(--text-muted); margin-bottom: 14px;
    }
    .macros-row { display: flex; gap: 8px; }
    .macro-card {
      flex: 1; background: var(--bg);
      border-radius: 10px; padding: 10px 6px; text-align: center;
    }
    .macro-name { font-size: 10px; color: var(--text-muted); margin-bottom: 2px; }
    .macro-value { font-size: 18px; font-weight: 700; line-height: 1.1; }
    .macro-value .unit { font-size: 11px; font-weight: 400; }
    .macro-target { font-size: 10px; color: var(--text-muted); margin-top: 1px; }
    .macro-value.over { color: var(--danger); }
    .macro-value.warn { color: var(--warning); }
    .macro-value.ok { color: var(--green-mid); }
    .date-nav {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px; background: white;
      border-bottom: 1px solid var(--border);
    }
    .date-nav-btn {
      width: 38px; height: 38px; border: none; background: none;
      font-size: 22px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; color: var(--green-mid);
      -webkit-tap-highlight-color: transparent;
    }
    .date-nav-btn:active { background: var(--bg); }
    .date-nav-btn.disabled { opacity: 0.25; pointer-events: none; }
    .date-nav-label { font-size: 15px; font-weight: 600; }
    .today-badge {
      display: inline-block; margin-left: 6px;
      background: var(--green-pale); color: var(--green-mid);
      font-size: 10px; font-weight: 700; padding: 1px 6px;
      border-radius: 8px; vertical-align: middle;
    }
    .meal-list { display: flex; flex-direction: column; gap: 1px; }
    .meal-item {
      display: flex; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border); gap: 8px;
    }
    .meal-item:last-child { border-bottom: none; }
    .meal-time { font-size: 11px; color: var(--text-muted); width: 38px; flex-shrink: 0; }
    .meal-info { flex: 1; min-width: 0; }
    .meal-name { font-size: 14px; line-height: 1.3; }
    .meal-macros { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .meal-kcal { font-size: 13px; font-weight: 700; color: var(--green-mid); flex-shrink: 0; }
    .meal-del {
      width: 30px; height: 30px; border: none; background: none;
      color: #CCC; font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .meal-del:active { background: #f0f0f0; color: var(--danger); }
    .summary-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-top: 1.5px solid var(--border); margin-top: 4px;
    }
    .summary-label { font-size: 14px; font-weight: 700; }
    .summary-val { font-size: 15px; font-weight: 700; color: var(--green-mid); }
    .empty-state {
      text-align: center; padding: 28px 20px; color: var(--text-muted);
    }
    .empty-icon { font-size: 36px; margin-bottom: 8px; }
    .empty-text { font-size: 14px; line-height: 1.5; }
    .fab {
      position: fixed;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + 14px);
      right: 18px;
      width: 56px; height: 56px; border-radius: 50%;
      background: var(--green-mid); color: white;
      border: none;
      box-shadow: 0 4px 14px rgba(45,106,79,0.4);
      font-size: 26px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 90; -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .fab:active { transform: scale(0.92); box-shadow: 0 2px 8px rgba(45,106,79,0.3); }
    .fab.hidden { display: none; }
    .export-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px; border: 1.5px dashed var(--border);
      border-radius: 10px; background: none;
      color: var(--text-muted); font-size: 14px; cursor: pointer;
      width: calc(100% - 24px); margin: 0 12px 8px;
      -webkit-tap-highlight-color: transparent;
    }
    .export-btn:active { background: var(--bg); }
    .import-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px; border: 1.5px dashed #74C69D;
      border-radius: 10px; background: none;
      color: var(--green-mid); font-size: 14px; cursor: pointer;
      width: calc(100% - 24px); margin: 0 12px 4px;
      -webkit-tap-highlight-color: transparent;
    }
    .import-btn:active { background: var(--green-pale); }
    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 200; display: flex; align-items: flex-end; justify-content: center;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: white; border-radius: 20px 20px 0 0;
      width: 100%; max-height: 92vh; overflow-y: auto;
      padding: 20px 16px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    }
    .modal-handle {
      width: 40px; height: 4px; background: var(--border);
      border-radius: 2px; margin: -8px auto 16px; display: block;
    }
    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 16px; text-align: center; }
    .search-wrap { position: relative; margin-bottom: 10px; }
    .search-input {
      width: 100%; padding: 13px 14px;
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 16px; background: #F8F9FA; outline: none;
      -webkit-appearance: none;
    }
    .search-input:focus { border-color: var(--green-light); background: white; }
    .ac-list {
      position: absolute; top: calc(100% + 4px); left: 0; right: 0;
      background: white; border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      max-height: 220px; overflow-y: auto; z-index: 300;
    }
    .ac-list.hidden { display: none; }
    .ac-item {
      padding: 12px 14px; cursor: pointer;
      border-bottom: 1px solid var(--border); font-size: 14px;
    }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:active { background: var(--green-pale); }
    .ac-unit { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .ac-kcal { float: right; font-size: 12px; color: var(--green-mid); font-weight: 600; }
    .selected-food-box {
      background: var(--green-pale); padding: 12px 14px;
      border-radius: 10px; margin-bottom: 12px;
    }
    .sel-name { font-weight: 600; font-size: 15px; }
    .sel-unit { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .sel-stats { display: flex; gap: 12px; margin-top: 6px; font-size: 13px; }
    .sel-kcal { color: var(--green-mid); font-weight: 700; }
    .sel-pfc { color: var(--text-muted); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .form-field { display: flex; flex-direction: column; gap: 4px; }
    .form-field.full { grid-column: 1 / -1; }
    .form-label { font-size: 12px; color: var(--text-muted); font-weight: 600; }
    .form-input {
      padding: 11px 12px; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 15px; background: #F8F9FA;
      outline: none; -webkit-appearance: none;
    }
    .form-input:focus { border-color: var(--green-light); background: white; }
    .btn {
      padding: 14px 20px; border-radius: 12px; border: none;
      font-size: 16px; font-weight: 700; cursor: pointer; width: 100%;
      margin-top: 10px; -webkit-tap-highlight-color: transparent;
      transition: opacity 0.1s;
    }
    .btn:active { opacity: 0.8; }
    .btn-primary { background: var(--green-mid); color: white; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .custom-section {
      margin-top: 14px; padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .custom-section-label {
      font-size: 13px; color: var(--text-muted); margin-bottom: 10px;
    }
    .fish-toggle {
      display: flex; align-items: center; gap: 10px;
      margin-top: 12px; font-size: 14px; cursor: pointer;
    }
    .fish-toggle input { width: 20px; height: 20px; cursor: pointer; }
    .fish-note {
      font-size: 11px; color: var(--text-muted);
      background: var(--green-pale); padding: 7px 10px;
      border-radius: 8px; margin-top: 8px; line-height: 1.5;
    }
    /* Supplements */
    .suppl-timing {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      padding: 10px 0 6px; letter-spacing: 0.3px;
    }
    .suppl-item {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 0; border-bottom: 1px solid var(--border);
    }
    .suppl-item:last-child { border-bottom: none; }
    .suppl-check {
      width: 26px; height: 26px; border: 2px solid var(--border);
      border-radius: 7px; flex-shrink: 0; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      -webkit-tap-highlight-color: transparent; transition: all 0.15s;
    }
    .suppl-check.checked { background: var(--green-mid); border-color: var(--green-mid); }
    .suppl-check.checked::after { content: "‚úì"; color: white; font-size: 15px; font-weight: 800; }
    .suppl-check.skipped { background: #E9ECEF; border-color: #CCC; }
    .suppl-check.skipped::after { content: "‚àí"; color: #999; font-size: 20px; font-weight: 700; line-height: 1; }
    .suppl-label { flex: 1; }
    .suppl-name { font-size: 14px; transition: color 0.15s; }
    .suppl-name.checked { text-decoration: line-through; color: var(--text-muted); }
    .suppl-name.skipped { color: var(--text-muted); }
    .suppl-note { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .suppl-skip-btn {
      font-size: 11px; color: var(--text-muted); background: #F0F0F0;
      border: 1px solid #DDD; border-radius: 10px; padding: 3px 8px;
      cursor: pointer; white-space: nowrap; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .suppl-skip-btn.active { background: #FFF3CD; border-color: #FFC107; color: #856404; }
    .compliance-bar {
      height: 10px; background: #E9ECEF;
      border-radius: 5px; overflow: hidden; margin: 8px 0 4px;
    }
    .compliance-fill {
      height: 100%; border-radius: 5px; background: var(--green-light);
      transition: width 0.3s;
    }
    .compliance-fill.full { background: var(--green-mid); }
    /* Weight */
    .weight-hero {
      text-align: center; padding: 8px 0 12px;
    }
    .weight-big {
      font-size: 56px; font-weight: 700;
      color: var(--green-dark); line-height: 1;
    }
    .weight-big .wunit { font-size: 20px; color: var(--text-muted); }
    .weight-sub { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .weight-input-row {
      display: flex; gap: 10px; align-items: center; margin-top: 12px;
    }
    .progress-main {
      height: 14px; background: #E9ECEF;
      border-radius: 7px; overflow: hidden; margin: 8px 0 4px;
    }
    .progress-fill {
      height: 100%; border-radius: 7px;
      background: linear-gradient(90deg, var(--green-light), var(--green-mid));
      transition: width 0.4s;
    }
    .milestone-list { display: flex; flex-direction: column; gap: 10px; }
    .milestone-item {
      display: flex; align-items: center; gap: 10px; font-size: 14px;
    }
    .milestone-dot {
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; flex-shrink: 0;
    }
    .milestone-dot.done { background: var(--green-pale); color: var(--green-mid); font-size: 15px; }
    .milestone-dot.next { background: #FFF3CD; color: #856404; font-weight: 700; }
    .milestone-dot.future { background: #E9ECEF; color: var(--text-muted); font-size: 10px; }
    .milestone-info { flex: 1; }
    .milestone-name { font-size: 14px; }
    .milestone-date { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .milestone-weight {
      font-size: 14px; font-weight: 700; color: var(--text-muted);
    }
    .milestone-weight.achieved { color: var(--green-mid); }
    .milestone-weight.next-weight { color: var(--warning); }
    /* Chart */
    .chart-scroll { overflow-x: auto; }
    /* Toast */
    .toast {
      position: fixed;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + 74px);
      left: 50%; transform: translateX(-50%);
      background: rgba(27,67,50,0.92); color: white;
      padding: 11px 20px; border-radius: 22px;
      font-size: 14px; z-index: 1000; white-space: nowrap;
      animation: toast-in 0.2s ease;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(8px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .spacer { height: 20px; }
    .hidden { display: none !important; }
    /* Qty input in modal */
    .qty-row {
      display: flex; align-items: center; gap: 10px; margin-top: 8px;
    }
    .qty-row label { font-size: 13px; color: var(--text-muted); white-space: nowrap; }
    .qty-input {
      flex: 1; padding: 10px 12px; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 16px; background: #F8F9FA;
      outline: none; -webkit-appearance: none; text-align: center;
    }
    .qty-input:focus { border-color: var(--green-light); }
    /* Import section */
    .import-section {
      margin: 0 12px 8px;
    }
    .import-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 11px; border: 1.5px dashed #ADB5BD;
      border-radius: 10px; background: none;
      color: var(--text-muted); font-size: 13px; cursor: pointer;
      width: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    .import-btn:active { background: var(--bg); }
    /* Nutrition bar */
    .nutr-bar { margin-bottom: 10px; }
    .nutr-bar-header { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px; }
    .nutr-bar-label { color: var(--text-muted); }
    .nutr-bar-val { font-weight: 600; }
    .nutr-bar-track { height: 6px; background: #E9ECEF; border-radius: 3px; overflow: hidden; }
    .nutr-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
    .nutr-bar-fill.ok { background: var(--green-light); }
    .nutr-bar-fill.warn { background: var(--warning); }
    .nutr-bar-fill.over { background: var(--danger); }
    /* Sleep */
    .sleep-hero {
      text-align: center; padding: 8px 0 12px;
    }
    .sleep-big {
      font-size: 52px; font-weight: 700;
      color: #2E4057; line-height: 1;
    }
    .sleep-big .sunit { font-size: 18px; color: var(--text-muted); }
    .sleep-sub { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .sleep-stage-bar {
      height: 20px; border-radius: 10px; overflow: hidden;
      display: flex; margin: 12px 0 6px; background: #E9ECEF;
    }
    .sleep-stage-rem   { background: #5B8FB9; }
    .sleep-stage-core  { background: #84B1CE; }
    .sleep-stage-deep  { background: #2E4057; }
    .sleep-stage-awake { background: #F4A261; }
    .sleep-legend {
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px;
    }
    .sleep-legend-item {
      display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-muted);
    }
    .sleep-legend-dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
    }
    /* AI Advice Cards */
    .advice-card {
      background: linear-gradient(135deg, #1B4332 0%, #2D6A4F 100%);
      border-radius: 14px; padding: 14px 16px; margin: 8px 12px;
      color: white; box-shadow: 0 2px 8px rgba(27,67,50,0.3);
    }
    .advice-card.stale { opacity: 0.55; }
    .advice-card-label {
      font-size: 10px; font-weight: 700; letter-spacing: 0.8px;
      opacity: 0.7; text-transform: uppercase; margin-bottom: 6px;
    }
    .advice-headline { font-size: 15px; font-weight: 700; line-height: 1.5; margin-bottom: 8px; }
    .advice-score-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .advice-score-num { font-size: 38px; font-weight: 800; line-height: 1; }
    .advice-score-meta { flex: 1; }
    .advice-score-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin-bottom: 2px; }
    .advice-score-fill { height: 100%; border-radius: 3px; background: #74C69D; }
    .advice-top-action {
      background: rgba(255,255,255,0.18); border-radius: 8px;
      padding: 8px 10px; font-size: 13px; font-weight: 700;
      line-height: 1.4; margin-top: 6px;
    }
    .advice-insight { font-size: 13px; line-height: 1.6; opacity: 0.95; margin-bottom: 8px; }
    .advice-week-trend { font-size: 12px; opacity: 0.8; margin-bottom: 6px; }
    .advice-tips { margin: 0 0 8px; padding-left: 16px; font-size: 12px; line-height: 1.8; opacity: 0.9; }
    .advice-box {
      background: rgba(255,255,255,0.15); border-radius: 8px;
      padding: 8px 10px; font-size: 12px; line-height: 1.5; margin-top: 6px;
    }
    .advice-box.green { background: rgba(116,198,157,0.25); }
    .advice-stale-note { font-size: 10px; opacity: 0.55; margin-top: 6px; text-align: right; }

    /* Pull-to-refresh */
    #ptr-indicator {
      position: fixed; top: var(--header-height); left: 0; right: 0;
      display: flex; align-items: center; justify-content: center;
      height: 0; overflow: hidden;
      transition: height 0.2s ease;
      background: var(--bg); z-index: 90;
    }
    #ptr-indicator.visible { height: 48px; }
    #ptr-spinner {
      width: 28px; height: 28px;
      border: 3px solid var(--border);
      border-top-color: var(--green-mid);
      border-radius: 50%;
      transition: transform 0.1s linear;
    }
    #ptr-spinner.spinning {
      animation: ptr-spin 0.7s linear infinite;
    }
    @keyframes ptr-spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div id="ptr-indicator"><div id="ptr-spinner"></div></div>
<div id="app">
  <header class="header">
    <h1 onclick="switchTab('meals')" style="cursor:pointer;">üåø Health Hub</h1>
    <div style="display:flex;align-items:center;gap:4px;">
      <span class="header-date" id="header-date"></span>
      <span class="header-clock" id="header-clock"></span>
      <button class="header-reload" onclick="location.reload()" title="„É™„É≠„Éº„Éâ">‚Üª</button>
    </div>
  </header>

  <main class="main" id="main-content"></main>

  <button class="fab hidden" id="fab-add" onclick="openModal()">Ôºã</button>

  <nav class="bottom-nav">
    <button class="nav-btn active" data-tab="meals" onclick="switchTab('meals')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3"/>
      </svg>
      È£ü‰∫ã
    </button>
    <button class="nav-btn" data-tab="supplements" onclick="switchTab('supplements')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
      </svg>
      „Çµ„Éó„É™
    </button>
    <button class="nav-btn" data-tab="weight" onclick="switchTab('weight')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      ‰ΩìÈáç
    </button>
    <button class="nav-btn" data-tab="sleep" onclick="switchTab('sleep')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
      Áù°Áú†
    </button>
    <button class="nav-btn" data-tab="shopping" onclick="switchTab('shopping')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
      </svg>
      Ë≤∑„ÅÑÁâ©
    </button>
  </nav>
</div>

<!-- Add Food Modal -->
<div class="modal-overlay hidden" id="modal-overlay" onclick="onOverlayClick(event)">
  <div class="modal">
    <span class="modal-handle"></span>
    <div class="modal-title">È£ü‰∫ã„ÇíË®òÈå≤</div>

    <div class="search-wrap">
      <input type="search" class="search-input" id="food-search"
             placeholder="È£üÂìÅÂêç„ÇíÊ§úÁ¥¢..."
             oninput="onFoodSearch(this.value)"
             autocomplete="off" autocorrect="off"
             spellcheck="false">
      <div class="ac-list hidden" id="ac-list"></div>
    </div>

    <div id="selected-box" class="hidden">
      <div class="selected-food-box">
        <div class="sel-name" id="sel-name"></div>
        <div class="sel-unit" id="sel-unit"></div>
        <div class="sel-stats">
          <span class="sel-kcal" id="sel-kcal"></span>
          <span class="sel-pfc" id="sel-pfc"></span>
        </div>
      </div>
      <div class="qty-row">
        <label>ÂÄãÊï∞„ÉªÈáè</label>
        <input type="number" class="qty-input" id="food-qty" value="1" min="0.1" max="99" step="0.5">
      </div>
    </div>

    <div id="custom-form" class="hidden">
      <div class="custom-section">
        <div class="custom-section-label">„Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Å™„ÅÑÈ£üÂìÅ„ÇíÊâãÂãï„ÅßÂÖ•Âäõ</div>
        <div class="form-grid">
          <div class="form-field full">
            <label class="form-label">È£üÂìÅÂêç</label>
            <input type="text" class="form-input" id="c-name" placeholder="‰æã: „ÇÜ„ÅßÂçµ">
          </div>
          <div class="form-field">
            <label class="form-label">„Ç´„É≠„É™„Éº (kcal)</label>
            <input type="number" class="form-input" id="c-kcal" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">„Åü„Çì„Å±„ÅèË≥™ P (g)</label>
            <input type="number" class="form-input" id="c-p" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">ËÑÇË≥™ F (g)</label>
            <input type="number" class="form-input" id="c-f" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">ÁÇ≠Ê∞¥ÂåñÁâ© C (g)</label>
            <input type="number" class="form-input" id="c-c" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">„Éû„Ç∞„Éç„Ç∑„Ç¶„É† Mg (mg)</label>
            <input type="number" class="form-input" id="c-mg" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">È£üÁâ©ÁπäÁ∂≠ (g)</label>
            <input type="number" class="form-input" id="c-fiber" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">Âçò‰Ωç</label>
            <input type="text" class="form-input" id="c-unit" placeholder="‰æã: 1ÂÄã">
          </div>
        </div>
        <label class="fish-toggle">
          <input type="checkbox" id="is-fish">
          üêü È≠ö„ÅÆËÑÇË≥™„Éú„Éº„Éä„ÇπÈÅ©Áî®Ôºà„Ç´„É≠„É™„Éº√ó0.7Ôºâ
        </label>
        <div class="fish-note">ÈùíÈ≠ö„ÉªÈÆ≠„Å™„Å©È≠ö„ÅÆËÑÇË≥™„Ç´„É≠„É™„Éº„ÅØ√ó0.7„ÅßË®àÁÆóÔºà„Ç™„É°„Ç¨3„ÅØ‰ΩìËÑÇËÇ™„Å´„Å™„Çä„Å´„Åè„ÅÑÔºâ</div>
      </div>
    </div>

    <button class="btn btn-primary" id="btn-record" onclick="addFoodRecord()">Ë®òÈå≤„Åô„Çã</button>
    <button class="btn btn-secondary" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
  </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="file-picker" accept=".md,text/plain,text/markdown"
       style="display:none" onchange="onFilePicked(event)">

<script>
// ======== FOOD DATABASE ========
const BUILT_IN_FOODS = [
  // ‰∏ªÈ£ü
  { id:1, name:"„Éë„Çπ„Ç≥ È∫¶„ÅÆ„ÇÅ„Åê„Åø ÂÖ®Á≤íÁ≤â„Ç§„É≥„Ç∞„É™„ÉÉ„Ç∑„É•„Éû„Éï„Ç£„É≥", unit:"1ÂÄã", kcal:152, p:5.7, f:1.3, c:30.5, mg:20, fiber:2.3, cat:"‰∏ªÈ£ü" },
  // Ëá™ÁÇä
  { id:2, name:"ÁÑ°Ê∞¥„Ç´„É¨„ÉºÔºàÂ∞èÁöø1ÊùØ 1/6Ôºâ", unit:"1ÊùØ", kcal:165, p:21, f:6, c:9, mg:40, fiber:3.0, cat:"Ëá™ÁÇä" },
  { id:3, name:"Áâõ„Åô„ÅòÁÑ°Ê∞¥„Ç´„É¨„ÉºÔºà1ÊùØ ËÇâ170g+„ÇΩ„Éº„ÇπÔºâ", unit:"1ÊùØ", kcal:385, p:53.5, f:6.1, c:31.6, mg:50, fiber:2.5, cat:"Ëá™ÁÇä" },
  { id:4, name:"Áâõ„Åô„ÅòÁÑ°Ê∞¥„Ç´„É¨„ÉºÔºàÈÅ©Èáè ËÇâ120g+ÁôΩÁ±≥150gÔºâ", unit:"1È£ü", kcal:525, p:42, f:5, c:78, mg:45, fiber:2.0, cat:"Ëá™ÁÇä" },
  { id:5, name:"Áâõ„Åô„ÅòÁÑ°Ê∞¥„Ç´„É¨„ÉºÔºàËÇâ119g+„ÇΩ„Éº„Çπ226g+ÁôΩÁ±≥114gÔºâ", unit:"1È£ü", kcal:502, p:46, f:5.2, c:67.8, mg:50, fiber:2.5, cat:"Ëá™ÁÇä" },
  { id:6, name:"Âë≥ÂôåÊ±ÅÔºàË±ÜËÖê„ÉªÁéâ„Å≠„Åé„Éª„Åò„ÇÉ„Åå„ÅÑ„ÇÇÔºâ", unit:"„ÅäÊ§Ä1ÊùØ", kcal:196, p:13, f:8.3, c:16.3, mg:50, fiber:2.0, cat:"Ëá™ÁÇä" },
  { id:7, name:"„Éñ„É´„Éº„Éô„É™„Éº„É®„Éº„Ç∞„É´„ÉàÔºà„Ç™„Éº„Éê„Éº„Éä„Ç§„Éà„Ç™„Éº„ÉÑÔºâ", unit:"ÂÖ®Èáè", kcal:510, p:28, f:17, c:73.7, mg:60, fiber:5.0, cat:"Ëá™ÁÇä" },
  { id:8, name:"È∂è„ÇÄ„Å≠„Ç≠„É£„Éô„ÉÑÈçã 1/3Èáè", unit:"1È£ü", kcal:246, p:33, f:6, c:17, mg:30, fiber:3.0, cat:"Ëá™ÁÇä" },
  // „Ç≥„É≥„Éì„Éã
  { id:10, name:"„Çª„Éñ„É≥ „Çè„Åã„ÇÅ„Åù„Å∞", unit:"1È£ü", kcal:278, p:16, f:1.5, c:54.2, mg:20, fiber:2.0, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:11, name:"„É≠„Éº„ÇΩ„É≥ „Ç≠„É£„É≥„Éá„Ç£„Éº„ÉÅ„Éº„Ç∫ „Éñ„É©„ÉÉ„ÇØ„Éö„ÉÉ„Éë„Éº", unit:"5Á≤í", kcal:87, p:5, f:7.2, c:0.5, mg:5, fiber:0, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:12, name:"„É≠„Éº„ÇΩ„É≥ „Çµ„É©„ÉÄ„ÉÅ„Ç≠„É≥„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ „Ç™„É™„Éº„Éñ&„ÉÅ„Éº„Ç∫", unit:"1Êú¨(60g)", kcal:98, p:11.1, f:4.4, c:3.5, mg:8, fiber:0, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:13, name:"„É≠„Éº„ÇΩ„É≥ ÁÇ≠ÁÅ´ÁÑº„Å™„Çì„Åì„Å§„Å§„Åè„Å≠ Èùí„Åò„Åù", unit:"1Ë¢ã(80g)", kcal:128, p:13.9, f:6.2, c:4.5, mg:8, fiber:0.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:14, name:"„É≠„Éº„ÇΩ„É≥ ÁÇô„ÇäÁÜüÊàêÁ¥ÖÈÆ≠„Åä„Å´„Åé„Çä", unit:"1ÂÄã", kcal:174, p:4.6, f:1.7, c:35.7, mg:8, fiber:0.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:15, name:"„Çª„Éñ„É≥ ÊâãÂ∑ª„Åä„Å´„Åé„Çä È∂è„Åù„Åº„Çç", unit:"1ÂÄã", kcal:192, p:6.2, f:1.9, c:38.4, mg:8, fiber:0.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:16, name:"„Çª„Éñ„É≥ Á†ÇËÇù„ÅÆÁÇ≠ÁÅ´ÁÑº", unit:"1Ë¢ã(70g)", kcal:101, p:20.4, f:1.7, c:0.9, mg:10, fiber:0, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:17, name:"„Çª„Éñ„É≥ „Çπ„É≥„Éâ„Ç•„Éñ„ÉÅ„Ç≤", unit:"1È£ü", kcal:190, p:18.6, f:9.7, c:8.6, mg:20, fiber:1.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:18, name:"„Çª„Éñ„É≥ Â§ßÂÖ•„ÇäË±ö„Åæ„Çì", unit:"1ÂÄã", kcal:340, p:11.5, f:12.4, c:46.5, mg:15, fiber:1.5, cat:"„Ç≥„É≥„Éì„Éã" },
  { id:19, name:"Â∞èÊûù„Éë„Ç§Ôºà„Çª„Éñ„É≥Ôºâ", unit:"1Êú¨(58g)", kcal:296, p:3, f:21.9, c:22.3, mg:15, fiber:1.0, cat:"„Ç≥„É≥„Éì„Éã" },
  // „Åä„ÇÑ„Å§
  { id:20, name:"ÂçóÈÉ®„Åõ„Çì„Åπ„ÅÑ ËêΩËä±Áîü", unit:"1Êûö", kcal:81, p:2.6, f:2.3, c:12.4, mg:15, fiber:0.5, cat:"„Åä„ÇÑ„Å§" },
  { id:21, name:"„ÅÜ„Åæ„ÅÑ„Åõ„Çì„Åπ„ÅÑ", unit:"1Êûö", kcal:80, p:1.8, f:0.2, c:17.8, mg:5, fiber:0.2, cat:"„Åä„ÇÑ„Å§" },
  { id:22, name:"„É≠„ÉÉ„ÉÜ „É™„ÉÉ„ÉÅ„Ç¢„Éº„É¢„É≥„Éâ„ÉÅ„Éß„Ç≥ „Éù„ÉÉ„Éó„Ç∏„Éß„Ç§", unit:"1Ë¢ã", kcal:203, p:3.8, f:13.5, c:16.5, mg:20, fiber:1.5, cat:"„Åä„ÇÑ„Å§" },
  { id:23, name:"„É≠„ÉÉ„ÉÜ „ÇØ„É©„É≥„Ç≠„Éº„Éù„ÉÉ„Éó„Ç∏„Éß„Ç§", unit:"1Ë¢ã(44g)", kcal:248, p:3, f:15.3, c:24.6, mg:15, fiber:1.0, cat:"„Åä„ÇÑ„Å§" },
  { id:24, name:"„Çπ„Éã„ÉÉ„Ç´„Éº„Ç∫", unit:"1Êú¨(51g)", kcal:248, p:4.4, f:12.2, c:29.5, mg:15, fiber:1.0, cat:"„Åä„ÇÑ„Å§" },
  // „Éï„É´„Éº„ÉÑ
  { id:30, name:"„Çπ„Ç¶„Ç£„Éº„ÉÜ„Ç£„Ç™ „Éë„Ç§„Éä„ÉÉ„Éó„É´Ôºà„ÅÑ„Å§„ÇÇ„ÅÆÈáèÔºâ", unit:"140g", kcal:75, p:1, f:0, c:19, mg:15, fiber:2.0, cat:"„Éï„É´„Éº„ÉÑ" },
  // Ë™øÂë≥Êñô
  { id:40, name:"„Éê„Çø„ÉºÔºàËñÑÂ°ó„ÇäÔºâ", unit:"Á¥Ñ5g", kcal:37, p:0, f:4.1, c:0, mg:0, fiber:0, cat:"Ë™øÂë≥Êñô" },
];

// ======== SUPPLEMENTS ========
const SUPPLEMENTS = [
  { id:"m1", timing:"morning",   name:"„É¶„É™„Çπ",               note:"Âá¶ÊñπËñ¨ÔºàÂ∞øÈÖ∏ÂÄ§Ôºâ",         catchup:true },
  { id:"m2", timing:"morning",   name:"„Éû„É´„ÉÅ„Éì„Çø„Éü„É≥",         note:"",                        catchup:true },
  { id:"m3", timing:"morning",   name:"CoQ10",                note:"",                        catchup:true },
  { id:"m4", timing:"morning",   name:"„Ç®„Éì„Ç™„Çπ 10Èå†",          note:"",                        catchup:false },
  { id:"m5", timing:"morning",   name:"Align or „Éì„Ç™„Çπ„É™„Éº",    note:"„Å©„Å°„Çâ„Åã1„Å§",              catchup:false },
  { id:"m6", timing:"morning",   name:"The Daily Power",      note:"È£≤„Åø„Åç„Çã„Åæ„Åß",              catchup:true },
  { id:"a1", timing:"afternoon", name:"„Çµ„Ç§„É™„Ç¶„É† 1ÂõûÁõÆÔºà5Á≤íÔºâ", note:"12:30„Åî„Çç ‚Äî „É¶„É™„Çπ„Åã„Çâ2hÂæå", catchup:false },
  { id:"a2", timing:"afternoon", name:"„Çµ„Ç§„É™„Ç¶„É† 2ÂõûÁõÆÔºà5Á≤íÔºâ", note:"15:00„Åî„Çç ‚Äî Â§ïÈ£ü„ÅÆËñ¨„Åæ„Åß3h", catchup:false },
  { id:"a3", timing:"afternoon", name:"„Çµ„Ç§„É™„Ç¶„É† 3ÂõûÁõÆÔºà5Á≤íÔºâ", note:"20:00„Åî„Çç ‚Äî „É≠„Çπ„Éê„Çπ„Çø„ÉÅ„É≥„Åã„Çâ2hÂæå", catchup:false },
  { id:"e1", timing:"evening",   name:"„É≠„Çπ„Éê„Çπ„Çø„ÉÅ„É≥",          note:"Âá¶ÊñπËñ¨Ôºà„Ç≥„É¨„Çπ„ÉÜ„É≠„Éº„É´ÔºâÂ§ïÈ£üÂæå", catchup:true },
  { id:"e2", timing:"evening",   name:"‰∫úÈâõ (THORNE)",         note:"",                        catchup:true },
  { id:"e3", timing:"evening",   name:"„Ç®„Éì„Ç™„Çπ 10Èå†",           note:"",                        catchup:false },
  { id:"e4", timing:"evening",   name:"„Éì„Ç™„Çπ„É™„Éº 2Èå†",          note:"",                        catchup:false },
  { id:"b1", timing:"bedtime",   name:"„Éû„Ç∞„Éç„Ç∑„Ç¶„É†",            note:"1„Ç´„Éó„Çª„É´‚âí87.5mg„ÄÅÊúÄÂ§ß4„Ç´„Éó„Çª„É´", catchup:false },
];
const TIMING_LABELS = {
  morning:   "‚òÄÔ∏è ÊúùÔºà1È£üÁõÆÂæå„Éª10ÊôÇ„Åî„ÇçÔºâ",
  afternoon: "üïê È£üÈñìÔºàÊòº„ÄúÂçàÂæåÔºâ",
  evening:   "üåô Â§úÔºà2È£üÁõÆÂæå„Éª18ÊôÇ„Åî„ÇçÔºâ",
  bedtime:   "üõè Â∞±ÂØùÂâçÔºàÂ§ïÈ£ü2ÊôÇÈñìÂæåÔºâ",
};

// ======== TARGETS & MILESTONES ========
const TARGETS = { kcalMin:1700, kcalMax:1800, kcalFloor:1400, pMin:80, pMax:100, fMax:50, cMax:220, mgTarget:370, fiberTarget:21 };
// kcalFloor: „Å©„ÅãÈ£ü„ÅÑÈò≤Ê≠¢„ÅÆÊúÄ‰Ωé„É©„Ç§„É≥ÔºàÁõÆÊ®ô„ÅÆÁ¥Ñ82%Ôºâ
// Ê†πÊã†: BMR‚âí1,647kcal„ÄÇ1,700„ÅÆ85%=1,445 ‚Üí Âàá„Çä„Çà„Åè1,400„ÄÇ
// 1,227kcal„ÅØÁõÆÊ®ô„ÅÆ72%„ÅßÂº∑„ÅÑÈ£¢È§ìÊÑü‚ÜíÁøåÊó•„É™„Éê„Ç¶„É≥„ÉâÈ£ü„ÅÑ„ÇíË™òÁô∫„ÄÇ
const MILESTONES = [
  { label:"10Êó•Âæå„ÉÅ„Çß„ÉÉ„ÇØ",   weight:87.7, date:"2026-02-23" },
  { label:"20Êó•Âæå„ÉÅ„Çß„ÉÉ„ÇØ",   weight:87.0, date:"2026-03-05" },
  { label:"30Êó•Âæå„ÉÅ„Çß„ÉÉ„ÇØ",   weight:86.3, date:"2026-03-15" },
  { label:"60Êó•Âæå„ÉÅ„Çß„ÉÉ„ÇØ",   weight:84.25, date:"2026-04-14" },
  { label:"ËÑÇËÇ™ËÇùÊîπÂñÑÔºà7%Ê∏õÔºâ", weight:82.2, date:"2026-05-14" },
  { label:"80„ÅÆÂ£Å„ÇíÂàá„Çã",     weight:79.9, date:"2026-12-31" },
  { label:"ÊúÄÁµÇÁõÆÊ®ô 75kg",    weight:75.0, date:"2027-03-31" },
];
const START_WEIGHT = 88.0;
const GOAL_WEIGHT = 75.0;
const SUPPL_DOSING = {
  mg: { perCapsule: 87.5, maxCapsules: 4 },
  psyllium: { fiberPerCapsule: 0.55, capPerServing: 5, maxServings: 3 }
};

// ======== STATE ========
let currentTab = 'meals';
let currentDate = todayStr();
let searchResults = [];
let selectedFood = null;

function todayStr() {
  const d = new Date();
  return fmtDate(d);
}
function fmtDate(d) {
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function pad(n) { return String(n).padStart(2,'0'); }

function formatDateLabel(ds) {
  const [y,m,d] = ds.split('-').map(Number);
  const dow = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][new Date(y,m-1,d).getDay()];
  return `${m}/${d}Ôºà${dow}Ôºâ`;
}

// ======== STORAGE ========
function ls(key, val) {
  if (val === undefined) {
    try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
  }
  localStorage.setItem(key, JSON.stringify(val));
}

function getMeals(ds) {
  return (ls(`meals_${ds}`) || []).map(m => {
    if (m.kcal !== undefined) return m; // Ê≠£Â∏∏ÂΩ¢Âºè
    if (m.total) { // „Éç„Çπ„ÉàÂΩ¢Âºè ‚Üí „Éï„É©„ÉÉ„ÉàÂåñ
      const itemNames = m.items?.map(i => i.name).join('„ÄÅ') || m.type || 'È£ü‰∫ã';
      return { time: m.time, name: itemNames,
        kcal: m.total.kcal||0, p: m.total.p||0, f: m.total.f||0, c: m.total.c||0,
        mg: m.total.mg||0, fiber: m.total.fiber||0 };
    }
    return null; // Ë™≠„ÇÅ„Å™„ÅÑ„Éá„Éº„Çø„ÅØÈô§Â§ñ
  }).filter(Boolean);
}
function saveMeals(ds, meals) { ls(`meals_${ds}`, meals); }
function getWeights()      { return ls('weights')   || {}; }
function saveWeights(w)   { ls('weights', w); }
function getBodyFat()     { return ls('bodyFat')   || {}; }
function saveBodyFat(bf)  { ls('bodyFat', bf); }
function getDailyKcal()   { return ls('dailyKcal') || {}; }
function saveDailyKcal(d) { ls('dailyKcal', d); }
function getSuppl(ds) { return ls(`suppl_${ds}`) || {}; }
function saveSuppl(ds, s) { ls(`suppl_${ds}`, s); }
function getSleepData() { return ls('sleep') || {}; }
function saveSleepData(s) { ls('sleep', s); }
function getCustomFoods() { return ls('custom_foods') || []; }
function saveCustomFoods(foods) { ls('custom_foods', foods); }
function getAllFoods() { return [...BUILT_IN_FOODS, ...getCustomFoods()]; }

function stampLastUpdated() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const el = document.getElementById('header-clock');
  if (el) el.textContent = `${hh}:${mm} Êõ¥Êñ∞`;
}

// ======== SERVER SYNC ========
const DATA_BASE_URL = 'https://shujiuyeda.github.io/web/data/';

async function tryFetchMeals(ds) {
  const existing = getMeals(ds);
  // kcalÊú™ÂÆöÁæ©Ôºà„Éç„Çπ„ÉàÂΩ¢Âºè„ÅÆÁîü„Éá„Éº„ÇøÔºâ„Åæ„Åü„ÅØmgÊú™ÂÆöÁæ©„ÅÆÂè§„ÅÑ„Éá„Éº„Çø„ÅØ„Çµ„Éº„Éê„Éº„Åã„Çâ‰∏äÊõ∏„ÅçÂèñÂæó„Åô„Çã
  const hasNestedData = existing.some(m => m.kcal === undefined);
  const needsRefresh = existing.some(m => m.mg === undefined) || hasNestedData;
  if (existing.length > 0 && !needsRefresh) return;
  try {
    const res = await fetch(`${DATA_BASE_URL}meals-${ds}.json`, { cache: 'no-store' });
    if (!res.ok) {
      // 404Á≠â„ÅßJSON„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅ„Éç„Çπ„ÉàÂΩ¢Âºè„ÅÆÂ£ä„Çå„Åü„Éá„Éº„Çø„ÅØÂâäÈô§„Åô„Çã
      if (hasNestedData) { saveMeals(ds, []); if (ds === currentDate) switchTab(currentTab); }
      return;
    }
    const data = await res.json();
    if (!data.meals || data.meals.length === 0) return;
    // JSON„ÅÆ„Éç„Çπ„ÉàÊßãÈÄ† {items, total:{kcal,p,f,c}} „Çí„Ç¢„Éó„É™ÂÜÖÂΩ¢Âºè {kcal,p,f,c} „Å´„Éï„É©„ÉÉ„ÉàÂåñ
    const normalized = data.meals.map(m => {
      if (m.total && m.kcal === undefined) {
        const itemNames = m.items?.map(i => i.name).join('„ÄÅ') || m.type || 'È£ü‰∫ã';
        const mgSum = m.total.mg || m.items?.reduce((s, i) => s + (i.mg || 0), 0) || 0;
        const fiberSum = m.total.fiber || m.items?.reduce((s, i) => s + (i.fiber || 0), 0) || 0;
        return { time: m.time, name: itemNames, kcal: m.total.kcal||0, p: m.total.p||0, f: m.total.f||0, c: m.total.c||0, mg: mgSum, fiber: fiberSum };
      }
      return m;
    });
    saveMeals(ds, normalized);
    stampLastUpdated();
    if (ds === currentDate) deferRender(currentTab);
    else if (currentTab === 'weight') deferRender('weight'); // ‰ΩìÈáç„Çø„Éñ„ÇÇÂÜçÊèèÁîª
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}

async function tryFetchSuppl(ds) {
  try {
    const res = await fetch(`${DATA_BASE_URL}suppl-${ds}.json`, { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json();
    if (!data.checks || Object.keys(data.checks).length === 0) return;
    const local = getSuppl(ds);
    let updated = false;
    Object.entries(data.checks).forEach(([k, v]) => {
      if (local[k] == null) { local[k] = v; updated = true; }
    });
    if (updated || Object.keys(local).length === 0) {
      saveSuppl(ds, Object.keys(local).length > 0 ? local : data.checks);
      stampLastUpdated();
      if (ds === currentDate && currentTab === 'supplements') deferRender(currentTab);
    }
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}

async function tryFetchDailyKcal() {
  try {
    const res = await fetch(`${DATA_BASE_URL}daily-kcal.json`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    const local = getDailyKcal();
    let updated = false;
    Object.entries(remote).forEach(([ds, kcal]) => {
      if (local[ds] == null) { local[ds] = kcal; updated = true; }
    });
    if (updated) {
      saveDailyKcal(local);
      if (currentTab === 'weight') deferRender('weight');
    }
  } catch { /* silent */ }
}

async function tryFetchWeights() {
  try {
    const res = await fetch(`${DATA_BASE_URL}weights.json`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    let updated = false;

    // ‰ΩìÈáç„Éû„Éº„Ç∏Ôºàlocal„ÅåÂÑ™ÂÖàÔºâ
    const localW = getWeights();
    const remoteW = remote.weights || remote; // Êóß„Éï„Ç©„Éº„Éû„ÉÉ„Éà‰∫íÊèõ
    Object.entries(remoteW).forEach(([ds, w]) => {
      if (localW[ds] == null) { localW[ds] = w; updated = true; }
    });
    if (updated) saveWeights(localW);

    // ‰ΩìËÑÇËÇ™„Éû„Éº„Ç∏Ôºàlocal„ÅåÂÑ™ÂÖàÔºâ
    if (remote.bodyFat) {
      const localBF = getBodyFat();
      let bfUpdated = false;
      Object.entries(remote.bodyFat).forEach(([ds, bf]) => {
        if (localBF[ds] == null) { localBF[ds] = bf; bfUpdated = true; }
      });
      if (bfUpdated) saveBodyFat(localBF);
      updated = updated || bfUpdated;
    }

    if (updated) {
      stampLastUpdated();
      if (currentTab === 'weight') deferRender('weight');
    }
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}

async function tryFetchShopping() {
  try {
    const res = await fetch(`${DATA_BASE_URL}shopping.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    if (!remote.items) return;
    // remote„ÇíÊ≠£Ôºàsource of truthÔºâ„Å®„Åó„Å¶‰∏äÊõ∏„ÅçÔºà„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÅØ shopping_checks „ÅßÂà•ÁÆ°ÁêÜÔºâ
    localStorage.setItem('shopping_items', JSON.stringify(remote.items));
    if (currentTab === 'shopping') deferRender('shopping');
  } catch { /* silent */ }
}

async function tryFetchSleep() {
  try {
    const res = await fetch(`${DATA_BASE_URL}sleep.json`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    const local = getSleepData();
    let updated = false;
    Object.entries(remote).forEach(([ds, s]) => {
      // „É≠„Éº„Ç´„É´„Å´„Å™„ÅÑ or „É™„É¢„Éº„Éà„Å´„Çø„Ç§„É†„É©„Ç§„É≥„Åå„ÅÇ„Å£„Å¶„É≠„Éº„Ç´„É´„Å´„Å™„ÅÑÂ†¥Âêà„ÅØÊõ¥Êñ∞
      if (local[ds] == null || (s.timeline && !local[ds].timeline)) {
        local[ds] = s; updated = true;
      }
    });
    if (updated) {
      saveSleepData(local);
      stampLastUpdated();
      if (currentTab === 'sleep') deferRender('sleep');
    }
  } catch { /* silent */ }
}

// ======== ADVICE ========
let adviceData = null;

async function tryFetchAdvice() {
  try {
    const res = await fetch(`${DATA_BASE_URL}advice.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json();
    adviceData = data;
    if (['meals','supplements','weight','sleep'].includes(currentTab)) {
      deferRender(currentTab);
    }
  } catch { /* silent */ }
}

function isAdviceStale() {
  if (!adviceData?.generated) return true;
  return (Date.now() - new Date(adviceData.generated).getTime()) > 24 * 60 * 60 * 1000;
}

function renderOverallBanner() {
  if (!adviceData?.overall) return '';
  const stale = isAdviceStale();
  const o = adviceData.overall;
  const score = o.score ?? 0;
  return `
    <div class="advice-card${stale ? ' stale' : ''}">
      <div class="advice-card-label">üåø ‰ªäÊó•„ÅÆÂÅ•Â∫∑„Çπ„Ç≥„Ç¢</div>
      <div class="advice-headline">${esc(o.headline)}</div>
      <div class="advice-score-row">
        <span class="advice-score-num">${score}</span>
        <div class="advice-score-meta">
          <div class="advice-score-bar"><div class="advice-score-fill" style="width:${score}%;"></div></div>
          <div style="font-size:10px;opacity:0.6;">/ 100</div>
        </div>
      </div>
      ${o.topAction ? `<div class="advice-top-action">‚ö° ‰ªä„Åô„Åê„ÇÑ„Çã„Åì„Å®Ôºö${esc(o.topAction)}</div>` : ''}
      ${stale ? '<div class="advice-stale-note">24ÊôÇÈñì‰ª•‰∏äÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>' : ''}
    </div>`;
}

function renderAdviceCard(tab) {
  if (!adviceData) return '';
  const stale = isAdviceStale();
  const data = adviceData[tab];
  const cross = (adviceData.crossDomain || []).filter(x => !x.relatedTabs || x.relatedTabs.includes(tab));
  if (!data && !cross.length) return '';
  let html = `<div class="advice-card${stale ? ' stale' : ''}"><div class="advice-card-label">ü§ñ AIÂàÜÊûê</div>`;
  if (data) {
    if (data.insight) html += `<div class="advice-insight">${esc(data.insight)}</div>`;
    if (tab === 'sleep' && data.weekTrend) html += `<div class="advice-week-trend">${esc(data.weekTrend)}</div>`;
    if (data.tips?.length) html += `<ul class="advice-tips">${data.tips.map(t => `<li>${esc(t)}</li>`).join('')}</ul>`;
    if (data.correlation) html += `<div class="advice-box">üí° ${esc(data.correlation)}</div>`;
    if (data.projection) html += `<div class="advice-box green">üìà ${esc(data.projection)}</div>`;
  }
  cross.forEach(item => {
    html += `<div class="advice-box" style="margin-top:8px;">üîó <strong>${esc(item.title)}</strong><br><span style="opacity:0.9;">${esc(item.body)}</span></div>`;
  });
  if (stale) html += '<div class="advice-stale-note">„Éá„Éº„ÇøÊõ¥Êñ∞ÂæÖ„Å°</div>';
  html += '</div>';
  return html;
}

// ======== INIT ========
function init() {
  document.getElementById('header-date').textContent = formatDateLabel(currentDate);
  stampLastUpdated();
  const hash = location.hash.replace('#', '');
  const startTab = ['meals','supplements','weight','shopping','sleep'].includes(hash) ? hash : 'meals';
  switchTab(startTab);
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/web/sw.js').catch(() => {});
  }
  // ÈÅéÂéª10Êó•ÂàÜ„ÅÆ„Éá„Éº„Çø„Çí„Çµ„Éº„Éê„Éº„Åã„ÇâËá™Âãï„É≠„Éº„Éâ
  for (let i = 0; i < 10; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    tryFetchMeals(ds);
    if (i < 2) tryFetchSuppl(ds); // „Çµ„Éó„É™„ÅØ‰ªäÊó•„ÉªÊò®Êó•„ÅÆ„Åø
  }
  tryFetchWeights();
  tryFetchDailyKcal();
  tryFetchShopping();
  tryFetchSleep();
  tryFetchAdvice();
  initPullToRefresh();
  initSwipeNavigation();
}

// ======== PULL TO REFRESH ========
function initPullToRefresh() {
  const indicator = document.getElementById('ptr-indicator');
  const spinner   = document.getElementById('ptr-spinner');
  const THRESHOLD = 64; // pxÂºï„Å£Âºµ„Å£„Åü„ÇâÁô∫Âãï
  let startY = 0, pulling = false, refreshing = false;

  document.addEventListener('touchstart', e => {
    if (refreshing) return;
    if (window.scrollY === 0) {
      startY = e.touches[0].clientY;
      pulling = true;
    }
  }, { passive: true });

  document.addEventListener('touchmove', e => {
    if (!pulling || refreshing) return;
    const dy = e.touches[0].clientY - startY;
    if (dy <= 0) { pulling = false; return; }
    const progress = Math.min(dy / THRESHOLD, 1);
    indicator.classList.add('visible');
    spinner.style.transform = `rotate(${progress * 270}deg)`;
  }, { passive: true });

  document.addEventListener('touchend', e => {
    if (!pulling || refreshing) return;
    pulling = false;
    const dy = e.changedTouches[0].clientY - startY;
    if (dy < THRESHOLD) {
      indicator.classList.remove('visible');
      spinner.style.transform = '';
      return;
    }
    // Áô∫Âãï: „Çπ„Éî„Éä„ÉºÂõû„Åó„Å¶ÂÖ®„Éá„Éº„ÇøÂÜçÂèñÂæó
    refreshing = true;
    spinner.classList.add('spinning');
    const today = todayStr();
    const fetches = [];
    for (let i = 0; i < 10; i++) {
      const d = new Date(); d.setDate(d.getDate() - i);
      fetches.push(tryFetchMeals(fmtDate(d)));
      if (i < 2) fetches.push(tryFetchSuppl(fmtDate(d)));
    }
    fetches.push(tryFetchWeights(), tryFetchDailyKcal(), tryFetchShopping(), tryFetchSleep(), tryFetchAdvice());
    Promise.all(fetches).finally(() => {
      switchTab(currentTab);
      spinner.classList.remove('spinning');
      spinner.style.transform = '';
      setTimeout(() => indicator.classList.remove('visible'), 300);
      refreshing = false;
    });
  }, { passive: true });
}

// ======== SWIPE NAVIGATION ========
function initSwipeNavigation() {
  const TABS = ['meals', 'supplements', 'weight', 'sleep', 'shopping'];
  let startX = 0, startY = 0;
  const main = document.getElementById('main-content');

  main.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }, { passive: true });

  main.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    // Ê®™„Çπ„ÉØ„Ç§„ÉóÂà§ÂÆöÔºö60px‰ª•‰∏ä„Åã„Å§Á∏¶„Çà„ÇäÊ®™„ÅåÂ§ß„Åç„ÅÑ
    if (Math.abs(dx) < 60 || Math.abs(dy) > Math.abs(dx) * 0.75) return;
    const idx = TABS.indexOf(currentTab);
    if (dx < 0 && idx < TABS.length - 1) switchTab(TABS[idx + 1]); // Â∑¶„Çπ„ÉØ„Ç§„Éó ‚Üí Ê¨°„ÅÆ„Çø„Éñ
    if (dx > 0 && idx > 0) switchTab(TABS[idx - 1]);               // Âè≥„Çπ„ÉØ„Ç§„Éó ‚Üí Ââç„ÅÆ„Çø„Éñ
  }, { passive: true });
}

// ======== TABS ========
// fetch„ÅåÂÆå‰∫Ü„Åô„Çã„Åü„Å≥„Å´Âç≥Â∫ß„Å´re-render„Åô„Çã„ÅÆ„ÇíÈò≤„ÅêÔºàÂàùÂõû„É≠„Éº„ÉâÊôÇ„ÅÆ10Âõû‰ª•‰∏ä„ÅÆ„Éï„É´DOMÂÜçÊèèÁîª„Çí1Âõû„Å´ÂâäÊ∏õÔºâ
let _renderTimer = null;
function deferRender(tab) {
  clearTimeout(_renderTimer);
  _renderTimer = setTimeout(() => switchTab(tab), 80);
}

function switchTab(tab) {
  currentTab = tab;
  location.hash = tab;
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById('fab-add').classList.toggle('hidden', tab !== 'meals');
  const main = document.getElementById('main-content');
  main.innerHTML = '';
  if (tab === 'meals') renderMeals(main);
  else if (tab === 'supplements') renderSuppl(main);
  else if (tab === 'weight') renderWeight(main);
  else if (tab === 'shopping') renderShopping(main);
  else if (tab === 'sleep') renderSleep(main);
}

function changeDate(delta) {
  const d = new Date(currentDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  const nd = fmtDate(d);
  if (nd > todayStr()) return;
  currentDate = nd;
  document.getElementById('header-date').textContent = formatDateLabel(currentDate);
  switchTab(currentTab);
  tryFetchMeals(nd);
  tryFetchSuppl(nd);
}

// ======== MEALS TAB ========
function renderMeals(container) {
  const meals = getMeals(currentDate);
  const t = totals(meals);
  const isToday = currentDate === todayStr();
  const kcalOver     = t.kcal > TARGETS.kcalMax;
  const remaining    = TARGETS.kcalMax - t.kcal;
  const floorGap     = TARGETS.kcalFloor - t.kcal; // Ë≤†„Å™„ÇâÊúÄ‰Ωé„É©„Ç§„É≥ÈÅîÊàêÊ∏à„Åø
  const hour         = new Date().getHours();
  const floorRisk    = isToday && floorGap > 0 && hour >= 20; // 20ÊôÇ‰ª•Èôç„ÅßÊú™ÈÅî
  const floorMsg     = hour >= 22
    ? `Â§úÈÅÖ„ÅÑ„ÅÆ„Åß‰ªäÂ§ú„ÅØÁÑ°ÁêÜ„Åõ„Åö„ÄÅÊòéÊó•„ÅÆÂçàÂâç‰∏≠„Å´„Çø„É≥„Éë„ÇØË≥™„Çí„Åó„Å£„Åã„ÇäÊëÇ„Å£„Å¶`
    : `ÊòéÊó•„ÅÆ„É™„Éê„Ç¶„É≥„ÉâÈò≤Ê≠¢„Å´„ÄÅÊ∂àÂåñ„ÅÆËâØ„ÅÑ„ÇÇ„ÅÆ„ÅßË£úÂÖÖ„Çí`;

  // Date nav
  let html = '';
  html += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
  `;

  // AI Overall banner
  html += renderOverallBanner();

  // Kcal summary card
  html += `
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <div class="kcal-display" style="margin-bottom:0;">
          <span class="kcal-num ${kcalOver ? 'over' : ''}">${Math.round(t.kcal)}</span>
          <span class="kcal-unit">kcal</span>
          <span class="kcal-target">/ ${TARGETS.kcalMin}„Äú${TARGETS.kcalMax}</span>
        </div>
        ${isToday ? `<button onclick="toggleMealAdvice()" style="font-size:11px;background:var(--green-pale);color:var(--green-dark);border:1px solid var(--green-light);border-radius:12px;padding:5px 10px;white-space:nowrap;cursor:pointer;flex-shrink:0;-webkit-tap-highlight-color:transparent;">‰ªäÈ£ü„Åπ„Çã„Å™„Çâ</button>` : ''}
      </div>
      <div id="meal-advice-panel" style="display:none;margin-top:10px;padding:10px;background:#F8FFF9;border-radius:10px;font-size:13px;line-height:1.7;border:1px solid var(--green-light);"></div>
      <div class="remaining" style="margin-top:6px;">
        ${remaining >= 0
          ? `„ÅÇ„Å® <strong>${Math.round(remaining)}</strong> kcal`
          : `<span style="color:var(--danger)">Ë∂ÖÈÅé <strong>${Math.round(-remaining)}</strong> kcal</span>`
        }
      </div>
      <div style="margin-top:5px;font-size:12px;display:flex;align-items:center;gap:6px;">
        <span style="color:var(--text-muted);">ÊúÄ‰Ωé„É©„Ç§„É≥ ${TARGETS.kcalFloor} kcal</span>
        ${floorGap <= 0
          ? `<span style="color:var(--green-mid);font-weight:600;">‚úì ÈÅîÊàê</span>`
          : floorRisk
            ? `<span style="color:#C0392B;font-weight:600;">‚ö† „ÅÇ„Å®${Math.round(floorGap)}kcal ‚Äî ${floorMsg}</span>`
            : `<span style="color:var(--text-muted);">„ÅÇ„Å®${Math.round(floorGap)}kcal</span>`
        }
      </div>
      <div class="macros-row">
        ${macroCard('„Åü„Çì„Å±„ÅèË≥™', t.p, `${TARGETS.pMin}-${TARGETS.pMax}g`, t.p > TARGETS.pMax ? 'over' : t.p >= TARGETS.pMin ? 'ok' : 'warn')}
        ${macroCard('ËÑÇË≥™', t.f, `„Äú${TARGETS.fMax}g`, t.f > TARGETS.fMax ? 'over' : 'ok')}
        ${macroCard('ÁÇ≠Ê∞¥ÂåñÁâ©', t.c, `„Äú${TARGETS.cMax}g`, t.c > TARGETS.cMax ? 'over' : 'ok')}
      </div>
    </div>
  `;

  // AI Meals advice card
  html += renderAdviceCard('meals');

  // Supplement guide card
  html += supplGuideHtml(t);

  // Nutrion progress bars
  html += `
    <div class="card">
      <div class="card-title">Ê†ÑÈ§ä„Éê„É©„É≥„Çπ</div>
      ${nutrBar('„Ç´„É≠„É™„Éº', t.kcal, TARGETS.kcalMax, 'kcal', t.kcal > TARGETS.kcalMax ? 'over' : t.kcal > TARGETS.kcalMin ? 'ok' : 'warn')}
      ${nutrBar('„Åü„Çì„Å±„ÅèË≥™', t.p, TARGETS.pMax, 'g', t.p > TARGETS.pMax ? 'over' : t.p >= TARGETS.pMin ? 'ok' : 'warn')}
      ${nutrBar('ËÑÇË≥™', t.f, TARGETS.fMax, 'g', t.f > TARGETS.fMax ? 'over' : 'ok')}
      ${nutrBar('ÁÇ≠Ê∞¥ÂåñÁâ©', t.c, TARGETS.cMax, 'g', t.c > TARGETS.cMax ? 'over' : 'ok')}
      ${nutrBar('È£üÁâ©ÁπäÁ∂≠', t.fiber, TARGETS.fiberTarget, 'g', t.fiber >= TARGETS.fiberTarget ? 'ok' : 'warn')}
      ${nutrBar('„Éû„Ç∞„Éç„Ç∑„Ç¶„É†', t.mg, TARGETS.mgTarget, 'mg', t.mg >= TARGETS.mgTarget ? 'ok' : 'warn')}
    </div>
  `;

  // Meal list card
  let mealHtml = `<div class="card"><div class="card-title">È£ü‰∫ãË®òÈå≤</div>`;
  if (meals.length === 0) {
    mealHtml += `<div class="empty-state">
      <div class="empty-icon">üçΩÔ∏è</div>
      <div class="empty-text">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>Âè≥‰∏ã„ÅÆ Ôºã „ÅßËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>`;
  } else {
    mealHtml += `<div class="meal-list">`;
    meals.forEach((m, i) => {
      mealHtml += `
        <div class="meal-item">
          <span class="meal-time">${m.time}</span>
          <div class="meal-info">
            <div class="meal-name">${esc(m.name)}</div>
            <div class="meal-macros">P${m.p.toFixed(1)} F${m.f.toFixed(1)} C${m.c.toFixed(1)}</div>
          </div>
          <span class="meal-kcal">${Math.round(m.kcal)}</span>
          <button class="meal-del" onclick="deleteMeal(${i})">√ó</button>
        </div>`;
    });
    mealHtml += `</div>
      <div class="summary-row">
        <span class="summary-label">ÂêàË®à</span>
        <span class="summary-val">${Math.round(t.kcal)} kcal</span>
      </div>`;
  }
  mealHtml += `</div>`;
  html += mealHtml;

  // Import / Export buttons
  html += `
    <button class="import-btn" onclick="triggerFilePicker()">
      üì• ‰ªäÊó•„ÅÆË®òÈå≤„ÇíÂèñ„ÇäËæº„ÇÄÔºà01_ÂÅ•Â∫∑„É°„É¢.mdÔºâ
    </button>
    <button class="export-btn" onclick="exportMarkdown()">
      üìã ObsidianÁî®„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Çí„Ç≥„Éî„Éº
    </button>
    <div class="spacer"></div>
  `;
  container.innerHTML = html;
}

function macroCard(name, val, target, status) {
  return `
    <div class="macro-card">
      <div class="macro-name">${name}</div>
      <div class="macro-value ${status}">${val.toFixed(1)}<span class="unit">g</span></div>
      <div class="macro-target">ÁõÆÊ®ô: ${target}</div>
    </div>`;
}

function nutrBar(label, val, max, unit, status) {
  const pct = Math.min((val / max) * 100, 100);
  return `
    <div class="nutr-bar">
      <div class="nutr-bar-header">
        <span class="nutr-bar-label">${label}</span>
        <span class="nutr-bar-val">${label === '„Ç´„É≠„É™„Éº' ? Math.round(val) : val.toFixed(1)}${unit} / ${label === '„Ç´„É≠„É™„Éº' ? max : max}${unit}</span>
      </div>
      <div class="nutr-bar-track">
        <div class="nutr-bar-fill ${status}" style="width:${pct.toFixed(1)}%"></div>
      </div>
    </div>`;
}

function supplGuideHtml(t) {
  const fiberPct = Math.min(t.fiber / TARGETS.fiberTarget * 100, 100).toFixed(1);
  const mgPct    = Math.min(t.mg    / TARGETS.mgTarget    * 100, 100).toFixed(1);

  // --- È£üÁâ©ÁπäÁ∂≠ ---
  let fiberMsg;
  if (t.fiber >= TARGETS.fiberTarget) {
    fiberMsg = `<span style="color:var(--success);font-size:13px;">‚úÖ ÁõÆÊ®ôÈÅîÊàêÔºÅ„Çµ„Ç§„É™„Ç¶„É†‰∏çË¶Å</span>`;
  } else {
    const deficit = (TARGETS.fiberTarget - t.fiber).toFixed(1);
    const totalCapsNeeded = Math.ceil((TARGETS.fiberTarget - t.fiber) / SUPPL_DOSING.psyllium.fiberPerCapsule);
    const dailyMax = SUPPL_DOSING.psyllium.capPerServing * SUPPL_DOSING.psyllium.maxServings; // 15Á≤í
    if (totalCapsNeeded > dailyMax) {
      fiberMsg = `<span style="font-size:13px;color:var(--text-muted);">‰∏çË∂≥ <strong style="color:var(--text);">${deficit}g</strong> ‚Üí „ÅÇ„Å®<strong style="color:var(--accent);">${totalCapsNeeded}Á≤í</strong>ÂàÜÔºà‰ªäÊó•„ÅÆ‰∏äÈôê: ${dailyMax}Á≤íÔºâ</span>`;
    } else {
      fiberMsg = `<span style="font-size:13px;color:var(--text-muted);">‰∏çË∂≥ <strong style="color:var(--text);">${deficit}g</strong> ‚Üí „ÅÇ„Å®<strong style="color:var(--accent);">${totalCapsNeeded}Á≤í</strong></span>`;
    }
  }

  // --- „Éû„Ç∞„Éç„Ç∑„Ç¶„É† ---
  let mgMsg;
  if (t.mg >= TARGETS.mgTarget) {
    mgMsg = `<span style="color:var(--success);font-size:13px;">‚úÖ ÁõÆÊ®ôÈÅîÊàêÔºÅMg‰∏çË¶Å</span>`;
  } else {
    const deficitMg = Math.round(TARGETS.mgTarget - t.mg);
    const capsNeeded = Math.min(Math.ceil(deficitMg / SUPPL_DOSING.mg.perCapsule), SUPPL_DOSING.mg.maxCapsules);
    mgMsg = `<span style="font-size:13px;color:var(--text-muted);">‰∏çË∂≥ <strong style="color:var(--text);">${deficitMg}mg</strong> ‚Üí Â∞±ÂØùÂâç„Å´<strong style="color:var(--accent);">${capsNeeded}Á≤í</strong></span>`;
  }

  return `
    <div class="card">
      <div class="card-title">üíä „Çµ„Éó„É™Èáè„Ç¨„Ç§„Éâ</div>
      <div style="margin-bottom:14px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span style="font-size:13px;">üåæ È£üÁâ©ÁπäÁ∂≠</span>
          <span style="font-size:13px;font-weight:600;">${t.fiber.toFixed(1)}g / ${TARGETS.fiberTarget}g</span>
        </div>
        <div class="nutr-bar-track" style="margin-bottom:6px;"><div class="nutr-bar-fill ${t.fiber >= TARGETS.fiberTarget ? 'ok' : 'warn'}" style="width:${fiberPct}%"></div></div>
        ${fiberMsg}
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span style="font-size:13px;">üß≤ „Éû„Ç∞„Éç„Ç∑„Ç¶„É†</span>
          <span style="font-size:13px;font-weight:600;">${Math.round(t.mg)}mg / ${TARGETS.mgTarget}mg</span>
        </div>
        <div class="nutr-bar-track" style="margin-bottom:6px;"><div class="nutr-bar-fill ${t.mg >= TARGETS.mgTarget ? 'ok' : 'warn'}" style="width:${mgPct}%"></div></div>
        ${mgMsg}
      </div>
    </div>`;
}

function totals(meals) {
  return meals.reduce((a, m) => ({
    kcal: a.kcal + (m.kcal || 0), p: a.p + (m.p || 0), f: a.f + (m.f || 0), c: a.c + (m.c || 0),
    mg: a.mg + (m.mg || 0), fiber: a.fiber + (m.fiber || 0)
  }), {kcal:0, p:0, f:0, c:0, mg:0, fiber:0});
}

function deleteMeal(idx) {
  if (!confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  const meals = getMeals(currentDate);
  meals.splice(idx, 1);
  saveMeals(currentDate, meals);
  switchTab('meals');
}

function exportMarkdown() {
  const meals = getMeals(currentDate);
  if (!meals.length) { showToast('Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
  const t = totals(meals);
  const [,m,d] = currentDate.split('-').map(Number);
  let md = `### ${m}/${d}\n| ÊôÇÂàª | ÂÜÖÂÆπ | kcal | P | F | C |\n|------|------|------|---|---|---|\n`;
  meals.forEach(ml => {
    md += `| ${ml.time} | ${ml.name} | ${Math.round(ml.kcal)} | ${ml.p.toFixed(1)}g | ${ml.f.toFixed(1)}g | ${ml.c.toFixed(1)}g |\n`;
  });
  md += `| **ÂêàË®à** | | **${Math.round(t.kcal)}** | **${t.p.toFixed(1)}g** | **${t.f.toFixed(1)}g** | **${t.c.toFixed(1)}g** |\n`;
  md += `| **ÁõÆÊ®ô** | 1,700-1,800kcal | | **80-100g** | **„Äú50g** | **„Äú220g** |`;
  navigator.clipboard.writeText(md)
    .then(() => showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'))
    .catch(() => { const ta = document.createElement('textarea'); ta.value = md; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'); });
}

// ======== MEAL ADVICE ========
function toggleMealAdvice() {
  const panel = document.getElementById('meal-advice-panel');
  if (!panel) return;
  if (panel.style.display !== 'none') { panel.style.display = 'none'; return; }

  const meals = getMeals(currentDate);
  const t = totals(meals);
  const hour = new Date().getHours();
  const min  = new Date().getMinutes();
  const timeStr = `${hour}:${String(min).padStart(2,'0')}`;
  const remaining = Math.round(TARGETS.kcalMax - t.kcal);
  const pRemain   = Math.max(0, TARGETS.pMin - t.p);
  const fOver     = Math.max(0, t.f - TARGETS.fMax);
  const cRemain   = Math.max(0, TARGETS.cMax - t.c);
  const fiberShort = Math.max(0, TARGETS.fiberTarget - t.fiber);

  // ÊôÇÂàª„Åî„Å®„ÅÆÊñπÈáù
  let timeLine = '';
  if (hour < 12)       timeLine = 'ÂçàÂâç‰∏≠„Å™„ÅÆ„Åß„ÄÅ„Åó„Å£„Åã„ÇäÈ£ü„Åπ„Å¶„ÇÇÂ§ß‰∏àÂ§´„ÄÇ';
  else if (hour < 15)  timeLine = 'ÊòºÈ£üÂæå„ÅÆÊôÇÈñìÂ∏Ø„ÄÇËªΩ„ÅÑ„Åä„ÇÑ„Å§Á®ãÂ∫¶„Å™„Çâ‚óé„ÄÇ';
  else if (hour < 18)  timeLine = 'Â§ïÈ£üÂâç„ÄÇÈ£ü„Åπ„Åô„Åé„Çã„Å®Â§ïÈ£ü„Å´ÂΩ±Èüø„Åô„Çã„Åã„ÇÇ„ÄÇ';
  else if (hour < 20)  timeLine = 'Â§ïÈ£ü„Çø„Ç§„É†„ÄÇ„Éê„É©„É≥„Çπ„Çà„ÅèÈ£ü„Åπ„Çâ„Çå„Åæ„Åô„ÄÇ';
  else if (hour < 22)  timeLine = 'Â§ú„Å™„ÅÆ„ÅßÁÇ≠Ê∞¥ÂåñÁâ©„ÉªËÑÇË≥™„ÅØÊéß„Åà„ÇÅ„Å´„ÄÇÂâçÊó•„ÅÆÈ£ü„Åπ„Åô„Åé„Å´„ÅØÁøåÊó•Â§ïÊñπ„ÅÆÁ©∫ËÖπÊÑü„ÅåÈñ¢‰øÇ„Åô„Çã„Åì„Å®„ÅåÂ§ö„ÅÑ„ÄÇ';
  else                 timeLine = 'Ê∑±Â§ú„ÄÇÊ∂àÂåñ„Å∏„ÅÆË≤†ÊãÖ„ÇíËÄÉ„Åà„Å¶ËªΩ„ÅÑ„ÇÇ„ÅÆ„Å†„Åë„Å´„ÄÇÂâçÊó•Â∞ë„Å™„ÅÑ‚ÜíÁøåÂ§ï„ÅÆÁàÜÈ£ü„ÅÑ„ÇíÈò≤„Åê„Å´„ÅØ„ÄÅ‰ªäÂ§ú„Çà„ÇäÊòéÊó•„ÅÆÊúù„ÄúÊòº„ÅÆ„Çø„É≥„Éë„ÇØË≥™„ÅåÂ§ß‰∫ã„ÄÇ';

  // „Ç´„É≠„É™„ÉºÊÆã„ÇäÁä∂Ê≥Å
  let kcalLine = '';
  if (remaining < 0)        kcalLine = `‚ö†Ô∏è „Åô„Åß„Å´${-remaining}kcalË∂ÖÈÅé„ÄÇÈ£ü„Åπ„Çã„Å™„ÇâË∂Ö‰Ωé„Ç´„É≠„É™„Éº„ÅÆ„ÇÇ„ÅÆ„ÅÆ„Åø„ÄÇ`;
  else if (remaining < 150) kcalLine = `ÊÆã„Çä${remaining}kcal„Å®„Çè„Åö„Åã„ÄÇÈ£≤„ÅøÁâ©„Éª„Éä„ÉÉ„ÉÑÂ∞ëÈáè„Åè„Çâ„ÅÑ„ÅåÈôêÁïå„ÄÇ`;
  else if (remaining < 300) kcalLine = `ÊÆã„Çä${remaining}kcal„ÄÇËªΩÈ£ü1ÂìÅ„Å™„ÇâÂÖ•„Çä„Åæ„Åô„ÄÇ`;
  else if (remaining < 500) kcalLine = `ÊÆã„Çä${remaining}kcal„ÄÇÈ£ü‰∫ã1ÂìÅ„ÄÅ„Åæ„Åü„ÅØ„Åó„Å£„Åã„ÇäÁõÆ„ÅÆËªΩÈ£ü„Åå‚óé„ÄÇ`;
  else                      kcalLine = `ÊÆã„Çä${remaining}kcal„ÄÇÈ£ü‰∫ã1È£üÂàÜ„ÅÆ‰ΩôË£ï„ÅÇ„Çä„ÄÇ`;

  // Ê†ÑÈ§äÂÑ™ÂÖàÂ∫¶
  let nutrLines = [];
  if (pRemain > 5)    nutrLines.push(`ü•© „Åü„Çì„Å±„ÅèË≥™„Åå„ÅÇ„Å®${pRemain.toFixed(0)}g‰∏çË∂≥ ‚Üí Âçµ„ÉªË±ÜËÖê„ÉªÈ∂è„ÇÄ„Å≠„ÉªÈ≠ö„Åå„Åä„Åô„Åô„ÇÅ`);
  if (fOver > 3)      nutrLines.push(`üõë ËÑÇË≥™„Åå${fOver.toFixed(0)}gË∂ÖÈÅé‰∏≠ ‚Üí Êèö„ÅíÁâ©„Éª„Éê„Çø„ÉºÁ≥ª„ÅØÈÅø„Åë„Å¶`);
  if (fiberShort > 3) nutrLines.push(`ü•¶ È£üÁâ©ÁπäÁ∂≠„Åå„ÅÇ„Å®${fiberShort.toFixed(1)}g‰∏çË∂≥ ‚Üí „Åç„ÅÆ„Åì„ÉªÊµ∑Ëóª„ÉªÈáéËèú„Çí„Éó„É©„Çπ„Åô„Çã„Å®‚óé`);
  if (cRemain < 20 && cRemain >= 0) nutrLines.push(`üçö ÁÇ≠Ê∞¥ÂåñÁâ©„ÅÆÊÆã„ÇäÊû†„ÅåÂ∞ë„Å™„ÅÑÔºàÊÆã„Çä${cRemain.toFixed(0)}gÔºâ„ÄÇ„ÅîÈ£Ø„Éª„Éë„É≥„ÅØÊéß„Åà„ÇÅ„Å´`);

  // „Åä„Åô„Åô„ÇÅÈ£üÊùêÔºàÊÆã„Çä„Ç´„É≠„É™„Éº„Å®„Åü„Çì„Å±„ÅèË≥™‰∏çË∂≥„Åã„ÇâÔºâ
  let recommend = '';
  if (remaining < 0) {
    recommend = '„Éñ„É©„ÉÉ„ÇØ„Ç≥„Éº„Éí„Éº„Éª„ÅäËå∂„ÉªÊ∞¥ „ÅÆ„ÅøÊé®Â•®';
  } else if (remaining < 150) {
    recommend = '„ÇÜ„ÅßÂçµ1ÂÄãÔºà77kcalÔºâ/ „Éó„É≠„ÉÜ„Ç§„É≥„Éê„ÉºÂçäÂàÜ / „Éä„ÉÉ„ÉÑ10Á≤íÁ®ãÂ∫¶';
  } else if (pRemain > 10 && remaining >= 150) {
    recommend = 'È∂è„ÇÄ„Å≠Ôºà100g„ÅßÁ¥Ñ110kcal/P23gÔºâ/ Ë±ÜËÖêÔºà150g„ÅßÁ¥Ñ85kcal/P7gÔºâ/ „ÇÜ„ÅßÂçµ2ÂÄãÔºà154kcal/P13gÔºâ/ Âà∫Ë∫´';
  } else if (pRemain > 0 && fOver < 3) {
    recommend = '„É®„Éº„Ç∞„É´„Éà / „ÉÅ„Éº„Ç∫ / ÂçµÊñôÁêÜ / Ëí∏„ÅóÈ∂è';
  } else {
    recommend = 'ÈáéËèú„Çπ„Éº„Éó / Ë±ÜËÖê / Êµ∑Ëóª„Çµ„É©„ÉÄ / „Åç„ÅÆ„ÅìÁÇí„ÇÅ';
  }

  const floorStatus = remaining >= (TARGETS.kcalMax - TARGETS.kcalFloor)
    ? `<div style="margin-top:8px;padding:6px 8px;background:#FFF3CD;border-radius:8px;font-size:12px;color:#856404;">‚ö† ÊúÄ‰Ωé„É©„Ç§„É≥Ôºà${TARGETS.kcalFloor}kcalÔºâÊú™ÈÅî„ÄÇ„ÅÇ„Å®${Math.round(TARGETS.kcalFloor - t.kcal)}kcalÈ£ü„Åπ„Å™„ÅÑ„Å®ÊòéÊó•„ÅÆ„É™„Éê„Ç¶„É≥„ÉâÈ£ü„ÅÑ„É™„Çπ„ÇØ„ÅÇ„Çä„ÄÇ</div>`
    : `<div style="font-size:12px;color:var(--green-mid);margin-top:6px;">‚úì ÊúÄ‰Ωé„É©„Ç§„É≥Ôºà${TARGETS.kcalFloor}kcalÔºâ„ÇØ„É™„Ç¢Ê∏à„Åø</div>`;

  // Â§úÈñìË£úÂÖÖ„Ç¨„Ç§„ÉâÔºà20ÊôÇ‰ª•Èôç„ÉªÊúÄ‰Ωé„É©„Ç§„É≥+200kcalÊú™Ê∫Ä„ÅÆÊôÇ„Å´Ë°®Á§∫Ôºâ
  let nightGuide = '';
  if (hour >= 20 && t.kcal < TARGETS.kcalFloor + 200) {
    const toFloor = Math.round(TARGETS.kcalFloor - t.kcal);
    const needMore = toFloor > 0;
    // „Ç™„Ç§„Ç≥„Çπ(120) + „ÇÜ„ÅßÂçµ2ÂÄã(154) = 274kcal
    const oikosCombo = Math.round(t.kcal + 274);
    nightGuide = `
    <div style="margin-top:10px;padding:10px;background:#FFF8E1;border-radius:10px;border:1px solid #FFD54F;">
      <div style="font-weight:700;color:#856404;margin-bottom:6px;">üåô Â§ú„ÅÆË£úÂÖÖ„Ç¨„Ç§„Éâ</div>
      ${needMore
        ? `<div style="font-size:12px;margin-bottom:8px;">„ÅÇ„Å®<strong style="color:#C0392B;">${toFloor}kcal</strong>„ÅßÊúÄ‰Ωé„É©„Ç§„É≥„ÄÇÂâçÊó•Â∞ë„Å™„ÅÑ‚ÜíÁøåÂ§ï„Å´Áîò„ÅÑ„ÇÇ„ÅÆÁàÜÈ£ü„ÅÑ„ÅÆ„Éë„Çø„Éº„É≥Ê≥®ÊÑè„ÄÇ</div>`
        : `<div style="font-size:12px;margin-bottom:8px;color:var(--green-mid);">‚úì ÊúÄ‰Ωé„É©„Ç§„É≥ÈÅîÊàêÊ∏à„Åø„ÄÇÁÑ°ÁêÜ„Åó„Å¶È£ü„Åπ„Å™„Åè„Å¶„ÇÇOK„ÄÇ</div>`
      }
      <div style="font-size:13px;font-weight:700;color:#555;margin-bottom:2px;">üòå „ÅäËÖπ„ÅåÁ©∫„ÅÑ„Å¶„ÅÑ„Å™„ÅÑ„Å™„Çâ</div>
      <div style="font-size:12px;color:#666;margin-bottom:8px;padding-left:4px;">‰ªäÂ§ú„Çà„Çä<strong>ÊòéÊó•„ÅÆÊúù„ÄúÊòº„Å´„Çø„É≥„Éë„ÇØË≥™„Çí„Åó„Å£„Åã„ÇäÊëÇ„Çã</strong>„Åª„ÅÜ„Åå„É™„Éê„Ç¶„É≥„ÉâÈò≤Ê≠¢„Å´ÂäπÊûúÁöÑ„ÄÇ„Ç≥„É≥„Éì„Éã„Å∏Ë°å„Åè„Å™„Çâ<strong>ÊòéÊó•„ÅÆÊúùÈ£ü„ÇíÂÖà„Å´Ë≤∑„Å£„Å¶„Åä„Åè</strong>„ÅÆ„Åå‚óé</div>
      <div style="font-size:13px;font-weight:700;color:#555;margin-bottom:2px;">üçΩÔ∏è „ÅäËÖπ„ÅåÁ©∫„ÅÑ„Å¶„ÅÑ„Çã„Å™„Çâ</div>
      <div style="font-size:12px;color:#666;padding-left:4px;">Ê∂àÂåñ„Å´ËâØ„ÅÑ„Çø„É≥„Éë„ÇØË≥™„ÅßË£úÂÖÖÔºö<br>
        <strong>„Ç™„Ç§„Ç≥„Çπ</strong>ÔºàÁ¥Ñ120kcal / PÁ¥Ñ14gÔºâ<br>
        Ôºã <strong>„ÇÜ„ÅßÂçµ2ÂÄã</strong>Ôºà154kcal / PÁ¥Ñ13gÔºâ<br>
        ‚Üí ÂêàË®à +274kcal Ôºù ‰ªäÊó• <strong style="color:#333;">${oikosCombo}kcal</strong>
        ${oikosCombo >= TARGETS.kcalFloor ? ' <span style="color:var(--green-mid);font-weight:700;">‚úì ÊúÄ‰Ωé„É©„Ç§„É≥„ÇØ„É™„Ç¢</span>' : ''}
      </div>
    </div>`;
  }

  panel.innerHTML = `
    <div style="font-weight:700;margin-bottom:6px;color:var(--green-dark);">üïê ${timeStr} ÁèæÂú®„ÅÆÁä∂Ê≥Å</div>
    <div>${timeLine}</div>
    <div style="margin-top:4px;">${kcalLine}</div>
    ${floorStatus}
    ${nutrLines.length ? `<div style="margin-top:8px;">${nutrLines.join('<br>')}</div>` : ''}
    <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--green-light);">
      <span style="font-weight:700;color:var(--green-dark);">üí° ‰ªäÈ£ü„Åπ„Çã„Å™„ÇâÔºö</span><br>${recommend}
    </div>
    ${nightGuide}`;
  panel.style.display = 'block';
}

// ======== MODAL ========
function openModal() {
  selectedFood = null;
  searchResults = [];
  document.getElementById('modal-overlay').classList.remove('hidden');
  document.getElementById('food-search').value = '';
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('selected-box').classList.add('hidden');
  document.getElementById('custom-form').classList.add('hidden');
  setTimeout(() => document.getElementById('food-search').focus(), 150);
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
  selectedFood = null;
}

function onOverlayClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

function onFoodSearch(query) {
  const ac = document.getElementById('ac-list');
  if (!query.trim()) {
    ac.classList.add('hidden');
    document.getElementById('selected-box').classList.add('hidden');
    document.getElementById('custom-form').classList.add('hidden');
    return;
  }
  const q = query.toLowerCase();
  searchResults = getAllFoods().filter(f => f.name.toLowerCase().includes(q)).slice(0, 8);

  let html = '';
  searchResults.forEach((f, i) => {
    html += `<div class="ac-item" onclick="selectByIndex(${i})">
      <div><span>${esc(f.name)}</span><span class="ac-kcal">${f.kcal}kcal</span></div>
      <div class="ac-unit">${esc(f.unit)} / P${f.p}g F${f.f}g C${f.c}g</div>
    </div>`;
  });
  html += `<div class="ac-item" style="color:var(--text-muted);" onclick="showCustom()">üìù ÊâãÂãï„ÅßÂÖ•Âäõ...</div>`;
  ac.innerHTML = html;
  ac.classList.remove('hidden');
}

function selectByIndex(i) {
  const food = searchResults[i];
  if (!food) return;
  selectedFood = food;
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('custom-form').classList.add('hidden');
  document.getElementById('sel-name').textContent = food.name;
  document.getElementById('sel-unit').textContent = 'Âçò‰Ωç: ' + food.unit;
  document.getElementById('sel-kcal').textContent = food.kcal + 'kcal';
  document.getElementById('sel-pfc').textContent = `P${food.p}g F${food.f}g C${food.c}g`;
  document.getElementById('food-qty').value = 1;
  document.getElementById('selected-box').classList.remove('hidden');
  document.getElementById('food-search').value = food.name;
}

function showCustom() {
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('selected-box').classList.add('hidden');
  document.getElementById('custom-form').classList.remove('hidden');
  document.getElementById('c-name').value = document.getElementById('food-search').value;
  selectedFood = null;
}

function addFoodRecord() {
  const now = new Date();
  const time = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  let record;

  if (selectedFood) {
    const qty = parseFloat(document.getElementById('food-qty').value) || 1;
    record = {
      time,
      name: selectedFood.name + (qty !== 1 ? ` √ó${qty}` : ''),
      kcal: selectedFood.kcal * qty,
      p: selectedFood.p * qty,
      f: selectedFood.f * qty,
      c: selectedFood.c * qty,
      mg: (selectedFood.mg || 0) * qty,
      fiber: (selectedFood.fiber || 0) * qty,
    };
  } else {
    const name = document.getElementById('c-name').value.trim();
    if (!name) { showToast('È£üÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
    let kcal = parseFloat(document.getElementById('c-kcal').value) || 0;
    const p = parseFloat(document.getElementById('c-p').value) || 0;
    const f = parseFloat(document.getElementById('c-f').value) || 0;
    const c = parseFloat(document.getElementById('c-c').value) || 0;
    const unit = document.getElementById('c-unit').value || '1È£ü';
    const isFish = document.getElementById('is-fish').checked;
    if (isFish) kcal = kcal - (f * 9 * 0.3);
    const mg = parseFloat(document.getElementById('c-mg').value) || 0;
    const fiber = parseFloat(document.getElementById('c-fiber').value) || 0;
    record = { time, name: name + (isFish ? ' üêü' : ''), kcal, p, f, c, mg, fiber };
    // Save to custom DB
    const customs = getCustomFoods();
    if (!customs.find(x => x.name === name)) {
      customs.push({ id: Date.now(), name, unit, kcal, p, f, c, mg, fiber, cat:'„Ç´„Çπ„Çø„É†' });
      saveCustomFoods(customs);
    }
  }

  const meals = getMeals(currentDate);
  meals.push(record);
  saveMeals(currentDate, meals);
  closeModal();
  showToast('Ë®òÈå≤„Åó„Åæ„Åó„Åü ‚úì');
  switchTab('meals');
}

// ======== SUPPLEMENTS TAB ========
function renderSuppl(container) {
  const checks = getSuppl(currentDate);
  const isToday = currentDate === todayStr();
  const done    = SUPPLEMENTS.filter(s => checks[s.id] === true).length;
  const skipped = SUPPLEMENTS.filter(s => checks[s.id] === 'skip').length;
  const pct = Math.round((done / SUPPLEMENTS.length) * 100);

  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div class="card-title" style="margin-bottom:0;">‰ªäÊó•„ÅÆÊúçËñ¨„Éª„Çµ„Éó„É™</div>
        <div id="pct-display" style="font-size:24px;font-weight:700;color:${pct===100?'var(--green-mid)':'var(--text-muted)'};">${pct}%</div>
      </div>
      <div class="compliance-bar">
        <div class="compliance-fill ${pct===100?'full':''}" id="comp-fill" style="width:${pct}%;"></div>
      </div>
      <div id="comp-count" style="font-size:12px;color:var(--text-muted);text-align:center;">${done} / ${SUPPLEMENTS.length} ÂÆå‰∫Ü${skipped > 0 ? `„ÄÄ<span style="color:#856404;">ÔºàÈ£≤„ÅøÂøò„Çå ${skipped}‰ª∂Ôºâ</span>` : ''}</div>
    </div>
  `;

  // AI Supplements advice card
  container.innerHTML += renderAdviceCard('supplements');

  let html = `<div class="card">`;
  const timings = ['morning','afternoon','evening','bedtime'];
  timings.forEach(t => {
    const items = SUPPLEMENTS.filter(s => s.timing === t);
    html += `<div class="suppl-timing">${TIMING_LABELS[t]}</div>`;
    items.forEach(s => {
      const state = checks[s.id]; // true | 'skip' | falsy
      const isChecked = state === true;
      const isSkipped = state === 'skip';
      html += `
        <div class="suppl-item">
          <div class="suppl-check ${isChecked ? 'checked' : isSkipped ? 'skipped' : ''}" id="sc-${s.id}" onclick="toggleSuppl('${s.id}')"></div>
          <div class="suppl-label">
            <div class="suppl-name ${isChecked ? 'checked' : isSkipped ? 'skipped' : ''}" id="sn-${s.id}">${esc(s.name)}</div>
            ${s.note ? `<div class="suppl-note">${esc(s.note)}</div>` : ''}
          </div>
          ${!s.catchup ? `<div class="suppl-skip-btn ${isSkipped ? 'active' : ''}" id="ss-${s.id}" onclick="skipSuppl('${s.id}')">È£≤„ÅøÂøò„Çå</div>` : ''}
        </div>`;
    });
  });
  html += `</div><div class="spacer"></div>`;
  container.innerHTML += html;
}

function toggleSuppl(id) {
  const checks = getSuppl(currentDate);
  checks[id] = checks[id] === true ? false : true; // skipÁä∂ÊÖã„Åã„Çâ„Åß„ÇÇ„ÄåÈ£≤„Çì„Å†„Äç„Å´„Åß„Åç„Çã
  saveSuppl(currentDate, checks);
  const sc = document.getElementById(`sc-${id}`);
  const sn = document.getElementById(`sn-${id}`);
  const ss = document.getElementById(`ss-${id}`);
  if (sc) { sc.className = 'suppl-check' + (checks[id] ? ' checked' : ''); }
  if (sn) { sn.className = 'suppl-name'  + (checks[id] ? ' checked' : ''); }
  if (ss) ss.classList.remove('active');
  updateCompliance(checks);
}

function skipSuppl(id) {
  const checks = getSuppl(currentDate);
  checks[id] = checks[id] === 'skip' ? false : 'skip';
  saveSuppl(currentDate, checks);
  const sc = document.getElementById(`sc-${id}`);
  const sn = document.getElementById(`sn-${id}`);
  const ss = document.getElementById(`ss-${id}`);
  if (sc) { sc.className = 'suppl-check' + (checks[id] === 'skip' ? ' skipped' : ''); }
  if (sn) { sn.className = 'suppl-name'  + (checks[id] === 'skip' ? ' skipped' : ''); }
  if (ss) ss.classList.toggle('active', checks[id] === 'skip');
  updateCompliance(checks);
}

function updateCompliance(checks) {
  const done    = SUPPLEMENTS.filter(s => checks[s.id] === true).length;
  const skipped = SUPPLEMENTS.filter(s => checks[s.id] === 'skip').length;
  const pct = Math.round((done / SUPPLEMENTS.length) * 100);
  const fill  = document.getElementById('comp-fill');
  const pctEl = document.getElementById('pct-display');
  const cntEl = document.getElementById('comp-count');
  if (fill)  { fill.style.width = pct + '%'; fill.classList.toggle('full', pct===100); }
  if (pctEl) { pctEl.textContent = pct + '%'; pctEl.style.color = pct===100 ? 'var(--green-mid)' : 'var(--text-muted)'; }
  if (cntEl) { cntEl.innerHTML = `${done} / ${SUPPLEMENTS.length} ÂÆå‰∫Ü${skipped > 0 ? `„ÄÄ<span style="color:#856404;">ÔºàÈ£≤„ÅøÂøò„Çå ${skipped}‰ª∂Ôºâ</span>` : ''}`; }
}

// ======== WEIGHT TAB ========
function renderWeight(container) {
  const weights  = getWeights();
  const bodyFat  = getBodyFat();
  const isToday  = currentDate === todayStr();
  const todayW   = weights[currentDate]  ?? null;
  const todayBF  = bodyFat[currentDate]  ?? null;

  // Last 10 days
  const chartData = [];
  for (let i = 9; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    chartData.push({ ds, w: weights[ds] ?? null, bf: bodyFat[ds] ?? null });
  }

  // ÂâçÊó•ÊëÇÂèñ„Ç´„É≠„É™„Éº„Çí‰ªòÂä†Ôºàmeal„Éá„Éº„ÇøÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞dailyKcal„Çí„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
  const dailyKcal = getDailyKcal();
  chartData.forEach(row => {
    const prevD = new Date(row.ds + 'T12:00:00'); prevD.setDate(prevD.getDate() - 1);
    const prevDs = fmtDate(prevD);
    const prevMeals = getMeals(prevDs);
    const fromMeals = prevMeals.reduce((s, m) => s + (m.kcal || 0), 0);
    row.prevKcal = fromMeals > 0 ? fromMeals : (dailyKcal[prevDs] ?? null);
  });

  // 7Êó•Âπ≥Âùá„ÉªÂâçÈÄ±ÊØî„ÉªÂà§ÂÆö„ÇíË®àÁÆóÔºàÂÖ®‰ΩìÈáç„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
  chartData.forEach(row => {
    // 7Êó•Âπ≥ÂùáÔºà„Åù„ÅÆÊó•„ÇíÂê´„ÇÄÈÅéÂéª7Êó•Ôºâ
    let s = 0, c = 0;
    for (let j = 6; j >= 0; j--) {
      const d2 = new Date(row.ds + 'T12:00:00'); d2.setDate(d2.getDate() - j);
      const w = weights[fmtDate(d2)];
      if (w != null) { s += w; c++; }
    }
    row.avg7 = c > 0 ? s / c : null;

    // ÂâçÈÄ±ÊØîÁî®: 7Êó•Ââç„ÅÆ7Êó•Âπ≥Âùá
    let s2 = 0, c2 = 0;
    for (let j = 13; j >= 7; j--) {
      const d2 = new Date(row.ds + 'T12:00:00'); d2.setDate(d2.getDate() - j);
      const w = weights[fmtDate(d2)];
      if (w != null) { s2 += w; c2++; }
    }
    const prevAvg = c2 >= 4 ? s2 / c2 : null;

    if (row.avg7 != null && prevAvg != null) {
      row.weekDiff = row.avg7 - prevAvg;
      row.judge = row.weekDiff <= -0.25 ? '‚úÖ' : row.weekDiff < 0 ? '‚ñ≥' : '√ó';
    } else {
      row.weekDiff = null;
      row.judge = null;
    }
  });

  const latestW = todayW ?? chartData.slice().reverse().find(d => d.w != null)?.w ?? null;
  const progressPct = latestW
    ? Math.max(0, Math.min(100, ((START_WEIGHT - latestW) / (START_WEIGHT - GOAL_WEIGHT)) * 100))
    : 0;
  const nextMS = latestW ? MILESTONES.find(m => m.weight < latestW) : MILESTONES[0];

  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
  `;

  // Weight entry card
  let wHtml = `<div class="card"><div class="card-title">‰ΩìÈáç„ÇíË®òÈå≤</div>`;
  if (todayW) {
    wHtml += `<div class="weight-hero">
      <div class="weight-big">${todayW.toFixed(2)}<span class="wunit">kg</span></div>
      ${todayBF != null ? `<div style="font-size:15px;color:var(--text-muted);margin-top:2px;">‰ΩìËÑÇËÇ™Áéá ${todayBF.toFixed(1)}%</div>` : ''}
      <div class="weight-sub">${formatDateLabel(currentDate)}„ÅÆË®òÈå≤</div>
    </div>`;
  }
  wHtml += `<div class="weight-input-row">
    <input type="number" id="weight-input" class="form-input" style="flex:1;"
           placeholder="${todayW ?? '88.0'}" step="0.05" min="50" max="300"
           value="${todayW ?? ''}">
    <span style="font-size:14px;color:var(--text-muted);white-space:nowrap;">kg</span>
  </div>
  <div class="weight-input-row" style="margin-top:8px;">
    <input type="number" id="bf-input" class="form-input" style="flex:1;"
           placeholder="${todayBF ?? '31.0'}" step="0.1" min="5" max="60"
           value="${todayBF ?? ''}">
    <span style="font-size:14px;color:var(--text-muted);white-space:nowrap;">% ‰ΩìËÑÇËÇ™</span>
  </div>
  <button class="btn btn-primary" style="margin-top:10px;"
          onclick="saveWeight()">‰øùÂ≠ò</button>
  </div>`;
  container.innerHTML += wHtml;

  // AI Weight advice card
  container.innerHTML += renderAdviceCard('weight');

  // Goal progress
  if (latestW) {
    container.innerHTML += `
      <div class="card">
        <div class="card-title">75kg„Å∏„ÅÆÈÅì„ÅÆ„Çä</div>
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);margin-bottom:6px;">
          <span>ÈñãÂßã: ${START_WEIGHT}kg</span>
          <span>ÁèæÂú®: <strong style="color:var(--text);">${latestW.toFixed(2)}kg</strong></span>
          <span>ÁõÆÊ®ô: ${GOAL_WEIGHT}kg</span>
        </div>
        <div class="progress-main">
          <div class="progress-fill" style="width:${progressPct.toFixed(1)}%;"></div>
        </div>
        <div style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:4px;">
          ÁõÆÊ®ô„Åæ„Åß „ÅÇ„Å® <strong>${(latestW - GOAL_WEIGHT).toFixed(2)}kg</strong>ÔºàÈÄ≤Êçó ${progressPct.toFixed(1)}%Ôºâ
        </div>
        ${nextMS ? (() => {
          const msDate = new Date(nextMS.date + 'T00:00:00');
          const now = new Date(); now.setHours(0,0,0,0);
          const daysLeft = Math.ceil((msDate - now) / 86400000);
          const diffKg = (latestW - nextMS.weight).toFixed(1);
          const m = msDate.getMonth() + 1;
          const d = msDate.getDate();
          return `
        <div style="margin-top:12px;padding:10px;background:var(--green-pale);border-radius:10px;">
          <div style="font-size:13px;font-weight:700;color:var(--green-mid);">üéØ Ê¨°„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥</div>
          <div style="font-size:14px;margin-top:2px;">${nextMS.label}: <strong>${nextMS.weight}kg</strong></div>
          <div style="margin-top:6px;display:flex;align-items:baseline;gap:8px;">
            <span style="font-size:20px;font-weight:800;color:#333;">${m}Êúà${d}Êó•„Åæ„Åß</span>
            <span style="font-size:13px;color:var(--text-muted);">„ÅÇ„Å®<strong style="color:${daysLeft <= 3 ? 'var(--danger)' : '#856404'};font-size:16px;margin:0 2px;">${daysLeft}</strong>Êó•</span>
          </div>
          <div style="font-size:13px;color:var(--text-muted);margin-top:4px;">„ÅÇ„Å® <strong>${diffKg}kg</strong> ËêΩ„Å®„Åô</div>
        </div>`;
        })() : `
        <div style="margin-top:12px;padding:10px;background:var(--green-pale);border-radius:10px;text-align:center;font-size:15px;font-weight:700;color:var(--green-mid);">
          üéâ ÂÖ®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÅîÊàêÔºÅ
        </div>`}
      </div>`;
  }

  // Chart + 10-day table
  {
    let histHtml = `<div class="card"><div class="card-title">‰ΩìÈáçÊé®ÁßªÔºàÁõ¥Ëøë10Êó•Ôºâ</div>`;
    if (chartData.filter(d => d.w != null).length >= 2) {
      histHtml += buildWeightChart(chartData);
    }
    // 10-day tableÔºàÊñ∞‚ÜíÂè§ „ÅÆÈ†Ü„ÅßË°®Á§∫Ôºâ
    const th = (label, align='right') =>
      `<th style="text-align:${align};padding:4px 4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);white-space:nowrap;">${label}</th>`;
    histHtml += `<table style="width:100%;border-collapse:collapse;margin-top:12px;font-size:12px;">
      <thead><tr>
        ${th('Êó•‰ªò','left')}${th('ÂâçÊó•kcal')}${th('‰ΩìÈáç')}${th('‰ΩìËÑÇËÇ™')}${th('7Êó•Âπ≥Âùá')}${th('Âà§ÂÆö')}
      </tr></thead><tbody>`;
    [...chartData].reverse().forEach(row => {
      const isToday2 = row.ds === todayStr();
      const judgeColor = row.judge === '‚úÖ' ? 'var(--green-mid)' : row.judge === '‚ñ≥' ? '#E5A020' : row.judge === '√ó' ? '#C0392B' : 'var(--text-muted)';
      const judgeStr = row.judge != null
        ? `<span style="color:${judgeColor};font-weight:700;">${row.judge}</span><br><span style="font-size:10px;color:var(--text-muted);">${row.weekDiff > 0 ? '+' : ''}${row.weekDiff.toFixed(2)}</span>`
        : '‚Äî';
      histHtml += `<tr style="${isToday2 ? 'background:var(--green-pale);' : ''}">
        <td style="padding:5px 4px;white-space:nowrap;">${row.ds.slice(5).replace('-','/')}${isToday2 ? '&nbsp;<span style="font-size:9px;color:var(--green-mid);">TODAY</span>' : ''}</td>
        <td style="text-align:right;padding:5px 4px;color:var(--text-muted);">${row.prevKcal != null ? row.prevKcal.toLocaleString() : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;font-weight:${row.w ? '600' : '400'}">${row.w != null ? row.w.toFixed(2) : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;color:var(--text-muted);">${row.bf != null ? row.bf.toFixed(1) + '%' : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;">${row.avg7 != null ? row.avg7.toFixed(2) : '‚Äî'}</td>
        <td style="text-align:center;padding:5px 4px;line-height:1.3;">${judgeStr}</td>
      </tr>`;
    });
    histHtml += `</tbody></table>
    <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">Âà§ÂÆö: ‚úÖ -0.25kg‰ª•‰∏äÊ∏õ Ôºè ‚ñ≥ ÂæÆÊ∏õ Ôºè √ó Â¢óÂä†Ôºà7Êó•Âπ≥Âùá„ÅÆÂâçÈÄ±ÊØîÔºâ</div>
    </div>`;
    container.innerHTML += histHtml;
  }

  // Milestones
  let msHtml = `<div class="card"><div class="card-title">„Éû„Ç§„É´„Çπ„Éà„Éº„É≥</div><div class="milestone-list">`;
  MILESTONES.forEach(m => {
    const achieved = latestW != null && latestW <= m.weight;
    const isNext = m === nextMS;
    const cls = achieved ? 'done' : isNext ? 'next' : 'future';
    const icon = achieved ? '‚úÖ' : isNext ? '‚Üí' : '‚óã';
    msHtml += `
      <div class="milestone-item">
        <div class="milestone-dot ${cls}">${icon}</div>
        <div class="milestone-info">
          <div class="milestone-name">${m.label}</div>
          <div class="milestone-date">${m.date}</div>
        </div>
        <div class="milestone-weight ${achieved ? 'achieved' : isNext ? 'next-weight' : ''}">${m.weight}kg</div>
      </div>`;
  });
  msHtml += `</div></div><div class="spacer"></div>`;
  container.innerHTML += msHtml;
}

function buildWeightChart(data) {
  const W = 320, H = 150;
  const PAD = {t:20, r:44, b:26, l:40};
  const pw = W - PAD.l - PAD.r;
  const ph = H - PAD.t - PAD.b;
  const n  = data.length;
  const xS = i => PAD.l + (i / (n - 1)) * pw;

  // ‰ΩìÈáç„Çπ„Ç±„Éº„É´ÔºàÂ∑¶YËª∏„ÉªÁ∑ëÔºâ
  const wVals = data.map(d => d.w).filter(v => v != null);
  const minW = Math.min(...wVals) - 0.5;
  const maxW = Math.max(...wVals) + 0.5;
  const yW = v => PAD.t + ph - ((v - minW) / (maxW - minW)) * ph;

  // ‰ΩìËÑÇËÇ™„Çπ„Ç±„Éº„É´ÔºàÂè≥YËª∏„Éª„Ç™„É¨„É≥„Ç∏Ôºâ
  const bfVals = data.map(d => d.bf).filter(v => v != null);
  const hasBF = bfVals.length >= 2;
  let yBF, minBF, maxBF;
  if (hasBF) {
    minBF = Math.min(...bfVals) - 1;
    maxBF = Math.max(...bfVals) + 1;
    yBF = v => PAD.t + ph - ((v - minBF) / (maxBF - minBF)) * ph;
  }

  // ‰ΩìÈáç„É©„Ç§„É≥„Éª„Éâ„ÉÉ„Éà
  const wPts  = data.filter(d => d.w != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yW(d.w).toFixed(1)}`).join(' ');
  const wDots = data.map((d,i) => d.w != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yW(d.w).toFixed(1)}" r="3" fill="white" stroke="#2D6A4F" stroke-width="2"/>`
    : '').join('');

  // 7Êó•Âπ≥Âùá„É©„Ç§„É≥Ôºà‰ΩìÈáç„Å®Âêå„ÅòYËª∏„ÉªÁ∑ëÁ†¥Á∑öÔºâ
  const avg7Pts = data.filter(d => d.avg7 != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yW(d.avg7).toFixed(1)}`).join(' ');

  // ‰ΩìËÑÇËÇ™„É©„Ç§„É≥„Éª„Éâ„ÉÉ„Éà
  let bfPts = '', bfDots = '';
  if (hasBF) {
    bfPts  = data.filter(d => d.bf != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yBF(d.bf).toFixed(1)}`).join(' ');
    bfDots = data.map((d,i) => d.bf != null
      ? `<circle cx="${xS(i).toFixed(1)}" cy="${yBF(d.bf).toFixed(1)}" r="2.5" fill="white" stroke="#E5A020" stroke-width="2"/>`
      : '').join('');
  }

  // Â∑¶YËª∏„É©„Éô„É´Ôºà‰ΩìÈáçÔºâ
  const wLabels = [minW, (minW+maxW)/2, maxW].map(v =>
    `<line x1="${PAD.l}" y1="${yW(v).toFixed(1)}" x2="${W-PAD.r}" y2="${yW(v).toFixed(1)}" stroke="#E9ECEF" stroke-width="1"/>
     <text x="${PAD.l-5}" y="${(yW(v)+4).toFixed(1)}" text-anchor="end" font-size="9" fill="#2D6A4F">${v.toFixed(1)}</text>`
  ).join('');

  // Âè≥YËª∏„É©„Éô„É´Ôºà‰ΩìËÑÇËÇ™Ôºâ
  const bfLabels = hasBF ? [minBF, (minBF+maxBF)/2, maxBF].map(v =>
    `<text x="${W-PAD.r+5}" y="${(yBF(v)+4).toFixed(1)}" text-anchor="start" font-size="9" fill="#E5A020">${v.toFixed(1)}%</text>`
  ).join('') : '';

  // XËª∏Êó•‰ªò„É©„Éô„É´
  const firstDs = data[0].ds.slice(5).replace('-','/');
  const lastDs  = data[n-1].ds.slice(5).replace('-','/');

  // Âá°‰æã
  const legend = `
    <line x1="${PAD.l}" y1="10" x2="${PAD.l+16}" y2="10" stroke="#2D6A4F" stroke-width="2"/>
    <text x="${PAD.l+18}" y="14" font-size="9" fill="#555">‰ΩìÈáç</text>
    <line x1="${PAD.l+46}" y1="10" x2="${PAD.l+62}" y2="10" stroke="#52B788" stroke-width="1.5" stroke-dasharray="5,3"/>
    <text x="${PAD.l+64}" y="14" font-size="9" fill="#555">7Êó•Âπ≥Âùá</text>
    ${hasBF ? `<line x1="${PAD.l+104}" y1="10" x2="${PAD.l+120}" y2="10" stroke="#E5A020" stroke-width="1.5" stroke-dasharray="4,2"/>
    <text x="${PAD.l+122}" y="14" font-size="9" fill="#555">‰ΩìËÑÇËÇ™%</text>` : ''}`;

  return `<div class="chart-scroll">
    <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
      ${wLabels}${bfLabels}
      ${avg7Pts ? `<polyline points="${avg7Pts}" fill="none" stroke="#52B788" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.85"/>` : ''}
      <polyline points="${wPts}" fill="none" stroke="#2D6A4F" stroke-width="2"/>
      ${hasBF ? `<polyline points="${bfPts}" fill="none" stroke="#E5A020" stroke-width="1.5" stroke-dasharray="4,2"/>` : ''}
      ${wDots}${bfDots}
      <text x="${PAD.l}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${firstDs}</text>
      <text x="${W-PAD.r}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${lastDs}</text>
      ${legend}
    </svg>
  </div>`;
}

function saveWeight() {
  const wInp  = document.getElementById('weight-input');
  const bfInp = document.getElementById('bf-input');
  const wVal  = parseFloat(wInp.value);
  const bfVal = parseFloat(bfInp?.value);
  if (!wVal || wVal < 30 || wVal > 300) { showToast('Ê≠£„Åó„ÅÑ‰ΩìÈáç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  const w = getWeights();
  w[currentDate] = wVal;
  saveWeights(w);
  if (!isNaN(bfVal) && bfVal > 0) {
    const bf = getBodyFat();
    bf[currentDate] = bfVal;
    saveBodyFat(bf);
  }
  showToast(`${wVal}kg${!isNaN(bfVal) && bfVal > 0 ? ' / ' + bfVal + '%' : ''} „ÇíË®òÈå≤„Åó„Åæ„Åó„Åü ‚úì`);
  switchTab('weight');
}

// ======== SLEEP TAB ========
function parseLocalDate(s) {
  // "2026-02-19T23:14" ‚Üí local Date object
  const [date, time] = s.split('T');
  const [y, mo, d] = date.split('-').map(Number);
  const [hh, mm]   = time.split(':').map(Number);
  return new Date(y, mo - 1, d, hh, mm, 0);
}

function hrToHM(h) {
  const m = Math.round(h * 60);
  return `${Math.floor(m / 60)}h${String(m % 60).padStart(2,'0')}m`;
}

function buildSleepTimeline(timeline, bedStart, bedEnd) {
  // „Éí„Éó„Éé„Ç∞„É©„É†ÔºöCatmull-Rom„Çπ„Éó„É©„Ç§„É≥ÔºàÂêÑ„Çª„Ç∞„É°„É≥„Éà‰∏≠ÁÇπ„ÇíÈÄö„ÇãËá™ÁÑ∂„Å™Ê≥¢Ôºâ
  const LEVEL = { awake:0, rem:1, core:2, deep:3 };
  const LABEL = { awake:'Ë¶öÈÜí', rem:'REM', core:'„Ç≥„Ç¢', deep:'Ê∑±„ÅÑ' };
  const COLOR = { awake:'#FBBF24', rem:'#A78BFA', core:'#60C6F1', deep:'#3B9EEB' };

  const W = 320;
  const PAD = { l:34, r:6, t:14, b:20 };
  const ROW = 28, LEVELS = 4;
  const ph = LEVELS * ROW;
  const H = PAD.t + ph + PAD.b;
  const pw = W - PAD.l - PAD.r;

  const startMs = parseLocalDate(bedStart).getTime();
  const endMs   = parseLocalDate(bedEnd).getTime();
  const totalMs = endMs - startMs;
  if (totalMs <= 0) return '';

  const toX = ms => PAD.l + ((ms - startMs) / totalMs) * pw;
  const toY = stage => PAD.t + (LEVEL[stage] ?? 2) * ROW + ROW / 2;

  // „Ç≥„É≥„Éà„É≠„Éº„É´„Éù„Ç§„É≥„ÉàÁîüÊàêÔºö
  // ‰∏≠ÁÇπ ‚Üí Â¢ÉÁïåÁÇπÔºà‰∏°„Çπ„ÉÜ„Éº„Ç∏„ÅÆÂπ≥ÂùáYÔºâ‚Üí ‰∏≠ÁÇπ ‚Üí Â¢ÉÁïåÁÇπ ... „Å®‰∫§‰∫í„Å´ÈÖçÁΩÆ
  // Â¢ÉÁïåÁÇπ„ÇíÈÄöÈÅé„Åô„Çã„Åì„Å®„Åß„Çπ„ÉÜ„Éº„Ç∏Âàá„ÇäÊõø„Çè„Çä„ÅÆÊôÇÂàª„ÅåÊ≠£Á¢∫„Å´„Å™„ÇäÈÄÜÊàª„Çä„ÇíÈò≤Ê≠¢
  const pts = [];
  const firstSeg = timeline[0];
  const lastSeg  = timeline[timeline.length - 1];
  pts.push({ x: toX(parseLocalDate(firstSeg.s).getTime()), y: toY(firstSeg.v) });
  for (let i = 0; i < timeline.length; i++) {
    const seg = timeline[i];
    const midMs = (parseLocalDate(seg.s).getTime() + parseLocalDate(seg.e).getTime()) / 2;
    pts.push({ x: toX(midMs), y: toY(seg.v) });
    // „Çª„Ç∞„É°„É≥„ÉàÈñì„ÅÆÂ¢ÉÁïåÁÇπ„ÇíËøΩÂä†ÔºàÊ¨°„ÅÆ„Çª„Ç∞„É°„É≥„Éà„Å∏„ÅÆÂàá„ÇäÊõø„Çè„ÇäÊôÇÂàª / Âπ≥ÂùáYÔºâ
    if (i < timeline.length - 1) {
      const boundMs = parseLocalDate(seg.e).getTime();
      const midY    = (toY(seg.v) + toY(timeline[i + 1].v)) / 2;
      pts.push({ x: toX(boundMs), y: midY });
    }
  }
  pts.push({ x: toX(parseLocalDate(lastSeg.e).getTime()), y: toY(lastSeg.v) });

  // Catmull-Rom ‚Üí ‰∏âÊ¨°„Éô„Ç∏„ÇßÂ§âÊèõÔºàXY„Å®„ÇÇ„Å´„ÇØ„É©„É≥„Éó„Åó„Å¶„Ç™„Éº„Éê„Éº„Ç∑„É•„Éº„ÉàÈò≤Ê≠¢Ôºâ
  const f = s => s.toFixed(2);
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  let d = `M ${f(pts[0].x)},${f(pts[0].y)}`;
  for (let i = 0; i < pts.length - 1; i++) {
    const p0 = pts[Math.max(0, i - 1)];
    const p1 = pts[i];
    const p2 = pts[i + 1];
    const p3 = pts[Math.min(pts.length - 1, i + 2)];
    const cp1x = clamp(p1.x + (p2.x - p0.x) / 6, p1.x, p2.x);
    const cp1y = clamp(p1.y + (p2.y - p0.y) / 6, Math.min(p1.y, p2.y), Math.max(p1.y, p2.y));
    const cp2x = clamp(p2.x - (p3.x - p1.x) / 6, p1.x, p2.x);
    const cp2y = clamp(p2.y - (p3.y - p1.y) / 6, Math.min(p1.y, p2.y), Math.max(p1.y, p2.y));
    d += ` C ${f(cp1x)},${f(cp1y)} ${f(cp2x)},${f(cp2y)} ${f(p2.x)},${f(p2.y)}`;
  }

  // Â°ó„Çä„Å§„Å∂„ÅóÔºàÊ≥¢ÂΩ¢„ÅÆ‰∏ã„ÇíÈñâ„Åò„ÇãÔºâ
  const bot = PAD.t + ph + 2;
  const fillD = d + ` L ${f(pts[pts.length-1].x)},${bot} L ${f(pts[0].x)},${bot} Z`;

  // YËª∏Ôºö„Çπ„ÉÜ„Éº„Ç∏„É©„Éô„É´Ôºã„Ç∞„É™„ÉÉ„ÉâÁ∑ö
  let yAxis = '';
  ['awake','rem','core','deep'].forEach(s => {
    const y = toY(s);
    yAxis += `<line x1="${PAD.l}" y1="${f(y)}" x2="${W-PAD.r}" y2="${f(y)}" stroke="#EBEBEB" stroke-width="1" stroke-dasharray="3,3"/>`;
    yAxis += `<text x="${PAD.l-4}" y="${f(y+3.5)}" text-anchor="end" font-size="9" fill="${COLOR[s]}" font-weight="700">${LABEL[s]}</text>`;
  });

  // ÊôÇÂàª„É©„Éô„É´Ôºà‰∏ãÊÆµÔºâ
  let tLabels = `
    <text x="${PAD.l}" y="${H-2}" text-anchor="start" font-size="9" fill="#888">${bedStart.slice(11,16)}</text>
    <text x="${W-PAD.r}" y="${H-2}" text-anchor="end" font-size="9" fill="#888">${bedEnd.slice(11,16)}</text>`;
  const sd = parseLocalDate(bedStart);
  let tick = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate(), sd.getHours() + 1, 0, 0);
  while (tick.getTime() < endMs) {
    const h = tick.getHours();
    if (h % 2 === 0) {
      const mx = toX(tick.getTime());
      if (mx > PAD.l + 22 && mx < W - PAD.r - 22) {
        tLabels += `<text x="${f(mx)}" y="${H-2}" text-anchor="middle" font-size="9" fill="#BBB">${h}:00</text>`;
      }
    }
    tick.setHours(tick.getHours() + 1);
  }

  // ÊôÇÈñìËª∏„Éô„Éº„Çπ„ÅÆ„Çπ„ÉÜ„Éº„Ç∏Ëâ≤ÂàÜ„ÅëÔºöÂêÑ„Çª„Ç∞„É°„É≥„Éà„ÅÆÊôÇÈñìÁ™ì„Çí„Çπ„ÉÜ„Éº„Ç∏Ëâ≤„Åß„ÇØ„É™„ÉÉ„ÉóÂ°ó„Çä
  const segFills = timeline.map(seg => {
    const x1 = toX(parseLocalDate(seg.s).getTime());
    const x2 = toX(parseLocalDate(seg.e).getTime());
    return `<rect x="${f(x1)}" y="${PAD.t}" width="${f(Math.max(x2-x1,0.5))}" height="${ph+2}" fill="${COLOR[seg.v] ?? '#6BAED6'}"/>`;
  }).join('');

  return `<div style="margin:10px 0 6px;">
    <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
      <defs>
        <clipPath id="hpClip">
          <path d="${fillD}"/>
        </clipPath>
        <filter id="hpBlur" x="-5%" width="110%" y="-5%" height="110%">
          <feGaussianBlur stdDeviation="10 0"/>
        </filter>
      </defs>
      ${yAxis}
      <g filter="url(#hpBlur)" clip-path="url(#hpClip)" opacity="0.6">
        ${segFills}
      </g>
      <path d="${d}" fill="none" stroke="#2E7FC1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      ${tLabels}
    </svg>
  </div>`;
}

function renderSleep(container) {
  const sleepAll = getSleepData();
  const isToday  = currentDate === todayStr();
  const todayS   = sleepAll[currentDate] ?? null;

  // Êó•‰ªò„Éä„Éì
  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>`;

  // ===== „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ =====
  let summaryHtml = `<div class="card"><div class="card-title">üåô Áù°Áú†„Çµ„Éû„É™„Éº</div>`;
  if (!todayS) {
    summaryHtml += `<div class="empty-state">
      <div class="empty-icon">üåô</div>
      <div class="empty-text">„Åì„ÅÆÊó•„ÅÆÁù°Áú†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>Health Auto Export„ÅßÂêåÊúü„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>`;
  } else {
    const totalH = todayS.total || 0;
    const remH   = todayS.rem   || 0;
    const coreH  = todayS.core  || 0;
    const deepH  = todayS.deep  || 0;
    const awakeH = todayS.awake || 0;
    const hasTimeline = !!(todayS.timeline && todayS.timeline.length > 0);

    const sleepIcon   = totalH >= 7 ? 'üò¥' : totalH >= 6 ? 'üòë' : 'ü•±';
    const sleepLabel  = totalH >= 7 ? 'ÂçÅÂàÜ' : totalH >= 6 ? '„ÇÑ„ÇÑ‰∏çË∂≥' : '‰∏çË∂≥';
    const statusColor = totalH >= 7 ? 'var(--green-mid)' : totalH >= 6 ? 'var(--warning)' : 'var(--danger)';

    // „Éí„Éº„É≠„ÉºË°åÔºàÂêàË®àÊôÇÈñì + Ë©ï‰æ°Ôºâ
    summaryHtml += `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0 2px;">
        <div>
          <div class="sleep-big">${hrToHM(totalH)}</div>
          ${hasTimeline ? `<div style="font-size:11px;color:var(--text-muted);margin-top:3px;">${todayS.bedStart.slice(11,16)} Â∞±ÂØù ‚Üí ${todayS.bedEnd.slice(11,16)} Ëµ∑Â∫ä</div>` : ''}
        </div>
        <div style="text-align:center;">
          <div style="font-size:30px;">${sleepIcon}</div>
          <div style="font-size:11px;font-weight:700;color:${statusColor};">${sleepLabel}</div>
        </div>
      </div>`;

    // „Çø„Ç§„É†„É©„Ç§„É≥Ê≥¢ÂΩ¢ÔºàApple Watch„Éá„Éº„Çø„Åå„ÅÇ„ÇãÊó•Ôºâ
    if (hasTimeline) {
      summaryHtml += buildSleepTimeline(todayS.timeline, todayS.bedStart, todayS.bedEnd);
    } else if (remH > 0) {
      // „Çø„Ç§„É†„É©„Ç§„É≥„Å™„Åó„ÉªREM„ÅÆ„Åø
      const remPct = Math.round((remH / totalH) * 100);
      summaryHtml += `
        <div class="sleep-stage-bar" style="margin:10px 0 4px;">
          <div class="sleep-stage-rem" style="width:${remPct}%;"></div>
          <div style="flex:1;background:#E9ECEF;"></div>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">REM ${hrToHM(remH)}Ôºà${remPct}%Ôºâ Ôºè Ë©≥Á¥∞„Çπ„ÉÜ„Éº„Ç∏„ÅØÊú™ÂèñÂæó</div>`;
    }

    // „Çπ„ÉÜ„Éº„Ç∏Ë©≥Á¥∞„Éú„ÉÉ„ÇØ„ÇπÔºà„Çø„Ç§„É†„É©„Ç§„É≥‰ªò„Åç„ÅÆÊó•Ôºâ
    if (coreH > 0 || remH > 0 || deepH > 0 || awakeH > 0) {
      summaryHtml += `<div style="display:flex;gap:6px;margin-top:10px;">
        ${coreH  > 0 ? `<div style="flex:1;text-align:center;background:#EEF5FA;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#5B8FB9;">${hrToHM(coreH)}</div><div style="font-size:10px;color:var(--text-muted);">„Ç≥„Ç¢</div></div>` : ''}
        ${remH   > 0 ? `<div style="flex:1;text-align:center;background:#EEF5FA;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#5B8FB9;">${hrToHM(remH)}</div><div style="font-size:10px;color:var(--text-muted);">REM</div></div>` : ''}
        ${deepH  > 0 ? `<div style="flex:1;text-align:center;background:#E8EEF5;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#2E4057;">${hrToHM(deepH)}</div><div style="font-size:10px;color:var(--text-muted);">Ê∑±„ÅÑ</div></div>` : ''}
        ${awakeH > 0 ? `<div style="flex:1;text-align:center;background:#FEF3EB;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#F4A261;">${hrToHM(awakeH)}</div><div style="font-size:10px;color:var(--text-muted);">Ë¶öÈÜí</div></div>` : ''}
      </div>`;
    }
  }
  summaryHtml += `</div>`;
  container.innerHTML += summaryHtml;

  // AI Sleep advice card
  container.innerHTML += renderAdviceCard('sleep');

  // ===== 7Êó•Èñì„Éà„É¨„É≥„Éâ =====
  const sleepChart = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    const s = sleepAll[ds] ?? null;
    sleepChart.push({ ds, total: s?.total ?? null, rem: s?.rem ?? null });
  }

  const hasChart = sleepChart.filter(d => d.total != null).length >= 2;
  let chartHtml = `<div class="card"><div class="card-title">Áù°Áú†„Éà„É¨„É≥„ÉâÔºàÁõ¥Ëøë7Êó•Ôºâ</div>`;
  if (hasChart) chartHtml += buildSleepChart(sleepChart);

  // 7Êó•„ÉÜ„Éº„Éñ„É´
  chartHtml += `<table style="width:100%;border-collapse:collapse;margin-top:12px;font-size:12px;">
    <thead><tr>
      <th style="text-align:left;padding:4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">Êó•‰ªò</th>
      <th style="text-align:right;padding:4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">ÂêàË®à</th>
      <th style="text-align:right;padding:4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">REM</th>
      <th style="text-align:right;padding:4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">REM%</th>
      <th style="text-align:center;padding:4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);"></th>
    </tr></thead><tbody>`;

  [...sleepChart].reverse().forEach(row => {
    const isToday2  = row.ds === todayStr();
    const totalMin  = row.total != null ? Math.round(row.total * 60) : null;
    const remMin    = row.rem   != null ? Math.round(row.rem   * 60) : null;
    const remPct2   = (row.total && row.rem != null) ? Math.round(row.rem / row.total * 100) : null;
    const totalStr  = totalMin != null ? `${Math.floor(totalMin/60)}h${String(totalMin%60).padStart(2,'0')}m` : '‚Äî';
    const remStr    = remMin   != null ? `${Math.floor(remMin/60)}h${String(remMin%60).padStart(2,'0')}m`     : '‚Äî';
    const goodSleep = row.total != null && row.total >= 7;
    const sleepIcon = row.total == null ? '' : row.total >= 7 ? 'üò¥' : row.total >= 6 ? 'üòë' : 'ü•±';

    chartHtml += `<tr style="${isToday2 ? 'background:var(--green-pale);' : ''}">
      <td style="padding:5px 4px;white-space:nowrap;">${row.ds.slice(5).replace('-','/')}${isToday2 ? '&nbsp;<span style="font-size:9px;color:var(--green-mid);">TODAY</span>' : ''}</td>
      <td style="text-align:right;padding:5px 4px;font-weight:600;color:${row.total==null?'var(--text-muted)':goodSleep?'var(--green-mid)':'var(--warning)'};">${totalStr}</td>
      <td style="text-align:right;padding:5px 4px;color:#5B8FB9;font-weight:${row.rem?'600':'400'};">${remStr}</td>
      <td style="text-align:right;padding:5px 4px;color:var(--text-muted);">${remPct2 != null ? remPct2 + '%' : '‚Äî'}</td>
      <td style="text-align:center;padding:5px 4px;font-size:15px;">${sleepIcon}</td>
    </tr>`;
  });
  chartHtml += `</tbody></table>
  <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">ÁõÆÂÆâ: ÂêàË®à7h‰ª•‰∏ä‚óé / REM 20„Äú25%„ÅåÁêÜÊÉ≥</div>
  </div><div class="spacer"></div>`;
  container.innerHTML += chartHtml;
}

function buildSleepChart(data) {
  const W = 320, H = 140;
  const PAD = {t:20, r:20, b:26, l:40};
  const pw = W - PAD.l - PAD.r;
  const ph = H - PAD.t - PAD.b;
  const n  = data.length;
  const xS = i => PAD.l + (i / (n - 1)) * pw;

  const totalVals = data.map(d => d.total).filter(v => v != null);
  const minT = Math.max(0, Math.min(...totalVals) - 0.5);
  const maxT = Math.max(...totalVals) + 0.5;
  const yT = v => PAD.t + ph - ((v - minT) / (maxT - minT)) * ph;

  // 7hÁõÆÊ®ô„É©„Ç§„É≥
  const goalY = (7 >= minT && 7 <= maxT) ? yT(7) : null;

  const totalPts = data.filter(d => d.total != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yT(d.total).toFixed(1)}`).join(' ');
  const totalDots = data.map((d,i) => d.total != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yT(d.total).toFixed(1)}" r="3" fill="white" stroke="#2E4057" stroke-width="2"/>`
    : '').join('');

  // REM „É©„Ç§„É≥
  const remVals = data.map(d => d.rem).filter(v => v != null && v > 0);
  let remPts = '', remDots = '';
  if (remVals.length >= 2) {
    remPts  = data.filter(d => d.rem != null && d.rem > 0).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yT(d.rem).toFixed(1)}`).join(' ');
    remDots = data.map((d,i) => d.rem != null && d.rem > 0
      ? `<circle cx="${xS(i).toFixed(1)}" cy="${yT(d.rem).toFixed(1)}" r="2.5" fill="white" stroke="#5B8FB9" stroke-width="2"/>`
      : '').join('');
  }

  // YËª∏„É©„Éô„É´
  const yLabels = [minT, (minT+maxT)/2, maxT].map(v =>
    `<line x1="${PAD.l}" y1="${yT(v).toFixed(1)}" x2="${W-PAD.r}" y2="${yT(v).toFixed(1)}" stroke="#E9ECEF" stroke-width="1"/>
     <text x="${PAD.l-5}" y="${(yT(v)+4).toFixed(1)}" text-anchor="end" font-size="9" fill="#555">${v.toFixed(1)}h</text>`
  ).join('');

  const firstDs = data[0].ds.slice(5).replace('-','/');
  const lastDs  = data[n-1].ds.slice(5).replace('-','/');

  const legend = `
    <line x1="${PAD.l}" y1="10" x2="${PAD.l+16}" y2="10" stroke="#2E4057" stroke-width="2"/>
    <text x="${PAD.l+18}" y="14" font-size="9" fill="#555">ÂêàË®à</text>
    ${remPts ? `<line x1="${PAD.l+44}" y1="10" x2="${PAD.l+60}" y2="10" stroke="#5B8FB9" stroke-width="1.5" stroke-dasharray="4,2"/>
    <text x="${PAD.l+62}" y="14" font-size="9" fill="#555">REM</text>` : ''}
    ${goalY ? `<line x1="${PAD.l+90}" y1="10" x2="${PAD.l+106}" y2="10" stroke="#28A745" stroke-width="1" stroke-dasharray="3,3"/>
    <text x="${PAD.l+108}" y="14" font-size="9" fill="#28A745">7hÁõÆÊ®ô</text>` : ''}`;

  return `<div class="chart-scroll">
    <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
      ${yLabels}
      ${goalY != null ? `<line x1="${PAD.l}" y1="${goalY.toFixed(1)}" x2="${W-PAD.r}" y2="${goalY.toFixed(1)}" stroke="#28A745" stroke-width="1" stroke-dasharray="3,3" opacity="0.6"/>` : ''}
      <polyline points="${totalPts}" fill="none" stroke="#2E4057" stroke-width="2"/>
      ${remPts ? `<polyline points="${remPts}" fill="none" stroke="#5B8FB9" stroke-width="1.5" stroke-dasharray="4,2"/>` : ''}
      ${totalDots}${remDots}
      <text x="${PAD.l}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${firstDs}</text>
      <text x="${W-PAD.r}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${lastDs}</text>
      ${legend}
    </svg>
  </div>`;
}

// ======== SHOPPING TAB ========
function renderShopping(container) {
  const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
  const checks = JSON.parse(localStorage.getItem('shopping_checks') || '{}');

  // ‰ªäÊó•„ÅÆÊ†ÑÈ§äÊÆã„ÇäË®àÁÆó
  const todayMeals = getMeals(todayStr());
  const t = totals(todayMeals);
  const kcalLeft = Math.max(0, Math.round(TARGETS.kcalMax - t.kcal));
  const pLeft    = Math.max(0, Math.round(TARGETS.pMin - t.p));
  const fLeft    = Math.max(0, Math.round(TARGETS.fMax - t.f));
  const cLeft    = Math.max(0, Math.round(TARGETS.cMax - t.c));
  const kcalOver = t.kcal > TARGETS.kcalMax;

  container.innerHTML = `
    <div class="card" style="margin-bottom:10px;">
      <div style="font-weight:700;font-size:14px;margin-bottom:8px;">üõí Ë≤∑„ÅÑÁâ©„É´„Éº„É´</div>
      <div style="font-size:13px;color:var(--text-muted);line-height:1.8;">
        ‚úì „É™„Çπ„Éà„Å´„ÅÇ„Çã„ÇÇ„ÅÆ„Å†„ÅëË≤∑„ÅÜ<br>
        ‚úì „ÅäËÖπ„ÅåÁ©∫„ÅÑ„ÅüÁä∂ÊÖã„ÅßË°å„Åã„Å™„ÅÑ
      </div>
      <div style="margin-top:10px;padding:8px 10px;background:var(--bg);border-radius:8px;font-size:12px;">
        <div style="font-weight:600;color:var(--text-muted);margin-bottom:4px;">‰ªäÊó•„ÅÆÊ†ÑÈ§äÊÆã„Çä</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <span>${kcalOver ? `<span style="color:var(--danger)">kcal Ë∂ÖÈÅé ${Math.round(t.kcal - TARGETS.kcalMax)}</span>` : `„Ç´„É≠„É™„Éº „ÅÇ„Å® <strong>${kcalLeft}</strong> kcal`}</span>
          <span>P „ÅÇ„Å® <strong>${pLeft}</strong>g</span>
          <span>ËÑÇË≥™ „ÅÇ„Å® <strong>${fLeft}</strong>g</span>
          <span>ÁÇ≠Ê∞¥ÂåñÁâ© „ÅÇ„Å® <strong>${cLeft}</strong>g</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:10px;">Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà</div>
      ${items.length === 0
        ? `<div style="color:var(--text-muted);font-size:13px;text-align:center;padding:20px 0;">„É™„Çπ„Éà„ÅØÁ©∫„Åß„Åô</div>`
        : (() => {
            const renderItems = (list) => list.map(item => {
              const checked = !!checks[item.id];
              return `
                <label style="display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;-webkit-tap-highlight-color:transparent;">
                  <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleShoppingItem('${item.id}', this.checked)"
                    style="width:20px;height:20px;flex-shrink:0;accent-color:var(--green-mid);margin-top:1px;">
                  <div>
                    <div style="font-size:14px;${checked ? 'text-decoration:line-through;color:var(--text-muted);' : ''}">${item.name}</div>
                    ${item.note ? `<div style="font-size:11px;color:var(--text-muted);margin-top:2px;">${item.note}</div>` : ''}
                  </div>
                </label>`;
            }).join('');
            const foodItems  = items.filter(i => i.category === 'food');
            const otherItems = items.filter(i => i.category !== 'food');
            let html = '';
            if (foodItems.length > 0) {
              html += `<div style="font-size:11px;font-weight:700;color:var(--text-muted);letter-spacing:.05em;text-transform:uppercase;padding:4px 0 2px;">ü•¶ È£üÂìÅ</div>${renderItems(foodItems)}`;
            }
            if (otherItems.length > 0) {
              html += `<div style="font-size:11px;font-weight:700;color:var(--text-muted);letter-spacing:.05em;text-transform:uppercase;padding:${foodItems.length > 0 ? '12px' : '4px'} 0 2px;">üì¶ „Åù„ÅÆ‰ªñ</div>${renderItems(otherItems)}`;
            }
            return html;
          })()
      }
      ${items.length > 0 ? `
        <button onclick="clearShoppingChecks()" style="margin-top:10px;font-size:12px;background:none;border:1px solid var(--border);border-radius:8px;padding:6px 12px;color:var(--text-muted);cursor:pointer;width:100%;">„ÉÅ„Çß„ÉÉ„ÇØ„Çí„É™„Çª„ÉÉ„Éà</button>
      ` : ''}
    </div>
  `;
}

function toggleShoppingItem(id, checked) {
  const checks = JSON.parse(localStorage.getItem('shopping_checks') || '{}');
  if (checked) checks[id] = true;
  else delete checks[id];
  localStorage.setItem('shopping_checks', JSON.stringify(checks));
}

function clearShoppingChecks() {
  localStorage.removeItem('shopping_checks');
  renderShopping(document.getElementById('main-content'));
}

// ======== IMPORT ========
// File System Access API (desktop Chrome/Safari) + fallback to <input type="file"> (iOS)
const supportsFileSystemAccess = 'showOpenFilePicker' in window;

// IndexedDB helpers for persisting FileSystemFileHandle
function idbOpen() {
  return new Promise((res, rej) => {
    const req = indexedDB.open('health-hub', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('handles');
    req.onsuccess = e => res(e.target.result);
    req.onerror = () => rej();
  });
}
async function idbGet(key) {
  try {
    const db = await idbOpen();
    return new Promise(res => {
      const tx = db.transaction('handles', 'readonly');
      const req = tx.objectStore('handles').get(key);
      req.onsuccess = () => res(req.result ?? null);
      req.onerror = () => res(null);
    });
  } catch { return null; }
}
async function idbPut(key, val) {
  try {
    const db = await idbOpen();
    return new Promise(res => {
      const tx = db.transaction('handles', 'readwrite');
      tx.objectStore('handles').put(val, key);
      tx.oncomplete = res;
    });
  } catch {}
}

async function triggerFilePicker() {
  if (supportsFileSystemAccess) {
    await loadWithFSA();
  } else {
    // iOS fallback
    const fp = document.getElementById('file-picker');
    fp.value = '';
    fp.click();
  }
}

async function loadWithFSA() {
  // Try saved handle first
  let handle = await idbGet('health-memo-handle');

  if (handle) {
    try {
      let perm = await handle.queryPermission({ mode: 'read' });
      if (perm !== 'granted') {
        perm = await handle.requestPermission({ mode: 'read' });
      }
      if (perm === 'granted') {
        showToast('Ë™≠„ÅøËæº„Åø‰∏≠...');
        const file = await handle.getFile();
        const text = await file.text();
        importFromMarkdown(text, handle.name);
        return;
      }
    } catch (e) {
      // Saved handle is stale (file moved/renamed) ‚Äî fall through to picker
      await idbPut('health-memo-handle', null);
    }
  }

  // First time or stale handle ‚Äî show file picker
  try {
    [handle] = await window.showOpenFilePicker({
      types: [{ description: 'Markdown / Text', accept: { 'text/*': ['.md', '.txt'] } }],
      multiple: false,
    });
  } catch (e) {
    if (e.name !== 'AbortError') showToast('„Éï„Ç°„Ç§„É´„ÇíÈñã„Åë„Åæ„Åõ„Çì„Åß„Åó„Åü: ' + e.message);
    return;
  }

  try {
    await idbPut('health-memo-handle', handle);
    showToast('Ë™≠„ÅøËæº„Åø‰∏≠...');
    const file = await handle.getFile();
    const text = await file.text();
    importFromMarkdown(text, handle.name);
    updateImportBtnLabel(handle.name);
  } catch (e) {
    showToast('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + e.message);
  }
}

function onFilePicked(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => importFromMarkdown(e.target.result, file.name);
  reader.readAsText(file, 'UTF-8');
}

function updateImportBtnLabel(filename) {
  const btn = document.querySelector('.import-btn');
  if (btn) btn.innerHTML = `üì• Âèñ„ÇäËæº„ÇÄ <span style="font-size:11px;opacity:0.7;">Ôºà${filename}Ôºâ</span>`;
}

// On page load: show saved filename on button if handle exists
async function initImportBtn() {
  if (!supportsFileSystemAccess) return;
  const handle = await idbGet('health-memo-handle');
  if (handle) updateImportBtnLabel(handle.name);
}

function importFromMarkdown(text, filename) {
  // Parse ALL date sections from the file
  // Supported formats: ### 2026/02/20  ### 2026/2/20  ### 2/20  ### 02/20
  const DATE_RE = /^#{1,4}\s.*?(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})|^#{1,4}\s.*?(\d{1,2})[\/\-](\d{1,2})(?!\d)/;

  const lines = text.split('\n');
  // Map: dateStr ("YYYY-MM-DD") ‚Üí meal[]
  const byDate = {};
  let currentDs = null;

  for (const rawLine of lines) {
    const line = rawLine.trim();

    if (/^#{1,4}\s/.test(line)) {
      const m = line.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
      if (m) {
        // Full year format: 2026/02/20
        currentDs = `${m[1]}-${pad(+m[2])}-${pad(+m[3])}`;
        if (!byDate[currentDs]) byDate[currentDs] = [];
        continue;
      }
      const m2 = line.match(/(\d{1,2})[\/\-](\d{1,2})(?!\d)/);
      if (m2) {
        // Month/day only: infer year from currentDate's year
        const yr = currentDate.split('-')[0];
        currentDs = `${yr}-${pad(+m2[1])}-${pad(+m2[2])}`;
        if (!byDate[currentDs]) byDate[currentDs] = [];
        continue;
      }
      // Non-date heading ‚Äî stop collecting for current date
      currentDs = null;
      continue;
    }

    if (!currentDs) continue;
    if (!line.startsWith('|')) continue;
    if (line.includes('---')) continue;
    if (/ÂêàË®à|ÁõÆÊ®ô|ÊôÇÂàª/.test(line)) continue;

    const cells = line.split('|').map(c => c.trim()).filter(c => c !== '');
    if (cells.length < 4) continue;

    const time = cells[0];
    const name = cells[1];
    const kcal = parseNum(cells[2]);
    const p    = parseNum(cells[3]);
    const f    = parseNum(cells.length > 4 ? cells[4] : '0');
    const c    = parseNum(cells.length > 5 ? cells[5] : '0');

    if (!/^\d{1,2}:\d{2}$/.test(time) || !name || kcal <= 0) continue;
    byDate[currentDs].push({ time, name, kcal, p, f, c });
  }

  // Remove dates with no meals
  const dates = Object.keys(byDate).filter(ds => byDate[ds].length > 0);

  if (dates.length === 0) {
    showToast('È£ü‰∫ãË®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
    return;
  }

  // Merge into localStorage for each date
  let totalAdded = 0;
  let datesUpdated = 0;
  dates.forEach(ds => {
    const existing = getMeals(ds);
    let added = 0;
    byDate[ds].forEach(item => {
      if (!existing.find(e => e.time === item.time && e.name === item.name)) {
        existing.push(item);
        added++;
      }
    });
    if (added > 0) {
      saveMeals(ds, existing);
      totalAdded += added;
      datesUpdated++;
    }
  });

  showToast(`${datesUpdated}Êó•ÂàÜ„Éª${totalAdded}‰ª∂ Âèñ„ÇäËæº„Åø„Åæ„Åó„Åü ‚úì`);
  switchTab('meals');
}

function parseNum(s) {
  return parseFloat(String(s).replace(/[^0-9.]/g, '')) || 0;
}

// ======== UTIL ========
function showToast(msg) {
  const ex = document.querySelector('.toast');
  if (ex) ex.remove();
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 0.2s'; setTimeout(() => el.remove(), 200); }, 2500);
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ======== START ========
init();
initImportBtn();

</script>
</body>
</html>
