<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1B4332">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Health Hub">
  <title>„Åó„ÇÖ„ÅÜ„Åó„ÇÖ„ÅÜ Health Hub</title>
  <link rel="manifest" href="manifest.json">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green-dark: #1B4332;
      --green-mid: #2D6A4F;
      --green-light: #52B788;
      --green-pale: #D8F3DC;
      --bg: #F0F4F0;
      --card: #FFFFFF;
      --text: #1A1A2E;
      --text-muted: #6C757D;
      --border: #DEE2E6;
      --accent: #52B788;
      --danger: #DC3545;
      --warning: #E5A020;
      --success: #28A745;
      --nav-height: 62px;
      --header-height: 52px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      overscroll-behavior-y: none;
      -webkit-font-smoothing: antialiased;
    }
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--header-height);
      background: var(--green-dark);
      color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      z-index: 100;
      padding-top: env(safe-area-inset-top, 0px);
    }
    .header h1 { font-size: 16px; font-weight: 700; }
    .header-date { font-size: 13px; opacity: 0.75; }
    .header-clock { font-size: 14px; font-weight: 700; opacity: 0.9; letter-spacing: 0.05em; }
    .header-reload {
      background: none; border: none; color: white; opacity: 0.75;
      font-size: 20px; padding: 6px 8px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s;
      display: inline-block;
    }
    .header-reload:active { opacity: 0.4; }
    .header-reload.spinning { animation: ptr-spin 0.7s linear infinite; }
    .main {
      padding-top: var(--header-height);
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 8px);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: calc(var(--nav-height) + var(--safe-bottom));
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 100;
      padding-bottom: var(--safe-bottom);
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 2px;
      border: none; background: none;
      color: var(--text-muted); font-size: 9px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      padding: 6px 2px;
      transition: color 0.15s;
    }
    .nav-btn.active { color: var(--green-mid); }
    .nav-btn svg { width: 20px; height: 20px; }
    .card {
      background: var(--card); border-radius: 14px;
      padding: 14px 16px; margin: 8px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 11px; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.6px; margin-bottom: 12px;
    }
    .kcal-display {
      display: flex; align-items: baseline; gap: 4px;
      justify-content: center; padding: 4px 0 8px;
    }
    .kcal-num {
      font-size: 48px; font-weight: 700;
      color: var(--green-dark); line-height: 1;
      transition: color 0.2s;
    }
    .kcal-num.over { color: var(--danger); }
    .kcal-unit { font-size: 16px; color: var(--text-muted); }
    .kcal-target { font-size: 13px; color: var(--text-muted); }
    .remaining {
      text-align: center; font-size: 13px;
      color: var(--text-muted); margin-bottom: 14px;
    }
    .macros-row { display: flex; gap: 8px; }
    .macro-card {
      flex: 1; background: var(--bg);
      border-radius: 10px; padding: 10px 6px; text-align: center;
    }
    .macro-name { font-size: 10px; color: var(--text-muted); margin-bottom: 2px; }
    .macro-value { font-size: 18px; font-weight: 700; line-height: 1.1; }
    .macro-value .unit { font-size: 11px; font-weight: 400; }
    .macro-target { font-size: 10px; color: var(--text-muted); margin-top: 1px; }
    .macro-pct { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-top: 1px; }
    .macro-value.over { color: var(--danger); }
    .macro-value.warn { color: var(--warning); }
    .macro-value.ok { color: var(--green-mid); }
    /* PFC„Éê„É©„É≥„Çπ„Éê„Éº */
    .pfc-bar {
      display: flex; height: 22px; border-radius: 6px;
      overflow: hidden; margin: 10px 0 4px;
    }
    .pfc-seg {
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; color: #fff;
      min-width: 20px; transition: width 0.3s;
    }
    .pfc-seg span { text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .pfc-seg.pfc-p { background: #52B788; }
    .pfc-seg.pfc-f { background: #E5A020; }
    .pfc-seg.pfc-c { background: #5B9BD5; }
    .pfc-legend {
      display: flex; justify-content: center; gap: 12px;
      font-size: 10px; color: var(--text-muted); margin-bottom: 6px;
    }
    .pfc-legend-item { display: flex; align-items: center; gap: 3px; }
    .pfc-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .pfc-dot.pfc-p { background: #52B788; }
    .pfc-dot.pfc-f { background: #E5A020; }
    .pfc-dot.pfc-c { background: #5B9BD5; }
    .date-nav {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px; background: white;
      border-bottom: 1px solid var(--border);
    }
    .date-nav-btn {
      width: 38px; height: 38px; border: none; background: none;
      font-size: 22px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; color: var(--green-mid);
      -webkit-tap-highlight-color: transparent;
    }
    .date-nav-btn:active { background: var(--bg); }
    .date-nav-btn.disabled { opacity: 0.25; pointer-events: none; }
    .date-nav-label { font-size: 15px; font-weight: 600; }
    .today-badge {
      display: inline-block; margin-left: 6px;
      background: var(--green-pale); color: var(--green-mid);
      font-size: 10px; font-weight: 700; padding: 1px 6px;
      border-radius: 8px; vertical-align: middle;
    }
    .meal-list { display: flex; flex-direction: column; gap: 1px; }
    .meal-item {
      display: flex; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border); gap: 8px;
    }
    .meal-item:last-child { border-bottom: none; }
    .meal-time { font-size: 11px; color: var(--text-muted); width: 38px; flex-shrink: 0; }
    .meal-info { flex: 1; min-width: 0; }
    .meal-name { font-size: 14px; line-height: 1.3; }
    .meal-macros { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .meal-kcal { font-size: 13px; font-weight: 700; color: var(--green-mid); flex-shrink: 0; }
    .meal-del {
      width: 30px; height: 30px; border: none; background: none;
      color: #CCC; font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .meal-del:active { background: #f0f0f0; color: var(--danger); }
    .meal-group { padding: 10px 0; border-bottom: 1px solid var(--border); }
    .meal-group:last-child { border-bottom: none; }
    .meal-group-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .meal-group-time { font-size: 11px; color: var(--text-muted); width: 38px; flex-shrink: 0; }
    .meal-group-label { font-size: 12px; font-weight: 600; color: var(--text-muted); flex: 1; }
    .meal-group-kcal { font-size: 15px; font-weight: 700; color: var(--green-mid); flex-shrink: 0; }
    .meal-group-items { margin: 0 0 6px 46px; }
    .meal-group-item { display: flex; align-items: center; padding: 3px 0; }
    .meal-group-item-info { flex: 1; min-width: 0; }
    .meal-group-item-name { font-size: 13px; line-height: 1.4; color: var(--text); display: block; }
    .meal-group-item-macros { font-size: 11px; color: var(--text-muted); }
    .meal-group-footer { display: flex; gap: 10px; flex-wrap: wrap; font-size: 11px; color: var(--text-muted); padding-left: 46px; }
    .summary-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-top: 1.5px solid var(--border); margin-top: 4px;
    }
    .summary-label { font-size: 14px; font-weight: 700; }
    .summary-val { font-size: 15px; font-weight: 700; color: var(--green-mid); }
    .empty-state {
      text-align: center; padding: 28px 20px; color: var(--text-muted);
    }
    .empty-icon { font-size: 36px; margin-bottom: 8px; }
    .empty-text { font-size: 14px; line-height: 1.5; }
    .fab {
      position: fixed;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + 14px);
      right: 18px;
      width: 56px; height: 56px; border-radius: 50%;
      background: var(--green-mid); color: white;
      border: none;
      box-shadow: 0 4px 14px rgba(45,106,79,0.4);
      font-size: 26px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 90; -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .fab:active { transform: scale(0.92); box-shadow: 0 2px 8px rgba(45,106,79,0.3); }
    .fab.hidden { display: none; }
    .export-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px; border: 1.5px dashed var(--border);
      border-radius: 10px; background: none;
      color: var(--text-muted); font-size: 14px; cursor: pointer;
      width: calc(100% - 24px); margin: 0 12px 8px;
      -webkit-tap-highlight-color: transparent;
    }
    .export-btn:active { background: var(--bg); }
    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 200; display: flex; align-items: flex-end; justify-content: center;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: white; border-radius: 20px 20px 0 0;
      width: 100%; max-height: 92vh; overflow-y: auto;
      padding: 20px 16px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    }
    .modal-handle {
      width: 40px; height: 4px; background: var(--border);
      border-radius: 2px; margin: -8px auto 16px; display: block;
    }
    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 16px; text-align: center; }
    .search-wrap { position: relative; margin-bottom: 10px; }
    .search-input {
      width: 100%; padding: 13px 14px;
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 16px; background: #F8F9FA; outline: none;
      -webkit-appearance: none;
    }
    .search-input:focus { border-color: var(--green-light); background: white; }
    .ac-list {
      position: absolute; top: calc(100% + 4px); left: 0; right: 0;
      background: white; border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      max-height: 220px; overflow-y: auto; z-index: 300;
    }
    .ac-list.hidden { display: none; }
    .ac-item {
      padding: 12px 14px; cursor: pointer;
      border-bottom: 1px solid var(--border); font-size: 14px;
    }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:active { background: var(--green-pale); }
    .ac-unit { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .ac-kcal { float: right; font-size: 12px; color: var(--green-mid); font-weight: 600; }
    .selected-food-box {
      background: var(--green-pale); padding: 12px 14px;
      border-radius: 10px; margin-bottom: 12px;
    }
    .sel-name { font-weight: 600; font-size: 15px; }
    .sel-unit { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .sel-stats { display: flex; gap: 12px; margin-top: 6px; font-size: 13px; }
    .sel-kcal { color: var(--green-mid); font-weight: 700; }
    .sel-pfc { color: var(--text-muted); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .form-field { display: flex; flex-direction: column; gap: 4px; }
    .form-field.full { grid-column: 1 / -1; }
    .form-label { font-size: 12px; color: var(--text-muted); font-weight: 600; }
    .form-input {
      padding: 11px 12px; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 15px; background: #F8F9FA;
      outline: none; -webkit-appearance: none;
    }
    .form-input:focus { border-color: var(--green-light); background: white; }
    .btn {
      padding: 14px 20px; border-radius: 12px; border: none;
      font-size: 16px; font-weight: 700; cursor: pointer; width: 100%;
      margin-top: 10px; -webkit-tap-highlight-color: transparent;
      transition: opacity 0.1s;
    }
    .btn:active { opacity: 0.8; }
    .btn-primary { background: var(--green-mid); color: white; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .custom-section {
      margin-top: 14px; padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .custom-section-label {
      font-size: 13px; color: var(--text-muted); margin-bottom: 10px;
    }
    .fish-toggle {
      display: flex; align-items: center; gap: 10px;
      margin-top: 12px; font-size: 14px; cursor: pointer;
    }
    .fish-toggle input { width: 20px; height: 20px; cursor: pointer; }
    .fish-note {
      font-size: 11px; color: var(--text-muted);
      background: var(--green-pale); padding: 7px 10px;
      border-radius: 8px; margin-top: 8px; line-height: 1.5;
    }
    /* Supplements */
    .suppl-timing {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      padding: 10px 0 6px; letter-spacing: 0.3px;
    }
    .suppl-item {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 0; border-bottom: 1px solid var(--border);
    }
    .suppl-item:last-child { border-bottom: none; }
    .suppl-check {
      width: 26px; height: 26px; border: 2px solid var(--border);
      border-radius: 7px; flex-shrink: 0; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      -webkit-tap-highlight-color: transparent; transition: all 0.15s;
    }
    .suppl-check.checked { background: var(--green-mid); border-color: var(--green-mid); }
    .suppl-check.checked::after { content: "‚úì"; color: white; font-size: 15px; font-weight: 800; }
    .suppl-check.skipped { background: #E9ECEF; border-color: #CCC; }
    .suppl-check.skipped::after { content: "‚àí"; color: #999; font-size: 20px; font-weight: 700; line-height: 1; }
    .suppl-label { flex: 1; }
    .suppl-name { font-size: 14px; transition: color 0.15s; }
    .suppl-name.checked { text-decoration: line-through; color: var(--text-muted); }
    .suppl-name.skipped { color: var(--text-muted); }
    .suppl-note { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .suppl-skip-btn {
      font-size: 11px; color: var(--text-muted); background: #F0F0F0;
      border: 1px solid #DDD; border-radius: 10px; padding: 3px 8px;
      cursor: pointer; white-space: nowrap; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .suppl-skip-btn.active { background: #FFF3CD; border-color: #FFC107; color: #856404; }
    .compliance-bar {
      height: 10px; background: #E9ECEF;
      border-radius: 5px; overflow: hidden; margin: 8px 0 4px;
    }
    .compliance-fill {
      height: 100%; border-radius: 5px; background: var(--green-light);
      transition: width 0.3s;
    }
    .compliance-fill.full { background: var(--green-mid); }
    /* Weight */
    .weight-hero {
      text-align: center; padding: 8px 0 12px;
    }
    .weight-big {
      font-size: 56px; font-weight: 700;
      color: var(--green-dark); line-height: 1;
    }
    .weight-big .wunit { font-size: 20px; color: var(--text-muted); }
    .weight-sub { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .weight-input-row {
      display: flex; gap: 10px; align-items: center; margin-top: 12px;
    }
    .progress-main {
      height: 14px; background: #E9ECEF;
      border-radius: 7px; overflow: hidden; margin: 8px 0 4px;
    }
    .progress-fill {
      height: 100%; border-radius: 7px;
      background: linear-gradient(90deg, var(--green-light), var(--green-mid));
      transition: width 0.4s;
    }
    .milestone-list { display: flex; flex-direction: column; gap: 10px; }
    .weekly-target-table { width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
    .weekly-target-table th { text-align:right; padding:4px 6px; color:var(--text-muted); font-weight:600; border-bottom:1px solid var(--border); white-space:nowrap; }
    .weekly-target-table th:first-child { text-align:left; }
    .weekly-target-table td { padding:5px 6px; text-align:right; }
    .weekly-target-table td:first-child { text-align:left; }
    .wt-current { background:var(--green-pale); font-weight:700; }
    .wt-achieved td { color:var(--green-mid); font-weight:700; }
    .milestone-item {
      display: flex; align-items: center; gap: 10px; font-size: 14px;
    }
    .milestone-dot {
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; flex-shrink: 0;
    }
    .milestone-dot.done { background: var(--green-pale); color: var(--green-mid); font-size: 15px; }
    .milestone-dot.next { background: #FFF3CD; color: #856404; font-weight: 700; }
    .milestone-dot.future { background: #E9ECEF; color: var(--text-muted); font-size: 10px; }
    .milestone-info { flex: 1; }
    .milestone-name { font-size: 14px; }
    .milestone-date { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .milestone-weight {
      font-size: 14px; font-weight: 700; color: var(--text-muted);
    }
    .milestone-weight.achieved { color: var(--green-mid); }
    .milestone-weight.next-weight { color: var(--warning); }
    /* Chart */
    .chart-scroll { overflow-x: auto; }
    /* Toast */
    .toast {
      position: fixed;
      bottom: calc(var(--nav-height) + var(--safe-bottom) + 74px);
      left: 50%; transform: translateX(-50%);
      background: rgba(27,67,50,0.92); color: white;
      padding: 11px 20px; border-radius: 22px;
      font-size: 14px; z-index: 1000; white-space: nowrap;
      animation: toast-in 0.2s ease;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(8px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .spacer { height: 20px; }
    .hidden { display: none !important; }
    /* Qty input in modal */
    .qty-row {
      display: flex; align-items: center; gap: 10px; margin-top: 8px;
    }
    .qty-row label { font-size: 13px; color: var(--text-muted); white-space: nowrap; }
    .qty-input {
      flex: 1; padding: 10px 12px; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 16px; background: #F8F9FA;
      outline: none; -webkit-appearance: none; text-align: center;
    }
    .qty-input:focus { border-color: var(--green-light); }
    /* Nutrition bar */
    .nutr-bar { margin-bottom: 10px; }
    .nutr-bar-header { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px; }
    .nutr-bar-label { color: var(--text-muted); }
    .nutr-bar-val { font-weight: 600; }
    .nutr-bar-track { height: 6px; background: #E9ECEF; border-radius: 3px; overflow: hidden; }
    .nutr-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
    .nutr-bar-fill.ok { background: var(--green-light); }
    .nutr-bar-fill.warn { background: var(--warning); }
    .nutr-bar-fill.over { background: var(--danger); }
    .nutr-group-label {
      font-size: 11px; font-weight: 600; color: var(--text-secondary);
      margin: 12px 0 4px 0; padding-top: 8px;
      border-top: 1px solid var(--border);
    }
    .nutr-group-label:first-of-type {
      margin-top: 0; padding-top: 0; border-top: none;
    }
    .nutr-bar-note {
      display: block;
      font-size: 10px;
      font-weight: 400;
      color: var(--text-muted);
      margin-top: 1px;
    }
    /* Sleep */
    .sleep-hero {
      text-align: center; padding: 8px 0 12px;
    }
    .sleep-big {
      font-size: 52px; font-weight: 700;
      color: #2E4057; line-height: 1;
    }
    .sleep-big .sunit { font-size: 18px; color: var(--text-muted); }
    .sleep-sub { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .sleep-stage-bar {
      height: 20px; border-radius: 10px; overflow: hidden;
      display: flex; margin: 12px 0 6px; background: #E9ECEF;
    }
    .sleep-stage-rem   { background: #5B8FB9; }
    .sleep-stage-core  { background: #84B1CE; }
    .sleep-stage-deep  { background: #2E4057; }
    .sleep-stage-awake { background: #F4A261; }
    .sleep-legend {
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px;
    }
    .sleep-legend-item {
      display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-muted);
    }
    .sleep-legend-dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
    }
    /* AI Advice Cards */
    .advice-card {
      background: linear-gradient(135deg, #1B4332 0%, #2D6A4F 100%);
      border-radius: 14px; padding: 14px 16px; margin: 8px 12px;
      color: white; box-shadow: 0 2px 8px rgba(27,67,50,0.3);
    }
    .advice-card.stale { opacity: 0.55; }
    .advice-card-label {
      font-size: 10px; font-weight: 700; letter-spacing: 0.8px;
      opacity: 0.7; text-transform: uppercase; margin-bottom: 6px;
    }
    .advice-headline { font-size: 15px; font-weight: 700; line-height: 1.5; margin-bottom: 8px; }
    .advice-score-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .advice-score-num { font-size: 38px; font-weight: 800; line-height: 1; }
    .advice-score-meta { flex: 1; }
    .advice-score-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin-bottom: 2px; }
    .advice-score-fill { height: 100%; border-radius: 3px; background: #74C69D; }
    .advice-top-action {
      background: rgba(255,255,255,0.18); border-radius: 8px;
      padding: 8px 10px; font-size: 13px; font-weight: 700;
      line-height: 1.4; margin-top: 6px;
    }
    .advice-insight { font-size: 13px; line-height: 1.6; opacity: 0.95; margin-bottom: 8px; }
    .advice-week-trend { font-size: 12px; opacity: 0.8; margin-bottom: 6px; }
    .advice-tips { margin: 0 0 8px; padding-left: 16px; font-size: 12px; line-height: 1.8; opacity: 0.9; }
    .advice-box {
      background: rgba(255,255,255,0.15); border-radius: 8px;
      padding: 8px 10px; font-size: 12px; line-height: 1.5; margin-top: 6px;
    }
    .advice-box.green { background: rgba(116,198,157,0.25); }
    .advice-stale-note { font-size: 10px; opacity: 0.55; margin-top: 6px; text-align: right; }

    /* Pull-to-refresh */
    #ptr-indicator {
      position: fixed; top: var(--header-height); left: 0; right: 0;
      display: flex; align-items: center; justify-content: center;
      height: 0; overflow: hidden;
      transition: height 0.2s ease;
      background: var(--bg); z-index: 90;
    }
    #ptr-indicator.visible { height: 48px; }
    #ptr-spinner {
      width: 28px; height: 28px;
      border: 3px solid var(--border);
      border-top-color: var(--green-mid);
      border-radius: 50%;
      transition: transform 0.1s linear;
    }
    #ptr-spinner.spinning {
      animation: ptr-spin 0.7s linear infinite;
    }
    @keyframes ptr-spin { to { transform: rotate(360deg); } }
    /* Sync dot */
    .sync-dot {
      background: none; border: none; color: #aaa;
      font-size: 14px; padding: 4px 6px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.2s;
      line-height: 1;
    }
    .sync-dot:active { opacity: 0.5; }
    /* Sync settings modal */
    #sync-modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 200; display: flex; align-items: flex-end; justify-content: center;
    }
    #sync-modal-overlay.hidden { display: none; }
    .sync-modal {
      background: white; border-radius: 20px 20px 0 0;
      width: 100%; padding: 20px 20px calc(20px + env(safe-area-inset-bottom, 0px));
    }
    .sync-modal-title { font-size: 17px; font-weight: 700; margin-bottom: 4px; text-align: center; }
    .sync-modal-sub { font-size: 13px; color: var(--text-muted); text-align: center; margin-bottom: 20px; }
    .sync-input {
      width: 100%; padding: 12px 14px; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 15px; background: var(--bg);
      font-family: monospace; letter-spacing: 0.05em;
      outline: none;
    }
    .sync-input:focus { border-color: var(--green-light); }
    .sync-btn-row { display: flex; gap: 10px; margin-top: 14px; }
    .sync-btn {
      flex: 1; padding: 12px; border: none; border-radius: 10px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .sync-btn.primary { background: var(--green-mid); color: white; }
    .sync-btn.secondary { background: var(--bg); color: var(--text); }
    .sync-btn.danger { background: #DC3545; color: white; }
    .sync-status-row {
      display: flex; align-items: center; gap: 10px;
      padding: 14px; background: var(--bg); border-radius: 10px;
      margin-bottom: 14px; font-size: 14px;
    }
    .sync-status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .kpi-dots { display:flex; gap:4px; align-items:center; margin:8px 0; }
    .kpi-dot { width:24px; height:24px; border-radius:50%; display:flex;
      align-items:center; justify-content:center; font-size:11px; }
    .kpi-dot.hit { background:var(--green-pale); color:var(--green-mid); }
    .kpi-dot.miss { background:#FDE8E8; color:var(--danger); }
    .kpi-dot.nodata { background:#E9ECEF; color:var(--text-muted); }
    .kpi-result { font-size:16px; font-weight:800; margin-left:auto; }
    .kpi-result.ok { color:var(--green-mid); }
    .kpi-result.ng { color:var(--warning); }
  </style>
</head>
<body>
<div id="ptr-indicator"><div id="ptr-spinner"></div></div>
<div id="app">
  <header class="header">
    <h1 onclick="switchTab('meals')" style="cursor:pointer;">üåø Health Hub</h1>
    <div style="display:flex;align-items:center;gap:4px;">
      <span class="header-date" id="header-date"></span>
      <span class="header-clock" id="header-clock"></span>
      <button class="sync-dot" id="sync-dot" onclick="openSyncSettings()" title="ÂêåÊúüË®≠ÂÆö">‚óè</button>
      <button class="header-reload" onclick="reloadData()" title="„É™„É≠„Éº„Éâ">‚Üª</button>
    </div>
  </header>

  <main class="main" id="main-content"></main>

  <button class="fab hidden" id="fab-add" onclick="openModal()">Ôºã</button>

  <nav class="bottom-nav">
    <button class="nav-btn active" data-tab="meals" onclick="switchTab('meals')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8h1a4 4 0 0 1 0 8h-1M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8zM6 1v3M10 1v3M14 1v3"/>
      </svg>
      È£ü‰∫ã
    </button>
    <button class="nav-btn" data-tab="supplements" onclick="switchTab('supplements')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
      </svg>
      „Çµ„Éó„É™
    </button>
    <button class="nav-btn" data-tab="weight" onclick="switchTab('weight')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      ‰ΩìÈáç
    </button>
    <button class="nav-btn" data-tab="exercise" onclick="switchTab('exercise')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
      </svg>
      ÈÅãÂãï
    </button>
    <button class="nav-btn" data-tab="sleep" onclick="switchTab('sleep')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
      Áù°Áú†
    </button>
    <button class="nav-btn" data-tab="shopping" onclick="switchTab('shopping')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
      </svg>
      Ë≤∑„ÅÑÁâ©
    </button>
  </nav>
</div>

<!-- Add Food Modal -->
<div class="modal-overlay hidden" id="modal-overlay" onclick="onOverlayClick(event)">
  <div class="modal">
    <span class="modal-handle"></span>
    <div class="modal-title">È£ü‰∫ã„ÇíË®òÈå≤</div>

    <div class="search-wrap">
      <input type="search" class="search-input" id="food-search"
             placeholder="È£üÂìÅÂêç„ÇíÊ§úÁ¥¢..."
             oninput="onFoodSearch(this.value)"
             autocomplete="off" autocorrect="off"
             spellcheck="false">
      <div class="ac-list hidden" id="ac-list"></div>
    </div>

    <div id="selected-box" class="hidden">
      <div class="selected-food-box">
        <div class="sel-name" id="sel-name"></div>
        <div class="sel-unit" id="sel-unit"></div>
        <div class="sel-stats">
          <span class="sel-kcal" id="sel-kcal"></span>
          <span class="sel-pfc" id="sel-pfc"></span>
        </div>
      </div>
      <div class="qty-row">
        <label>ÂÄãÊï∞„ÉªÈáè</label>
        <input type="number" class="qty-input" id="food-qty" value="1" min="0.1" max="99" step="0.5">
      </div>
    </div>

    <div id="custom-form" class="hidden">
      <div class="custom-section">
        <div class="custom-section-label">„Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Å™„ÅÑÈ£üÂìÅ„ÇíÊâãÂãï„ÅßÂÖ•Âäõ</div>
        <div class="form-grid">
          <div class="form-field full">
            <label class="form-label">È£üÂìÅÂêç</label>
            <input type="text" class="form-input" id="c-name" placeholder="‰æã: „ÇÜ„ÅßÂçµ">
          </div>
          <div class="form-field">
            <label class="form-label">„Ç´„É≠„É™„Éº (kcal)</label>
            <input type="number" class="form-input" id="c-kcal" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">„Åü„Çì„Å±„ÅèË≥™ P (g)</label>
            <input type="number" class="form-input" id="c-p" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">ËÑÇË≥™ F (g)</label>
            <input type="number" class="form-input" id="c-f" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">ÁÇ≠Ê∞¥ÂåñÁâ© C (g)</label>
            <input type="number" class="form-input" id="c-c" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">„Éû„Ç∞„Éç„Ç∑„Ç¶„É† Mg (mg)</label>
            <input type="number" class="form-input" id="c-mg" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">È£üÁâ©ÁπäÁ∂≠ (g)</label>
            <input type="number" class="form-input" id="c-fiber" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">È£ΩÂíåËÑÇËÇ™ÈÖ∏ (g)</label>
            <input type="number" class="form-input" id="c-satfat" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">Â°©ÂàÜ (g)</label>
            <input type="number" class="form-input" id="c-salt" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">„Ç´„É´„Ç∑„Ç¶„É† Ca (mg)</label>
            <input type="number" class="form-input" id="c-ca" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">„Ç´„É™„Ç¶„É† K (mg)</label>
            <input type="number" class="form-input" id="c-k" placeholder="0">
          </div>
          <div class="form-field">
            <label class="form-label">Âçò‰Ωç</label>
            <input type="text" class="form-input" id="c-unit" placeholder="‰æã: 1ÂÄã">
          </div>
        </div>
        <label class="fish-toggle">
          <input type="checkbox" id="is-fish">
          üêü È≠ö„ÅÆËÑÇË≥™„Éú„Éº„Éä„ÇπÈÅ©Áî®Ôºà„Ç´„É≠„É™„Éº√ó0.7Ôºâ
        </label>
        <div class="fish-note">ÈùíÈ≠ö„ÉªÈÆ≠„Å™„Å©È≠ö„ÅÆËÑÇË≥™„Ç´„É≠„É™„Éº„ÅØ√ó0.7„ÅßË®àÁÆóÔºà„Ç™„É°„Ç¨3„ÅØ‰ΩìËÑÇËÇ™„Å´„Å™„Çä„Å´„Åè„ÅÑÔºâ</div>
      </div>
    </div>

    <button class="btn btn-primary" id="btn-record" onclick="addFoodRecord()">Ë®òÈå≤„Åô„Çã</button>
    <button class="btn btn-secondary" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
  </div>
</div>

<!-- Sync Settings Modal -->
<div id="sync-modal-overlay" class="hidden" onclick="if(event.target===this)closeSyncSettings()">
  <div class="sync-modal">
    <span class="modal-handle" style="width:40px;height:4px;background:var(--border);border-radius:2px;margin:-8px auto 16px;display:block;"></span>
    <div class="sync-modal-title">üîÑ GitHub ÂêåÊúüË®≠ÂÆö</div>
    <div class="sync-modal-sub">iPhone„Åß„ÉÅ„Çß„ÉÉ„ÇØ ‚Üí GitHub„Å´Ëá™Âãï‰øùÂ≠ò</div>
    <div id="sync-config-view"></div>
  </div>
</div>

<script>
// ======== FOOD DATABASE ========
// food-db.json „Åã„ÇâÂãïÁöÑ„É≠„Éº„ÉâÔºàÂàùÂõûfetchÂæå„Å´„Ç≠„É£„ÉÉ„Ç∑„É•Ôºâ
let BUILT_IN_FOODS = [];
async function loadFoodDb() {
  try {
    const res = await fetch(`${DATA_BASE_URL}food-db.json`, { cache: 'no-store' });
    if (!res.ok) return;
    BUILT_IN_FOODS = await res.json();
  } catch { /* „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Á©∫ÈÖçÂàó„ÅÆ„Åæ„ÅæÔºà„Ç´„Çπ„Çø„É†È£üÂìÅ„ÅØÂºï„ÅçÁ∂ö„Åç‰ΩøÁî®ÂèØÔºâ */ }
}

// ======== SUPPLEMENTS ========
const SUPPLEMENTS = [
  { id:"m1", timing:"morning",   name:"„É¶„É™„Çπ",               note:"Âá¶ÊñπËñ¨ÔºàÂ∞øÈÖ∏ÂÄ§Ôºâ",         catchup:true },
  { id:"m2", timing:"morning",   name:"„Éû„É´„ÉÅ„Éì„Çø„Éü„É≥",         note:"",                        catchup:true },
  { id:"m3", timing:"morning",   name:"CoQ10",                note:"",                        catchup:true },
  { id:"m4", timing:"morning",   name:"„Ç®„Éì„Ç™„Çπ 10Èå†",          note:"",                        catchup:false },
  { id:"m5", timing:"morning",   name:"„Éì„Ç™„Çπ„É™„Éº",              note:"",                        catchup:false },
  { id:"m6", timing:"morning",   name:"The Daily Power",      note:"È£≤„Åø„Åç„Çã„Åæ„Åß",              catchup:true },
  { id:"e1", timing:"evening",   name:"„É≠„Çπ„Éê„Çπ„Çø„ÉÅ„É≥",          note:"Âá¶ÊñπËñ¨Ôºà„Ç≥„É¨„Çπ„ÉÜ„É≠„Éº„É´ÔºâÂ§ïÈ£üÂæå", catchup:true },
  { id:"e2", timing:"evening",   name:"‰∫úÈâõ (THORNE)",         note:"",                        catchup:true },
  { id:"e3", timing:"evening",   name:"„Ç®„Éì„Ç™„Çπ 10Èå†",           note:"",                        catchup:false },
  { id:"e4", timing:"evening",   name:"„Éì„Ç™„Çπ„É™„Éº 2Èå†",          note:"",                        catchup:false },
  { id:"b1", timing:"bedtime",   name:"„Éû„Ç∞„Éç„Ç∑„Ç¶„É†",            note:"1„Ç´„Éó„Çª„É´‚âí87.5mg„ÄÅÊúÄÂ§ß4„Ç´„Éó„Çª„É´", catchup:false },
];
const TIMING_LABELS = {
  morning:   "‚òÄÔ∏è ÊúùÔºà1È£üÁõÆÂæå„Éª10ÊôÇ„Åî„ÇçÔºâ",
  evening:   "üåô Â§úÔºà2È£üÁõÆÂæå„Éª18ÊôÇ„Åî„ÇçÔºâ",
  bedtime:   "üõè Â∞±ÂØùÂâçÔºàÂ§ïÈ£ü2ÊôÇÈñìÂæåÔºâ",
};

// ======== TARGETS & MILESTONES ========
const TARGETS = {
  kcalMin:1700, kcalMax:1800, kcalFloor:1400,
  pfcP:25, pfcF:25, pfcC:50,  // PFCÁõÆÊ®ôÊØîÁéá(%)
  mgTarget:370, fiberTarget:21,
  saltTarget:7.5,    // Â°©ÂàÜ(g) ‚Äî ÁõÆÊ®ô7.5g‰ª•‰∏ã
  satFatPct:7,       // È£ΩÂíåËÑÇËÇ™ÈÖ∏ ‚Äî Á∑è„Ç´„É≠„É™„Éº„ÅÆ7%‰ª•‰∏ãÔºàAHA„Ç¨„Ç§„Éâ„É©„Ç§„É≥Ôºâ
  caTarget:750,      // „Ç´„É´„Ç∑„Ç¶„É†(mg) ‚Äî ÂéöÂä¥ÁúÅ50-64Ê≠≥Áî∑ÊÄßÊé®Â•®Èáè
  kTarget:2600       // „Ç´„É™„Ç¶„É†(mg) ‚Äî ÂéöÂä¥ÁúÅÁî∑ÊÄßÁõÆÊ®ôÈáè
};
// kcalFloor: „Å©„ÅãÈ£ü„ÅÑÈò≤Ê≠¢„ÅÆÊúÄ‰Ωé„É©„Ç§„É≥ÔºàÁõÆÊ®ô„ÅÆÁ¥Ñ82%Ôºâ
// Ê†πÊã†: BMR‚âí1,647kcal„ÄÇ1,700„ÅÆ85%=1,445 ‚Üí Âàá„Çä„Çà„Åè1,400„ÄÇ
// 1,227kcal„ÅØÁõÆÊ®ô„ÅÆ72%„ÅßÂº∑„ÅÑÈ£¢È§ìÊÑü‚ÜíÁøåÊó•„É™„Éê„Ç¶„É≥„ÉâÈ£ü„ÅÑ„ÇíË™òÁô∫„ÄÇ
// PFC„Åã„ÇâÁõÆÊ®ô„Ç∞„É©„É†„ÇíËá™ÂãïË®àÁÆó
TARGETS.pMin = Math.round(TARGETS.pfcP/100 * TARGETS.kcalMin / 4);  // 106
TARGETS.pMax = Math.round(TARGETS.pfcP/100 * TARGETS.kcalMax / 4);  // 113
TARGETS.fMin = Math.round(TARGETS.pfcF/100 * TARGETS.kcalMin / 9);  // 47
TARGETS.fMax = Math.round(TARGETS.pfcF/100 * TARGETS.kcalMax / 9);  // 50
TARGETS.cMin = Math.round(TARGETS.pfcC/100 * TARGETS.kcalMin / 4);  // 213
TARGETS.cMax = Math.round(TARGETS.pfcC/100 * TARGETS.kcalMax / 4);  // 225
TARGETS.satFatMax = Math.round(TARGETS.satFatPct/100 * TARGETS.kcalMax / 9);  // 14g
TARGETS.unsatFatMin = TARGETS.fMin - TARGETS.satFatMax;  // 33g
const MILESTONES = [
  { label:"ËÑÇËÇ™ËÇùÊîπÂñÑÔºà7%Ê∏õÔºâ", weight:82.2, bf:27, date:"2026-06-22" },
  { label:"80„ÅÆÂ£Å„ÇíÂàá„Çã",     weight:79.9, bf:25, date:"2026-08-15" },
  { label:"75kg„ÇíÂàá„Çã",       weight:74.9, bf:21, date:"2026-12-09" },
  { label:"72kg„ÇíÂàá„Çã",       weight:71.9, bf:19, date:"2027-02-17" },
  { label:"ÊúÄÁµÇÁõÆÊ®ô 69.9kg",   weight:69.9, bf:18, date:"2027-04-03" },
];
const WEEKLY_TARGETS = [
  { week:1, date:"2026-03-02", highProb:87.0, bonus:86.9 },
  { week:2, date:"2026-03-09", highProb:86.7, bonus:86.5 },
  { week:3, date:"2026-03-16", highProb:86.4, bonus:86.1 },
  { week:4, date:"2026-03-23", highProb:86.1, bonus:85.7 },
  { week:5, date:"2026-03-30", highProb:85.8, bonus:85.3 },
];
const START_WEIGHT = 88.0;
const GOAL_WEIGHT = 69.9;
const SUPPL_DOSING = {
  mg: { perCapsule: 87.5, maxCapsules: 4 },
  psyllium: { fiberPerCapsule: 0.55, capPerServing: 5, maxServings: 3 }
};

// ======== STATE ========
let currentTab = 'meals';
let currentDate = todayStr();
let searchResults = [];
let selectedFood = null;

function todayStr() {
  const d = new Date();
  return fmtDate(d);
}
function fmtDate(d) {
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function pad(n) { return String(n).padStart(2,'0'); }

function formatDateLabel(ds) {
  const [y,m,d] = ds.split('-').map(Number);
  const dow = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][new Date(y,m-1,d).getDay()];
  return `${m}/${d}Ôºà${dow}Ôºâ`;
}

// ======== STORAGE ========
function ls(key, val) {
  if (val === undefined) {
    try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
  }
  localStorage.setItem(key, JSON.stringify(val));
}

function getMeals(ds) {
  return (ls(`meals_${ds}`) || []).map(m => {
    if (m.kcal !== undefined) return m; // Ê≠£Â∏∏ÂΩ¢Âºè
    if (m.total) { // „Éç„Çπ„ÉàÂΩ¢Âºè ‚Üí „Éï„É©„ÉÉ„ÉàÂåñ
      const itemNames = m.items?.map(i => i.name).join('„ÄÅ') || m.type || 'È£ü‰∫ã';
      return { time: m.time, name: itemNames,
        kcal: m.total.kcal||0, p: m.total.p||0, f: m.total.f||0, c: m.total.c||0,
        mg: m.total.mg||0, fiber: m.total.fiber||0 };
    }
    return null; // Ë™≠„ÇÅ„Å™„ÅÑ„Éá„Éº„Çø„ÅØÈô§Â§ñ
  }).filter(Boolean);
}
function saveMeals(ds, meals) { ls(`meals_${ds}`, meals); }
function getWeights()      { return ls('weights')   || {}; }
function saveWeights(w)   { ls('weights', w); }
function getBodyFat()     { return ls('bodyFat')   || {}; }
function saveBodyFat(bf)  { ls('bodyFat', bf); }

function getSuppl(ds) { return ls(`suppl_${ds}`) || {}; }
function saveSuppl(ds, s) { ls(`suppl_${ds}`, s); }
function getSleepData() { return ls('sleep') || {}; }
function saveSleepData(s) { ls('sleep', s); }
function getCustomFoods() { return ls('custom_foods') || []; }
function saveCustomFoods(foods) { ls('custom_foods', foods); }
function getAllFoods() { return [...BUILT_IN_FOODS, ...getCustomFoods()]; }
function getHealthLog()    { return ls('healthLog') || {}; }
function saveHealthLog(d)  { ls('healthLog', d); }
function getWorkoutLog()     { return ls('workoutLog') || { sessions: [] }; }
function saveWorkoutLog(d)  { ls('workoutLog', d); }
function getFitnessCheck()  { return ls('fitnessCheck') || { benchmarks: {}, checks: [] }; }
function saveFitnessCheck(d){ ls('fitnessCheck', d); }

function stampLastUpdated() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const el = document.getElementById('header-clock');
  if (el) el.textContent = `${hh}:${mm} Êõ¥Êñ∞`;
}

// ======== SERVER SYNC ========
const DATA_BASE_URL = 'https://shujiuyeda.github.io/web/data/';

// ======== GITHUB SYNC ========
const GH_REPO = 'shujiuyeda/web';
const GH_API  = 'https://api.github.com';

function ghToken()       { return ls('gh_pat') || ''; }
function ghSyncEnabled() { return !!ghToken(); }

let _lastSyncError = null;
function setSyncStatus(status, code) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  const colors = { ok:'#28A745', syncing:'#E5A020', error:'#DC3545', none:'#aaa' };
  dot.style.color = colors[status] || colors.none;
  if (code !== undefined) _lastSyncError = code;
}

async function ghGetFileSha(path) {
  try {
    // „Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÅßÂè§„ÅÑSHA„ÅåËøî„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
    const res = await fetch(`${GH_API}/repos/${GH_REPO}/contents/${path}?_=${Date.now()}`, {
      headers: { 'Authorization': `Bearer ${ghToken()}`, 'Accept': 'application/vnd.github+json' }
    });
    if (!res.ok) return null;
    return (await res.json()).sha || null;
  } catch { return null; }
}

async function ghPutFile(path, content, message) {
  const sha = await ghGetFileSha(path);
  const body = { message, content: btoa(unescape(encodeURIComponent(content))) };
  if (sha) body.sha = sha;
  try {
    const res = await fetch(`${GH_API}/repos/${GH_REPO}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${ghToken()}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      _lastSyncError = res.status;
      console.error('ghPutFile failed:', res.status, path);
    }
    return res.ok;
  } catch (e) {
    _lastSyncError = 'net';
    console.error('ghPutFile error:', e, path);
    return false;
  }
}

let _syncQueue = Promise.resolve();
function syncSupplToGitHub(ds) {
  if (!ghSyncEnabled()) return;
  _syncQueue = _syncQueue.then(async () => {
    setSyncStatus('syncing');
    try {
      const checks = getSuppl(ds);
      const saved = {};
      Object.entries(checks).forEach(([k, v]) => { if (v === true) saved[k] = true; });
      const content = JSON.stringify({ date: ds, checks: saved }, null, 2);
      const ok = await ghPutFile(`data/suppl-${ds}.json`, content, `suppl sync: ${ds}`);
      setSyncStatus(ok ? 'ok' : 'error');
      if (ok) {
        const pending = (ls('pending_syncs') || []).filter(p => p !== ds);
        ls('pending_syncs', pending);
      } else {
        const pending = ls('pending_syncs') || [];
        if (!pending.includes(ds)) ls('pending_syncs', [...pending, ds]);
      }
    } catch {
      setSyncStatus('error');
      const pending = ls('pending_syncs') || [];
      if (!pending.includes(ds)) ls('pending_syncs', [...pending, ds]);
    }
  });
}

function syncWeightsToGitHub() {
  if (!ghSyncEnabled()) return;
  _syncQueue = _syncQueue.then(async () => {
    setSyncStatus('syncing');
    try {
      const weights = getWeights();
      const bodyFat = getBodyFat();
      const content = JSON.stringify({ weights, bodyFat }, null, 2);
      const ds = currentDate;
      const ok = await ghPutFile('data/weights.json', content, `weight sync: ${ds}`);
      setSyncStatus(ok ? 'ok' : 'error');
      if (!ok) {
        const pending = ls('pending_syncs') || [];
        if (!pending.includes('weights')) ls('pending_syncs', [...pending, 'weights']);
      }
    } catch {
      setSyncStatus('error');
      const pending = ls('pending_syncs') || [];
      if (!pending.includes('weights')) ls('pending_syncs', [...pending, 'weights']);
    }
  });
}

function syncShoppingToGitHub() {
  if (!ghSyncEnabled()) return;
  _syncQueue = _syncQueue.then(async () => {
    setSyncStatus('syncing');
    try {
      const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
      const checks = JSON.parse(localStorage.getItem('shopping_checks') || '{}');
      const updated = currentDate;
      const content = JSON.stringify({ updated, items, checks }, null, 2);
      const ok = await ghPutFile('data/shopping.json', content, `shopping sync: ${updated}`);
      setSyncStatus(ok ? 'ok' : 'error');
      if (!ok) {
        const pending = ls('pending_syncs') || [];
        if (!pending.includes('shopping')) ls('pending_syncs', [...pending, 'shopping']);
      }
    } catch {
      setSyncStatus('error');
      const pending = ls('pending_syncs') || [];
      if (!pending.includes('shopping')) ls('pending_syncs', [...pending, 'shopping']);
    }
  });
}

async function flushPendingSyncs() {
  if (!ghSyncEnabled()) return;
  const pending = ls('pending_syncs') || [];
  for (const ds of pending) {
    if (ds === 'shopping') await syncShoppingToGitHub();
    else await syncSupplToGitHub(ds);
  }
}

async function testGhToken(token) {
  try {
    const res = await fetch(`${GH_API}/repos/${GH_REPO}`, {
      headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json' }
    });
    return res.ok;
  } catch { return false; }
}

function openSyncSettings() {
  document.getElementById('sync-modal-overlay').classList.remove('hidden');
  renderSyncConfig();
}
function closeSyncSettings() {
  document.getElementById('sync-modal-overlay').classList.add('hidden');
}
function renderSyncConfig() {
  const view = document.getElementById('sync-config-view');
  const token = ghToken();
  if (token) {
    const masked = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + token.slice(-6);
    view.innerHTML = `
      <div class="sync-status-row">
        <div class="sync-status-dot" style="background:#28A745"></div>
        <span>Êé•Á∂öÊ∏à„Åø: <code style="font-family:monospace">${masked}</code></span>
      </div>
      ${_lastSyncError ? `<div style="font-size:12px;color:#DC3545;margin-top:6px;">‚ö†Ô∏è ÊúÄÁµÇ„Ç®„É©„Éº: HTTP ${_lastSyncError}${_lastSyncError===403?' (Êõ∏„ÅçËæº„ÅøÊ®©Èôê„Å™„ÅóÔºü)':_lastSyncError===401?' („Éà„Éº„ÇØ„É≥ÊúüÈôêÂàá„ÇåÔºü)':_lastSyncError===422?' (SHA‰∏ç‰∏ÄËá¥Ôºü)':''}</div>` : ''}
      <div class="sync-btn-row">
        <button class="sync-btn secondary" onclick="testAndShowResult()">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
        <button class="sync-btn danger" onclick="disconnectGh()">ÂàáÊñ≠</button>
      </div>
      <div id="sync-test-result" style="margin-top:12px;font-size:14px;text-align:center;"></div>
      <button class="sync-btn secondary" style="width:100%;margin-top:10px" onclick="closeSyncSettings()">Èñâ„Åò„Çã</button>`;
  } else {
    view.innerHTML = `
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;line-height:1.6">
        Fine-grained PATÔºà<code>shujiuyeda/web</code> „ÅÆ Contents: Read and writeÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
      </p>
      <input type="password" class="sync-input" id="pat-input" placeholder="github_pat_...">
      <div class="sync-btn-row">
        <button class="sync-btn secondary" onclick="closeSyncSettings()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="sync-btn primary" onclick="saveGhToken()">Êé•Á∂ö„ÉÜ„Çπ„ÉàÔºÜ‰øùÂ≠ò</button>
      </div>
      <div id="sync-test-result" style="margin-top:12px;font-size:14px;text-align:center;"></div>`;
  }
}
async function saveGhToken() {
  const input = document.getElementById('pat-input');
  const token = (input?.value || '').trim();
  if (!token) return;
  const result = document.getElementById('sync-test-result');
  result.textContent = 'Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...';
  const ok = await testGhToken(token);
  if (ok) {
    ls('gh_pat', token);
    setSyncStatus('ok');
    result.textContent = '‚úÖ Êé•Á∂öOKÔºÅ‰øùÂ≠ò„Åó„Åæ„Åó„Åü';
    setTimeout(() => { closeSyncSettings(); flushPendingSyncs(); }, 1200);
  } else {
    result.textContent = '‚ùå Êé•Á∂öÂ§±Êïó„ÄÇ„Éà„Éº„ÇØ„É≥„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
  }
}
async function testAndShowResult() {
  const result = document.getElementById('sync-test-result');
  result.textContent = 'Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...';
  const repoOk = await testGhToken(ghToken());
  if (!repoOk) { result.textContent = '‚ùå Êé•Á∂öÂ§±ÊïóÔºà„É™„Éù„Ç∏„Éà„É™„Ç¢„ÇØ„Çª„Çπ‰∏çÂèØÔºâ'; return; }
  // Contents read „ÉÜ„Çπ„ÉàÔºàSHAÂèñÂæó„ÇíË©¶„Åø„ÇãÔºâ
  const sha = await ghGetFileSha('data/shopping.json');
  const errNote = _lastSyncError ? `„ÄÄÊúÄÁµÇ„Ç®„É©„Éº: HTTP ${_lastSyncError}` : '';
  if (!sha) {
    result.textContent = '‚ö†Ô∏è „É™„Éù„Ç∏„Éà„É™OK„Å†„Åå„Éï„Ç°„Ç§„É´Ë™≠„ÅøÂèñ„Çä‰∏çÂèØ„ÄÇContents„Çπ„Ç≥„Éº„Éó„ÇíÁ¢∫Ë™ç„Åó„Å¶' + errNote;
  } else {
    result.textContent = `‚úÖ Êé•Á∂öOKÔºàSHAÂèñÂæóÊàêÂäüÔºâ${errNote}`;
  }
}
function disconnectGh() {
  if (!confirm('GitHubÂêåÊúü„ÇíÂàáÊñ≠„Åó„Åæ„Åô„ÅãÔºü')) return;
  localStorage.removeItem('gh_pat');
  setSyncStatus('none');
  renderSyncConfig();
}

async function tryFetchMeals(ds) {
  try {
    // „Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº‰ªò„Åç„ÅßÂ∏∏„Å´„É™„É¢„Éº„Éà„Åã„ÇâfetchÔºàlocalStorage„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å™„ÅÑÔºâ
    const res = await fetch(`${DATA_BASE_URL}meals-${ds}.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json();
    if (!data.meals) return;  // malformed„Éá„Éº„Çø„ÅÆ„Åø„Çπ„Ç≠„ÉÉ„Éó
    if (data.meals.length === 0) {
      saveMeals(ds, []);  // „É™„É¢„Éº„Éà„ÅåÁ©∫ ‚Üí localStorage„Çí„ÇØ„É™„Ç¢
      stampLastUpdated();
      if (ds === currentDate) deferRender(currentTab);
      return;
    }
    // JSON„ÅÆ„Éç„Çπ„ÉàÊßãÈÄ† {items, total:{kcal,p,f,c}} „Çí„Ç¢„Éó„É™ÂÜÖÂΩ¢Âºè {kcal,p,f,c} „Å´„Éï„É©„ÉÉ„ÉàÂåñ
    const normalized = data.meals.map(m => {
      if (m.total && m.kcal === undefined) {
        const itemNames = m.items?.map(i => i.name).join('„ÄÅ') || m.type || 'È£ü‰∫ã';
        const mgSum = m.total.mg || m.items?.reduce((s, i) => s + (i.mg || 0), 0) || 0;
        const fiberSum = m.total.fiber || m.items?.reduce((s, i) => s + (i.fiber || 0), 0) || 0;
        return { time: m.time, name: itemNames, kcal: m.total.kcal||0, p: m.total.p||0, f: m.total.f||0, c: m.total.c||0, mg: mgSum, fiber: fiberSum };
      }
      return m;
    });
    // „É™„É¢„Éº„ÉàÂÑ™ÂÖà„Åß„Éû„Éº„Ç∏: „É≠„Éº„Ç´„É´„Å´„Åó„Åã„Å™„ÅÑÈ£ü‰∫ãÔºà„Ç¢„Éó„É™UIÊâãÂÖ•ÂäõÂàÜÔºâ„ÅØ‰øùÊåÅ
    const local = getMeals(ds);
    const remoteTimes = new Set(normalized.map(m => m.time));
    const localOnly = local.filter(m => !remoteTimes.has(m.time));
    const merged = [...normalized, ...localOnly];
    saveMeals(ds, merged);
    stampLastUpdated();
    if (ds === currentDate) deferRender(currentTab);
    else if (currentTab === 'weight') deferRender('weight'); // ‰ΩìÈáç„Çø„Éñ„ÇÇÂÜçÊèèÁîª
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}

async function tryFetchSuppl(ds) {
  try {
    const res = await fetch(`${DATA_BASE_URL}suppl-${ds}.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json();
    if (!data.checks || Object.keys(data.checks).length === 0) return;
    if (ghSyncEnabled()) {
      // ÂêåÊúü„É¢„Éº„Éâ: „É™„É¢„Éº„Éà„ÅåÊ≠£ÔºàiPhoneÂÅ¥„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂèçÊò†Ôºâ
      saveSuppl(ds, data.checks);
    } else {
      // Ë™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®„É¢„Éº„Éâ: local„ÅåÂÑ™ÂÖà„Åß„Éû„Éº„Ç∏
      const local = getSuppl(ds);
      let updated = false;
      Object.entries(data.checks).forEach(([k, v]) => {
        if (local[k] == null) { local[k] = v; updated = true; }
      });
      if (updated || Object.keys(local).length === 0) {
        saveSuppl(ds, Object.keys(local).length > 0 ? local : data.checks);
      } else { return; }
    }
    stampLastUpdated();
    if (ds === currentDate && currentTab === 'supplements') deferRender(currentTab);
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}


async function tryFetchHealthLog() {
  try {
    const res = await fetch(`${DATA_BASE_URL}health-log.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    const local = getHealthLog();
    let updated = false;
    Object.entries(remote).forEach(([ds, entry]) => {
      if (!local[ds]) { local[ds] = entry; updated = true; }
      else {
        // „É™„É¢„Éº„Éà„ÅÆÂÄ§„Åß„Çµ„Éº„Éê„Éº„ÅåÊ≠£„Å®„Åó„Å¶‰∏äÊõ∏„ÅçÔºà„Çµ„Éº„Éê„Éº„ÅåSource of TruthÔºâ
        Object.entries(entry).forEach(([k, v]) => {
          if (v != null && local[ds][k] !== v) { local[ds][k] = v; updated = true; }
        });
      }
    });
    if (updated) saveHealthLog(local);
  } catch { /* silent */ }
}

async function tryFetchWeights() {
  try {
    const res = await fetch(`${DATA_BASE_URL}weights.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    let updated = false;

    // ‰ΩìÈáç„Éû„Éº„Ç∏Ôºà„Çµ„Éº„Éê„Éº„ÅåSource of TruthÔºâ
    const localW = getWeights();
    const remoteW = remote.weights || remote; // Êóß„Éï„Ç©„Éº„Éû„ÉÉ„Éà‰∫íÊèõ
    Object.entries(remoteW).forEach(([ds, w]) => {
      if (localW[ds] == null || localW[ds] !== w) { localW[ds] = w; updated = true; }
    });
    if (updated) saveWeights(localW);

    // ‰ΩìËÑÇËÇ™„Éû„Éº„Ç∏Ôºà„Çµ„Éº„Éê„Éº„ÅåSource of TruthÔºâ
    if (remote.bodyFat) {
      const localBF = getBodyFat();
      let bfUpdated = false;
      Object.entries(remote.bodyFat).forEach(([ds, bf]) => {
        if (localBF[ds] == null || localBF[ds] !== bf) { localBF[ds] = bf; bfUpdated = true; }
      });
      if (bfUpdated) saveBodyFat(localBF);
      updated = updated || bfUpdated;
    }

    if (updated) {
      stampLastUpdated();
      if (currentTab === 'weight') deferRender('weight');
    }
  } catch { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅØsilent */ }
}

async function tryFetchShopping() {
  try {
    const res = await fetch(`${DATA_BASE_URL}shopping.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    if (!remote.items) return;
    // items„ÅØremote„ÇíÊ≠£Ôºàsource of truthÔºâ„Å®„Åó„Å¶‰∏äÊõ∏„Åç
    localStorage.setItem('shopping_items', JSON.stringify(remote.items));
    // checks„ÅØ„É≠„Éº„Ç´„É´„Å´„ÅÇ„Çå„Å∞„É≠„Éº„Ç´„É´ÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞remote„Çí‰Ωø„ÅÜ
    if (remote.checks && Object.keys(remote.checks).length > 0) {
      const local = JSON.parse(localStorage.getItem('shopping_checks') || '{}');
      if (Object.keys(local).length === 0) {
        localStorage.setItem('shopping_checks', JSON.stringify(remote.checks));
      }
    }
    if (currentTab === 'shopping') deferRender('shopping');
  } catch { /* silent */ }
}

async function tryFetchSleep() {
  try {
    const res = await fetch(`${DATA_BASE_URL}sleep.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    const local = getSleepData();
    let updated = false;
    Object.entries(remote).forEach(([ds, s]) => {
      // „Çµ„Éº„Éê„Éº„ÅåSource of Truth: „É≠„Éº„Ç´„É´„Å´„Å™„ÅÑ or ÂÜÖÂÆπ„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞
      if (local[ds] == null || JSON.stringify(local[ds]) !== JSON.stringify(s)) {
        local[ds] = s; updated = true;
      }
    });
    if (updated) {
      saveSleepData(local);
      stampLastUpdated();
      if (currentTab === 'sleep') deferRender('sleep');
    }
  } catch { /* silent */ }
}

async function tryFetchWorkoutLog() {
  try {
    const res = await fetch(`${DATA_BASE_URL}workout-log.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    if (!remote.sessions) return;
    // „É™„É¢„Éº„Éà„ÅÆsessions„Çí„Éû„Éº„Ç∏ÔºàÊó•‰ªò„Éô„Éº„Çπ„Åß„ÄÅ„É≠„Éº„Ç´„É´„Å´„Å™„ÅÑÊó•‰ªò„ÇíËøΩÂä†Ôºâ
    const local = getWorkoutLog();
    const localDates = new Set((local.sessions || []).map(s => s.date));
    let updated = false;
    remote.sessions.forEach(s => {
      if (!localDates.has(s.date)) { local.sessions.push(s); updated = true; }
    });
    if (updated) {
      local.sessions.sort((a, b) => a.date.localeCompare(b.date));
      saveWorkoutLog(local);
      if (currentTab === 'exercise') deferRender('exercise');
    }
  } catch { /* silent */ }
}

async function tryFetchFitnessCheck() {
  try {
    const res = await fetch(`${DATA_BASE_URL}fitness-check.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const remote = await res.json();
    if (!remote.checks) return;
    saveFitnessCheck(remote);
    if (currentTab === 'exercise') deferRender('exercise');
  } catch { /* silent */ }
}

function syncStretchToGitHub(ds) {
  if (!ghSyncEnabled()) return;
  _syncQueue = _syncQueue.then(async () => {
    setSyncStatus('syncing');
    try {
      const log = getHealthLog();
      const content = JSON.stringify(log, null, 4);
      const ok = await ghPutFile('data/health-log.json', content, `stretch sync: ${ds}`);
      setSyncStatus(ok ? 'ok' : 'error');
    } catch { setSyncStatus('error'); }
  });
}

// ======== ADVICE ========
let adviceStore = {};   // ÂÖ®Êó•‰ªòÂàÜ { "YYYY-MM-DD": {...} }
let adviceData = null;  // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆÊó•‰ªòÂàÜÔºàÊó¢Â≠òÈñ¢Êï∞„Å®„ÅÆ‰∫íÊèõÁî®Ôºâ

async function tryFetchAdvice() {
  try {
    const res = await fetch(`${DATA_BASE_URL}advice.json?_=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json();
    if (data.generated) {
      adviceStore = { [todayStr()]: data };  // ÊóßÊßãÈÄ†Ôºö‰ªäÊó•„ÅÆÊó•‰ªò„Åß„É©„ÉÉ„Éó
    } else {
      adviceStore = data;                     // Êñ∞ÊßãÈÄ†Ôºö„Åù„ÅÆ„Åæ„ÅæÊ†ºÁ¥ç
    }
    syncAdviceToCurrentDate();
  } catch { /* silent */ }
}

function syncAdviceToCurrentDate() {
  adviceData = adviceStore[currentDate] || null;
  if (['meals','supplements','weight','sleep'].includes(currentTab)) {
    deferRender(currentTab);
  }
}

function isAdviceStale() {
  if (!adviceData?.generated) return true;
  if (currentDate !== todayStr()) return false;  // ÈÅéÂéªÊó•„ÅØÂõ∫ÂÆö„Éá„Éº„Çø„Å®„Åó„Å¶Êâ±„ÅÜ
  return (Date.now() - new Date(adviceData.generated).getTime()) > 24 * 60 * 60 * 1000;
}

function getAdviceDateLabel() {
  if (currentDate === todayStr()) return '‰ªäÊó•„ÅÆÂÅ•Â∫∑„Çπ„Ç≥„Ç¢';
  const [, m, d] = currentDate.split('-').map(Number);
  return `${m}Êúà${d}Êó•„ÅÆÂÅ•Â∫∑„Çπ„Ç≥„Ç¢`;
}

function renderOverallBanner() {
  if (!adviceData?.overall) {
    if (currentDate !== todayStr()) {
      return `<div class="advice-card" style="opacity:0.6;text-align:center;padding:16px;">
        <div class="advice-card-label">üåø ${getAdviceDateLabel()}</div>
        <div style="font-size:13px;color:var(--text-muted);margin-top:8px;">„Åì„ÅÆÊó•„ÅÆAIÂàÜÊûê„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
      </div>`;
    }
    return '';
  }
  const stale = isAdviceStale();
  const o = adviceData.overall;
  const score = o.score ?? 0;
  return `
    <div class="advice-card${stale ? ' stale' : ''}">
      <div class="advice-card-label">üåø ${getAdviceDateLabel()}</div>
      <div class="advice-headline">${esc(o.headline)}</div>
      <div class="advice-score-row">
        <span class="advice-score-num">${score}</span>
        <div class="advice-score-meta">
          <div class="advice-score-bar"><div class="advice-score-fill" style="width:${score}%;"></div></div>
          <div style="font-size:10px;opacity:0.6;">/ 100</div>
        </div>
      </div>
      ${o.topAction ? `<div class="advice-top-action">‚ö° ‰ªä„Åô„Åê„ÇÑ„Çã„Åì„Å®Ôºö${esc(o.topAction)}</div>` : ''}
      ${stale ? '<div class="advice-stale-note">24ÊôÇÈñì‰ª•‰∏äÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>' : ''}
    </div>`;
}

function renderGutCard() {
  if (!adviceData || !adviceData.gut) return '';
  const g = adviceData.gut;
  const stale = isAdviceStale() ? ' stale' : '';
  const barColor = g.score >= 70 ? '#74C69D' : g.score >= 40 ? '#F4A261' : '#E76F51';

  let html = `<div class="advice-card${stale}" style="background:linear-gradient(135deg,#1A3A2A 0%,#2A5A3F 100%);">`;
  html += `<div class="advice-card-label">ü¶† ËÖ∏ÂÜÖÁí∞Â¢É„Çπ„Ç≥„Ç¢</div>`;
  html += `<div class="advice-score-row">`;
  html += `<span class="advice-score-num">${g.score}</span>`;
  html += `<div class="advice-score-meta">`;
  html += `<div class="advice-score-bar"><div class="advice-score-fill" style="width:${g.score}%;background:${barColor};"></div></div>`;
  html += `<div style="font-size:10px;opacity:0.6;">/ 100</div>`;
  html += `</div></div>`;

  if (g.factors) {
    const labels = {
      fiber:      ['ü•¨ È£üÁâ©ÁπäÁ∂≠', 15],
      diversity:  ['üå± Ê§çÁâ©Â§öÊßòÊÄß', 10],
      fermented:  ['ü´ò Áô∫ÈÖµÈ£üÂìÅ', 12],
      polyphenol: ['ü´ê „Éù„É™„Éï„Çß„Éé„Éº„É´', 8],
      regularity: ['‚è∞ È£ü‰∫ã„É™„Ç∫„É†', 10],
      probiotics: ['üíä „Éó„É≠„Éê„Ç§„Ç™', 8],
      prebiotics: ['üåø „Éó„É¨„Éê„Ç§„Ç™', 7],
      bowel:      ['üí© „ÅäÈÄö„Åò', 15],
      water:      ['üíß Ê∞¥ÂàÜ', 6],
      sleep:      ['üò¥ Áù°Áú†', 6],
      steps:      ['üö∂ Ê≠©Êï∞', 3]
    };
    html += `<div style="margin-top:10px;">`;
    for (const [key, [label, max]] of Object.entries(labels)) {
      const f = g.factors[key];
      if (!f) continue;
      const pct = Math.round(f.pts / max * 100);
      html += `<div style="display:flex;align-items:center;gap:6px;margin:4px 0;font-size:11px;">`;
      html += `<span style="width:100px;opacity:0.8;">${label}</span>`;
      html += `<div style="flex:1;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;">`;
      html += `<div style="width:${pct}%;height:100%;background:${barColor};border-radius:2px;"></div>`;
      html += `</div>`;
      html += `<span style="width:32px;text-align:right;opacity:0.7;">${f.pts}/${max}</span>`;
      html += `</div>`;
    }
    html += `</div>`;
  }

  if (g.insight) html += `<div class="advice-insight" style="margin-top:10px;">${esc(g.insight)}</div>`;
  if (g.tips?.length) {
    html += '<ul class="advice-tips">';
    g.tips.forEach(t => html += `<li>${esc(t)}</li>`);
    html += '</ul>';
  }
  if (g.correlation) html += `<div class="advice-box">üí° ${esc(g.correlation)}</div>`;
  if (stale) html += '<div class="advice-stale-note">„Éá„Éº„ÇøÊõ¥Êñ∞ÂæÖ„Å°</div>';
  html += '</div>';
  return html;
}

function isWalkDay(entry) {
  if (!entry) return false;
  return (entry.walkDistance != null && entry.walkDistance >= 3.0);
}

function isBedOnTime(sleepEntry) {
  if (!sleepEntry || !sleepEntry.bedStart) return null;
  const h = parseInt(sleepEntry.bedStart.slice(11, 13));
  const m = parseInt(sleepEntry.bedStart.slice(14, 16));
  if (h >= 20) return true;
  if (h === 0) return true;
  if (h === 1 && m <= 30) return true;
  return false;
}

function renderKpiCard(title, subtitle, days7, threshold) {
  const hitCount = days7.filter(d => d.hit === true).length;
  const achieved = hitCount >= threshold;
  const dots = days7.map(d => {
    if (d.hit === true)  return '<div class="kpi-dot hit">‚úÖ</div>';
    if (d.hit === false) return '<div class="kpi-dot miss">‚ùå</div>';
    return '<div class="kpi-dot nodata">‚óã</div>';
  }).join('');
  const resultLabel = achieved
    ? `<span class="kpi-result ok">${hitCount}/7 ‚úÖ</span>`
    : `<span class="kpi-result ng">${hitCount}/7 „ÅÇ„Å®${threshold - hitCount}Âõû</span>`;
  return `<div class="card">
    <div class="card-title">${title}</div>
    <div style="display:flex;align-items:center;">
      <div class="kpi-dots">${dots}</div>${resultLabel}
    </div>
    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">${subtitle}</div>
  </div>`;
}

function renderAdviceCard(tab) {
  if (!adviceData) return '';
  const stale = isAdviceStale();
  const data = adviceData[tab];
  const cross = (adviceData.crossDomain || []).filter(x => !x.relatedTabs || x.relatedTabs.includes(tab));
  if (!data && !cross.length) return '';
  let html = `<div class="advice-card${stale ? ' stale' : ''}"><div class="advice-card-label">ü§ñ AIÂàÜÊûê${currentDate !== todayStr() ? `Ôºà${currentDate.split('-').slice(1).map(Number).join('/')}Ôºâ` : ''}</div>`;
  if (data) {
    if (data.insight) html += `<div class="advice-insight">${esc(data.insight)}</div>`;
    if (tab === 'sleep' && data.weekTrend) html += `<div class="advice-week-trend">${esc(data.weekTrend)}</div>`;
    if (data.tips?.length) html += `<ul class="advice-tips">${data.tips.map(t => `<li>${esc(t)}</li>`).join('')}</ul>`;
    if (data.correlation) html += `<div class="advice-box">üí° ${esc(data.correlation)}</div>`;
    if (data.projection) html += `<div class="advice-box green">üìà ${esc(data.projection)}</div>`;
  }
  cross.forEach(item => {
    html += `<div class="advice-box" style="margin-top:8px;">üîó <strong>${esc(item.title)}</strong><br><span style="opacity:0.9;">${esc(item.body)}</span></div>`;
  });
  if (stale) html += '<div class="advice-stale-note">„Éá„Éº„ÇøÊõ¥Êñ∞ÂæÖ„Å°</div>';
  html += '</div>';
  return html;
}

// ======== INIT ========
function init() {
  loadFoodDb(); // È£üÂìÅDB„ÇíJSON„Åã„ÇâÈùûÂêåÊúü„É≠„Éº„Éâ
  document.getElementById('header-date').textContent = formatDateLabel(currentDate);
  stampLastUpdated();
  const hash = location.hash.replace('#', '');
  const startTab = ['meals','supplements','weight','exercise','shopping','sleep'].includes(hash) ? hash : 'meals';
  currentTab = startTab; // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çí„Çπ„Ç≠„ÉÉ„Éó„Åô„Çã„Åü„ÇÅÂÖà„Å´„Çª„ÉÉ„Éà
  switchTab(startTab);
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/web/sw.js').catch(() => {});
  }
  // ÈÅéÂéª10Êó•ÂàÜ„ÅÆ„Éá„Éº„Çø„Çí„Çµ„Éº„Éê„Éº„Åã„ÇâËá™Âãï„É≠„Éº„Éâ
  for (let i = 0; i < 10; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    tryFetchMeals(ds);
    if (i < 2) tryFetchSuppl(ds); // „Çµ„Éó„É™„ÅØ‰ªäÊó•„ÉªÊò®Êó•„ÅÆ„Åø
  }
  tryFetchWeights();
  tryFetchHealthLog();
  tryFetchWorkoutLog();
  tryFetchFitnessCheck();
  tryFetchShopping();
  tryFetchSleep();
  tryFetchAdvice();
  initPullToRefresh();
  initSwipeNavigation();
}

// ======== PULL TO REFRESH ========
function initPullToRefresh() {
  const indicator = document.getElementById('ptr-indicator');
  const spinner   = document.getElementById('ptr-spinner');
  const THRESHOLD = 64; // pxÂºï„Å£Âºµ„Å£„Åü„ÇâÁô∫Âãï
  let startY = 0, pulling = false, refreshing = false;

  document.addEventListener('touchstart', e => {
    if (refreshing) return;
    if (window.scrollY === 0) {
      startY = e.touches[0].clientY;
      pulling = true;
    }
  }, { passive: true });

  document.addEventListener('touchmove', e => {
    if (!pulling || refreshing) return;
    const dy = e.touches[0].clientY - startY;
    if (dy <= 0) { pulling = false; return; }
    const progress = Math.min(dy / THRESHOLD, 1);
    indicator.classList.add('visible');
    spinner.style.transform = `rotate(${progress * 270}deg)`;
  }, { passive: true });

  document.addEventListener('touchend', e => {
    if (!pulling || refreshing) return;
    pulling = false;
    const dy = e.changedTouches[0].clientY - startY;
    if (dy < THRESHOLD) {
      indicator.classList.remove('visible');
      spinner.style.transform = '';
      return;
    }
    // Áô∫Âãï: „Çπ„Éî„Éä„ÉºÂõû„Åó„Å¶ÂÖ®„Éá„Éº„ÇøÂÜçÂèñÂæó
    refreshing = true;
    spinner.classList.add('spinning');
    const today = todayStr();
    const fetches = [];
    for (let i = 0; i < 10; i++) {
      const d = new Date(); d.setDate(d.getDate() - i);
      fetches.push(tryFetchMeals(fmtDate(d)));
      if (i < 2) fetches.push(tryFetchSuppl(fmtDate(d)));
    }
    fetches.push(loadFoodDb(), tryFetchWeights(), tryFetchHealthLog(), tryFetchWorkoutLog(), tryFetchFitnessCheck(), tryFetchShopping(), tryFetchSleep(), tryFetchAdvice());
    Promise.all(fetches).finally(() => {
      switchTab(currentTab);
      spinner.classList.remove('spinning');
      spinner.style.transform = '';
      setTimeout(() => indicator.classList.remove('visible'), 300);
      refreshing = false;
    });
  }, { passive: true });
}

// ======== RELOAD BUTTON ========
let _reloading = false;
function reloadData() {
  if (_reloading) return;
  _reloading = true;
  const btn = document.querySelector('.header-reload');
  if (btn) btn.classList.add('spinning');
  const fetches = [];
  for (let i = 0; i < 10; i++) {
    const d = new Date(); d.setDate(d.getDate() - i);
    fetches.push(tryFetchMeals(fmtDate(d)));
    if (i < 2) fetches.push(tryFetchSuppl(fmtDate(d)));
  }
  fetches.push(loadFoodDb(), tryFetchWeights(), tryFetchHealthLog(), tryFetchWorkoutLog(), tryFetchFitnessCheck(), tryFetchShopping(), tryFetchSleep(), tryFetchAdvice());
  Promise.all(fetches).finally(() => {
    switchTab(currentTab);
    if (btn) btn.classList.remove('spinning');
    showToast('Êõ¥Êñ∞„Åó„Åæ„Åó„Åü');
    _reloading = false;
  });
}

// ======== SWIPE NAVIGATION ========
const TABS = ['meals', 'supplements', 'weight', 'exercise', 'sleep', 'shopping'];
let _swipeAnimating = false;

function initSwipeNavigation() {
  let startX = 0, startY = 0, lockDir = null;
  let ghostEl = null, ghostDir = 0;
  const main = document.getElementById('main-content');

  function removeGhost() {
    if (ghostEl) { ghostEl.remove(); ghostEl = null; ghostDir = 0; }
  }

  function createGhost(targetTab, dir) {
    removeGhost();
    const W = window.innerWidth;
    ghostEl = document.createElement('main');
    ghostEl.className = 'main';
    Object.assign(ghostEl.style, {
      position: 'fixed', top: '0', left: '0', right: '0', bottom: '0',
      zIndex: '10', overflowY: 'auto',
      transform: `translateX(${dir * W}px)`,
      willChange: 'transform', transition: 'none'
    });
    if (targetTab === 'meals') renderMeals(ghostEl);
    else if (targetTab === 'supplements') renderSuppl(ghostEl);
    else if (targetTab === 'weight') renderWeight(ghostEl);
    else if (targetTab === 'exercise') renderExercise(ghostEl);
    else if (targetTab === 'shopping') renderShopping(ghostEl);
    else if (targetTab === 'sleep') renderSleep(ghostEl);
    document.body.appendChild(ghostEl);
    ghostDir = dir;
  }

  main.addEventListener('touchstart', e => {
    if (_swipeAnimating) return;
    removeGhost(); // ÂâçÂõû„ÅÆ„Çπ„Éä„ÉÉ„Éó„Éê„ÉÉ„ÇØ‰∏≠„Å´Êñ∞„Åó„ÅÑ„Çπ„ÉØ„Ç§„Éó„ÅåÂßã„Åæ„Å£„Åü„Çâ„Ç¥„Éº„Çπ„Éà„ÇíÂç≥Ê∂àÂéª
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    lockDir = null;
    main.style.transition = '';
  }, { passive: true });

  // passive:false „Å´„Åó„Å¶Ê®™„Çπ„ÉØ„Ç§„ÉóÁ¢∫ÂÆöÊôÇ„Å´Á∏¶„Çπ„ÇØ„É≠„Éº„É´„ÇíÊ≠¢„ÇÅ„Çã
  main.addEventListener('touchmove', e => {
    if (_swipeAnimating || lockDir === 'v') return;
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;
    if (lockDir === null && (Math.abs(dx) > 8 || Math.abs(dy) > 8)) {
      lockDir = Math.abs(dx) >= Math.abs(dy) ? 'h' : 'v';
      if (lockDir === 'h') {
        // Ê®™„Çπ„ÉØ„Ç§„ÉóÁ¢∫ÂÆö ‚Üí Èö£„Éö„Éº„Ç∏„ÇíÂç≥Â∫ß„Å´„Ç¥„Éº„Çπ„Éà„Å®„Åó„Å¶ÁîüÊàê
        const idx = TABS.indexOf(currentTab);
        if (dx < 0 && idx < TABS.length - 1) createGhost(TABS[idx + 1], 1);
        else if (dx > 0 && idx > 0)          createGhost(TABS[idx - 1], -1);
      }
    }
    if (lockDir !== 'h') return;
    e.preventDefault(); // Ê®™„Çπ„ÉØ„Ç§„Éó‰∏≠„ÅØÁ∏¶„Çπ„ÇØ„É≠„Éº„É´ÊäëÊ≠¢
    const idx = TABS.indexOf(currentTab);
    const W = window.innerWidth;
    // Á´Ø„ÅÆ„Çø„Éñ„ÅØ rubber band ÂäπÊûúÔºà15%„Åæ„ÅßÂºï„Åë„ÇãÔºâ
    const rubber = (idx === 0 && dx > 0) || (idx === TABS.length - 1 && dx < 0);
    const actualDx = rubber ? dx * 0.15 : dx;
    main.style.transform = `translateX(${actualDx}px)`;
    // „Ç¥„Éº„Çπ„Éà„ÇÇÂêåÈáè„Å†„ÅëÂãï„Åã„Åó„Å¶„ÄåÈö£„Éö„Éº„Ç∏„ÅåË¶ã„Åà„Å¶„Åè„Çã„ÄçÊÑü„ÇíÂá∫„Åô
    if (ghostEl) ghostEl.style.transform = `translateX(${ghostDir * W + actualDx}px)`;
  }, { passive: false });

  main.addEventListener('touchend', e => {
    if (_swipeAnimating || lockDir !== 'h') return;
    const dx = e.changedTouches[0].clientX - startX;
    const idx = TABS.indexOf(currentTab);
    const W = window.innerWidth;
    const THRESHOLD = 70;
    const goNext = dx < -THRESHOLD && idx < TABS.length - 1;
    const goPrev = dx > THRESHOLD && idx > 0;
    const dir = goNext ? 1 : -1;

    // „Ç¥„Éº„Çπ„Éà„ÅÆÊñπÂêë„ÅåÊÑèÂõ≥„Å®ÈÅï„ÅÜÂ†¥ÂêàÔºàÈÄî‰∏≠„ÅßÂêë„ÅçÂèçËª¢Ôºâ„ÅØÁ†¥Ê£Ñ
    if ((goNext || goPrev) && ghostEl && ghostDir !== dir) removeGhost();

    if (goNext || goPrev) {
      _swipeAnimating = true;
      const easing = 'transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      // ÁèæÂú®„Éö„Éº„Ç∏„Çí„Çπ„É©„Ç§„Éâ„Ç¢„Ç¶„Éà
      main.style.transition = easing;
      main.style.transform = `translateX(${dir * -W}px)`;
      // „Ç¥„Éº„Çπ„Éà„Çí„Çπ„É©„Ç§„Éâ„Ç§„É≥ÔºàÊåáËøΩÂæìÂæå„ÅÆÊÆã„ÇäË∑ùÈõ¢„Å†„Åë„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ
      if (ghostEl) { ghostEl.style.transition = easing; ghostEl.style.transform = 'translateX(0)'; }
      setTimeout(() => {
        // „Çø„ÉñÂàáÊõø„Åßmain„Å´Êñ∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊèèÁîªÔºà„Çπ„ÉØ„Ç§„Éó‰∏≠„Å™„ÅÆ„ÅßswitchTab„ÅÆ„Çø„ÉÉ„Éó„Ç¢„Éã„É°„ÅØÁô∫Âãï„Åó„Å™„ÅÑÔºâ
        switchTab(goNext ? TABS[idx + 1] : TABS[idx - 1]);
        main.style.transition = 'none';
        main.style.transform = ''; // main„ÇíÂç≥Â∫ß„Å´Ê≠£‰ΩçÁΩÆ„Å∏Ôºà„Ç¥„Éº„Çπ„Éà„ÅÆ‰∏ã„Å´Èö†„Çå„Å¶„ÅÑ„ÇãÔºâ
        requestAnimationFrame(() => {
          removeGhost();            // „Ç¥„Éº„Çπ„Éà„ÇíÊ∂à„Åô„Å®main„ÅåË¶ã„Åà„ÇãÔºà„Åô„Åß„Å´Ê≠£‰ΩçÁΩÆ„Å™„ÅÆ„Åß„Ç∫„É¨„Å™„ÅóÔºâ
          main.style.transition = '';
          _swipeAnimating = false;
        });
      }, 260);
    } else {
      // „Çπ„Éä„ÉÉ„Éó„Éê„ÉÉ„ÇØÔºà‰∏°ÊñπÂÖÉ„ÅÆ‰ΩçÁΩÆ„Å∏Ôºâ
      const easing = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      main.style.transition = easing;
      main.style.transform = '';
      if (ghostEl) { ghostEl.style.transition = easing; ghostEl.style.transform = `translateX(${ghostDir * W}px)`; }
      setTimeout(() => { main.style.transition = ''; removeGhost(); }, 320);
    }
  }, { passive: true });
}

// ======== TABS ========
// fetch„ÅåÂÆå‰∫Ü„Åô„Çã„Åü„Å≥„Å´Âç≥Â∫ß„Å´re-render„Åô„Çã„ÅÆ„ÇíÈò≤„ÅêÔºàÂàùÂõû„É≠„Éº„ÉâÊôÇ„ÅÆ10Âõû‰ª•‰∏ä„ÅÆ„Éï„É´DOMÂÜçÊèèÁîª„Çí1Âõû„Å´ÂâäÊ∏õÔºâ
let _renderTimer = null;
function deferRender(tab) {
  clearTimeout(_renderTimer);
  _renderTimer = setTimeout(() => switchTab(tab), 80);
}

function switchTab(tab) {
  const prevIdx = TABS.indexOf(currentTab);
  const nextIdx = TABS.indexOf(tab);
  currentTab = tab;
  location.hash = tab;
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById('fab-add').classList.toggle('hidden', tab !== 'meals');
  const main = document.getElementById('main-content');
  main.innerHTML = '';
  if (tab === 'meals') renderMeals(main);
  else if (tab === 'supplements') renderSuppl(main);
  else if (tab === 'weight') renderWeight(main);
  else if (tab === 'exercise') renderExercise(main);
  else if (tab === 'shopping') renderShopping(main);
  else if (tab === 'sleep') renderSleep(main);
  // „Çø„ÉÉ„ÉóÊôÇ„ÅÆ„Çπ„É©„Ç§„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºà„Çπ„ÉØ„Ç§„Éó‰∏≠„ÅØ initSwipeNavigation „ÅåÊãÖÂΩìÔºâ
  if (!_swipeAnimating && prevIdx >= 0 && prevIdx !== nextIdx) {
    const dir = nextIdx > prevIdx ? 1 : -1;
    main.style.transform = `translateX(${dir * window.innerWidth}px)`;
    requestAnimationFrame(() => requestAnimationFrame(() => {
      main.style.transition = 'transform 0.28s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      main.style.transform = '';
      setTimeout(() => { main.style.transition = ''; }, 300);
    }));
  }
}

function changeDate(delta) {
  const d = new Date(currentDate + 'T12:00:00');
  d.setDate(d.getDate() + delta);
  const nd = fmtDate(d);
  if (nd > todayStr()) return;
  currentDate = nd;
  document.getElementById('header-date').textContent = formatDateLabel(currentDate);
  syncAdviceToCurrentDate();
  switchTab(currentTab);
  tryFetchMeals(nd);
  tryFetchSuppl(nd);
}

// ======== MEALS TAB ========
function fastingBadge(currentDateStr, firstMealTime) {
  // ÂâçÊó•„ÅÆÊúÄÂæå„ÅÆÈ£ü‰∫ãÊôÇÂàª„ÇíÂèñÂæó
  const prevD = new Date(currentDateStr + 'T12:00:00');
  prevD.setDate(prevD.getDate() - 1);
  const prevMeals = getMeals(fmtDate(prevD));
  if (!prevMeals.length || !firstMealTime) return '';
  const lastPrevTime = prevMeals.map(m => m.time).sort().pop();
  // ÂàÜÂçò‰Ωç„ÅßÂ∑Æ„ÇíË®àÁÆó
  const [ph, pm] = lastPrevTime.split(':').map(Number);
  const [fh, fm] = firstMealTime.split(':').map(Number);
  const diffMin = (fh * 60 + fm) - (ph * 60 + pm) + 24 * 60; // ÁøåÊó•ÂàÜ„ÇíÂä†ÁÆó
  const hours = Math.floor(diffMin / 60);
  const mins  = diffMin % 60;
  const label = mins > 0 ? `${hours}h${mins}m` : `${hours}h`;
  const color = hours >= 14 ? '#4CAF50' : hours >= 12 ? '#8BC34A' : hours >= 10 ? '#FFC107' : '#9E9E9E';
  return `<div style="display:flex;align-items:center;gap:6px;padding:8px 0 4px;font-size:12px;color:var(--text-muted);">
    <span style="font-size:15px;">‚è±</span>
    <span>ÂâçÂ§ú„ÅÆÊñ≠È£üÊôÇÈñì</span>
    <span style="font-weight:700;color:${color};font-size:14px;">${label}</span>
    <span style="color:var(--text-muted);">(ÂâçÊó• ${lastPrevTime} ‚Üí ${firstMealTime})</span>
  </div>`;
}

function renderMeals(container) {
  const meals = getMeals(currentDate);
  const t = totals(meals);
  const isToday = currentDate === todayStr();
  const kcalOver     = t.kcal > TARGETS.kcalMax;
  const remaining    = TARGETS.kcalMax - t.kcal;
  const floorGap     = TARGETS.kcalFloor - t.kcal; // Ë≤†„Å™„ÇâÊúÄ‰Ωé„É©„Ç§„É≥ÈÅîÊàêÊ∏à„Åø
  const hour         = new Date().getHours();
  const floorRisk    = isToday && floorGap > 0 && hour >= 20; // 20ÊôÇ‰ª•Èôç„ÅßÊú™ÈÅî
  const floorMsg     = hour >= 22
    ? `Â§úÈÅÖ„ÅÑ„ÅÆ„Åß‰ªäÂ§ú„ÅØÁÑ°ÁêÜ„Åõ„Åö„ÄÅÊòéÊó•„ÅÆÂçàÂâç‰∏≠„Å´„Çø„É≥„Éë„ÇØË≥™„Çí„Åó„Å£„Åã„ÇäÊëÇ„Å£„Å¶`
    : `ÊòéÊó•„ÅÆ„É™„Éê„Ç¶„É≥„ÉâÈò≤Ê≠¢„Å´„ÄÅÊ∂àÂåñ„ÅÆËâØ„ÅÑ„ÇÇ„ÅÆ„ÅßË£úÂÖÖ„Çí`;

  // Date nav
  let html = '';
  html += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
  `;

  // AI Overall banner
  html += renderOverallBanner();

  // ‰ªäÊó•„ÅÆÊ∞¥ÂàÜ„Éê„ÉºÔºàkcal„Ç´„Éº„Éâ„ÅÆÁõ¥ÂâçÔºâ
  const _tw = adviceData && (adviceData.todayWater || (adviceData.gut && adviceData.gut.todayWater));
  if (_tw) {
    const tw = _tw;
    const wmax = tw.max || tw.target;
    const wpct = Math.min(100, Math.round(tw.current / wmax * 100));
    const targetPct = Math.min(100, Math.round(tw.target / wmax * 100));
    const reached = tw.current >= tw.target;
    const wcolor = reached ? '#27AE60' : wpct >= 60 ? '#2980B9' : '#E67E22';
    const remaining = Math.max(0, tw.target - tw.current).toFixed(1);
    html += `<div class="card" style="padding:12px 16px;">`;
    html += `<div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;">`;
    html += `<span style="font-size:13px;font-weight:600;color:#2980B9;">üíß ‰ªäÊó•„ÅÆÊ∞¥ÂàÜ</span>`;
    html += `<span style="font-size:20px;font-weight:700;color:${wcolor};">${tw.current}<span style="font-size:12px;font-weight:400;color:var(--text-muted);">L</span><span style="font-size:12px;color:var(--text-muted);"> / ${tw.target}L</span></span>`;
    html += `</div>`;
    html += `<div style="position:relative;height:10px;background:#E8F4FD;border-radius:5px;overflow:hidden;">`;
    html += `<div style="width:${wpct}%;height:100%;background:${wcolor};border-radius:5px;"></div>`;
    html += `<div style="position:absolute;top:0;left:${targetPct}%;width:2px;height:100%;background:rgba(0,0,0,0.25);"></div>`;
    html += `</div>`;
    html += `<div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${remaining > 0 ? `„ÅÇ„Å® ${remaining}L „ÅßÁõÆÊ®ôÈÅîÊàê` : 'ÁõÆÊ®ôÈÅîÊàêÔºÅüéâ'}</div>`;
    html += `</div>`;
  }

  // Kcal summary card
  html += `
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <div class="kcal-display" style="margin-bottom:0;">
          <span class="kcal-num ${kcalOver ? 'over' : ''}">${Math.round(t.kcal)}</span>
          <span class="kcal-unit">kcal</span>
          <span class="kcal-target">/ ${TARGETS.kcalMin}„Äú${TARGETS.kcalMax}</span>
        </div>
        ${isToday ? `<button onclick="toggleMealAdvice()" style="font-size:11px;background:var(--green-pale);color:var(--green-dark);border:1px solid var(--green-light);border-radius:12px;padding:5px 10px;white-space:nowrap;cursor:pointer;flex-shrink:0;-webkit-tap-highlight-color:transparent;">‰ªäÈ£ü„Åπ„Çã„Å™„Çâ</button>` : ''}
      </div>
      <div id="meal-advice-panel" style="display:none;margin-top:10px;padding:10px;background:#F8FFF9;border-radius:10px;font-size:13px;line-height:1.7;border:1px solid var(--green-light);"></div>
      <div class="remaining" style="margin-top:6px;">
        ${remaining >= 0
          ? `„ÅÇ„Å® <strong>${Math.round(remaining)}</strong> kcal`
          : `<span style="color:var(--danger)">Ë∂ÖÈÅé <strong>${Math.round(-remaining)}</strong> kcal</span>`
        }
      </div>
      <div style="margin-top:5px;font-size:12px;display:flex;align-items:center;gap:6px;">
        <span style="color:var(--text-muted);">ÊúÄ‰Ωé„É©„Ç§„É≥ ${TARGETS.kcalFloor} kcal</span>
        ${floorGap <= 0
          ? `<span style="color:var(--green-mid);font-weight:600;">‚úì ÈÅîÊàê</span>`
          : floorRisk
            ? `<span style="color:#C0392B;font-weight:600;">‚ö† „ÅÇ„Å®${Math.round(floorGap)}kcal ‚Äî ${floorMsg}</span>`
            : `<span style="color:var(--text-muted);">„ÅÇ„Å®${Math.round(floorGap)}kcal</span>`
        }
      </div>
      ${(() => {
        const pKcal = t.p * 4, fKcal = t.f * 9, cKcal = t.c * 4;
        const totalMacroKcal = pKcal + fKcal + cKcal || 1;
        const pPct = Math.round(pKcal / totalMacroKcal * 100);
        const fPct = Math.round(fKcal / totalMacroKcal * 100);
        const cPct = 100 - pPct - fPct;
        return `
        <div class="pfc-bar">
          <div class="pfc-seg pfc-p" style="width:${pPct}%"><span>${pPct}</span></div>
          <div class="pfc-seg pfc-f" style="width:${fPct}%"><span>${fPct}</span></div>
          <div class="pfc-seg pfc-c" style="width:${cPct}%"><span>${cPct}</span></div>
        </div>
        <div class="pfc-legend">
          <span class="pfc-legend-item"><span class="pfc-dot pfc-p"></span>P ÁõÆÊ®ô${TARGETS.pfcP}%</span>
          <span class="pfc-legend-item"><span class="pfc-dot pfc-f"></span>F ÁõÆÊ®ô${TARGETS.pfcF}%</span>
          <span class="pfc-legend-item"><span class="pfc-dot pfc-c"></span>C ÁõÆÊ®ô${TARGETS.pfcC}%</span>
        </div>
        <div class="macros-row">
          ${macroCard('„Åü„Çì„Å±„ÅèË≥™', t.p, `${TARGETS.pMin}-${TARGETS.pMax}g`, t.p > TARGETS.pMax ? 'over' : t.p >= TARGETS.pMin ? 'ok' : 'warn', pPct)}
          ${macroCard('ËÑÇË≥™', t.f, `${TARGETS.fMin}-${TARGETS.fMax}g`, t.f > TARGETS.fMax ? 'over' : t.f >= TARGETS.fMin ? 'ok' : 'warn', fPct)}
          ${macroCard('ÁÇ≠Ê∞¥ÂåñÁâ©', t.c, `${TARGETS.cMin}-${TARGETS.cMax}g`, t.c > TARGETS.cMax ? 'over' : t.c >= TARGETS.cMin ? 'ok' : 'warn', cPct)}
        </div>`;
      })()}
    </div>
  `;

  // Supplement guide card
  html += supplGuideHtml(t);

  // Nutrion progress bars
  const unsatFat = Math.max(0, t.f - t.satFat);
  html += `
    <div class="card">
      <div class="card-title">Ê†ÑÈ§ä„Éê„É©„É≥„Çπ</div>
      <div class="nutr-group-label">„Éû„ÇØ„É≠Ê†ÑÈ§äÁ¥†</div>
      ${nutrBar('„Ç´„É≠„É™„Éº', t.kcal, TARGETS.kcalMax, 'kcal', t.kcal > TARGETS.kcalMax ? 'over' : t.kcal > TARGETS.kcalMin ? 'ok' : 'warn', 'Ê∏õÈáè„Éö„Éº„ÇπÁ∂≠ÊåÅ„ÅÆÂü∫Êú¨')}
      ${nutrBar('„Åü„Çì„Å±„ÅèË≥™', t.p, TARGETS.pMax, 'g', t.p > TARGETS.pMax ? 'over' : t.p >= TARGETS.pMin ? 'ok' : 'warn', 'Á≠ãËÇâ„ÇíÂÆà„Çã„ÉªÊ∫ÄËÖπÊÑü„Ç≠„Éº„Éó')}
      ${nutrBar('ËÑÇË≥™', t.f, TARGETS.fMax, 'g', t.f > TARGETS.fMax ? 'over' : t.f >= TARGETS.fMin ? 'ok' : 'warn', '„Éõ„É´„É¢„É≥„ÉªÁ¥∞ËÉûËÜú„ÅÆÊùêÊñô')}
      ${nutrBar('ÁÇ≠Ê∞¥ÂåñÁâ©', t.c, TARGETS.cMax, 'g', t.c > TARGETS.cMax ? 'over' : t.c >= TARGETS.cMin ? 'ok' : 'warn', 'ËÑ≥„Å®‰Ωì„ÅÆ„Ç®„Éç„É´„ÇÆ„ÉºÊ∫ê')}
      <div class="nutr-group-label">ËÑÇË≥™„ÅÆË≥™ ‚Äî Èáè„Çà„Çä‰∏≠Ë∫´„ÅåÂ§ß‰∫ã</div>
      ${nutrBar('üî¥ ÊÇ™„ÅÑËÑÇÔºàÊéß„Åà„ÇÅ„Å´Ôºâ', t.satFat, TARGETS.satFatMax, 'g', t.satFat > TARGETS.satFatMax ? 'over' : 'ok', 'ËÇâ„Éª„Éê„Çø„Éº„Éª„ÉÅ„Éº„Ç∫„ÉªËèìÂ≠ê„ÅÆÊ≤π ‚Üí LDL„Ç≥„É¨„Çπ„ÉÜ„É≠„Éº„É´‚Üë')}
      ${nutrBar('üü¢ ËâØ„ÅÑËÑÇÔºàÁ©çÊ•µÁöÑ„Å´Ôºâ', unsatFat, TARGETS.unsatFatMin, 'g', unsatFat >= TARGETS.unsatFatMin ? 'ok' : 'warn', 'È≠ö(œâ3)„Éª„Ç™„É™„Éº„ÉñÊ≤π(œâ9)„Éª„Éä„ÉÉ„ÉÑ(œâ6) ‚Üí Ë°ÄÁÆ°„ÇíÂÆà„Çã')}
      <div class="nutr-group-label">„Éü„Éç„É©„É´„Éª„Åù„ÅÆ‰ªñ</div>
      ${nutrBar('È£üÁâ©ÁπäÁ∂≠ÔºàÁ©çÊ•µÁöÑ„Å´Ôºâ', t.fiber, TARGETS.fiberTarget, 'g', t.fiber >= TARGETS.fiberTarget ? 'ok' : 'warn', 'ËÖ∏ÂÜÖÁí∞Â¢É„ÉªË°ÄÁ≥ñÂÄ§„ÅÆÊÄ•‰∏äÊòá„ÇíÊäë„Åà„Çã')}
      ${nutrBar('Â°©ÂàÜÔºàÊéß„Åà„ÇÅ„Å´Ôºâ', t.salt, TARGETS.saltTarget, 'g', t.salt > TARGETS.saltTarget ? 'over' : 'ok', 'Ë°ÄÂúß„Éª„ÇÄ„Åè„Åø„ÅÆÂéüÂõ† ‚Üí Êó•Êú¨‰∫∫„ÅÆÊúÄÂ§ß„É™„Çπ„ÇØ')}
      ${nutrBar('„Éû„Ç∞„Éç„Ç∑„Ç¶„É†ÔºàÁ©çÊ•µÁöÑ„Å´Ôºâ', t.mg, TARGETS.mgTarget, 'mg', t.mg >= TARGETS.mgTarget ? 'ok' : 'warn', 'Áù°Áú†„ÅÆË≥™„ÉªÁ≠ãËÇâ„ÅÆ„É™„É©„ÉÉ„ÇØ„Çπ')}
      ${nutrBar('„Ç´„É´„Ç∑„Ç¶„É†ÔºàÁ©çÊ•µÁöÑ„Å´Ôºâ', t.ca, TARGETS.caTarget, 'mg', t.ca >= TARGETS.caTarget ? 'ok' : 'warn', 'È™®„ÉªÊ≠Ø„ÇíÂÆà„Çã ‚Üí Ê∏õÈáè‰∏≠„Å´‰∏çË∂≥„Åó„Åå„Å°')}
      ${nutrBar('„Ç´„É™„Ç¶„É†ÔºàÁ©çÊ•µÁöÑ„Å´Ôºâ', t.k, TARGETS.kTarget, 'mg', t.k >= TARGETS.kTarget ? 'ok' : 'warn', 'Â°©ÂàÜ„Çí‰ΩìÂ§ñ„Å´ÊéíÂá∫ ‚Üí ÈáéËèú„ÉªÊûúÁâ©„ÉªËäã„Å´Â§ö„ÅÑ')}
    </div>
  `;

  // Meal list card
  let mealHtml = `<div class="card"><div class="card-title">È£ü‰∫ãË®òÈå≤</div>`;
  if (meals.length === 0) {
    mealHtml += `<div class="empty-state">
      <div class="empty-icon">üçΩÔ∏è</div>
      <div class="empty-text">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>Âè≥‰∏ã„ÅÆ Ôºã „ÅßËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>`;
  } else {
    // ÊôÇÂàª„Åß„ÇΩ„Éº„Éà„Åó„Å¶„Åã„Çâ„Ç∞„É´„Éº„ÉóÂåñ
    meals.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
    const mealGroups = [];
    const timeMap = {};
    meals.forEach((m, i) => {
      if (!timeMap[m.time]) {
        const g = { time: m.time, items: [], kcal: 0, p: 0, f: 0, c: 0, fiber: 0, mg: 0 };
        timeMap[m.time] = g;
        mealGroups.push(g);
      }
      const g = timeMap[m.time];
      g.items.push({ name: m.name, kcal: m.kcal||0, p: m.p||0, f: m.f||0, c: m.c||0, fiber: m.fiber||0, mg: m.mg||0, idx: i });
      g.kcal  += m.kcal  || 0;
      g.p     += m.p     || 0;
      g.f     += m.f     || 0;
      g.c     += m.c     || 0;
      g.fiber += m.fiber || 0;
      g.mg    += m.mg    || 0;
    });
    const mealLbl = t => { const h = parseInt(t); return h < 11 ? 'ÊúùÈ£ü' : h < 15 ? 'ÊòºÈ£ü' : h < 18 ? 'ÈñìÈ£ü' : 'Â§ïÈ£ü'; };
    const firstMealTime = mealGroups[0]?.time;
    mealHtml += fastingBadge(currentDate, firstMealTime);
    mealHtml += `<div class="meal-list">`;
    mealGroups.forEach(g => {
      mealHtml += `<div class="meal-group">
        <div class="meal-group-header">
          <span class="meal-group-time">${g.time}</span>
          <span class="meal-group-label">${mealLbl(g.time)}</span>
          <span class="meal-group-kcal">${Math.round(g.kcal)} kcal</span>
        </div>
        <div class="meal-group-items">`;
      g.items.forEach(item => {
        mealHtml += `<div class="meal-group-item">
            <div class="meal-group-item-info">
              <span class="meal-group-item-name">‚Ä¢ ${esc(item.name)}</span>
              <span class="meal-group-item-macros">${Math.round(item.kcal)}kcal„ÄÄP${item.p.toFixed(1)} F${item.f.toFixed(1)} C${item.c.toFixed(1)} È£üÁâ©ÁπäÁ∂≠${item.fiber.toFixed(1)}g Mg${Math.round(item.mg)}mg</span>
            </div>
            <button class="meal-del" onclick="deleteMeal(${item.idx})">√ó</button>
          </div>`;
      });
      mealHtml += `</div>
        <div class="meal-group-footer">
          <span>P ${g.p.toFixed(1)}g</span><span>F ${g.f.toFixed(1)}g</span><span>C ${g.c.toFixed(1)}g</span><span>È£üÁâ©ÁπäÁ∂≠ ${g.fiber.toFixed(1)}g</span><span>Mg ${Math.round(g.mg)}mg</span>
        </div>
      </div>`;
    });
    mealHtml += `</div>
      <div class="summary-row">
        <span class="summary-label">ÂêàË®à</span>
        <span class="summary-val">${Math.round(t.kcal)} kcal</span>
      </div>`;
  }
  mealHtml += `</div>`;
  html += mealHtml;

  html += `<div class="spacer"></div>`;

  // ËÖ∏ÂÜÖÁí∞Â¢É„Çπ„Ç≥„Ç¢ÔºãAIÂàÜÊûê„ÅØÊúÄ‰∏ãÈÉ®
  html += renderGutCard();
  html += renderAdviceCard('meals');

  container.innerHTML = html;
}

function macroCard(name, val, target, status, pct) {
  return `
    <div class="macro-card">
      <div class="macro-name">${name}</div>
      <div class="macro-value ${status}">${val.toFixed(1)}<span class="unit">g</span></div>
      <div class="macro-pct">${pct}%</div>
      <div class="macro-target">ÁõÆÊ®ô: ${target}</div>
    </div>`;
}

function nutrBar(label, val, max, unit, status, note) {
  const pct = Math.min((val / max) * 100, 100);
  return `
    <div class="nutr-bar">
      <div class="nutr-bar-header">
        <span class="nutr-bar-label">${label}${note ? `<span class="nutr-bar-note">${note}</span>` : ''}</span>
        <span class="nutr-bar-val">${label === '„Ç´„É≠„É™„Éº' ? Math.round(val) : val.toFixed(1)}${unit} / ${label === '„Ç´„É≠„É™„Éº' ? max : max}${unit}</span>
      </div>
      <div class="nutr-bar-track">
        <div class="nutr-bar-fill ${status}" style="width:${pct.toFixed(1)}%"></div>
      </div>
    </div>`;
}

function supplGuideHtml(t) {
  const fiberPct = Math.min(t.fiber / TARGETS.fiberTarget * 100, 100).toFixed(1);
  const mgPct    = Math.min(t.mg    / TARGETS.mgTarget    * 100, 100).toFixed(1);

  // --- È£üÁâ©ÁπäÁ∂≠ ---
  let fiberMsg;
  if (t.fiber >= TARGETS.fiberTarget) {
    fiberMsg = `<span style="color:var(--success);font-size:13px;">‚úÖ ÁõÆÊ®ôÈÅîÊàêÔºÅ</span>`;
  } else {
    const deficit = (TARGETS.fiberTarget - t.fiber).toFixed(1);
    const fiberPerServing = SUPPL_DOSING.psyllium.fiberPerCapsule * SUPPL_DOSING.psyllium.capPerServing;
    const psylliumServings = Math.min(Math.ceil(parseFloat(deficit) / fiberPerServing), SUPPL_DOSING.psyllium.maxServings);
    const psylliumCaps = psylliumServings * SUPPL_DOSING.psyllium.capPerServing;
    fiberMsg = `<span style="font-size:13px;color:var(--text-muted);">‰∏çË∂≥ <strong style="color:var(--text);">${deficit}g</strong> ‚Üí Â§ïÈ£üÂæå„Çµ„Ç§„É™„Ç¶„É†<strong style="color:var(--accent);">${psylliumServings}ÂõûÂàÜ(${psylliumCaps}Á≤í)</strong>„ÅßË£úÂÆå</span>`;
  }

  // --- „Éû„Ç∞„Éç„Ç∑„Ç¶„É† ---
  let mgMsg;
  if (t.mg >= TARGETS.mgTarget) {
    mgMsg = `<span style="color:var(--success);font-size:13px;">‚úÖ ÁõÆÊ®ôÈÅîÊàêÔºÅMg‰∏çË¶Å</span>`;
  } else {
    const deficitMg = Math.round(TARGETS.mgTarget - t.mg);
    const capsNeeded = Math.min(Math.ceil(deficitMg / SUPPL_DOSING.mg.perCapsule), SUPPL_DOSING.mg.maxCapsules);
    mgMsg = `<span style="font-size:13px;color:var(--text-muted);">‰∏çË∂≥ <strong style="color:var(--text);">${deficitMg}mg</strong> ‚Üí Â∞±ÂØùÂâç„Å´<strong style="color:var(--accent);">${capsNeeded}Á≤í</strong></span>`;
  }

  return `
    <div class="card">
      <div class="card-title">üíä „Çµ„Éó„É™Èáè„Ç¨„Ç§„Éâ</div>
      <div style="margin-bottom:14px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span style="font-size:13px;">üåæ È£üÁâ©ÁπäÁ∂≠</span>
          <span style="font-size:13px;font-weight:600;">${t.fiber.toFixed(1)}g / ${TARGETS.fiberTarget}g</span>
        </div>
        <div class="nutr-bar-track" style="margin-bottom:6px;"><div class="nutr-bar-fill ${t.fiber >= TARGETS.fiberTarget ? 'ok' : 'warn'}" style="width:${fiberPct}%"></div></div>
        ${fiberMsg}
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span style="font-size:13px;">üß≤ „Éû„Ç∞„Éç„Ç∑„Ç¶„É†</span>
          <span style="font-size:13px;font-weight:600;">${Math.round(t.mg)}mg / ${TARGETS.mgTarget}mg</span>
        </div>
        <div class="nutr-bar-track" style="margin-bottom:6px;"><div class="nutr-bar-fill ${t.mg >= TARGETS.mgTarget ? 'ok' : 'warn'}" style="width:${mgPct}%"></div></div>
        ${mgMsg}
      </div>
    </div>`;
}

function totals(meals) {
  return meals.reduce((a, m) => ({
    kcal: a.kcal + (m.kcal || 0), p: a.p + (m.p || 0), f: a.f + (m.f || 0), c: a.c + (m.c || 0),
    mg: a.mg + (m.mg || 0), fiber: a.fiber + (m.fiber || 0),
    salt: a.salt + (m.salt || 0), satFat: a.satFat + (m.satFat || 0),
    ca: a.ca + (m.ca || 0), k: a.k + (m.k || 0)
  }), {kcal:0, p:0, f:0, c:0, mg:0, fiber:0, salt:0, satFat:0, ca:0, k:0});
}

function deleteMeal(idx) {
  if (!confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  const meals = getMeals(currentDate);
  meals.splice(idx, 1);
  saveMeals(currentDate, meals);
  switchTab('meals');
}


// ======== MEAL ADVICE ========
function toggleMealAdvice() {
  const panel = document.getElementById('meal-advice-panel');
  if (!panel) return;
  if (panel.style.display !== 'none') { panel.style.display = 'none'; return; }

  const meals = getMeals(currentDate);
  const t = totals(meals);
  const hour = new Date().getHours();
  const min  = new Date().getMinutes();
  const timeStr = `${hour}:${String(min).padStart(2,'0')}`;
  const remaining = Math.round(TARGETS.kcalMax - t.kcal);
  const pRemain   = Math.max(0, TARGETS.pMin - t.p);
  const fOver     = Math.max(0, t.f - TARGETS.fMax);
  const cRemain   = Math.max(0, TARGETS.cMax - t.c);
  const fiberShort = Math.max(0, TARGETS.fiberTarget - t.fiber);

  // ÊôÇÂàª„Åî„Å®„ÅÆÊñπÈáù
  let timeLine = '';
  if (hour < 12)       timeLine = 'ÂçàÂâç‰∏≠„Å™„ÅÆ„Åß„ÄÅ„Åó„Å£„Åã„ÇäÈ£ü„Åπ„Å¶„ÇÇÂ§ß‰∏àÂ§´„ÄÇ';
  else if (hour < 15)  timeLine = 'ÊòºÈ£üÂæå„ÅÆÊôÇÈñìÂ∏Ø„ÄÇËªΩ„ÅÑ„Åä„ÇÑ„Å§Á®ãÂ∫¶„Å™„Çâ‚óé„ÄÇ';
  else if (hour < 18)  timeLine = 'Â§ïÈ£üÂâç„ÄÇÈ£ü„Åπ„Åô„Åé„Çã„Å®Â§ïÈ£ü„Å´ÂΩ±Èüø„Åô„Çã„Åã„ÇÇ„ÄÇ';
  else if (hour < 20)  timeLine = 'Â§ïÈ£ü„Çø„Ç§„É†„ÄÇ„Éê„É©„É≥„Çπ„Çà„ÅèÈ£ü„Åπ„Çâ„Çå„Åæ„Åô„ÄÇ';
  else if (hour < 22)  timeLine = 'Â§ú„Å™„ÅÆ„ÅßÁÇ≠Ê∞¥ÂåñÁâ©„ÉªËÑÇË≥™„ÅØÊéß„Åà„ÇÅ„Å´„ÄÇÂâçÊó•„ÅÆÈ£ü„Åπ„Åô„Åé„Å´„ÅØÁøåÊó•Â§ïÊñπ„ÅÆÁ©∫ËÖπÊÑü„ÅåÈñ¢‰øÇ„Åô„Çã„Åì„Å®„ÅåÂ§ö„ÅÑ„ÄÇ';
  else                 timeLine = 'Ê∑±Â§ú„ÄÇÊ∂àÂåñ„Å∏„ÅÆË≤†ÊãÖ„ÇíËÄÉ„Åà„Å¶ËªΩ„ÅÑ„ÇÇ„ÅÆ„Å†„Åë„Å´„ÄÇÂâçÊó•Â∞ë„Å™„ÅÑ‚ÜíÁøåÂ§ï„ÅÆÁàÜÈ£ü„ÅÑ„ÇíÈò≤„Åê„Å´„ÅØ„ÄÅ‰ªäÂ§ú„Çà„ÇäÊòéÊó•„ÅÆÊúù„ÄúÊòº„ÅÆ„Çø„É≥„Éë„ÇØË≥™„ÅåÂ§ß‰∫ã„ÄÇ';

  // „Ç´„É≠„É™„ÉºÊÆã„ÇäÁä∂Ê≥Å
  let kcalLine = '';
  if (remaining < 0)        kcalLine = `‚ö†Ô∏è „Åô„Åß„Å´${-remaining}kcalË∂ÖÈÅé„ÄÇÈ£ü„Åπ„Çã„Å™„ÇâË∂Ö‰Ωé„Ç´„É≠„É™„Éº„ÅÆ„ÇÇ„ÅÆ„ÅÆ„Åø„ÄÇ`;
  else if (remaining < 150) kcalLine = `ÊÆã„Çä${remaining}kcal„Å®„Çè„Åö„Åã„ÄÇÈ£≤„ÅøÁâ©„Éª„Éä„ÉÉ„ÉÑÂ∞ëÈáè„Åè„Çâ„ÅÑ„ÅåÈôêÁïå„ÄÇ`;
  else if (remaining < 300) kcalLine = `ÊÆã„Çä${remaining}kcal„ÄÇËªΩÈ£ü1ÂìÅ„Å™„ÇâÂÖ•„Çä„Åæ„Åô„ÄÇ`;
  else if (remaining < 500) kcalLine = `ÊÆã„Çä${remaining}kcal„ÄÇÈ£ü‰∫ã1ÂìÅ„ÄÅ„Åæ„Åü„ÅØ„Åó„Å£„Åã„ÇäÁõÆ„ÅÆËªΩÈ£ü„Åå‚óé„ÄÇ`;
  else                      kcalLine = `ÊÆã„Çä${remaining}kcal„ÄÇÈ£ü‰∫ã1È£üÂàÜ„ÅÆ‰ΩôË£ï„ÅÇ„Çä„ÄÇ`;

  // Ê†ÑÈ§äÂÑ™ÂÖàÂ∫¶
  let nutrLines = [];
  if (pRemain > 5)    nutrLines.push(`ü•© „Åü„Çì„Å±„ÅèË≥™„Åå„ÅÇ„Å®${pRemain.toFixed(0)}g‰∏çË∂≥ ‚Üí Âçµ„ÉªË±ÜËÖê„ÉªÈ∂è„ÇÄ„Å≠„ÉªÈ≠ö„Åå„Åä„Åô„Åô„ÇÅ`);
  if (fOver > 3)      nutrLines.push(`üõë ËÑÇË≥™„Åå${fOver.toFixed(0)}gË∂ÖÈÅé‰∏≠ ‚Üí Êèö„ÅíÁâ©„Éª„Éê„Çø„ÉºÁ≥ª„ÅØÈÅø„Åë„Å¶`);
  if (fiberShort > 3) nutrLines.push(`ü•¶ È£üÁâ©ÁπäÁ∂≠„Åå„ÅÇ„Å®${fiberShort.toFixed(1)}g‰∏çË∂≥ ‚Üí „Åç„ÅÆ„Åì„ÉªÊµ∑Ëóª„ÉªÈáéËèú„Çí„Éó„É©„Çπ„Åô„Çã„Å®‚óé`);
  if (cRemain < 20 && cRemain >= 0) nutrLines.push(`üçö ÁÇ≠Ê∞¥ÂåñÁâ©„ÅÆÊÆã„ÇäÊû†„ÅåÂ∞ë„Å™„ÅÑÔºàÊÆã„Çä${cRemain.toFixed(0)}gÔºâ„ÄÇ„ÅîÈ£Ø„Éª„Éë„É≥„ÅØÊéß„Åà„ÇÅ„Å´`);

  // „Åä„Åô„Åô„ÇÅÈ£üÊùêÔºàÊÆã„Çä„Ç´„É≠„É™„Éº„Å®„Åü„Çì„Å±„ÅèË≥™‰∏çË∂≥„Åã„ÇâÔºâ
  let recommend = '';
  if (remaining < 0) {
    recommend = '„Éñ„É©„ÉÉ„ÇØ„Ç≥„Éº„Éí„Éº„Éª„ÅäËå∂„ÉªÊ∞¥ „ÅÆ„ÅøÊé®Â•®';
  } else if (remaining < 150) {
    recommend = '„ÇÜ„ÅßÂçµ1ÂÄãÔºà77kcalÔºâ/ „Éó„É≠„ÉÜ„Ç§„É≥„Éê„ÉºÂçäÂàÜ / „Éä„ÉÉ„ÉÑ10Á≤íÁ®ãÂ∫¶';
  } else if (pRemain > 10 && remaining >= 150) {
    recommend = 'È∂è„ÇÄ„Å≠Ôºà100g„ÅßÁ¥Ñ110kcal/P23gÔºâ/ Ë±ÜËÖêÔºà150g„ÅßÁ¥Ñ85kcal/P7gÔºâ/ „ÇÜ„ÅßÂçµ2ÂÄãÔºà154kcal/P13gÔºâ/ Âà∫Ë∫´';
  } else if (pRemain > 0 && fOver < 3) {
    recommend = '„É®„Éº„Ç∞„É´„Éà / „ÉÅ„Éº„Ç∫ / ÂçµÊñôÁêÜ / Ëí∏„ÅóÈ∂è';
  } else {
    recommend = 'ÈáéËèú„Çπ„Éº„Éó / Ë±ÜËÖê / Êµ∑Ëóª„Çµ„É©„ÉÄ / „Åç„ÅÆ„ÅìÁÇí„ÇÅ';
  }

  const floorStatus = remaining >= (TARGETS.kcalMax - TARGETS.kcalFloor)
    ? `<div style="margin-top:8px;padding:6px 8px;background:#FFF3CD;border-radius:8px;font-size:12px;color:#856404;">‚ö† ÊúÄ‰Ωé„É©„Ç§„É≥Ôºà${TARGETS.kcalFloor}kcalÔºâÊú™ÈÅî„ÄÇ„ÅÇ„Å®${Math.round(TARGETS.kcalFloor - t.kcal)}kcalÈ£ü„Åπ„Å™„ÅÑ„Å®ÊòéÊó•„ÅÆ„É™„Éê„Ç¶„É≥„ÉâÈ£ü„ÅÑ„É™„Çπ„ÇØ„ÅÇ„Çä„ÄÇ</div>`
    : `<div style="font-size:12px;color:var(--green-mid);margin-top:6px;">‚úì ÊúÄ‰Ωé„É©„Ç§„É≥Ôºà${TARGETS.kcalFloor}kcalÔºâ„ÇØ„É™„Ç¢Ê∏à„Åø</div>`;

  // Â§úÈñìË£úÂÖÖ„Ç¨„Ç§„ÉâÔºà20ÊôÇ‰ª•Èôç„ÉªÊúÄ‰Ωé„É©„Ç§„É≥+200kcalÊú™Ê∫Ä„ÅÆÊôÇ„Å´Ë°®Á§∫Ôºâ
  let nightGuide = '';
  if (hour >= 20 && t.kcal < TARGETS.kcalFloor + 200) {
    const toFloor = Math.round(TARGETS.kcalFloor - t.kcal);
    const needMore = toFloor > 0;
    // „Ç™„Ç§„Ç≥„Çπ(120) + „ÇÜ„ÅßÂçµ2ÂÄã(154) = 274kcal
    const oikosCombo = Math.round(t.kcal + 274);
    nightGuide = `
    <div style="margin-top:10px;padding:10px;background:#FFF8E1;border-radius:10px;border:1px solid #FFD54F;">
      <div style="font-weight:700;color:#856404;margin-bottom:6px;">üåô Â§ú„ÅÆË£úÂÖÖ„Ç¨„Ç§„Éâ</div>
      ${needMore
        ? `<div style="font-size:12px;margin-bottom:8px;">„ÅÇ„Å®<strong style="color:#C0392B;">${toFloor}kcal</strong>„ÅßÊúÄ‰Ωé„É©„Ç§„É≥„ÄÇÂâçÊó•Â∞ë„Å™„ÅÑ‚ÜíÁøåÂ§ï„Å´Áîò„ÅÑ„ÇÇ„ÅÆÁàÜÈ£ü„ÅÑ„ÅÆ„Éë„Çø„Éº„É≥Ê≥®ÊÑè„ÄÇ</div>`
        : `<div style="font-size:12px;margin-bottom:8px;color:var(--green-mid);">‚úì ÊúÄ‰Ωé„É©„Ç§„É≥ÈÅîÊàêÊ∏à„Åø„ÄÇÁÑ°ÁêÜ„Åó„Å¶È£ü„Åπ„Å™„Åè„Å¶„ÇÇOK„ÄÇ</div>`
      }
      <div style="font-size:13px;font-weight:700;color:#555;margin-bottom:2px;">üòå „ÅäËÖπ„ÅåÁ©∫„ÅÑ„Å¶„ÅÑ„Å™„ÅÑ„Å™„Çâ</div>
      <div style="font-size:12px;color:#666;margin-bottom:8px;padding-left:4px;">‰ªäÂ§ú„Çà„Çä<strong>ÊòéÊó•„ÅÆÊúù„ÄúÊòº„Å´„Çø„É≥„Éë„ÇØË≥™„Çí„Åó„Å£„Åã„ÇäÊëÇ„Çã</strong>„Åª„ÅÜ„Åå„É™„Éê„Ç¶„É≥„ÉâÈò≤Ê≠¢„Å´ÂäπÊûúÁöÑ„ÄÇ„Ç≥„É≥„Éì„Éã„Å∏Ë°å„Åè„Å™„Çâ<strong>ÊòéÊó•„ÅÆÊúùÈ£ü„ÇíÂÖà„Å´Ë≤∑„Å£„Å¶„Åä„Åè</strong>„ÅÆ„Åå‚óé</div>
      <div style="font-size:13px;font-weight:700;color:#555;margin-bottom:2px;">üçΩÔ∏è „ÅäËÖπ„ÅåÁ©∫„ÅÑ„Å¶„ÅÑ„Çã„Å™„Çâ</div>
      <div style="font-size:12px;color:#666;padding-left:4px;">Ê∂àÂåñ„Å´ËâØ„ÅÑ„Çø„É≥„Éë„ÇØË≥™„ÅßË£úÂÖÖÔºö<br>
        <strong>„Ç™„Ç§„Ç≥„Çπ</strong>ÔºàÁ¥Ñ120kcal / PÁ¥Ñ14gÔºâ<br>
        Ôºã <strong>„ÇÜ„ÅßÂçµ2ÂÄã</strong>Ôºà154kcal / PÁ¥Ñ13gÔºâ<br>
        ‚Üí ÂêàË®à +274kcal Ôºù ‰ªäÊó• <strong style="color:#333;">${oikosCombo}kcal</strong>
        ${oikosCombo >= TARGETS.kcalFloor ? ' <span style="color:var(--green-mid);font-weight:700;">‚úì ÊúÄ‰Ωé„É©„Ç§„É≥„ÇØ„É™„Ç¢</span>' : ''}
      </div>
    </div>`;
  }

  panel.innerHTML = `
    <div style="font-weight:700;margin-bottom:6px;color:var(--green-dark);">üïê ${timeStr} ÁèæÂú®„ÅÆÁä∂Ê≥Å</div>
    <div>${timeLine}</div>
    <div style="margin-top:4px;">${kcalLine}</div>
    ${floorStatus}
    ${nutrLines.length ? `<div style="margin-top:8px;">${nutrLines.join('<br>')}</div>` : ''}
    <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--green-light);">
      <span style="font-weight:700;color:var(--green-dark);">üí° ‰ªäÈ£ü„Åπ„Çã„Å™„ÇâÔºö</span><br>${recommend}
    </div>
    ${nightGuide}`;
  panel.style.display = 'block';
}

// ======== MODAL ========
function openModal() {
  selectedFood = null;
  searchResults = [];
  document.getElementById('modal-overlay').classList.remove('hidden');
  document.getElementById('food-search').value = '';
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('selected-box').classList.add('hidden');
  document.getElementById('custom-form').classList.add('hidden');
  setTimeout(() => document.getElementById('food-search').focus(), 150);
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
  selectedFood = null;
}

function onOverlayClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

function onFoodSearch(query) {
  const ac = document.getElementById('ac-list');
  if (!query.trim()) {
    ac.classList.add('hidden');
    document.getElementById('selected-box').classList.add('hidden');
    document.getElementById('custom-form').classList.add('hidden');
    return;
  }
  const q = query.toLowerCase();
  searchResults = getAllFoods().filter(f => f.name.toLowerCase().includes(q)).slice(0, 8);

  let html = '';
  searchResults.forEach((f, i) => {
    html += `<div class="ac-item" onclick="selectByIndex(${i})">
      <div><span>${esc(f.name)}</span><span class="ac-kcal">${f.kcal}kcal</span></div>
      <div class="ac-unit">${esc(f.unit)} / P${f.p}g F${f.f}g C${f.c}g</div>
    </div>`;
  });
  html += `<div class="ac-item" style="color:var(--text-muted);" onclick="showCustom()">üìù ÊâãÂãï„ÅßÂÖ•Âäõ...</div>`;
  ac.innerHTML = html;
  ac.classList.remove('hidden');
}

function selectByIndex(i) {
  const food = searchResults[i];
  if (!food) return;
  selectedFood = food;
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('custom-form').classList.add('hidden');
  document.getElementById('sel-name').textContent = food.name;
  document.getElementById('sel-unit').textContent = 'Âçò‰Ωç: ' + food.unit;
  document.getElementById('sel-kcal').textContent = food.kcal + 'kcal';
  document.getElementById('sel-pfc').textContent = `P${food.p}g F${food.f}g C${food.c}g`;
  document.getElementById('food-qty').value = 1;
  document.getElementById('selected-box').classList.remove('hidden');
  document.getElementById('food-search').value = food.name;
}

function showCustom() {
  document.getElementById('ac-list').classList.add('hidden');
  document.getElementById('selected-box').classList.add('hidden');
  document.getElementById('custom-form').classList.remove('hidden');
  document.getElementById('c-name').value = document.getElementById('food-search').value;
  selectedFood = null;
}

function addFoodRecord() {
  const now = new Date();
  const time = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  let record;

  if (selectedFood) {
    const qty = parseFloat(document.getElementById('food-qty').value) || 1;
    record = {
      time,
      name: selectedFood.name + (qty !== 1 ? ` √ó${qty}` : ''),
      kcal: selectedFood.kcal * qty,
      p: selectedFood.p * qty,
      f: selectedFood.f * qty,
      c: selectedFood.c * qty,
      mg: (selectedFood.mg || 0) * qty,
      fiber: (selectedFood.fiber || 0) * qty,
      satFat: (selectedFood.satFat || 0) * qty,
      salt: (selectedFood.salt || 0) * qty,
      ca: (selectedFood.ca || 0) * qty,
      k: (selectedFood.k || 0) * qty,
    };
  } else {
    const name = document.getElementById('c-name').value.trim();
    if (!name) { showToast('È£üÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
    let kcal = parseFloat(document.getElementById('c-kcal').value) || 0;
    const p = parseFloat(document.getElementById('c-p').value) || 0;
    const f = parseFloat(document.getElementById('c-f').value) || 0;
    const c = parseFloat(document.getElementById('c-c').value) || 0;
    const unit = document.getElementById('c-unit').value || '1È£ü';
    const isFish = document.getElementById('is-fish').checked;
    if (isFish) kcal = kcal - (f * 9 * 0.3);
    const mg = parseFloat(document.getElementById('c-mg').value) || 0;
    const fiber = parseFloat(document.getElementById('c-fiber').value) || 0;
    const satFat = parseFloat(document.getElementById('c-satfat').value) || 0;
    const salt = parseFloat(document.getElementById('c-salt').value) || 0;
    const ca = parseFloat(document.getElementById('c-ca').value) || 0;
    const k = parseFloat(document.getElementById('c-k').value) || 0;
    record = { time, name: name + (isFish ? ' üêü' : ''), kcal, p, f, c, mg, fiber, satFat, salt, ca, k };
    // Save to custom DB
    const customs = getCustomFoods();
    if (!customs.find(x => x.name === name)) {
      customs.push({ id: Date.now(), name, unit, kcal, p, f, c, mg, fiber, satFat, salt, ca, k, cat:'„Ç´„Çπ„Çø„É†' });
      saveCustomFoods(customs);
    }
  }

  const meals = getMeals(currentDate);
  meals.push(record);
  saveMeals(currentDate, meals);
  closeModal();
  showToast('Ë®òÈå≤„Åó„Åæ„Åó„Åü ‚úì');
  switchTab('meals');
}

// ======== SUPPLEMENTS TAB ========
function renderSuppl(container) {
  const checks = getSuppl(currentDate);
  const isToday = currentDate === todayStr();
  const done    = SUPPLEMENTS.filter(s => checks[s.id] === true).length;
  const skipped = SUPPLEMENTS.filter(s => checks[s.id] === 'skip').length;
  const pct = Math.round((done / SUPPLEMENTS.length) * 100);

  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div class="card-title" style="margin-bottom:0;">‰ªäÊó•„ÅÆÊúçËñ¨„Éª„Çµ„Éó„É™</div>
        <div id="pct-display" style="font-size:24px;font-weight:700;color:${pct===100?'var(--green-mid)':'var(--text-muted)'};">${pct}%</div>
      </div>
      <div class="compliance-bar">
        <div class="compliance-fill ${pct===100?'full':''}" id="comp-fill" style="width:${pct}%;"></div>
      </div>
      <div id="comp-count" style="font-size:12px;color:var(--text-muted);text-align:center;">${done} / ${SUPPLEMENTS.length} ÂÆå‰∫Ü${skipped > 0 ? `„ÄÄ<span style="color:#856404;">ÔºàÈ£≤„ÅøÂøò„Çå ${skipped}‰ª∂Ôºâ</span>` : ''}</div>
    </div>
  `;

  // AI Supplements advice card
  container.innerHTML += renderAdviceCard('supplements');

  let html = `<div class="card">`;
  const timings = ['morning','evening','bedtime'];
  timings.forEach(t => {
    const items = SUPPLEMENTS.filter(s => s.timing === t);
    html += `<div class="suppl-timing">${TIMING_LABELS[t]}</div>`;
    items.forEach(s => {
      const state = checks[s.id]; // true | 'skip' | falsy
      const isChecked = state === true;
      const isSkipped = state === 'skip';
      html += `
        <div class="suppl-item">
          <div class="suppl-check ${isChecked ? 'checked' : isSkipped ? 'skipped' : ''}" id="sc-${s.id}" onclick="toggleSuppl('${s.id}')"></div>
          <div class="suppl-label">
            <div class="suppl-name ${isChecked ? 'checked' : isSkipped ? 'skipped' : ''}" id="sn-${s.id}">${esc(s.name)}</div>
            ${s.note ? `<div class="suppl-note">${esc(s.note)}</div>` : ''}
          </div>
          ${!s.catchup ? `<div class="suppl-skip-btn ${isSkipped ? 'active' : ''}" id="ss-${s.id}" onclick="skipSuppl('${s.id}')" style="${isChecked ? 'display:none' : ''}">È£≤„ÅøÂøò„Çå</div>` : ''}
        </div>`;
    });
  });
  html += `</div>`;

  // Â§ïÈ£üÂæå„Çµ„Ç§„É™„Ç¶„É†„Ç´„Éº„ÉâÔºàÁπäÁ∂≠‰∏çË∂≥ÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ
  const meals = getMeals(currentDate);
  const t = totals(meals);
  html += renderPsylliumCard(t, checks);

  html += `<div class="spacer"></div>`;
  container.innerHTML += html;
}

function toggleSuppl(id) {
  const checks = getSuppl(currentDate);
  checks[id] = checks[id] === true ? false : true; // skipÁä∂ÊÖã„Åã„Çâ„Åß„ÇÇ„ÄåÈ£≤„Çì„Å†„Äç„Å´„Åß„Åç„Çã
  saveSuppl(currentDate, checks);
  const sc = document.getElementById(`sc-${id}`);
  const sn = document.getElementById(`sn-${id}`);
  const ss = document.getElementById(`ss-${id}`);
  if (sc) { sc.className = 'suppl-check' + (checks[id] ? ' checked' : ''); }
  if (sn) { sn.className = 'suppl-name'  + (checks[id] ? ' checked' : ''); }
  if (ss) { ss.classList.remove('active'); ss.style.display = checks[id] ? 'none' : ''; }
  updateCompliance(checks);
  syncSupplToGitHub(currentDate);
}

function skipSuppl(id) {
  const checks = getSuppl(currentDate);
  checks[id] = checks[id] === 'skip' ? false : 'skip';
  saveSuppl(currentDate, checks);
  const sc = document.getElementById(`sc-${id}`);
  const sn = document.getElementById(`sn-${id}`);
  const ss = document.getElementById(`ss-${id}`);
  if (sc) { sc.className = 'suppl-check' + (checks[id] === 'skip' ? ' skipped' : ''); }
  if (sn) { sn.className = 'suppl-name'  + (checks[id] === 'skip' ? ' skipped' : ''); }
  if (ss) ss.classList.toggle('active', checks[id] === 'skip');
  updateCompliance(checks);
  syncSupplToGitHub(currentDate);
}

function togglePsyllium(id) {
  const checks = getSuppl(currentDate);
  checks[id] = checks[id] === true ? false : true;
  saveSuppl(currentDate, checks);
  syncSupplToGitHub(currentDate);
  // „Ç´„Éº„Éâ„ÇíÂÜçÊèèÁîª
  const card = document.getElementById('psyllium-card');
  if (card) {
    const meals = getMeals(currentDate);
    const t = totals(meals);
    card.outerHTML = renderPsylliumCard(t, checks);
  }
}

function renderPsylliumCard(t, checks) {
  const fiberPerServing = SUPPL_DOSING.psyllium.fiberPerCapsule * SUPPL_DOSING.psyllium.capPerServing;
  const hasMeals = getMeals(currentDate).length > 0;

  let content;
  if (!hasMeals) {
    content = `<div style="font-size:13px;color:var(--text-muted);">È£ü‰∫ã„ÇíË®òÈå≤„Åó„Å¶„Åã„ÇâÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>`;
  } else if (t.fiber >= TARGETS.fiberTarget) {
    content = `<div style="font-size:13px;color:var(--success);">‚úÖ È£üÁâ©ÁπäÁ∂≠ ${t.fiber.toFixed(1)}g ÁõÆÊ®ôÈÅîÊàêÔºÅ„Çµ„Ç§„É™„Ç¶„É†‰∏çË¶Å</div>`;
  } else {
    const deficit = TARGETS.fiberTarget - t.fiber;
    const servingsNeeded = Math.min(Math.ceil(deficit / fiberPerServing), SUPPL_DOSING.psyllium.maxServings);
    const psylliumIds = ['a1','a2','a3'].slice(0, servingsNeeded);
    let checkboxHtml = psylliumIds.map((id, i) => {
      const checked = checks[id] === true;
      return `
        <div class="suppl-item" style="padding:6px 0;">
          <div class="suppl-check ${checked ? 'checked' : ''}" onclick="togglePsyllium('${id}')"></div>
          <div class="suppl-label">
            <div class="suppl-name ${checked ? 'checked' : ''}">${i + 1}ÂõûÁõÆÔºà${SUPPL_DOSING.psyllium.capPerServing}Á≤íÔºâ</div>
          </div>
        </div>`;
    }).join('');
    content = `
      <div style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">
        ‰∏çË∂≥ <strong style="color:var(--text);">${deficit.toFixed(1)}g</strong> ‚Üí
        <strong style="color:var(--accent);">${servingsNeeded}ÂõûÂàÜ(${servingsNeeded * SUPPL_DOSING.psyllium.capPerServing}Á≤í)</strong>Êé®Â•®
      </div>
      ${checkboxHtml}`;
  }

  return `
    <div class="card" id="psyllium-card" style="${!hasMeals ? 'opacity:0.6;' : ''}">
      <div class="card-title">üåæ Â§ïÈ£üÂæå„Çµ„Ç§„É™„Ç¶„É†ÔºàÁπäÁ∂≠‰∏çË∂≥ÊôÇÔºâ</div>
      ${content}
    </div>`;
}

function updateCompliance(checks) {
  const done    = SUPPLEMENTS.filter(s => checks[s.id] === true).length;
  const skipped = SUPPLEMENTS.filter(s => checks[s.id] === 'skip').length;
  const pct = Math.round((done / SUPPLEMENTS.length) * 100);
  const fill  = document.getElementById('comp-fill');
  const pctEl = document.getElementById('pct-display');
  const cntEl = document.getElementById('comp-count');
  if (fill)  { fill.style.width = pct + '%'; fill.classList.toggle('full', pct===100); }
  if (pctEl) { pctEl.textContent = pct + '%'; pctEl.style.color = pct===100 ? 'var(--green-mid)' : 'var(--text-muted)'; }
  if (cntEl) { cntEl.innerHTML = `${done} / ${SUPPLEMENTS.length} ÂÆå‰∫Ü${skipped > 0 ? `„ÄÄ<span style="color:#856404;">ÔºàÈ£≤„ÅøÂøò„Çå ${skipped}‰ª∂Ôºâ</span>` : ''}`; }
}

// ======== WEIGHT TAB ========
function renderWeight(container) {
  const weights  = getWeights();
  const bodyFat  = getBodyFat();
  const isToday  = currentDate === todayStr();
  const todayW   = weights[currentDate]  ?? null;
  const todayBF  = bodyFat[currentDate]  ?? null;

  // Last 10 days
  const chartData = [];
  for (let i = 9; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    chartData.push({ ds, w: weights[ds] ?? null, bf: bodyFat[ds] ?? null });
  }

  // ÂâçÊó•ÊëÇÂèñ„Ç´„É≠„É™„Éº„Çí‰ªòÂä†Ôºàmeals-*.json„Åã„ÇâÂèñÂæóÔºâ
  chartData.forEach(row => {
    const prevD = new Date(row.ds + 'T12:00:00'); prevD.setDate(prevD.getDate() - 1);
    const prevDs = fmtDate(prevD);
    const prevMeals = getMeals(prevDs);
    const fromMeals = prevMeals.reduce((s, m) => s + (m.kcal || 0), 0);
    row.prevKcal = fromMeals > 0 ? fromMeals : null;
  });

  // 7Êó•Âπ≥Âùá„ÉªÂâçÈÄ±ÊØî„ÉªÂà§ÂÆö„ÇíË®àÁÆóÔºàÂÖ®‰ΩìÈáç„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
  chartData.forEach(row => {
    // 7Êó•Âπ≥ÂùáÔºà„Åù„ÅÆÊó•„ÇíÂê´„ÇÄÈÅéÂéª7Êó•Ôºâ
    let s = 0, c = 0;
    for (let j = 6; j >= 0; j--) {
      const d2 = new Date(row.ds + 'T12:00:00'); d2.setDate(d2.getDate() - j);
      const w = weights[fmtDate(d2)];
      if (w != null) { s += w; c++; }
    }
    row.avg7 = c > 0 ? s / c : null;

    // ÂâçÈÄ±ÊØîÁî®: 7Êó•Ââç„ÅÆ7Êó•Âπ≥Âùá
    let s2 = 0, c2 = 0;
    for (let j = 13; j >= 7; j--) {
      const d2 = new Date(row.ds + 'T12:00:00'); d2.setDate(d2.getDate() - j);
      const w = weights[fmtDate(d2)];
      if (w != null) { s2 += w; c2++; }
    }
    const prevAvg = c2 >= 4 ? s2 / c2 : null;

    if (row.avg7 != null && prevAvg != null) {
      row.weekDiff = row.avg7 - prevAvg;
      row.judge = row.weekDiff <= -0.25 ? '‚úÖ' : row.weekDiff < 0 ? '‚ñ≥' : '√ó';
    } else {
      row.weekDiff = null;
      row.judge = null;
    }
  });

  const latestW = todayW ?? chartData.slice().reverse().find(d => d.w != null)?.w ?? null;
  const progressPct = latestW
    ? Math.max(0, Math.min(100, ((START_WEIGHT - latestW) / (START_WEIGHT - GOAL_WEIGHT)) * 100))
    : 0;
  const nextMS = latestW ? MILESTONES.find(m => m.weight < latestW) : MILESTONES[0];

  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>
  `;

  // Weight entry card
  const formHidden = todayW != null;
  let wHtml = `<div class="card"><div class="card-title">‰ΩìÈáç„ÇíË®òÈå≤</div>`;
  if (todayW) {
    wHtml += `<div class="weight-hero">
      <div class="weight-big">${todayW.toFixed(2)}<span class="wunit">kg</span></div>
      ${todayBF != null ? `<div style="font-size:15px;color:var(--text-muted);margin-top:2px;">‰ΩìËÑÇËÇ™Áéá ${todayBF.toFixed(1)}%</div>` : ''}
      <div class="weight-sub">${formatDateLabel(currentDate)}„ÅÆË®òÈå≤</div>
    </div>
    <div style="text-align:center;margin-top:8px;">
      <button class="btn" style="font-size:13px;padding:4px 14px;"
              onclick="document.getElementById('weight-form').style.display='block';this.style.display='none';">‚úèÔ∏è ÊâãÂÖ•Âäõ</button>
    </div>`;
  }
  wHtml += `<div id="weight-form" style="${formHidden ? 'display:none;' : ''}margin-top:${todayW ? '10px' : '0'};">
  <div class="weight-input-row">
    <input type="number" id="weight-input" class="form-input" style="flex:1;"
           placeholder="${todayW ?? '88.0'}" step="0.05" min="50" max="300"
           value="${todayW ?? ''}">
    <span style="font-size:14px;color:var(--text-muted);white-space:nowrap;">kg</span>
  </div>
  <div class="weight-input-row" style="margin-top:8px;">
    <input type="number" id="bf-input" class="form-input" style="flex:1;"
           placeholder="${todayBF ?? '31.0'}" step="0.1" min="5" max="60"
           value="${todayBF ?? ''}">
    <span style="font-size:14px;color:var(--text-muted);white-space:nowrap;">% ‰ΩìËÑÇËÇ™</span>
  </div>
  <button class="btn btn-primary" style="margin-top:10px;"
          onclick="saveWeight()">‰øùÂ≠ò</button>
  </div>
  </div>`;
  container.innerHTML += wHtml;

  // AI Weight advice card
  container.innerHTML += renderAdviceCard('weight');

  // Goal progress
  if (latestW) {
    container.innerHTML += `
      <div class="card">
        <div class="card-title">69.9kg„Å∏„ÅÆÈÅì„ÅÆ„Çä</div>
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);margin-bottom:6px;">
          <span>ÈñãÂßã: ${START_WEIGHT}kg</span>
          <span>ÁèæÂú®: <strong style="color:var(--text);">${latestW.toFixed(2)}kg</strong></span>
          <span>ÁõÆÊ®ô: ${GOAL_WEIGHT}kg</span>
        </div>
        <div class="progress-main">
          <div class="progress-fill" style="width:${progressPct.toFixed(1)}%;"></div>
        </div>
        <div style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:4px;">
          ÁõÆÊ®ô„Åæ„Åß „ÅÇ„Å® <strong>${(latestW - GOAL_WEIGHT).toFixed(2)}kg</strong>ÔºàÈÄ≤Êçó ${progressPct.toFixed(1)}%Ôºâ
        </div>
        ${nextMS ? (() => {
          const msDate = new Date(nextMS.date + 'T00:00:00');
          const now = new Date(); now.setHours(0,0,0,0);
          const daysLeft = Math.ceil((msDate - now) / 86400000);
          const diffKg = (latestW - nextMS.weight).toFixed(1);
          const m = msDate.getMonth() + 1;
          const d = msDate.getDate();
          return `
        <div style="margin-top:12px;padding:10px;background:var(--green-pale);border-radius:10px;">
          <div style="font-size:13px;font-weight:700;color:var(--green-mid);">üéØ Ê¨°„ÅÆ„Éû„Ç§„É´„Çπ„Éà„Éº„É≥</div>
          <div style="font-size:14px;margin-top:2px;">${nextMS.label}: <strong>${nextMS.weight}kg</strong></div>
          <div style="margin-top:6px;display:flex;align-items:baseline;gap:8px;">
            <span style="font-size:20px;font-weight:800;color:#333;">${m}Êúà${d}Êó•„Åæ„Åß</span>
            <span style="font-size:13px;color:var(--text-muted);">„ÅÇ„Å®<strong style="color:${daysLeft <= 3 ? 'var(--danger)' : '#856404'};font-size:16px;margin:0 2px;">${daysLeft}</strong>Êó•</span>
          </div>
          <div style="font-size:13px;color:var(--text-muted);margin-top:4px;">„ÅÇ„Å® <strong>${diffKg}kg</strong> ËêΩ„Å®„Åô</div>
        </div>`;
        })() : `
        <div style="margin-top:12px;padding:10px;background:var(--green-pale);border-radius:10px;text-align:center;font-size:15px;font-weight:700;color:var(--green-mid);">
          üéâ ÂÖ®„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÈÅîÊàêÔºÅ
        </div>`}
      </div>`;
  }

  // Chart + 10-day table
  {
    let histHtml = `<div class="card"><div class="card-title">‰ΩìÈáçÊé®ÁßªÔºàÁõ¥Ëøë10Êó•Ôºâ</div>`;
    if (chartData.filter(d => d.w != null).length >= 2) {
      histHtml += buildWeightChart(chartData);
    }
    // 10-day tableÔºàÊñ∞‚ÜíÂè§ „ÅÆÈ†Ü„ÅßË°®Á§∫Ôºâ
    const th = (label, align='right') =>
      `<th style="text-align:${align};padding:4px 4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);white-space:nowrap;">${label}</th>`;
    histHtml += `<table style="width:100%;border-collapse:collapse;margin-top:12px;font-size:12px;">
      <thead><tr>
        ${th('Êó•‰ªò','left')}${th('ÂâçÊó•kcal')}${th('‰ΩìÈáç')}${th('‰ΩìËÑÇËÇ™')}${th('7Êó•Âπ≥Âùá')}${th('Âà§ÂÆö')}
      </tr></thead><tbody>`;
    [...chartData].reverse().forEach(row => {
      const isToday2 = row.ds === todayStr();
      const judgeColor = row.judge === '‚úÖ' ? 'var(--green-mid)' : row.judge === '‚ñ≥' ? '#E5A020' : row.judge === '√ó' ? '#C0392B' : 'var(--text-muted)';
      const judgeStr = row.judge != null
        ? `<span style="color:${judgeColor};font-weight:700;">${row.judge}</span><br><span style="font-size:10px;color:var(--text-muted);">${row.weekDiff > 0 ? '+' : ''}${row.weekDiff.toFixed(2)}</span>`
        : '‚Äî';
      histHtml += `<tr style="${isToday2 ? 'background:var(--green-pale);' : ''}">
        <td style="padding:5px 4px;white-space:nowrap;">${row.ds.slice(5).replace('-','/')}${isToday2 ? '&nbsp;<span style="font-size:9px;color:var(--green-mid);">TODAY</span>' : ''}</td>
        <td style="text-align:right;padding:5px 4px;color:var(--text-muted);">${row.prevKcal != null ? row.prevKcal.toLocaleString() : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;font-weight:${row.w ? '600' : '400'}">${row.w != null ? row.w.toFixed(2) : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;color:var(--text-muted);">${row.bf != null ? row.bf.toFixed(1) + '%' : '‚Äî'}</td>
        <td style="text-align:right;padding:5px 4px;">${row.avg7 != null ? row.avg7.toFixed(2) : '‚Äî'}</td>
        <td style="text-align:center;padding:5px 4px;line-height:1.3;">${judgeStr}</td>
      </tr>`;
    });
    histHtml += `</tbody></table>
    <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">Âà§ÂÆö: ‚úÖ -0.25kg‰ª•‰∏äÊ∏õ Ôºè ‚ñ≥ ÂæÆÊ∏õ Ôºè √ó Â¢óÂä†Ôºà7Êó•Âπ≥Âùá„ÅÆÂâçÈÄ±ÊØîÔºâ</div>
    </div>`;
    container.innerHTML += histHtml;
  }

  // Short-term weekly targets (5-week table)
  {
    const today = new Date(); today.setHours(0,0,0,0);
    // Find current week index (first week whose date >= today)
    let currentWeekIdx = -1;
    for (let i = 0; i < WEEKLY_TARGETS.length; i++) {
      const d = new Date(WEEKLY_TARGETS[i].date + 'T00:00:00');
      if (d >= today) { currentWeekIdx = i; break; }
    }
    let wtHtml = `<div class="card"><div class="card-title">Áü≠ÊúüÁõÆÊ®ôÔºà5ÈÄ±ÈñìÔºâ</div>
      <table class="weekly-target-table">
        <thead><tr>
          <th>ÈÄ±Êú´</th><th>Áä∂ÊÖã</th><th>È´òÁ¢∫Áéá<br><span style="font-weight:400;font-size:10px;">-0.3kg/ÈÄ±</span></th><th>„Éú„Éº„Éä„Çπ<br><span style="font-weight:400;font-size:10px;">-0.4kg/ÈÄ±</span></th>
        </tr></thead><tbody>`;
    WEEKLY_TARGETS.forEach((wt, i) => {
      const wtDate = new Date(wt.date + 'T00:00:00');
      const isPast = wtDate < today;
      const isCurrent = i === currentWeekIdx;
      const achieved = latestW != null && latestW <= wt.highProb;
      const bonusAchieved = latestW != null && latestW <= wt.bonus;
      let icon, rowCls;
      if (isPast && achieved) { icon = '‚úÖ'; rowCls = 'wt-achieved'; }
      else if (isPast && bonusAchieved) { icon = 'üéØ'; rowCls = 'wt-achieved'; }
      else if (isPast) { icon = '‚ñ≥'; rowCls = ''; }
      else if (isCurrent) { icon = '‚Üí'; rowCls = 'wt-current'; }
      else { icon = '‚óã'; rowCls = ''; }
      const [,mm,dd] = wt.date.split('-');
      function diffLabel(target) {
        if (latestW == null) return '';
        const d = latestW - target;
        if (d <= 0) return `<br><span style="font-size:10px;color:var(--green-mid);">ÈÅîÊàê +${Math.abs(d).toFixed(2)}kg</span>`;
        return `<br><span style="font-size:10px;color:var(--text-muted);">„ÅÇ„Å® -${d.toFixed(2)}kg</span>`;
      }
      const highProbAchieved = (isPast && achieved) || (!isPast && latestW != null && latestW <= wt.highProb);
      const bonusAchievedCell = (isPast && bonusAchieved) || (!isPast && latestW != null && latestW <= wt.bonus);
      const highProbCell = highProbAchieved
        ? `<td style="color:var(--green-mid);font-weight:700;">${wt.highProb}kg ‚úÖ${diffLabel(wt.highProb)}</td>`
        : `<td>${wt.highProb}kg${diffLabel(wt.highProb)}</td>`;
      const bonusCell = bonusAchievedCell
        ? `<td style="color:var(--green-mid);font-weight:700;">${wt.bonus}kg üéØ${diffLabel(wt.bonus)}</td>`
        : `<td>${wt.bonus}kg${diffLabel(wt.bonus)}</td>`;
      wtHtml += `<tr class="${rowCls}">
        <td>${mm}/${dd}</td><td style="text-align:center;">${icon}</td>${highProbCell}${bonusCell}
      </tr>`;
    });
    wtHtml += `</tbody></table>
      <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">Ëµ∑ÁÇπ: 87.25kgÔºà2/24Ôºâ</div>
    </div>`;
    container.innerHTML += wtHtml;
  }

  // Long-term Milestones
  let msHtml = `<div class="card"><div class="card-title">Èï∑Êúü„Éû„Ç§„É´„Çπ„Éà„Éº„É≥</div><div class="milestone-list">`;
  MILESTONES.forEach(m => {
    const achieved = latestW != null && latestW <= m.weight;
    const isNext = m === nextMS;
    const cls = achieved ? 'done' : isNext ? 'next' : 'future';
    const icon = achieved ? '‚úÖ' : isNext ? '‚Üí' : '‚óã';
    msHtml += `
      <div class="milestone-item">
        <div class="milestone-dot ${cls}">${icon}</div>
        <div class="milestone-info">
          <div class="milestone-name">${m.label}</div>
          <div class="milestone-date">${m.date}</div>
        </div>
        <div class="milestone-weight ${achieved ? 'achieved' : isNext ? 'next-weight' : ''}">${m.weight}kg<span style="font-size:11px;font-weight:400;color:var(--text-muted);margin-left:4px;">${m.bf}%</span></div>
      </div>`;
  });
  msHtml += `</div></div><div class="spacer"></div>`;
  container.innerHTML += msHtml;
}

function buildWeightChart(data) {
  const W = 320, H = 150;
  const PAD = {t:20, r:44, b:26, l:40};
  const pw = W - PAD.l - PAD.r;
  const ph = H - PAD.t - PAD.b;
  const n  = data.length;
  const xS = i => PAD.l + (i / (n - 1)) * pw;

  // ‰ΩìÈáç„Çπ„Ç±„Éº„É´ÔºàÂ∑¶YËª∏„ÉªÁ∑ëÔºâ
  const wVals = data.map(d => d.w).filter(v => v != null);
  const minW = Math.min(...wVals) - 0.5;
  const maxW = Math.max(...wVals) + 0.5;
  const yW = v => PAD.t + ph - ((v - minW) / (maxW - minW)) * ph;

  // ‰ΩìËÑÇËÇ™„Çπ„Ç±„Éº„É´ÔºàÂè≥YËª∏„Éª„Ç™„É¨„É≥„Ç∏Ôºâ
  const bfVals = data.map(d => d.bf).filter(v => v != null);
  const hasBF = bfVals.length >= 2;
  let yBF, minBF, maxBF;
  if (hasBF) {
    minBF = Math.min(...bfVals) - 1;
    maxBF = Math.max(...bfVals) + 1;
    yBF = v => PAD.t + ph - ((v - minBF) / (maxBF - minBF)) * ph;
  }

  // ‰ΩìÈáç„É©„Ç§„É≥„Éª„Éâ„ÉÉ„Éà
  const wPts  = data.filter(d => d.w != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yW(d.w).toFixed(1)}`).join(' ');
  const wDots = data.map((d,i) => d.w != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yW(d.w).toFixed(1)}" r="3" fill="white" stroke="#2D6A4F" stroke-width="2"/>`
    : '').join('');

  // 7Êó•Âπ≥Âùá„É©„Ç§„É≥Ôºà‰ΩìÈáç„Å®Âêå„ÅòYËª∏„ÉªÁ∑ëÁ†¥Á∑öÔºâ
  const avg7Pts = data.filter(d => d.avg7 != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yW(d.avg7).toFixed(1)}`).join(' ');

  // ‰ΩìËÑÇËÇ™„É©„Ç§„É≥„Éª„Éâ„ÉÉ„Éà
  let bfPts = '', bfDots = '';
  if (hasBF) {
    bfPts  = data.filter(d => d.bf != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yBF(d.bf).toFixed(1)}`).join(' ');
    bfDots = data.map((d,i) => d.bf != null
      ? `<circle cx="${xS(i).toFixed(1)}" cy="${yBF(d.bf).toFixed(1)}" r="2.5" fill="white" stroke="#E5A020" stroke-width="2"/>`
      : '').join('');
  }

  // Â∑¶YËª∏„É©„Éô„É´Ôºà‰ΩìÈáçÔºâ
  const wLabels = [minW, (minW+maxW)/2, maxW].map(v =>
    `<line x1="${PAD.l}" y1="${yW(v).toFixed(1)}" x2="${W-PAD.r}" y2="${yW(v).toFixed(1)}" stroke="#E9ECEF" stroke-width="1"/>
     <text x="${PAD.l-5}" y="${(yW(v)+4).toFixed(1)}" text-anchor="end" font-size="9" fill="#2D6A4F">${v.toFixed(1)}</text>`
  ).join('');

  // Âè≥YËª∏„É©„Éô„É´Ôºà‰ΩìËÑÇËÇ™Ôºâ
  const bfLabels = hasBF ? [minBF, (minBF+maxBF)/2, maxBF].map(v =>
    `<text x="${W-PAD.r+5}" y="${(yBF(v)+4).toFixed(1)}" text-anchor="start" font-size="9" fill="#E5A020">${v.toFixed(1)}%</text>`
  ).join('') : '';

  // XËª∏Êó•‰ªò„É©„Éô„É´
  const firstDs = data[0].ds.slice(5).replace('-','/');
  const lastDs  = data[n-1].ds.slice(5).replace('-','/');

  // Âá°‰æã
  const legend = `
    <line x1="${PAD.l}" y1="10" x2="${PAD.l+16}" y2="10" stroke="#2D6A4F" stroke-width="2"/>
    <text x="${PAD.l+18}" y="14" font-size="9" fill="#555">‰ΩìÈáç</text>
    <line x1="${PAD.l+46}" y1="10" x2="${PAD.l+62}" y2="10" stroke="#52B788" stroke-width="1.5" stroke-dasharray="5,3"/>
    <text x="${PAD.l+64}" y="14" font-size="9" fill="#555">7Êó•Âπ≥Âùá</text>
    ${hasBF ? `<line x1="${PAD.l+104}" y1="10" x2="${PAD.l+120}" y2="10" stroke="#E5A020" stroke-width="1.5" stroke-dasharray="4,2"/>
    <text x="${PAD.l+122}" y="14" font-size="9" fill="#555">‰ΩìËÑÇËÇ™%</text>` : ''}`;

  return `<div class="chart-scroll">
    <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
      ${wLabels}${bfLabels}
      ${avg7Pts ? `<polyline points="${avg7Pts}" fill="none" stroke="#52B788" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.85"/>` : ''}
      <polyline points="${wPts}" fill="none" stroke="#2D6A4F" stroke-width="2"/>
      ${hasBF ? `<polyline points="${bfPts}" fill="none" stroke="#E5A020" stroke-width="1.5" stroke-dasharray="4,2"/>` : ''}
      ${wDots}${bfDots}
      <text x="${PAD.l}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${firstDs}</text>
      <text x="${W-PAD.r}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${lastDs}</text>
      ${legend}
    </svg>
  </div>`;
}

function saveWeight() {
  const wInp  = document.getElementById('weight-input');
  const bfInp = document.getElementById('bf-input');
  const wVal  = parseFloat(wInp.value);
  const bfVal = parseFloat(bfInp?.value);
  if (!wVal || wVal < 30 || wVal > 300) { showToast('Ê≠£„Åó„ÅÑ‰ΩìÈáç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  const w = getWeights();
  w[currentDate] = wVal;
  saveWeights(w);
  if (!isNaN(bfVal) && bfVal > 0) {
    const bf = getBodyFat();
    bf[currentDate] = bfVal;
    saveBodyFat(bf);
  }
  syncWeightsToGitHub();
  showToast(`${wVal}kg${!isNaN(bfVal) && bfVal > 0 ? ' / ' + bfVal + '%' : ''} „ÇíË®òÈå≤„Åó„Åæ„Åó„Åü ‚úì`);
  switchTab('weight');
}

// ======== SLEEP TAB ========
function parseLocalDate(s) {
  // "YYYY-MM-DDTHH:MM" „Å® "YYYY-MM-DD HH:MM:SS +0900" „ÅÆ‰∏°Êñπ„Å´ÂØæÂøú
  const sep = s.includes('T') ? 'T' : ' ';
  const [date, time] = s.split(sep);
  const [y, mo, d] = date.split('-').map(Number);
  const [hh, mm]   = time.split(':').map(Number);
  return new Date(y, mo - 1, d, hh, mm, 0);
}

function hrToHM(h) {
  const m = Math.round(h * 60);
  return `${Math.floor(m / 60)}h${String(m % 60).padStart(2,'0')}m`;
}

function buildSleepTimeline(timeline, bedStart, bedEnd, idSuffix = '') {
  // „Éí„Éó„Éé„Ç∞„É©„É†ÔºöCatmull-Rom„Çπ„Éó„É©„Ç§„É≥ÔºàÂêÑ„Çª„Ç∞„É°„É≥„Éà‰∏≠ÁÇπ„ÇíÈÄö„ÇãËá™ÁÑ∂„Å™Ê≥¢Ôºâ
  const LEVEL = { awake:0, rem:1, core:2, deep:3 };
  const LABEL = { awake:'Ë¶öÈÜí', rem:'REM', core:'„Ç≥„Ç¢', deep:'Ê∑±„ÅÑ' };
  const COLOR = { awake:'#FBBF24', rem:'#A78BFA', core:'#60C6F1', deep:'#3B9EEB' };

  const W = 320;
  const PAD = { l:34, r:6, t:14, b:20 };
  const ROW = 28, LEVELS = 4;
  const ph = LEVELS * ROW;
  const H = PAD.t + ph + PAD.b;
  const pw = W - PAD.l - PAD.r;

  const startMs = parseLocalDate(bedStart).getTime();
  const endMs   = parseLocalDate(bedEnd).getTime();
  const totalMs = endMs - startMs;
  if (totalMs <= 0) return '';

  const toX = ms => PAD.l + ((ms - startMs) / totalMs) * pw;
  const toY = stage => PAD.t + (LEVEL[stage] ?? 2) * ROW + ROW / 2;

  // „Ç≥„É≥„Éà„É≠„Éº„É´„Éù„Ç§„É≥„ÉàÁîüÊàêÔºö
  // ‰∏≠ÁÇπ ‚Üí Â¢ÉÁïåÁÇπÔºà‰∏°„Çπ„ÉÜ„Éº„Ç∏„ÅÆÂπ≥ÂùáYÔºâ‚Üí ‰∏≠ÁÇπ ‚Üí Â¢ÉÁïåÁÇπ ... „Å®‰∫§‰∫í„Å´ÈÖçÁΩÆ
  // Â¢ÉÁïåÁÇπ„ÇíÈÄöÈÅé„Åô„Çã„Åì„Å®„Åß„Çπ„ÉÜ„Éº„Ç∏Âàá„ÇäÊõø„Çè„Çä„ÅÆÊôÇÂàª„ÅåÊ≠£Á¢∫„Å´„Å™„ÇäÈÄÜÊàª„Çä„ÇíÈò≤Ê≠¢
  const pts = [];
  const firstSeg = timeline[0];
  const lastSeg  = timeline[timeline.length - 1];
  pts.push({ x: toX(parseLocalDate(firstSeg.s).getTime()), y: toY(firstSeg.v) });
  for (let i = 0; i < timeline.length; i++) {
    const seg = timeline[i];
    const midMs = (parseLocalDate(seg.s).getTime() + parseLocalDate(seg.e).getTime()) / 2;
    pts.push({ x: toX(midMs), y: toY(seg.v) });
    // „Çª„Ç∞„É°„É≥„ÉàÈñì„ÅÆÂ¢ÉÁïåÁÇπ„ÇíËøΩÂä†ÔºàÊ¨°„ÅÆ„Çª„Ç∞„É°„É≥„Éà„Å∏„ÅÆÂàá„ÇäÊõø„Çè„ÇäÊôÇÂàª / Âπ≥ÂùáYÔºâ
    if (i < timeline.length - 1) {
      const boundMs = parseLocalDate(seg.e).getTime();
      const midY    = (toY(seg.v) + toY(timeline[i + 1].v)) / 2;
      pts.push({ x: toX(boundMs), y: midY });
    }
  }
  pts.push({ x: toX(parseLocalDate(lastSeg.e).getTime()), y: toY(lastSeg.v) });

  // Catmull-Rom ‚Üí ‰∏âÊ¨°„Éô„Ç∏„ÇßÂ§âÊèõÔºàXY„Å®„ÇÇ„Å´„ÇØ„É©„É≥„Éó„Åó„Å¶„Ç™„Éº„Éê„Éº„Ç∑„É•„Éº„ÉàÈò≤Ê≠¢Ôºâ
  const f = s => s.toFixed(2);
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  let d = `M ${f(pts[0].x)},${f(pts[0].y)}`;
  for (let i = 0; i < pts.length - 1; i++) {
    const p0 = pts[Math.max(0, i - 1)];
    const p1 = pts[i];
    const p2 = pts[i + 1];
    const p3 = pts[Math.min(pts.length - 1, i + 2)];
    const cp1x = clamp(p1.x + (p2.x - p0.x) / 6, p1.x, p2.x);
    const cp1y = clamp(p1.y + (p2.y - p0.y) / 6, Math.min(p1.y, p2.y), Math.max(p1.y, p2.y));
    const cp2x = clamp(p2.x - (p3.x - p1.x) / 6, p1.x, p2.x);
    const cp2y = clamp(p2.y - (p3.y - p1.y) / 6, Math.min(p1.y, p2.y), Math.max(p1.y, p2.y));
    d += ` C ${f(cp1x)},${f(cp1y)} ${f(cp2x)},${f(cp2y)} ${f(p2.x)},${f(p2.y)}`;
  }

  // Â°ó„Çä„Å§„Å∂„ÅóÔºàÊ≥¢ÂΩ¢„ÅÆ‰∏ã„ÇíÈñâ„Åò„ÇãÔºâ
  const bot = PAD.t + ph + 2;
  const fillD = d + ` L ${f(pts[pts.length-1].x)},${bot} L ${f(pts[0].x)},${bot} Z`;

  // YËª∏Ôºö„Çπ„ÉÜ„Éº„Ç∏„É©„Éô„É´Ôºã„Ç∞„É™„ÉÉ„ÉâÁ∑ö
  let yAxis = '';
  ['awake','rem','core','deep'].forEach(s => {
    const y = toY(s);
    yAxis += `<line x1="${PAD.l}" y1="${f(y)}" x2="${W-PAD.r}" y2="${f(y)}" stroke="#EBEBEB" stroke-width="1" stroke-dasharray="3,3"/>`;
    yAxis += `<text x="${PAD.l-4}" y="${f(y+3.5)}" text-anchor="end" font-size="9" fill="${COLOR[s]}" font-weight="700">${LABEL[s]}</text>`;
  });

  // ÊôÇÂàª„É©„Éô„É´Ôºà‰∏ãÊÆµÔºâ
  const bedX = PAD.l;       // Â∞±ÂØù„É©„Éô„É´„ÅÆËµ∑ÁÇπÔºàtext-anchor: startÔºâ
  const wakeX = W - PAD.r;  // Ëµ∑Â∫ä„É©„Éô„É´„ÅÆËµ∑ÁÇπÔºàtext-anchor: endÔºâ
  const LABEL_W = 30;       // "HH:MM" „ÅÆÊ¶ÇÁÆóÂπÖÔºàfont-size 9Ôºâ
  const GAP = 6;            // „É©„Éô„É´Èñì„ÅÆÊúÄÂ∞è‰ΩôÁôΩ

  let tLabels = `
    <text x="${bedX}" y="${H-2}" text-anchor="start" font-size="9" fill="#888">${bedStart.slice(11,16)}</text>
    <text x="${wakeX}" y="${H-2}" text-anchor="end" font-size="9" fill="#888">${bedEnd.slice(11,16)}</text>`;
  const sd = parseLocalDate(bedStart);
  let tick = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate(), sd.getHours() + 1, 0, 0);
  while (tick.getTime() < endMs) {
    const h = tick.getHours();
    if (h % 2 === 0) {
      const mx = toX(tick.getTime());
      // Â∞±ÂØù„É©„Éô„É´Âè≥Á´Ø„ÉªËµ∑Â∫ä„É©„Éô„É´Â∑¶Á´Ø„Å®„ÅÆË∑ùÈõ¢„ÇíÁ¢∫Ë™ç
      if (mx > bedX + LABEL_W + GAP && mx < wakeX - LABEL_W - GAP) {
        tLabels += `<text x="${f(mx)}" y="${H-2}" text-anchor="middle" font-size="9" fill="#BBB">${h}:00</text>`;
      }
    }
    tick.setHours(tick.getHours() + 1);
  }

  // ÊôÇÈñìËª∏„Éô„Éº„Çπ„ÅÆ„Çπ„ÉÜ„Éº„Ç∏Ëâ≤ÂàÜ„ÅëÔºöÂêÑ„Çª„Ç∞„É°„É≥„Éà„ÅÆÊôÇÈñìÁ™ì„Çí„Çπ„ÉÜ„Éº„Ç∏Ëâ≤„Åß„ÇØ„É™„ÉÉ„ÉóÂ°ó„Çä
  const segFills = timeline.map(seg => {
    const x1 = toX(parseLocalDate(seg.s).getTime());
    const x2 = toX(parseLocalDate(seg.e).getTime());
    return `<rect x="${f(x1)}" y="${PAD.t}" width="${f(Math.max(x2-x1,0.5))}" height="${ph+2}" fill="${COLOR[seg.v] ?? '#6BAED6'}"/>`;
  }).join('');

  const clipId = `hpClip${idSuffix}`;
  const blurId = `hpBlur${idSuffix}`;
  return `<div style="margin:10px 0 6px;">
    <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
      <defs>
        <clipPath id="${clipId}">
          <path d="${fillD}"/>
        </clipPath>
        <filter id="${blurId}" x="-5%" width="110%" y="-5%" height="110%">
          <feGaussianBlur stdDeviation="10 0"/>
        </filter>
      </defs>
      ${yAxis}
      <g filter="url(#${blurId})" clip-path="url(#${clipId})" opacity="0.6">
        ${segFills}
      </g>
      <path d="${d}" fill="none" stroke="#2E7FC1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      ${tLabels}
    </svg>
  </div>`;
}

function renderSleep(container) {
  const sleepAll = getSleepData();
  const isToday  = currentDate === todayStr();
  const todayS   = sleepAll[currentDate] ?? null;
  const hasNaps  = !!(todayS && todayS.naps && todayS.naps.length > 0);

  // Êó•‰ªò„Éä„Éì
  container.innerHTML += `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>`;

  // ===== 1Êó•ÂêàË®à„Éò„ÉÉ„ÉÄ„ÉºÔºàÊòºÂØù„Åå„ÅÇ„ÇãÊó•„ÅÆ„ÅøÔºâ =====
  if (hasNaps) {
    const nightH   = todayS.total ?? 0;
    const napTotal = todayS.naps.reduce((s, n) => s + (n.total ?? 0), 0);
    const dayTotal = todayS.dayTotal ?? (nightH + napTotal);
    const dayIcon  = dayTotal >= 7 ? 'üåü' : dayTotal >= 6.5 ? 'üò¥' : dayTotal >= 6 ? 'üòë' : 'ü•±';
    const dayColor = dayTotal >= 7 ? 'var(--green-mid)' : dayTotal >= 6.5 ? 'var(--green-mid)' : dayTotal >= 6 ? 'var(--warning)' : 'var(--danger)';
    container.innerHTML += `<div class="card" style="background:linear-gradient(135deg,var(--green-pale),#EEF5FA);border:1px solid var(--border);">
      <div class="card-title">üìä 1Êó•„ÅÆÁù°Áú†ÂêàË®à</div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0;">
        <div>
          <div class="sleep-big" style="color:${dayColor};">${hrToHM(dayTotal)}</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">üåô Â§úÈñì ${hrToHM(nightH)} Ôºã üò¥ ÊòºÂØù ${hrToHM(napTotal)}</div>
        </div>
        <div style="font-size:32px;">${dayIcon}</div>
      </div>
    </div>`;
  }

  // ===== „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ =====
  let summaryHtml = `<div class="card"><div class="card-title">${hasNaps ? 'üåô Â§úÈñìÁù°Áú†' : 'üåô Áù°Áú†„Çµ„Éû„É™„Éº'}</div>`;
  if (!todayS) {
    summaryHtml += `<div class="empty-state">
      <div class="empty-icon">üåô</div>
      <div class="empty-text">„Åì„ÅÆÊó•„ÅÆÁù°Áú†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>Health Auto Export„ÅßÂêåÊúü„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>`;
  } else {
    const totalH = todayS.total || 0;
    const remH   = todayS.rem   || 0;
    const coreH  = todayS.core  || 0;
    const deepH  = todayS.deep  || 0;
    const awakeH = todayS.awake || 0;
    const hasTimeline = !!(todayS.timeline && todayS.timeline.length > 0);

    const sleepIcon   = totalH >= 7 ? 'üåü' : totalH >= 6.5 ? 'üò¥' : totalH >= 6 ? 'üòë' : 'ü•±';
    const sleepLabel  = totalH >= 7 ? 'ÊúÄÈ´ò' : totalH >= 6.5 ? 'ÂçÅÂàÜ' : totalH >= 6 ? '„ÇÑ„ÇÑ‰∏çË∂≥' : '‰∏çË∂≥';
    const statusColor = totalH >= 7 ? 'var(--green-mid)' : totalH >= 6.5 ? 'var(--green-mid)' : totalH >= 6 ? 'var(--warning)' : 'var(--danger)';

    // „Éí„Éº„É≠„ÉºË°åÔºàÂêàË®àÊôÇÈñì + Ë©ï‰æ°Ôºâ
    summaryHtml += `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0 2px;">
        <div>
          <div class="sleep-big">${hrToHM(totalH)}</div>
          ${hasTimeline ? `<div style="font-size:11px;color:var(--text-muted);margin-top:3px;">${todayS.bedStart.slice(11,16)} Â∞±ÂØù ‚Üí ${todayS.bedEnd.slice(11,16)} Ëµ∑Â∫ä</div>` : ''}
        </div>
        <div style="text-align:center;">
          <div style="font-size:30px;">${sleepIcon}</div>
          <div style="font-size:11px;font-weight:700;color:${statusColor};">${sleepLabel}</div>
        </div>
      </div>`;

    // „Çø„Ç§„É†„É©„Ç§„É≥Ê≥¢ÂΩ¢ÔºàApple Watch„Éá„Éº„Çø„Åå„ÅÇ„ÇãÊó•Ôºâ
    if (hasTimeline) {
      summaryHtml += buildSleepTimeline(todayS.timeline, todayS.bedStart, todayS.bedEnd, '_night');
    } else if (remH > 0) {
      // „Çø„Ç§„É†„É©„Ç§„É≥„Å™„Åó„ÉªREM„ÅÆ„Åø
      const remPct = Math.round((remH / totalH) * 100);
      summaryHtml += `
        <div class="sleep-stage-bar" style="margin:10px 0 4px;">
          <div class="sleep-stage-rem" style="width:${remPct}%;"></div>
          <div style="flex:1;background:#E9ECEF;"></div>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">REM ${hrToHM(remH)}Ôºà${remPct}%Ôºâ Ôºè Ë©≥Á¥∞„Çπ„ÉÜ„Éº„Ç∏„ÅØÊú™ÂèñÂæó</div>`;
    }

    // „Çπ„ÉÜ„Éº„Ç∏Ë©≥Á¥∞„Éú„ÉÉ„ÇØ„ÇπÔºà„Çø„Ç§„É†„É©„Ç§„É≥‰ªò„Åç„ÅÆÊó•Ôºâ
    if (coreH > 0 || remH > 0 || deepH > 0 || awakeH > 0) {
      const bedH = totalH + awakeH;
      const sPct = h => bedH > 0 ? Math.round((h / bedH) * 100) : 0;
      const sInd = (type, pct) => {
        let dot, label, color;
        if (type === 'core') {
          if (pct >= 45 && pct <= 55) { dot = '‚óè'; label = 'ÁêÜÊÉ≥Âüü'; color = '#22C55E'; }
          else if (pct < 45) { dot = '‚ñ≥'; label = '„ÇÑ„ÇÑÂ∞ë'; color = '#F59E0B'; }
          else { dot = '‚ñ≥'; label = '„ÇÑ„ÇÑÂ§ö'; color = '#F59E0B'; }
        } else if (type === 'rem') {
          if (pct >= 20 && pct <= 25) { dot = '‚óè'; label = 'ÁêÜÊÉ≥Âüü'; color = '#22C55E'; }
          else if (pct >= 15 && pct < 20) { dot = '‚ñ≥'; label = '„ÇÑ„ÇÑÂ∞ë'; color = '#F59E0B'; }
          else if (pct > 25 && pct <= 30) { dot = '‚ñ≥'; label = '„ÇÑ„ÇÑÂ§ö'; color = '#F59E0B'; }
          else { dot = '‚ñº'; label = pct < 15 ? 'Â∞ë„Å™„ÇÅ' : 'Â§ö„ÇÅ'; color = '#EF4444'; }
        } else if (type === 'deep') {
          if (pct >= 10 && pct <= 20) { dot = '‚óè'; label = 'ÁêÜÊÉ≥Âüü'; color = '#22C55E'; }
          else if (pct >= 8 && pct < 10) { dot = '‚ñ≥'; label = '„ÇÑ„ÇÑÂ∞ë'; color = '#F59E0B'; }
          else if (pct > 20) { dot = '‚ñº'; label = 'Â§ö„ÇÅ'; color = '#EF4444'; }
          else { dot = '‚ñº'; label = 'Â∞ë„Å™„ÇÅ'; color = '#EF4444'; }
        } else {
          if (pct < 5) { dot = '‚óè'; label = 'ËâØÂ•Ω'; color = '#22C55E'; }
          else if (pct <= 10) { dot = '‚ñ≥'; label = '„ÇÑ„ÇÑÂ§ö'; color = '#F59E0B'; }
          else { dot = '‚ñº'; label = 'Â§ö„ÇÅ'; color = '#EF4444'; }
        }
        const targets = { core: '45-55%', rem: '20-25%', deep: '10-20%', awake: '<5%' };
        return `<div style="font-size:9px;color:${color};margin-top:2px;">${dot}${label}<span style="color:var(--text-muted);font-size:8px;"> ÁõÆÂÆâ${targets[type]}</span></div>`;
      };
      const cPct = sPct(coreH), rPct = sPct(remH), dPct = sPct(deepH), aPct = sPct(awakeH);
      summaryHtml += `<div style="display:flex;gap:6px;margin-top:10px;">
        ${coreH  > 0 ? `<div style="flex:1;text-align:center;background:#EEF5FA;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#5B8FB9;">${hrToHM(coreH)}</div><div style="font-size:10px;color:var(--text-muted);">„Ç≥„Ç¢ ${cPct}%</div>${sInd('core', cPct)}<div style="font-size:8px;color:var(--text-muted);margin-top:2px;">Âü∫Êú¨‰ºëÊÅØ</div></div>` : ''}
        ${remH   > 0 ? `<div style="flex:1;text-align:center;background:#EEF5FA;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#5B8FB9;">${hrToHM(remH)}</div><div style="font-size:10px;color:var(--text-muted);">REM ${rPct}%</div>${sInd('rem', rPct)}<div style="font-size:8px;color:var(--text-muted);margin-top:2px;">Ë®òÊÜ∂„ÉªÊÑüÊÉÖ</div></div>` : ''}
        ${deepH  > 0 ? `<div style="flex:1;text-align:center;background:#E8EEF5;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#2E4057;">${hrToHM(deepH)}</div><div style="font-size:10px;color:var(--text-muted);">Ê∑±„ÅÑ ${dPct}%</div>${sInd('deep', dPct)}<div style="font-size:8px;color:var(--text-muted);margin-top:2px;">ÊàêÈï∑„Éõ„É´„É¢„É≥</div></div>` : ''}
        ${awakeH > 0 ? `<div style="flex:1;text-align:center;background:#FEF3EB;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#F4A261;">${hrToHM(awakeH)}</div><div style="font-size:10px;color:var(--text-muted);">Ë¶öÈÜí ${aPct}%</div>${sInd('awake', aPct)}<div style="font-size:8px;color:var(--text-muted);margin-top:2px;">Â∞ë„Å™„ÅÑ„Åª„Å©‚óé</div></div>` : ''}
      </div>`;
      // „Éí„É≥„Éà„Ç´„Éº„Éâ v2ÔºàAI„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫ÂØæÂøú„Éª2Ë°åÊßãÊàêÔºâ
      const stageHints = (adviceData && adviceData.sleep && adviceData.sleep.stageHints) ? adviceData.sleep.stageHints : {};
      const fallbacks = {
        deep: 'ÊàêÈï∑„Éõ„É´„É¢„É≥ÔºàËÑÇËÇ™ÁáÉÁÑº+Á≠ã‰øÆÂæ©Ôºâ„ÅØÊ∑±„ÅÑÁù°Áú†‰∏≠„Å´ÂàÜÊ≥å„ÄÇÊ¥ªÂãïÈáè„Å®MgÊúçÁî®„ÅßÊîπÂñÑ',
        rem: 'Ë¶èÂâáÁöÑ„Å™Ëµ∑Â∫äÊôÇÈñì„Å®ÂçÅÂàÜ„Å™Áù°Áú†ÊôÇÈñì„ÅåREM„ÇíÊîπÂñÑ„Åó„Åæ„Åô',
        remOver: 'REMÈÅéÂ§ö„ÅØ„Çπ„Éà„É¨„Çπ„ÇÑÁù°Áú†‰∏çË∂≥„ÅÆÂèçÂãï„ÅÆÂèØËÉΩÊÄß„ÄÇÁù°Áú†ÊôÇÈñì„ÅÆÁ¢∫‰øù„Çí',
        core: 'Á∑èÁù°Áú†ÊôÇÈñì„ÇíÂ¢ó„ÇÑ„Åô„Åì„Å®„Åå„Ç≥„Ç¢Áù°Áú†ÊîπÂñÑ„ÅÆËøëÈÅì„Åß„Åô',
        awake: '‰∏≠ÈÄîË¶öÈÜí„ÅØ„Ç≥„É´„ÉÅ„Çæ„Éº„É´‚Üë„ÅßËÑÇËÇ™ÁáÉÁÑº„ÇíÈòªÂÆ≥„ÄÇMgÊúçÁî®„Å®20ÊôÇ‰ª•Èôç„ÅÆÊ∞¥ÂàÜÂà∂Èôê„Çí'
      };
      const hints = [];
      if (dPct > 0 && dPct < 10) hints.push({ stage: 'Ê∑±„ÅÑÁù°Áú†ÔºàËÑÇËÇ™ÁáÉÁÑºÔºâ', status: `„ÇÑ„ÇÑÂ∞ë„Å™„ÇÅÔºà${dPct}%Ôºâ`, text: stageHints.deep || fallbacks.deep, color: dPct < 8 ? '#EF4444' : '#F59E0B' });
      if (rPct > 0 && rPct < 20) hints.push({ stage: 'REMÔºàË®òÊÜ∂„ÉªÊÑüÊÉÖÔºâ', status: `„ÇÑ„ÇÑÂ∞ë„Å™„ÇÅÔºà${rPct}%Ôºâ`, text: stageHints.rem || fallbacks.rem, color: rPct < 15 ? '#EF4444' : '#F59E0B' });
      if (rPct > 25) hints.push({ stage: 'REMÔºàË®òÊÜ∂„ÉªÊÑüÊÉÖÔºâ', status: `Â§ö„ÇÅÔºà${rPct}%Ôºâ`, text: stageHints.rem || fallbacks.remOver, color: rPct > 30 ? '#EF4444' : '#F59E0B' });
      if (cPct > 0 && cPct < 45) hints.push({ stage: '„Ç≥„Ç¢ÔºàÂü∫Êú¨‰ºëÊÅØÔºâ', status: `„ÇÑ„ÇÑÂ∞ë„Å™„ÇÅÔºà${cPct}%Ôºâ`, text: stageHints.core || fallbacks.core, color: '#F59E0B' });
      if (aPct >= 5) hints.push({ stage: 'Ë¶öÈÜíÔºàÂ∞ë„Å™„ÅÑ„Åª„Å©‚óéÔºâ', status: `Â§ö„ÇÅÔºà${aPct}%Ôºâ`, text: stageHints.awake || fallbacks.awake, color: aPct > 10 ? '#EF4444' : '#F59E0B' });
      if (hints.length === 0) {
        summaryHtml += `<div style="margin-top:8px;padding:7px 10px;background:#F0FDF4;border-radius:8px;font-size:10px;color:#16A34A;text-align:center;">‚ú® Áù°Áú†„Éê„É©„É≥„ÇπËâØÂ•ΩÔºÅ</div>`;
      } else {
        hints.forEach(h => {
          summaryHtml += `<div style="margin-top:6px;padding:6px 10px;background:#FFFBEB;border-radius:8px;border-left:3px solid ${h.color};font-size:10px;color:var(--text-secondary);"><span style="color:${h.color};font-weight:600;">${h.stage}: </span>${h.status}<br><span style="color:var(--text-muted);">‚Üí ${h.text}</span></div>`;
        });
      }
    }
  }
  summaryHtml += `</div>`;
  container.innerHTML += summaryHtml;

  // ===== „É™„Éê„Ç¶„É≥„ÉâË≠¶Âëä„Ç´„Éº„Éâ =====
  if (todayS && isToday) {
    const totalH = todayS.total || 0;
    const reboundRisk = totalH >= 7 ? 'high' : totalH >= 6.5 ? 'medium' : null;
    if (reboundRisk) {
      const isHigh = reboundRisk === 'high';
      const bgColor = isHigh ? '#FFF7ED' : '#FFFBEB';
      const borderColor = isHigh ? '#F97316' : '#F59E0B';
      const titleColor = isHigh ? '#EA580C' : '#D97706';
      const riskLabel = isHigh ? '‚ö° „É™„Éê„Ç¶„É≥„ÉâÊ≥®ÊÑèÔºàÈ´ò„É™„Çπ„ÇØÔºâ' : '‚ö° „É™„Éê„Ç¶„É≥„ÉâÊ≥®ÊÑè';
      const reboundMsg = (adviceData && adviceData.sleep && adviceData.sleep.reboundAlert && adviceData.sleep.reboundAlert.message)
        ? adviceData.sleep.reboundAlert.message : null;
      container.innerHTML += `
        <div class="card" style="background:${bgColor};border-left:4px solid ${borderColor};padding:12px 14px;">
          <div style="font-size:13px;font-weight:700;color:${titleColor};margin-bottom:8px;">${riskLabel}</div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">„Çà„ÅèÁú†„Çå„ÅüÁøåÊó•„ÅØÂ§úÊõ¥„Åã„Åó„É™„Çπ„ÇØUP„ÄÇÈÅéÂéª„Éá„Éº„Çø„ÅåÁ§∫„ÅôÂÇæÂêë„ÇíÊÑèË≠ò„Åó„Å¶‰ªäÂ§ú„ÅÆÂ∞±ÂØù„ÇíÂÆà„Çç„ÅÜ„ÄÇ</div>
          <div style="font-size:11px;color:var(--text-secondary);line-height:1.8;">
            <div>üìå <strong>22:30</strong>„ÄÄÂ∞±ÂØùÊ∫ñÂÇô„Ç¢„É©„Éº„É†„Çí„Çª„ÉÉ„Éà</div>
            <div>üìå <strong>23:00</strong>„ÄÄÂ∏ÉÂõ£„Å´ÂÖ•„ÇãÔºàÁú†„Åè„Å™„Åè„Å¶„ÇÇÔºâ</div>
            <div>üìå <strong>21:00‰ª•Èôç</strong>„ÄÄ„Çπ„Éû„Éõ„ÉªPCÊéß„Åà„ÇÅ„Å´</div>
          </div>
          ${reboundMsg ? `<div style="margin-top:10px;padding:6px 10px;background:rgba(0,0,0,0.04);border-radius:6px;font-size:10px;color:${titleColor};">üí° ${reboundMsg}</div>` : ''}
        </div>`;
    }
  }

  // ===== ÊòºÂØù„Ç´„Éº„ÉâÔºàÊòºÂØù„Åå„ÅÇ„ÇãÊó•„ÅÆ„ÅøÔºâ =====
  if (hasNaps) {
    todayS.naps.forEach((nap, idx) => {
      const napH = nap.total ?? 0;
      const hasNapTimeline = !!(nap.timeline && nap.timeline.length > 0);
      const cN = nap.core ?? 0, rN = nap.rem ?? 0, dN = nap.deep ?? 0, aN = nap.awake ?? 0;
      const napLabel = todayS.naps.length > 1 ? ` ${idx + 1}` : '';
      let napHtml = `<div class="card"><div class="card-title">üò¥ ÊòºÂØù${napLabel}</div>`;
      napHtml += `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0 2px;">
        <div>
          <div class="sleep-big" style="color:#A78BFA;">${hrToHM(napH)}</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:3px;">${nap.start.slice(11,16)} „Äú ${nap.end.slice(11,16)}</div>
        </div>
        <div style="font-size:28px;">üò¥</div>
      </div>`;
      if (hasNapTimeline) {
        napHtml += buildSleepTimeline(nap.timeline, nap.start, nap.end, `_nap${idx}`);
      } else {
        // „Çπ„ÉÜ„Éº„Ç∏„Éá„Éº„Çø„Å™„ÅóÔºö„Ç∑„É≥„Éó„É´„Å™„Éê„ÉºË°®Á§∫
        napHtml += `<div style="height:14px;background:linear-gradient(90deg,#A78BFA,#C4B5FD);border-radius:6px;margin:10px 0 4px;opacity:0.7;"></div>
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Apple Watch„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Éá„Éº„Çø„Å™„ÅóÔºàAutoSleepÊ§úÂá∫Ôºâ</div>`;
      }
      if (cN > 0 || rN > 0 || dN > 0 || aN > 0) {
        napHtml += `<div style="display:flex;gap:6px;margin-top:10px;">
          ${cN > 0 ? `<div style="flex:1;text-align:center;background:#EEF5FA;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#5B8FB9;">${hrToHM(cN)}</div><div style="font-size:10px;color:var(--text-muted);">„Ç≥„Ç¢</div></div>` : ''}
          ${rN > 0 ? `<div style="flex:1;text-align:center;background:#EEF5FA;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#5B8FB9;">${hrToHM(rN)}</div><div style="font-size:10px;color:var(--text-muted);">REM</div></div>` : ''}
          ${dN > 0 ? `<div style="flex:1;text-align:center;background:#E8EEF5;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#2E4057;">${hrToHM(dN)}</div><div style="font-size:10px;color:var(--text-muted);">Ê∑±„ÅÑ</div></div>` : ''}
          ${aN > 0 ? `<div style="flex:1;text-align:center;background:#FEF3EB;border-radius:8px;padding:7px 2px;"><div style="font-size:13px;font-weight:700;color:#F4A261;">${hrToHM(aN)}</div><div style="font-size:10px;color:var(--text-muted);">Ë¶öÈÜí</div></div>` : ''}
        </div>`;
      }
      napHtml += `</div>`;
      container.innerHTML += napHtml;
    });
  }

  // Â∞±ÂØùÊôÇÈñì KPIÔºàÈÅéÂéª7Êó•Ôºâ
  {
    const bedDays = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(); d.setDate(d.getDate() - i);
      const ds = fmtDate(d);
      const hit = isBedOnTime(sleepAll[ds]);
      bedDays.push({ date: ds, hit });
    }
    container.innerHTML += renderKpiCard(
      'üõèÔ∏è Â∞±ÂØùÊôÇÈñì KPIÔºàÈÅéÂéª7Êó•Ôºâ',
      'ÁõÆÊ®ô: 6Âõû/7Êó• Ôºè 1:30„Åæ„Åß„Å´Â∞±ÂØù',
      bedDays,
      6
    );
  }

  // AI Sleep advice card
  container.innerHTML += renderAdviceCard('sleep');

  // ===== 7Êó•Èñì„Éà„É¨„É≥„Éâ =====
  const sleepChart = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    const s = sleepAll[ds] ?? null;
    const napTotal = s?.naps ? s.naps.reduce((sum, n) => sum + (n.total ?? 0), 0) : 0;
    const displayTotal = s?.dayTotal ?? (napTotal > 0 ? (s?.total ?? 0) + napTotal : s?.total ?? null);
    sleepChart.push({ ds, total: displayTotal, nightOnly: s?.total ?? null, napH: napTotal > 0 ? napTotal : null, rem: s?.rem ?? null, deep: s?.deep ?? null, awake: s?.awake ?? null });
  }

  const hasAnyNap  = sleepChart.some(r => r.napH != null);
  const hasChart = sleepChart.filter(d => d.total != null).length >= 2;
  let chartHtml = `<div class="card"><div class="card-title">Áù°Áú†„Éà„É¨„É≥„ÉâÔºàÁõ¥Ëøë7Êó•Ôºâ</div>`;
  if (hasChart) chartHtml += buildSleepChart(sleepChart);

  // 7Êó•„ÉÜ„Éº„Éñ„É´
  const thStyle = 'text-align:right;padding:4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);';
  chartHtml += `<table style="width:100%;border-collapse:collapse;margin-top:12px;font-size:12px;">
    <thead><tr>
      <th style="text-align:left;padding:4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">Êó•‰ªò</th>
      <th style="${thStyle}">ÂêàË®à</th>
      ${hasAnyNap ? `<th style="${thStyle}">ÊòºÂØù</th>` : ''}
      <th style="${thStyle}">Ê∑±„ÅÑ</th>
      <th style="${thStyle}">Ê∑±„ÅÑ%</th>
      <th style="${thStyle}">Ë¶öÈÜí%</th>
      <th style="text-align:center;padding:4px;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);"></th>
    </tr></thead><tbody>`;

  [...sleepChart].reverse().forEach(row => {
    const isToday2  = row.ds === todayStr();
    const totalMin  = row.total != null ? Math.round(row.total * 60) : null;
    const deepMin   = row.deep  != null ? Math.round(row.deep  * 60) : null;
    const bedTotal  = row.nightOnly != null ? row.nightOnly + (row.awake || 0) : null;
    const deepPct2  = (bedTotal && row.deep  != null) ? Math.round(row.deep  / bedTotal * 100) : null;
    const awakePct2 = (bedTotal && row.awake != null) ? Math.round(row.awake / bedTotal * 100) : null;
    const totalStr  = totalMin != null ? `${Math.floor(totalMin/60)}h${String(totalMin%60).padStart(2,'0')}m` : '‚Äî';
    const deepStr   = deepMin  != null ? `${Math.floor(deepMin/60)}h${String(deepMin%60).padStart(2,'0')}m`   : '‚Äî';
    const napMin    = row.napH  != null ? Math.round(row.napH * 60) : null;
    const napStr    = napMin    != null ? `${Math.floor(napMin/60)}h${String(napMin%60).padStart(2,'0')}m`    : '‚Äî';
    const goodSleep = row.total != null && row.total >= 6.5;
    const sleepIcon = row.total == null ? '' : row.total >= 7 ? 'üåü' : row.total >= 6.5 ? 'üò¥' : row.total >= 6 ? 'üòë' : 'ü•±';
    const deepColor = deepPct2 == null ? 'var(--text-muted)' : (deepPct2 >= 10 && deepPct2 <= 20) ? 'var(--green-mid)' : (deepPct2 >= 8) ? '#F59E0B' : '#EF4444';
    const awakeColor = awakePct2 == null ? 'var(--text-muted)' : awakePct2 < 5 ? 'var(--green-mid)' : awakePct2 <= 10 ? '#F59E0B' : '#EF4444';

    chartHtml += `<tr style="${isToday2 ? 'background:var(--green-pale);' : ''}">
      <td style="padding:5px 4px;white-space:nowrap;">${row.ds.slice(5).replace('-','/')}${isToday2 ? '&nbsp;<span style="font-size:9px;color:var(--green-mid);">TODAY</span>' : ''}</td>
      <td style="text-align:right;padding:5px 4px;font-weight:600;color:${row.total==null?'var(--text-muted)':goodSleep?'var(--green-mid)':'var(--warning)'};">${totalStr}</td>
      ${hasAnyNap ? `<td style="text-align:right;padding:5px 4px;color:#A78BFA;font-weight:${row.napH?'600':'400'};">${napStr}</td>` : ''}
      <td style="text-align:right;padding:5px 4px;color:#2E4057;font-weight:${row.deep!=null?'600':'400'};">${deepStr}</td>
      <td style="text-align:right;padding:5px 4px;font-weight:600;color:${deepColor};">${deepPct2 != null ? deepPct2 + '%' : '‚Äî'}</td>
      <td style="text-align:right;padding:5px 4px;font-weight:600;color:${awakeColor};">${awakePct2 != null ? awakePct2 + '%' : '‚Äî'}</td>
      <td style="text-align:center;padding:5px 4px;font-size:15px;">${sleepIcon}</td>
    </tr>`;
  });
  chartHtml += `</tbody></table>
  <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">ÁõÆÂÆâ: ÂêàË®à7h+‚óé / Ê∑±„ÅÑ10-20%ÔºàÊàêÈï∑„Éõ„É´„É¢„É≥Ôºâ / Ë¶öÈÜí5%‰ª•‰∏ã${hasAnyNap ? ' Ôºè ÂêàË®à„ÅØÂ§úÈñìÔºãÊòºÂØù„ÅÆÂêàÁÆó' : ''}</div>
  </div><div class="spacer"></div>`;
  container.innerHTML += chartHtml;
}

function buildSleepChart(data) {
  const W = 320, H = 140;
  const PAD = {t:20, r:36, b:26, l:40};
  const pw = W - PAD.l - PAD.r;
  const ph = H - PAD.t - PAD.b;
  const n  = data.length;
  const xS = i => PAD.l + (i / (n - 1)) * pw;

  const totalVals = data.map(d => d.total).filter(v => v != null);
  const minT = Math.max(0, Math.min(...totalVals) - 0.5);
  const maxT = Math.max(...totalVals) + 0.5;
  const yT = v => PAD.t + ph - ((v - minT) / (maxT - minT)) * ph;

  // 7hÁõÆÊ®ô„É©„Ç§„É≥
  const goalY = (7 >= minT && 7 <= maxT) ? yT(7) : null;

  const totalPts = data.filter(d => d.total != null).map(d => `${xS(data.indexOf(d)).toFixed(1)},${yT(d.total).toFixed(1)}`).join(' ');
  const totalDots = data.map((d,i) => d.total != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yT(d.total).toFixed(1)}" r="3" fill="white" stroke="#2E4057" stroke-width="2"/>`
    : '').join('');

  // Âè≥YËª∏: „Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„Çπ„Ç±„Éº„É´ (0-30%)
  const yR = v => PAD.t + ph - (v / 30) * ph;

  // Ê∑±„ÅÑ% „É©„Ç§„É≥
  const deepPcts = data.map(d => {
    const bed = d.nightOnly != null ? d.nightOnly + (d.awake || 0) : null;
    return (bed && d.deep != null) ? Math.round(d.deep / bed * 100) : null;
  });
  const hasDeep = deepPcts.filter(v => v != null).length >= 2;
  const deepPts = hasDeep ? data.map((d,i) => deepPcts[i] != null ? `${xS(i).toFixed(1)},${yR(deepPcts[i]).toFixed(1)}` : null).filter(v=>v).join(' ') : '';
  const deepDots = hasDeep ? data.map((d,i) => deepPcts[i] != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yR(deepPcts[i]).toFixed(1)}" r="2.5" fill="white" stroke="#7C3AED" stroke-width="1.5"/>`
    : '').join('') : '';

  // Ë¶öÈÜí% „É©„Ç§„É≥
  const awakePcts = data.map(d => {
    const bed = d.nightOnly != null ? d.nightOnly + (d.awake || 0) : null;
    return (bed && d.awake != null) ? Math.round(d.awake / bed * 100) : null;
  });
  const hasAwake = awakePcts.filter(v => v != null).length >= 2;
  const awakePts = hasAwake ? data.map((d,i) => awakePcts[i] != null ? `${xS(i).toFixed(1)},${yR(awakePcts[i]).toFixed(1)}` : null).filter(v=>v).join(' ') : '';
  const awakeDots = hasAwake ? data.map((d,i) => awakePcts[i] != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yR(awakePcts[i]).toFixed(1)}" r="2.5" fill="white" stroke="#F4A261" stroke-width="1.5"/>`
    : '').join('') : '';

  // Â∑¶YËª∏„É©„Éô„É´ÔºàÊôÇÈñìÔºâ
  const yLabels = [minT, (minT+maxT)/2, maxT].map(v =>
    `<line x1="${PAD.l}" y1="${yT(v).toFixed(1)}" x2="${W-PAD.r}" y2="${yT(v).toFixed(1)}" stroke="#E9ECEF" stroke-width="1"/>
     <text x="${PAD.l-5}" y="${(yT(v)+4).toFixed(1)}" text-anchor="end" font-size="9" fill="#555">${v.toFixed(1)}h</text>`
  ).join('');

  // Âè≥YËª∏„É©„Éô„É´Ôºà%Ôºâ
  const rAxisLabels = [0, 15, 30].map(v =>
    `<text x="${W-PAD.r+3}" y="${(yR(v)+3).toFixed(1)}" text-anchor="start" font-size="8" fill="#999">${v}%</text>`
  ).join('');

  const firstDs = data[0].ds.slice(5).replace('-','/');
  const lastDs  = data[n-1].ds.slice(5).replace('-','/');

  const legend = `
    <line x1="${PAD.l}" y1="10" x2="${PAD.l+16}" y2="10" stroke="#2E4057" stroke-width="2"/>
    <text x="${PAD.l+18}" y="14" font-size="9" fill="#555">ÂêàË®à</text>
    ${hasDeep ? `<line x1="${PAD.l+44}" y1="10" x2="${PAD.l+60}" y2="10" stroke="#7C3AED" stroke-width="1.5"/>
    <text x="${PAD.l+62}" y="14" font-size="9" fill="#555">Ê∑±„ÅÑ%</text>` : ''}
    ${hasAwake ? `<line x1="${PAD.l+100}" y1="10" x2="${PAD.l+116}" y2="10" stroke="#F4A261" stroke-width="1.5" stroke-dasharray="4,2"/>
    <text x="${PAD.l+118}" y="14" font-size="9" fill="#555">Ë¶öÈÜí%</text>` : ''}
    ${goalY != null ? `<line x1="${PAD.l+158}" y1="10" x2="${PAD.l+174}" y2="10" stroke="#28A745" stroke-width="1" stroke-dasharray="3,3"/>
    <text x="${PAD.l+176}" y="14" font-size="9" fill="#28A745">7hÁõÆÊ®ô</text>` : ''}`;

  return `<div class="chart-scroll">
    <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
      ${yLabels}
      ${rAxisLabels}
      ${goalY != null ? `<line x1="${PAD.l}" y1="${goalY.toFixed(1)}" x2="${W-PAD.r}" y2="${goalY.toFixed(1)}" stroke="#28A745" stroke-width="1" stroke-dasharray="3,3" opacity="0.6"/>` : ''}
      <polyline points="${totalPts}" fill="none" stroke="#2E4057" stroke-width="2.5"/>
      ${hasDeep  ? `<polyline points="${deepPts}"  fill="none" stroke="#7C3AED" stroke-width="1.5"/>` : ''}
      ${hasAwake ? `<polyline points="${awakePts}" fill="none" stroke="#F4A261" stroke-width="1.5" stroke-dasharray="4,2"/>` : ''}
      ${totalDots}${deepDots}${awakeDots}
      <text x="${PAD.l}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${firstDs}</text>
      <text x="${W-PAD.r}" y="${H-2}" text-anchor="middle" font-size="9" fill="#999">${lastDs}</text>
      ${legend}
    </svg>
  </div>`;
}

// ======== EXERCISE TAB ========
const STRETCH_ITEMS = [
  { id: 'st1', name: '„ÇÇ„ÇÇ„ÅÆ„Çπ„Éà„É¨„ÉÉ„ÉÅ',       note: 'Ê∑±ÂëºÂê∏3Âõû√óÂ∑¶Âè≥3Âõû' },
  { id: 'st2', name: '‰∏πÁî∞„ÇíÁãô„Å£„ÅüËÖπÁ≠ã',       note: '‰ΩìËÇ≤Â∫ß„Çä„ÄÅ10Áßí' },
  { id: 'st3', name: 'ÂÜÖËª¢Á≠ã„Çπ„ÇØ„ÉØ„ÉÉ„ÉàÔºàÂ£ÅÔºâ', note: 'ÈñãËÑö„ÄÅÊ∑±„ÇÅ„Å´' },
  { id: 'st4', name: 'ÂÜÖËÇ°„Çπ„ÇØ„ÉØ„ÉÉ„Éà',         note: '„Åã„Åã„Å®ÊµÆ„Åã„Åõ' }
];

function toggleStretch(id) {
  const log = getHealthLog();
  if (!log[currentDate]) log[currentDate] = {};
  const s = log[currentDate].stretch || {};
  s[id] = !s[id];
  log[currentDate].stretch = s;
  saveHealthLog(log);
  // DOMÊõ¥Êñ∞
  const cb = document.getElementById(`st-${id}`);
  if (cb) cb.checked = !!s[id];
  const done = STRETCH_ITEMS.filter(i => s[i.id]).length;
  const counter = document.getElementById('stretch-counter');
  if (counter) counter.textContent = `${done}/${STRETCH_ITEMS.length} ÂÆå‰∫Ü`;
  syncStretchToGitHub(currentDate);
}

function renderExercise(container) {
  const log = getHealthLog();
  const isToday = currentDate === todayStr();
  const entry = log[currentDate] || {};
  const wl = getWorkoutLog();
  const fc = getFitnessCheck();

  // Êó•‰ªò„Éä„Éì
  container.innerHTML = `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeDate(-1)">‚Äπ</button>
      <span class="date-nav-label">
        ${formatDateLabel(currentDate)}${isToday ? '<span class="today-badge">TODAY</span>' : ''}
      </span>
      <button class="date-nav-btn ${isToday ? 'disabled' : ''}" onclick="changeDate(1)">‚Ä∫</button>
    </div>`;

  // Êï£Ê≠© KPIÔºàÈÅéÂéª7Êó•Ôºâ
  {
    const walkDays = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(); d.setDate(d.getDate() - i);
      const ds = fmtDate(d);
      const e = log[ds];
      const hit = e ? isWalkDay(e) : null;
      walkDays.push({ date: ds, hit });
    }
    container.innerHTML += renderKpiCard(
      'üö∂ Êó©ÊúùÊï£Ê≠© KPIÔºàÈÅéÂéª7Êó•Ôºâ',
      'ÁõÆÊ®ô: ÈÄ±3Âõû Ôºè 45ÂàÜ„Éª3km‰ª•‰∏ä',
      walkDays,
      3
    );
  }

  // „Ç´„Éº„Éâ2: „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Ç∞„É™„ÉÉ„ÉâÔºà2„Çª„ÇØ„Ç∑„Éß„É≥Ôºâ
  const fmt1 = v => v != null ? String(v) : '---';
  const fmtN = (v, dec) => v != null ? Number(v).toFixed(dec) : '---';
  const steps = entry.steps;
  const stepsLabel = steps == null ? '---' : steps < 100 ? `${steps}<span style="font-size:9px;color:var(--warning);"> ÂêåÊúüÂæÖ„Å°</span>` : steps.toLocaleString();

  // VO2 Max „Ç´„É©„ÉºÔºàÁõÆÊ®ô35+, Poor=27‰ª•‰∏ãÔºâ
  const vo2Color = entry.vo2max == null ? 'var(--text-muted)' :
    entry.vo2max >= 35 ? 'var(--success)' :
    entry.vo2max >= 31 ? 'var(--warning)' : 'var(--danger)';
  // Walking HR „Ç´„É©„ÉºÔºà‰Ωé„ÅÑ„Åª„Å©ËâØ„ÅÑ: <90=green, 90-110=warning, >110=dangerÔºâ
  const whrColor = entry.walkHR == null ? 'var(--text-muted)' :
    entry.walkHR < 90 ? 'var(--success)' :
    entry.walkHR <= 110 ? 'var(--warning)' : 'var(--danger)';

  const gridCell = (val, label, color = 'var(--text)') => `
    <div style="text-align:center;background:var(--bg);border-radius:10px;padding:10px 6px;">
      <div style="font-size:20px;font-weight:700;color:${color};">${val}</div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:3px;">${label}</div>
    </div>`;

  container.innerHTML += `
    <div class="card">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">üö∂ „Ç¶„Ç©„Éº„Ç≠„É≥„Ç∞</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:14px;">
        ${gridCell(stepsLabel, 'Ê≠©Êï∞', steps && steps >= 8000 ? 'var(--success)' : steps && steps >= 6000 ? 'var(--warning)' : 'var(--text)')}
        ${gridCell(fmtN(entry.stride, 1), 'Ê≠©ÂπÖ cm', entry.stride && entry.stride >= 75 ? 'var(--success)' : entry.stride ? 'var(--warning)' : 'var(--text-muted)')}
        ${gridCell(fmtN(entry.walkSpeed, 1), 'ÈÄüÂ∫¶ km/h')}
        ${gridCell(fmtN(entry.walkDistance, 1), 'Ë∑ùÈõ¢ km')}
      </div>
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">‚ù§Ô∏è „Éê„Ç§„Çø„É´„Çµ„Ç§„É≥</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;">
        ${gridCell(fmt1(entry.rhr), 'ÂÆâÈùôÊôÇÂøÉÊãç', 'var(--green-mid)')}
        ${gridCell(fmt1(entry.hrv), 'HRV ms', '#5B8FB9')}
        ${gridCell(fmt1(entry.walkHR), 'Ê≠©Ë°åÂøÉÊãç', whrColor)}
        ${gridCell(entry.vo2max != null ? fmtN(entry.vo2max, 1) : '---', 'VO‚ÇÇMax', vo2Color)}
      </div>
    </div>`;

  // „Ç´„Éº„Éâ3: „Çπ„Éà„É¨„ÉÉ„ÉÅ
  const stretch = entry.stretch || {};
  const doneCnt = STRETCH_ITEMS.filter(i => stretch[i.id]).length;
  let stretchHtml = `
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div class="card-title" style="margin-bottom:0;">üßò „Çπ„Éà„É¨„ÉÉ„ÉÅ</div>
        <div id="stretch-counter" style="font-size:12px;color:var(--text-muted);">${doneCnt}/${STRETCH_ITEMS.length} ÂÆå‰∫Ü</div>
      </div>`;
  STRETCH_ITEMS.forEach(item => {
    const chk = !!stretch[item.id];
    stretchHtml += `
      <label style="display:flex;align-items:center;gap:12px;padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer;-webkit-tap-highlight-color:transparent;">
        <input type="checkbox" id="st-${item.id}" ${chk ? 'checked' : ''} onchange="toggleStretch('${item.id}')"
          style="width:20px;height:20px;flex-shrink:0;accent-color:var(--green-mid);">
        <div>
          <div style="font-size:14px;${chk ? 'text-decoration:line-through;color:var(--text-muted);' : ''}">${item.name}</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:1px;">${item.note}</div>
        </div>
      </label>`;
  });
  stretchHtml += `</div>`;
  container.innerHTML += stretchHtml;

  // „Ç´„Éº„Éâ4: „Éï„Ç£„ÉÉ„Éà„Éç„Çπ„ÉÅ„Çß„ÉÉ„ÇØÔºàÊúÄÊñ∞„Éá„Éº„ÇøË°®Á§∫Ôºâ
  const bm = fc.benchmarks || {};
  const checks = fc.checks || [];
  const latestCheck = checks.length > 0 ? checks[checks.length - 1] : null;
  const prevCheck = checks.length > 1 ? checks[checks.length - 2] : null;

  const trendArrow = (curr, prev) => {
    if (curr == null || prev == null) return '';
    return curr > prev ? '<span style="color:var(--success);">‚Üë</span>' :
           curr < prev ? '<span style="color:var(--danger);">‚Üì</span>' :
           '<span style="color:var(--text-muted);">‚Üí</span>';
  };

  const fitnessBar = (val, max, color) => {
    if (val == null) return '';
    const pct = Math.min(100, Math.round((val / max) * 100));
    return `<div style="height:5px;background:#E9ECEF;border-radius:3px;margin-top:4px;">
      <div style="height:5px;width:${pct}%;background:${color};border-radius:3px;"></div>
    </div>`;
  };

  const fitnessLabel = (val, good, excellent) => {
    if (val == null) return '';
    const color = val >= excellent ? 'var(--success)' : val >= good ? 'var(--warning)' : 'var(--danger)';
    const text = val >= excellent ? 'Excellent' : val >= good ? 'Good' : 'Below';
    return `<div style="font-size:9px;color:${color};margin-top:2px;">${text}</div>`;
  };

  let fcHtml = `<div class="card"><div class="card-title">üèãÔ∏è „Éï„Ç£„ÉÉ„Éà„Éç„Çπ„ÉÅ„Çß„ÉÉ„ÇØ`;
  if (latestCheck) {
    fcHtml += ` <span style="font-weight:400;color:var(--text-muted);">ÊúÄÁµÇ: ${latestCheck.date.slice(5).replace('-','/')}</span>`;
  }
  fcHtml += `</div>`;

  if (!latestCheck) {
    fcHtml += `<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">„Åæ„Å†Ê∏¨ÂÆö„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br><span style="font-size:11px;">„Éë„Éº„ÇΩ„Éä„É´„Éà„É¨„Éº„Éã„É≥„Ç∞„ÅßÊ∏¨ÂÆöÂæå„Å´Ë®òÈå≤„Åï„Çå„Åæ„Åô</span></div>`;
  } else {
    const gripAvg = bm.gripStrength ? (bm.gripStrength.avg || 45) : 45;
    const gripStrong = bm.gripStrength ? (bm.gripStrength.strong || 48.5) : 48.5;
    const slegGood = bm.singleLegStance ? (bm.singleLegStance.good || 37) : 37;
    const slegExc = bm.singleLegStance ? (bm.singleLegStance.excellent || 45) : 45;
    const s2sGood = bm.sitToStand30 ? (bm.sitToStand30.good || 15) : 15;
    const s2sExc = bm.sitToStand30 ? (bm.sitToStand30.excellent || 20) : 20;

    const gripRColor = latestCheck.gripR >= gripStrong ? 'var(--success)' : latestCheck.gripR >= gripAvg ? 'var(--warning)' : 'var(--danger)';
    const gripLColor = latestCheck.gripL >= gripStrong ? 'var(--success)' : latestCheck.gripL >= gripAvg ? 'var(--warning)' : 'var(--danger)';

    fcHtml += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:8px;">`;

    // Êè°ÂäõÂè≥
    fcHtml += `<div style="text-align:center;background:var(--bg);border-radius:10px;padding:8px 4px;">
      <div style="font-size:16px;font-weight:700;color:${gripRColor};">${latestCheck.gripR != null ? latestCheck.gripR : '‚Äî'}${trendArrow(latestCheck.gripR, prevCheck?.gripR)}</div>
      ${fitnessBar(latestCheck.gripR, 60, gripRColor)}
      ${fitnessLabel(latestCheck.gripR, gripAvg, gripStrong)}
      <div style="font-size:9px;color:var(--text-muted);margin-top:3px;">Êè°ÂäõÂè≥ kg</div>
    </div>`;

    // Êè°ÂäõÂ∑¶
    fcHtml += `<div style="text-align:center;background:var(--bg);border-radius:10px;padding:8px 4px;">
      <div style="font-size:16px;font-weight:700;color:${gripLColor};">${latestCheck.gripL != null ? latestCheck.gripL : '‚Äî'}${trendArrow(latestCheck.gripL, prevCheck?.gripL)}</div>
      ${fitnessBar(latestCheck.gripL, 60, gripLColor)}
      ${fitnessLabel(latestCheck.gripL, gripAvg, gripStrong)}
      <div style="font-size:9px;color:var(--text-muted);margin-top:3px;">Êè°ÂäõÂ∑¶ kg</div>
    </div>`;

    // ÁâáË∂≥Á´ã„Å°Âè≥
    const slRColor = latestCheck.singleLegR >= slegExc ? 'var(--success)' : latestCheck.singleLegR >= slegGood ? 'var(--warning)' : 'var(--danger)';
    fcHtml += `<div style="text-align:center;background:var(--bg);border-radius:10px;padding:8px 4px;">
      <div style="font-size:16px;font-weight:700;color:${slRColor};">${latestCheck.singleLegR != null ? latestCheck.singleLegR : '‚Äî'}${trendArrow(latestCheck.singleLegR, prevCheck?.singleLegR)}</div>
      ${fitnessBar(latestCheck.singleLegR, 60, slRColor)}
      ${fitnessLabel(latestCheck.singleLegR, slegGood, slegExc)}
      <div style="font-size:9px;color:var(--text-muted);margin-top:3px;">ÁâáË∂≥Âè≥ sec</div>
    </div>`;

    // ÁâáË∂≥Á´ã„Å°Â∑¶
    const slLColor = latestCheck.singleLegL >= slegExc ? 'var(--success)' : latestCheck.singleLegL >= slegGood ? 'var(--warning)' : 'var(--danger)';
    fcHtml += `<div style="text-align:center;background:var(--bg);border-radius:10px;padding:8px 4px;">
      <div style="font-size:16px;font-weight:700;color:${slLColor};">${latestCheck.singleLegL != null ? latestCheck.singleLegL : '‚Äî'}${trendArrow(latestCheck.singleLegL, prevCheck?.singleLegL)}</div>
      ${fitnessBar(latestCheck.singleLegL, 60, slLColor)}
      ${fitnessLabel(latestCheck.singleLegL, slegGood, slegExc)}
      <div style="font-size:9px;color:var(--text-muted);margin-top:3px;">ÁâáË∂≥Â∑¶ sec</div>
    </div>`;

    // Ê§ÖÂ≠êÁ´ã„Å°‰∏ä„Åå„Çä
    const s2sColor = latestCheck.sitToStand30 >= s2sExc ? 'var(--success)' : latestCheck.sitToStand30 >= s2sGood ? 'var(--warning)' : 'var(--danger)';
    fcHtml += `<div style="text-align:center;background:var(--bg);border-radius:10px;padding:8px 4px;">
      <div style="font-size:16px;font-weight:700;color:${s2sColor};">${latestCheck.sitToStand30 != null ? latestCheck.sitToStand30 : '‚Äî'}${trendArrow(latestCheck.sitToStand30, prevCheck?.sitToStand30)}</div>
      ${fitnessBar(latestCheck.sitToStand30, 30, s2sColor)}
      ${fitnessLabel(latestCheck.sitToStand30, s2sGood, s2sExc)}
      <div style="font-size:9px;color:var(--text-muted);margin-top:3px;">Ê§ÖÂ≠ê 30sec</div>
    </div>`;

    fcHtml += `</div>`;
    if (latestCheck.notes) {
      fcHtml += `<div style="margin-top:8px;font-size:12px;color:var(--text-muted);">${esc(latestCheck.notes)}</div>`;
    }
  }
  fcHtml += `<div style="font-size:9px;color:var(--text-muted);margin-top:8px;">„Éô„É≥„ÉÅ„Éû„Éº„ÇØ: Êè°Âäõ45kg avg / ÁâáË∂≥Á´ã„Å°37sec Good / Ê§ÖÂ≠êÁ´ã„Å°15Âõû GoodÔºà57Ê≠≥Áî∑ÊÄß„Éª„Éë„Éº„ÇΩ„Éä„É´„ÅßÊúà1Ê∏¨ÂÆöÔºâ</div>`;
  fcHtml += `</div>`;
  container.innerHTML += fcHtml;

  // „Ç´„Éº„Éâ5: Á≠ã„Éà„É¨„É≠„Ç∞ÔºàÂΩìÊó•„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
  const sessions = (wl.sessions || []).filter(s => s.date === currentDate);
  if (sessions.length > 0) {
    sessions.forEach(session => {
      const typeLabel = session.type === 'personal' ? '„Éë„Éº„ÇΩ„Éä„É´' : session.type === 'seitai' ? 'Êï¥‰Ωì' : 'Ëá™‰∏ª„Éà„É¨';
      const exRows = session.exercises.filter(e => e.reps !== '‚Äî').map(e =>
        `<tr><td style="padding:5px 4px;">${esc(e.name)}</td><td style="padding:5px 4px;text-align:center;">${esc(e.weight)}</td><td style="padding:5px 4px;text-align:center;">${esc(e.reps)}</td><td style="padding:5px 4px;text-align:center;color:var(--text-muted);font-size:11px;">${esc(e.bodyPart)}</td></tr>`
      ).join('');
      container.innerHTML += `
        <div class="card">
          <div class="card-title">üí™ Á≠ã„Éà„É¨„É≠„Ç∞ ‚Äî ${typeLabel}</div>
          ${exRows ? `<table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead><tr style="border-bottom:2px solid var(--border);">
              <th style="padding:4px;text-align:left;font-weight:600;font-size:11px;color:var(--text-muted);">Á®ÆÁõÆ</th>
              <th style="padding:4px;text-align:center;font-weight:600;font-size:11px;color:var(--text-muted);">ÈáçÈáè</th>
              <th style="padding:4px;text-align:center;font-weight:600;font-size:11px;color:var(--text-muted);">„É¨„ÉÉ„Éó</th>
              <th style="padding:4px;text-align:center;font-weight:600;font-size:11px;color:var(--text-muted);">ÈÉ®‰Ωç</th>
            </thead><tbody>${exRows}</tbody></table>` : ''}
          ${session.totalSets > 0 ? `<div style="margin-top:8px;text-align:right;font-size:12px;color:var(--text-muted);">ÂêàË®à: ${session.totalSets}„Çª„ÉÉ„Éà</div>` : ''}
          ${session.notes ? `<div style="margin-top:6px;font-size:12px;color:var(--text-muted);line-height:1.5;">${esc(session.notes)}</div>` : ''}
        </div>`;
    });
  }

  // „Ç´„Éº„Éâ5: 7Êó•Ê≠©Êï∞„Éà„É¨„É≥„Éâ
  const last7 = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    const e2 = log[ds] || {};
    last7.push({ ds, steps: e2.steps ?? null, stride: e2.stride ?? null, walkSpeed: e2.walkSpeed ?? null, walkDistance: e2.walkDistance ?? null });
  }

  const maxSteps = Math.max(...last7.map(r => r.steps ?? 0), 10000);
  let barsHtml = `<div style="display:flex;align-items:flex-end;gap:4px;height:80px;margin-bottom:6px;">`;
  last7.forEach(r => {
    const pct = r.steps != null ? Math.min(100, Math.round((r.steps / maxSteps) * 100)) : 0;
    const color = r.steps == null ? '#E9ECEF' : r.steps >= 8000 ? 'var(--success)' : r.steps >= 6000 ? 'var(--warning)' : '#B0BEC5';
    const isCurrentDate = r.ds === currentDate;
    barsHtml += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;">
      <div style="font-size:9px;color:var(--text-muted);">${r.steps != null ? (r.steps >= 1000 ? (r.steps/1000).toFixed(1)+'k' : r.steps) : ''}</div>
      <div style="width:100%;background:${color};height:${Math.max(pct, r.steps != null ? 4 : 0)}%;border-radius:4px 4px 0 0;${isCurrentDate ? 'outline:2px solid var(--green-mid);' : ''}"></div>
      <div style="font-size:9px;color:${isCurrentDate ? 'var(--green-mid)' : 'var(--text-muted)'};">${r.ds.slice(5).replace('-','/')}</div>
    </div>`;
  });
  barsHtml += `</div>`;

  let tableRows = last7.map(r => {
    const isCurrentDate2 = r.ds === currentDate;
    return `<tr style="${isCurrentDate2 ? 'background:var(--green-pale);' : ''}">
      <td style="padding:5px 4px;white-space:nowrap;">${r.ds.slice(5).replace('-','/')}${isCurrentDate2 ? '&nbsp;<span style="font-size:9px;color:var(--green-mid);">TODAY</span>' : ''}</td>
      <td style="text-align:right;padding:5px 4px;font-weight:600;color:${r.steps == null ? 'var(--text-muted)' : r.steps >= 8000 ? 'var(--success)' : r.steps >= 6000 ? 'var(--warning)' : 'var(--text)'};">${r.steps != null ? r.steps.toLocaleString() : '‚Äî'}</td>
      <td style="text-align:right;padding:5px 4px;color:${r.stride && r.stride >= 75 ? 'var(--success)' : 'var(--text)'};">${r.stride != null ? r.stride.toFixed(1) : '‚Äî'}</td>
      <td style="text-align:right;padding:5px 4px;">${r.walkSpeed != null ? r.walkSpeed.toFixed(1) : '‚Äî'}</td>
      <td style="text-align:right;padding:5px 4px;color:var(--text-muted);">${r.walkDistance != null ? r.walkDistance.toFixed(1) : '‚Äî'}</td>
    </tr>`;
  }).join('');

  container.innerHTML += `
    <div class="card">
      <div class="card-title">üö∂ Ê≠©Êï∞„Éà„É¨„É≥„ÉâÔºà7Êó•Ôºâ</div>
      ${barsHtml}
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead><tr style="border-bottom:2px solid var(--border);">
          <th style="padding:4px;text-align:left;font-size:10px;color:var(--text-muted);">Êó•‰ªò</th>
          <th style="padding:4px;text-align:right;font-size:10px;color:var(--text-muted);">Ê≠©Êï∞</th>
          <th style="padding:4px;text-align:right;font-size:10px;color:var(--text-muted);">Ê≠©ÂπÖcm</th>
          <th style="padding:4px;text-align:right;font-size:10px;color:var(--text-muted);">ÈÄüÂ∫¶km/h</th>
          <th style="padding:4px;text-align:right;font-size:10px;color:var(--text-muted);">Ë∑ùÈõ¢km</th>
        </tr></thead>
        <tbody>${tableRows}</tbody>
      </table>
      <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">ÁõÆÂÆâ: 8,000Ê≠©‰ª•‰∏ä‚óé / Ê≠©ÂπÖ75cmÁõÆÊ®ô</div>
    </div>`;

  // „Ç´„Éº„Éâ7: ÂøÉÊãç„Éá„Éº„ÇøÔºà7Êó•„ÄÅ5ÂàóÔºâ
  let heartRows = last7.map(r => {
    const isCurrentDate3 = r.ds === currentDate;
    const e3 = log[r.ds] || {};
    const whrTd = e3.walkHR != null ?
      `<td style="text-align:right;padding:5px 4px;color:${e3.walkHR < 90 ? 'var(--success)' : e3.walkHR <= 110 ? 'var(--warning)' : 'var(--danger)'};">${e3.walkHR}</td>` :
      `<td style="text-align:right;padding:5px 4px;color:var(--text-muted);">‚Äî</td>`;
    const vo2Td = e3.vo2max != null ?
      `<td style="text-align:right;padding:5px 4px;color:${e3.vo2max >= 35 ? 'var(--success)' : e3.vo2max >= 31 ? 'var(--warning)' : 'var(--danger)'};">${e3.vo2max.toFixed(1)}</td>` :
      `<td style="text-align:right;padding:5px 4px;color:var(--text-muted);">‚Äî</td>`;
    return `<tr style="${isCurrentDate3 ? 'background:var(--green-pale);' : ''}">
      <td style="padding:5px 4px;white-space:nowrap;">${r.ds.slice(5).replace('-','/')}${isCurrentDate3 ? '&nbsp;<span style="font-size:9px;color:var(--green-mid);">TODAY</span>' : ''}</td>
      <td style="text-align:right;padding:5px 4px;font-weight:600;color:var(--green-mid);">${e3.rhr != null ? e3.rhr : '‚Äî'}</td>
      <td style="text-align:right;padding:5px 4px;color:#5B8FB9;">${e3.hrv != null ? e3.hrv : '‚Äî'}</td>
      ${whrTd}${vo2Td}
    </tr>`;
  }).join('');

  container.innerHTML += `
    <div class="card">
      <div class="card-title">üíì ÂøÉÊãç„Éá„Éº„ÇøÔºà7Êó•Ôºâ</div>
      <table style="width:100%;border-collapse:collapse;font-size:11px;">
        <thead><tr style="border-bottom:2px solid var(--border);">
          <th style="padding:4px;text-align:left;font-size:10px;color:var(--text-muted);">Êó•‰ªò</th>
          <th style="padding:4px;text-align:right;font-size:10px;color:var(--text-muted);">RHR</th>
          <th style="padding:4px;text-align:right;font-size:10px;color:var(--text-muted);">HRV</th>
          <th style="padding:4px;text-align:right;font-size:10px;color:var(--text-muted);">Ê≠©Ë°åHR</th>
          <th style="padding:4px;text-align:right;font-size:10px;color:var(--text-muted);">VO‚ÇÇMax</th>
        </tr></thead>
        <tbody>${heartRows}</tbody>
      </table>
      <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">RHR/Ê≠©Ë°åHR: ‰Ωé„ÅÑ„Åª„Å©‚óé / HRV: È´ò„ÅÑ„Åª„Å©‚óé / VO‚ÇÇMax: 35+ÁõÆÊ®ôÔºàÁèæÂú®~27Ôºâ</div>
    </div>`;

  // „Ç´„Éº„Éâ8: Ê≠©ÂπÖ„ÅÆÊé®ÁßªÔºà14Êó•Êäò„ÇåÁ∑ö„Ç∞„É©„ÉïÔºâ
  const STRIDE_GOAL = 75; // 167.5cm √ó 0.45
  const last14 = [];
  for (let i = 13; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    last14.push({ ds, stride: (log[ds] || {}).stride ?? null });
  }
  const strideVals = last14.map(r => r.stride).filter(v => v != null);
  if (strideVals.length >= 2) {
    container.innerHTML += buildStrideChart(last14, STRIDE_GOAL);
  } else {
    container.innerHTML += `
      <div class="card">
        <div class="card-title">üìè Ê≠©ÂπÖ„ÅÆÊé®ÁßªÔºà14Êó•Ôºâ</div>
        <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">„Éá„Éº„ÇøÂèéÈõÜ‰∏≠Ôºà2Êó•‰ª•‰∏äÂøÖË¶ÅÔºâ</div>
      </div>`;
  }

  // „Ç´„Éº„Éâ9: VO2 MaxÊé®ÁßªÔºà14Êó•Êäò„ÇåÁ∑ö„Ç∞„É©„ÉïÔºâ
  const last14vo2 = [];
  for (let i = 13; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = fmtDate(d);
    last14vo2.push({ ds, vo2max: (log[ds] || {}).vo2max ?? null });
  }
  const vo2Vals = last14vo2.map(r => r.vo2max).filter(v => v != null);
  if (vo2Vals.length >= 1) {
    container.innerHTML += buildVO2Chart(last14vo2);
  } else {
    container.innerHTML += `
      <div class="card">
        <div class="card-title">ü´Å VO‚ÇÇ MaxÊé®ÁßªÔºà14Êó•Ôºâ</div>
        <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">„Éá„Éº„ÇøÂèéÈõÜ‰∏≠ÔºàÊúâÈÖ∏Á¥†ÈÅãÂãï„Çí„Åó„ÅüÊó•„Å´Ëá™ÂãïË®òÈå≤Ôºâ</div>
      </div>`;
  }

  container.innerHTML += `<div class="spacer"></div>`;
}

function buildStrideChart(data, goalCm) {
  const W = 320, H = 130;
  const PAD = { t: 20, r: 20, b: 26, l: 42 };
  const pw = W - PAD.l - PAD.r;
  const ph = H - PAD.t - PAD.b;
  const n = data.length;
  const validVals = data.map(r => r.stride).filter(v => v != null);
  const minV = Math.min(...validVals, goalCm) - 3;
  const maxV = Math.max(...validVals, goalCm) + 3;
  const xS = i => PAD.l + (i / (n - 1)) * pw;
  const yS = v => PAD.t + ph - ((v - minV) / (maxV - minV)) * ph;
  const goalY = yS(goalCm);

  // „Éù„É™„É©„Ç§„É≥ÔºàÈÄ£Á∂ö„Åó„Å¶„ÅÑ„ÇãÁÇπ„ÅÆ„ÅøÔºâ
  const pts = data.map((r, i) => r.stride != null ? `${xS(i).toFixed(1)},${yS(r.stride).toFixed(1)}` : null);
  let segments = [];
  let cur = [];
  pts.forEach((p, i) => {
    if (p) { cur.push(p); }
    else if (cur.length > 0) { segments.push(cur.join(' ')); cur = []; }
  });
  if (cur.length > 0) segments.push(cur.join(' '));

  const lines = segments.map(s => `<polyline points="${s}" fill="none" stroke="#2E7FC1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`).join('');
  const dots = data.map((r, i) => r.stride != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yS(r.stride).toFixed(1)}" r="3" fill="white" stroke="#2E7FC1" stroke-width="2"/>`
    : '').join('');

  const yLabels = [minV, goalCm, maxV].map(v =>
    `<line x1="${PAD.l}" y1="${yS(v).toFixed(1)}" x2="${W - PAD.r}" y2="${yS(v).toFixed(1)}" stroke="#E9ECEF" stroke-width="1"/>
     <text x="${PAD.l - 5}" y="${(yS(v) + 4).toFixed(1)}" text-anchor="end" font-size="9" fill="#555">${Math.round(v)}</text>`
  ).join('');

  const firstDs = data[0].ds.slice(5).replace('-', '/');
  const lastDs = data[n - 1].ds.slice(5).replace('-', '/');

  return `<div class="card">
    <div class="card-title">üìè Ê≠©ÂπÖ„ÅÆÊé®ÁßªÔºà14Êó•Ôºâ ‚Äî ÁõÆÊ®ô ${goalCm}cmÔºàËÇ°Èñ¢ÁØÄÊîπÂñÑ„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞Ôºâ</div>
    <div class="chart-scroll">
      <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
        ${yLabels}
        <line x1="${PAD.l}" y1="${goalY.toFixed(1)}" x2="${W - PAD.r}" y2="${goalY.toFixed(1)}" stroke="#28A745" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.8"/>
        <text x="${W - PAD.r + 3}" y="${(goalY + 4).toFixed(1)}" font-size="9" fill="#28A745">ÁõÆÊ®ô</text>
        ${lines}${dots}
        <text x="${PAD.l}" y="${H - 2}" text-anchor="middle" font-size="9" fill="#999">${firstDs}</text>
        <text x="${W - PAD.r}" y="${H - 2}" text-anchor="middle" font-size="9" fill="#999">${lastDs}</text>
      </svg>
    </div>
    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">ÁõÆÊ®ô75cm = Ë∫´Èï∑167.5cm √ó 0.45 / Ê≠©ÂπÖ„ÅåÂ∫É„Åå„Çã„Åª„Å©ËÇ°Èñ¢ÁØÄ„ÅåÊîπÂñÑ„Åï„Çå„Å¶„ÅÑ„ÇãË®ºÊã†</div>
  </div>`;
}

function buildVO2Chart(data) {
  const W = 320, H = 130;
  const PAD = { t: 20, r: 28, b: 26, l: 42 };
  const pw = W - PAD.l - PAD.r;
  const ph = H - PAD.t - PAD.b;
  const n = data.length;
  const VO2_GOAL = 35;   // ÁõÆÊ®ô
  const VO2_POOR = 27;   // ÁèæÂú®ÂÄ§‰ªòËøë„ÅÆÁõÆÂÆâ„É©„Ç§„É≥
  const validVals = data.map(r => r.vo2max).filter(v => v != null);
  const minV = Math.min(...validVals, VO2_POOR) - 1;
  const maxV = Math.max(...validVals, VO2_GOAL) + 1;
  const xS = i => PAD.l + (i / (n - 1)) * pw;
  const yS = v => PAD.t + ph - ((v - minV) / (maxV - minV)) * ph;
  const goalY = yS(VO2_GOAL);
  const poorY = yS(VO2_POOR);

  // „Éù„É™„É©„Ç§„É≥ÔºàÈÄ£Á∂ö„Åó„Å¶„ÅÑ„ÇãÁÇπ„ÅÆ„Åø„ÄÅnull„ÅØ„ÇÆ„É£„ÉÉ„ÉóÔºâ
  const pts = data.map((r, i) => r.vo2max != null ? `${xS(i).toFixed(1)},${yS(r.vo2max).toFixed(1)}` : null);
  let segments = [], cur = [];
  pts.forEach(p => {
    if (p) { cur.push(p); }
    else if (cur.length > 0) { segments.push(cur.join(' ')); cur = []; }
  });
  if (cur.length > 0) segments.push(cur.join(' '));

  const lines = segments.map(s => `<polyline points="${s}" fill="none" stroke="#E0703C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`).join('');
  const dots = data.map((r, i) => r.vo2max != null
    ? `<circle cx="${xS(i).toFixed(1)}" cy="${yS(r.vo2max).toFixed(1)}" r="3" fill="white" stroke="#E0703C" stroke-width="2"/>
       <text x="${xS(i).toFixed(1)}" y="${(yS(r.vo2max) - 6).toFixed(1)}" text-anchor="middle" font-size="8" fill="#E0703C">${r.vo2max.toFixed(1)}</text>`
    : '').join('');

  const yLabels = [minV, VO2_POOR, VO2_GOAL, maxV].map(v =>
    `<line x1="${PAD.l}" y1="${yS(v).toFixed(1)}" x2="${W - PAD.r}" y2="${yS(v).toFixed(1)}" stroke="#E9ECEF" stroke-width="1"/>
     <text x="${PAD.l - 5}" y="${(yS(v) + 4).toFixed(1)}" text-anchor="end" font-size="9" fill="#555">${v}</text>`
  ).join('');

  const firstDs = data[0].ds.slice(5).replace('-', '/');
  const lastDs = data[n - 1].ds.slice(5).replace('-', '/');

  return `<div class="card">
    <div class="card-title">ü´Å VO‚ÇÇ MaxÊé®ÁßªÔºà14Êó•Ôºâ ‚Äî ÁõÆÊ®ô 35 ml/kg/minÔºàMayo Clinic: Ê≠ª‰∫°Áéá‰∫àÊ∏¨ #1ÊåáÊ®ôÔºâ</div>
    <div class="chart-scroll">
      <svg viewBox="0 0 ${W} ${H}" width="100%" style="overflow:visible;">
        ${yLabels}
        <line x1="${PAD.l}" y1="${goalY.toFixed(1)}" x2="${W - PAD.r}" y2="${goalY.toFixed(1)}" stroke="#28A745" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.8"/>
        <text x="${W - PAD.r + 3}" y="${(goalY + 4).toFixed(1)}" font-size="9" fill="#28A745">ÁõÆÊ®ô</text>
        <line x1="${PAD.l}" y1="${poorY.toFixed(1)}" x2="${W - PAD.r}" y2="${poorY.toFixed(1)}" stroke="#DC3545" stroke-width="1" stroke-dasharray="3,3" opacity="0.6"/>
        <text x="${W - PAD.r + 3}" y="${(poorY + 4).toFixed(1)}" font-size="9" fill="#DC3545">Poor</text>
        ${lines}${dots}
        <text x="${PAD.l}" y="${H - 2}" text-anchor="middle" font-size="9" fill="#999">${firstDs}</text>
        <text x="${W - PAD.r}" y="${H - 2}" text-anchor="middle" font-size="9" fill="#999">${lastDs}</text>
      </svg>
    </div>
    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">ÊúâÈÖ∏Á¥†ÈÅãÂãï„Çí„Åó„ÅüÊó•„ÅÆ„ÅøËá™ÂãïË®òÈå≤ / ÁèæÂú®~27ÔºàPoorÔºâ‚Üí 35+ÔºàGoodÔºâ„ÇíÁõÆÊåá„Åô</div>
  </div>`;
}

// ======== SHOPPING TAB ========
function renderShopping(container) {
  const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
  const checks = JSON.parse(localStorage.getItem('shopping_checks') || '{}');
  const checkedCount = items.filter(i => checks[i.id]).length;

  // ‰ªäÊó•„ÅÆÊ†ÑÈ§äÊÆã„ÇäË®àÁÆó
  const todayMeals = getMeals(todayStr());
  const t = totals(todayMeals);
  const kcalLeft = Math.max(0, Math.round(TARGETS.kcalMax - t.kcal));
  const pLeft    = Math.max(0, Math.round(TARGETS.pMin - t.p));
  const fLeft    = Math.max(0, Math.round(TARGETS.fMax - t.f));
  const cLeft    = Math.max(0, Math.round(TARGETS.cMax - t.c));
  const kcalOver = t.kcal > TARGETS.kcalMax;

  container.innerHTML = `
    <div class="card" style="margin-bottom:10px;">
      <div style="font-weight:700;font-size:14px;margin-bottom:8px;">üõí Ë≤∑„ÅÑÁâ©„É´„Éº„É´</div>
      <div style="font-size:13px;color:var(--text-muted);line-height:1.8;">
        ‚úì „É™„Çπ„Éà„Å´„ÅÇ„Çã„ÇÇ„ÅÆ„Å†„ÅëË≤∑„ÅÜ<br>
        ‚úì „ÅäËÖπ„ÅåÁ©∫„ÅÑ„ÅüÁä∂ÊÖã„ÅßË°å„Åã„Å™„ÅÑ
      </div>
      <div style="margin-top:10px;padding:8px 10px;background:var(--bg);border-radius:8px;font-size:12px;">
        <div style="font-weight:600;color:var(--text-muted);margin-bottom:4px;">‰ªäÊó•„ÅÆÊ†ÑÈ§äÊÆã„Çä</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <span>${kcalOver ? `<span style="color:var(--danger)">kcal Ë∂ÖÈÅé ${Math.round(t.kcal - TARGETS.kcalMax)}</span>` : `„Ç´„É≠„É™„Éº „ÅÇ„Å® <strong>${kcalLeft}</strong> kcal`}</span>
          <span>P „ÅÇ„Å® <strong>${pLeft}</strong>g</span>
          <span>ËÑÇË≥™ „ÅÇ„Å® <strong>${fLeft}</strong>g</span>
          <span>ÁÇ≠Ê∞¥ÂåñÁâ© „ÅÇ„Å® <strong>${cLeft}</strong>g</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:10px;">Ë≤∑„ÅÑÁâ©„É™„Çπ„Éà</div>
      ${items.length === 0
        ? `<div style="color:var(--text-muted);font-size:13px;text-align:center;padding:20px 0;">„É™„Çπ„Éà„ÅØÁ©∫„Åß„Åô</div>`
        : (() => {
            const renderItems = (list) => list.map(item => {
              const checked = !!checks[item.id];
              return `
                <label style="display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;-webkit-tap-highlight-color:transparent;">
                  <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleShoppingItem('${item.id}', this.checked, this)"
                    style="width:20px;height:20px;flex-shrink:0;accent-color:var(--green-mid);margin-top:1px;">
                  <div>
                    <div style="font-size:14px;${checked ? 'text-decoration:line-through;color:var(--text-muted);' : ''}">${item.name}</div>
                    ${item.note ? `<div style="font-size:11px;color:var(--text-muted);margin-top:2px;">${item.note}</div>` : ''}
                  </div>
                </label>`;
            }).join('');
            const foodItems  = items.filter(i => i.category === 'food');
            const otherItems = items.filter(i => i.category !== 'food');
            let html = '';
            if (foodItems.length > 0) {
              html += `<div style="font-size:11px;font-weight:700;color:var(--text-muted);letter-spacing:.05em;text-transform:uppercase;padding:4px 0 2px;">ü•¶ È£üÂìÅ</div>${renderItems(foodItems)}`;
            }
            if (otherItems.length > 0) {
              html += `<div style="font-size:11px;font-weight:700;color:var(--text-muted);letter-spacing:.05em;text-transform:uppercase;padding:${foodItems.length > 0 ? '12px' : '4px'} 0 2px;">üì¶ „Åù„ÅÆ‰ªñ</div>${renderItems(otherItems)}`;
            }
            return html;
          })()
      }
      ${items.length > 0 ? `
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button onclick="clearShoppingChecks()" style="flex:1;font-size:12px;background:none;border:1px solid var(--border);border-radius:8px;padding:6px 12px;color:var(--text-muted);cursor:pointer;">„ÉÅ„Çß„ÉÉ„ÇØ„Çí„É™„Çª„ÉÉ„Éà</button>
          <button onclick="deleteCheckedShoppingItems()" ${checkedCount === 0 ? 'disabled' : ''} style="flex:1;font-size:12px;background:none;border:1px solid ${checkedCount === 0 ? 'var(--border)' : 'var(--danger)'};border-radius:8px;padding:6px 12px;color:${checkedCount === 0 ? 'var(--text-muted)' : 'var(--danger)'};cursor:${checkedCount === 0 ? 'default' : 'pointer'};opacity:${checkedCount === 0 ? '0.4' : '1'};">„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø„ÇíÂâäÈô§</button>
        </div>
      ` : ''}
    </div>
  `;
}

function toggleShoppingItem(id, checked, el) {
  const checks = JSON.parse(localStorage.getItem('shopping_checks') || '{}');
  if (checked) checks[id] = true;
  else delete checks[id];
  localStorage.setItem('shopping_checks', JSON.stringify(checks));
  // Áõ¥Êé•DOMÊìç‰Ωú„Åß„Çπ„Éà„É©„Ç§„ÇØ„Çπ„É´„Éº„ÇíÂàá„ÇäÊõø„ÅàÔºàrenderShopping()„ÅÆDOMÁΩÆÊèõ„ÇíÈÅø„Åë„ÇãÔºâ
  const nameEl = el && el.nextElementSibling && el.nextElementSibling.firstElementChild;
  if (nameEl) {
    nameEl.style.textDecoration = checked ? 'line-through' : 'none';
    nameEl.style.color = checked ? 'var(--text-muted)' : '';
  }
  // ÂâäÈô§„Éú„Çø„É≥„ÅÆÊ¥ªÊÄßÁä∂ÊÖã„ÇíÊõ¥Êñ∞
  const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
  const checkedCount = items.filter(i => checks[i.id]).length;
  const delBtn = document.querySelector('[onclick="deleteCheckedShoppingItems()"]');
  if (delBtn) {
    delBtn.disabled = checkedCount === 0;
    delBtn.style.borderColor = checkedCount === 0 ? 'var(--border)' : 'var(--danger)';
    delBtn.style.color = checkedCount === 0 ? 'var(--text-muted)' : 'var(--danger)';
    delBtn.style.cursor = checkedCount === 0 ? 'default' : 'pointer';
    delBtn.style.opacity = checkedCount === 0 ? '0.4' : '1';
  }
  syncShoppingToGitHub();
}

function clearShoppingChecks() {
  localStorage.removeItem('shopping_checks');
  renderShopping(document.getElementById('main-content'));
  syncShoppingToGitHub();
}

function deleteCheckedShoppingItems() {
  const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
  const checks = JSON.parse(localStorage.getItem('shopping_checks') || '{}');
  const checkedCount = items.filter(i => checks[i.id]).length;
  if (checkedCount === 0) return;
  if (!confirm(`„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø„ÅÆ${checkedCount}‰ª∂„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
  const remaining = items.filter(i => !checks[i.id]);
  localStorage.setItem('shopping_items', JSON.stringify(remaining));
  localStorage.removeItem('shopping_checks');
  renderShopping(document.getElementById('main-content'));
  syncShoppingToGitHub();
}

// ======== UTIL ========
function showToast(msg) {
  const ex = document.querySelector('.toast');
  if (ex) ex.remove();
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 0.2s'; setTimeout(() => el.remove(), 200); }, 2500);
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ======== START ========
init();
setSyncStatus(ghSyncEnabled() ? 'ok' : 'none');
if (navigator.onLine) flushPendingSyncs();
window.addEventListener('online', () => flushPendingSyncs());

</script>
</body>
</html>
