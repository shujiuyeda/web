<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1B4332">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="è³¼è²·è¨˜éŒ²">
  <title>ğŸ›’ è³¼è²·è¨˜éŒ²</title>
  <link rel="manifest" href="kaimono-manifest.json">
  <link rel="apple-touch-icon" href="kaimono-icon.svg">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green-dark: #1B4332;
      --green-mid: #2D6A4F;
      --green-light: #52B788;
      --green-pale: #D8F3DC;
      --bg: #F0F4F0;
      --card: #FFFFFF;
      --text: #1A1A2E;
      --text-muted: #6C757D;
      --border: #DEE2E6;
      --danger: #DC3545;
      --success: #28A745;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    .main { overflow-x: hidden; }
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--green-dark);
      color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      padding-top: var(--safe-top);
      height: calc(52px + var(--safe-top));
      z-index: 100;
    }
    .header h1 { font-size: 16px; font-weight: 700; }
    .header-sub { font-size: 12px; opacity: 0.75; }
    .header-reload {
      background: none; border: none; color: white; opacity: 0.75;
      font-size: 22px; padding: 6px 8px; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s;
      display: inline-block; line-height: 1;
    }
    .header-reload:active { opacity: 0.4; }
    .header-reload.spinning { animation: hdr-spin 0.7s linear infinite; }
    @keyframes hdr-spin { to { transform: rotate(360deg); } }
    .main {
      padding-top: calc(52px + var(--safe-top));
      padding-bottom: calc(24px + var(--safe-bottom));
    }
    .card {
      background: var(--card); border-radius: 14px;
      padding: 14px 16px; margin: 8px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 11px; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.6px; margin-bottom: 12px;
    }
    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block; font-size: 12px; font-weight: 600;
      color: var(--text-muted); margin-bottom: 5px;
    }
    .form-input, .form-textarea, .form-select {
      width: 100%; padding: 10px 12px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 15px; color: var(--text);
      background: var(--bg);
      font-family: inherit;
      -webkit-appearance: none;
      outline: none;
      transition: border-color 0.15s;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      border-color: var(--green-light);
      background: #fff;
    }
    .form-textarea {
      min-height: 100px; resize: vertical;
      line-height: 1.6;
    }
    .form-row { display: flex; gap: 10px; }
    .form-row .form-group { flex: 1; }
    .btn-primary {
      width: 100%; padding: 14px;
      background: var(--green-mid); color: white;
      border: none; border-radius: 12px;
      font-size: 16px; font-weight: 700;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      transition: opacity 0.15s, transform 0.1s;
    }
    .btn-primary:active { opacity: 0.75; transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.5; cursor: default; transform: none; }
    .spinner {
      display: inline-block; width: 15px; height: 15px;
      border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
      border-radius: 50%; animation: spin 0.7s linear infinite;
      vertical-align: middle; margin-right: 5px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .history-header {
      display: flex; align-items: baseline; justify-content: space-between;
      margin-bottom: 4px;
    }
    .history-date { font-size: 12px; color: var(--text-muted); }
    .history-store { font-size: 15px; font-weight: 700; color: var(--text); }
    .history-total {
      font-size: 15px; font-weight: 700;
      color: var(--green-dark);
    }
    .history-items {
      font-size: 13px; color: var(--text-muted);
      line-height: 1.5; white-space: pre-wrap;
      word-break: break-all;
    }
    .empty-state {
      text-align: center; padding: 32px 16px;
      color: var(--text-muted); font-size: 14px;
    }
    .empty-icon { font-size: 40px; margin-bottom: 8px; }
    .toast {
      position: fixed; bottom: calc(20px + var(--safe-bottom));
      left: 50%; transform: translateX(-50%);
      background: rgba(20,20,20,0.88); color: white;
      padding: 10px 20px; border-radius: 20px;
      font-size: 14px; white-space: nowrap;
      opacity: 0; transition: opacity 0.3s;
      pointer-events: none; z-index: 999;
    }
    .toast.show { opacity: 1; }
    .stats-row {
      display: flex; gap: 8px; margin-bottom: 14px;
    }
    .stat-box {
      flex: 1; background: var(--bg); border-radius: 10px;
      padding: 10px 8px; text-align: center;
    }
    .stat-value { font-size: 18px; font-weight: 700; color: var(--green-dark); }
    .stat-label { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    .section-badge {
      display: inline-block; padding: 2px 8px;
      background: var(--green-pale); color: var(--green-dark);
      border-radius: 8px; font-size: 11px; font-weight: 600;
      margin-left: 6px;
    }
    .history-item {
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: background 0.1s;
      border-radius: 8px;
      margin: 0 -8px;
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
    }
    .history-item:last-child { border-bottom: none; }
    .history-item:active { background: var(--bg); }

    /* ===== ANALYSIS SECTION ===== */
    .cat-row { margin-bottom: 10px; }
    .cat-row-header {
      display: flex; justify-content: space-between; align-items: baseline;
      font-size: 13px; margin-bottom: 5px;
    }
    .cat-name { font-weight: 600; color: var(--text); }
    .cat-meta { font-size: 12px; color: var(--text-muted); }
    .cat-track { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
    .cat-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
    .cat-cafe       { background: #7B5E3A; }
    .cat-convenience{ background: #2D6A4F; }
    .cat-super      { background: #52B788; }
    .cat-restaurant { background: #D4763B; }
    .cat-other      { background: #9CA3AF; }
    .analysis-subtitle {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.6px;
      margin: 14px 0 10px;
    }
    .analysis-subtitle:first-child { margin-top: 0; }
    .pattern-card {
      background: var(--bg); border-radius: 10px;
      padding: 12px 14px; margin-bottom: 8px;
    }
    .pattern-card:last-child { margin-bottom: 0; }
    .pattern-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .pattern-emoji { font-size: 18px; line-height: 1; }
    .pattern-title { font-size: 14px; font-weight: 700; color: var(--text); }
    .pattern-detail { font-size: 13px; color: var(--text-muted); line-height: 1.55; }
    .pattern-tip {
      font-size: 12px; color: var(--green-dark); font-weight: 600;
      margin-top: 7px; padding-top: 7px;
      border-top: 1px solid var(--border);
    }
    .pattern-accumulating {
      font-size: 12px; color: var(--text-muted); font-style: italic;
    }
    .ai-advice-card {
      background: #1B4332; color: white;
      border-radius: 12px; padding: 14px 16px; margin-top: 12px;
    }
    .ai-advice-generated {
      font-size: 10px; opacity: 0.5; margin-bottom: 8px;
    }
    .ai-advice-headline {
      font-size: 15px; font-weight: 700; line-height: 1.45;
      margin-bottom: 12px;
    }
    .ai-advice-tips { list-style: none; padding: 0; margin: 0; }
    .ai-advice-tips li {
      font-size: 13px; line-height: 1.6;
      padding: 4px 0; opacity: 0.9;
      display: flex; gap: 8px;
    }
    .ai-advice-tips li::before { content: "â†’"; opacity: 0.55; flex-shrink: 0; }

    /* ===== DETAIL MODAL ===== */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 200;
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal-sheet {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--card);
      border-radius: 20px 20px 0 0;
      padding: 0 0 calc(24px + var(--safe-bottom));
      z-index: 201;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      max-height: 85vh;
      overflow-y: auto;
    }
    .modal-sheet.open { transform: translateY(0); }
    .modal-handle {
      width: 36px; height: 4px; border-radius: 2px;
      background: var(--border); margin: 12px auto 16px;
    }
    .modal-header {
      padding: 0 20px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }
    .modal-store {
      font-size: 19px; font-weight: 700; color: var(--text);
      margin-bottom: 4px;
    }
    .modal-meta {
      font-size: 13px; color: var(--text-muted);
    }
    .modal-total {
      font-size: 26px; font-weight: 700; color: var(--green-dark);
      padding: 14px 20px 4px;
    }
    .modal-section-title {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.6px;
      padding: 12px 20px 6px;
    }
    .modal-items-list {
      padding: 0 20px;
    }
    .modal-item-row {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 15px; color: var(--text);
      display: flex; align-items: center; gap: 8px;
    }
    .modal-item-row:last-child { border-bottom: none; }
    .modal-item-bullet {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--green-light); flex-shrink: 0;
    }
    .modal-payment {
      padding: 8px 20px;
      font-size: 13px; color: var(--text-muted);
      display: flex; align-items: center; gap: 6px;
    }
    .modal-note {
      margin: 4px 20px 0;
      background: var(--bg); border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px; color: var(--text-muted);
    }
  </style>
</head>
<body>

<div class="header">
  <h1>ğŸ›’ è³¼è²·è¨˜éŒ²</h1>
  <div style="display:flex; align-items:center; gap:4px;">
    <span class="header-sub" id="today-label"></span>
    <button class="header-reload" id="reload-btn" onclick="reloadData()" title="ãƒªãƒ­ãƒ¼ãƒ‰">â†»</button>
  </div>
</div>

<div class="main">

  <!-- ===== INPUT FORM ===== -->
  <div class="card">
    <div class="card-title">æ–°ã—ã„è³¼è²·è¨˜éŒ²</div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="input-date">æ—¥ä»˜</label>
        <input type="date" id="input-date" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label" for="input-total">åˆè¨ˆé‡‘é¡ï¼ˆå††ï¼‰</label>
        <input type="number" id="input-total" class="form-input" placeholder="ä¾‹: 2500" min="0" inputmode="numeric">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="input-store">åº—èˆ—å</label>
      <input type="text" id="input-store" class="form-input" placeholder="ä¾‹: ãƒ©ã‚¤ãƒ•ã€æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼" list="store-list">
      <datalist id="store-list">
        <option value="ãƒ©ã‚¤ãƒ•">
        <option value="ãƒãƒ«ã‚¨ãƒ„">
        <option value="ã‚ªãƒ¼ã‚±ãƒ¼">
        <option value="æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼">
        <option value="æˆåŸçŸ³äº•">
        <option value="ã‚³ãƒ³ãƒ“ãƒ‹ï¼ˆã‚»ãƒ–ãƒ³ï¼‰">
        <option value="ã‚³ãƒ³ãƒ“ãƒ‹ï¼ˆãƒ­ãƒ¼ã‚½ãƒ³ï¼‰">
        <option value="ã‚³ãƒ³ãƒ“ãƒ‹ï¼ˆãƒ•ã‚¡ãƒŸãƒï¼‰">
        <option value="ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢">
        <option value="Amazon">
        <option value="iHerb">
      </datalist>
    </div>

    <div class="form-group">
      <label class="form-label" for="input-items">è³¼å…¥å“ç›®ï¼ˆ1è¡Œ1å“ï¼‰</label>
      <textarea id="input-items" class="form-textarea" placeholder="ç‰›ã™ã˜:398&#10;ã«ã‚“ã˜ã‚“:88&#10;ãƒŠã‚¹:128&#10;â€»é‡‘é¡ãªã—ã§ã‚‚OK"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label" for="input-note">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="input-note" class="form-input" placeholder="ã‚»ãƒ¼ãƒ«å“ãªã©">
    </div>

    <button class="btn-primary" id="save-btn" onclick="savePurchase()">
      ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜
    </button>
  </div>

  <!-- ===== STATS ===== -->
  <div class="card" id="stats-card" style="display:none;">
    <div class="card-title">ğŸ“Š é›†è¨ˆï¼ˆä»Šæœˆï¼‰</div>
    <div class="stats-row" id="stats-row"></div>
  </div>

  <!-- ===== ANALYSIS ===== -->
  <div class="card" id="analysis-card" style="display:none;">
    <div class="card-title">ğŸ” è³¼è²·ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ</div>
    <div class="analysis-subtitle" style="margin-top:0;">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º</div>
    <div id="category-bars"></div>
    <div class="analysis-subtitle">æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³</div>
    <div id="pattern-cards"></div>
    <div id="ai-advice-wrap"></div>
  </div>

  <!-- ===== HISTORY ===== -->
  <div class="card">
    <div class="card-title">
      ğŸ“‹ è³¼è²·å±¥æ­´
      <span class="section-badge" id="history-count">0ä»¶</span>
    </div>
    <div id="history-list">
      <div class="empty-state">
        <div class="empty-icon">ğŸ›’</div>
        <div>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- ===== DETAIL MODAL ===== -->
<div class="modal-overlay" id="modal-overlay" onclick="closeDetail()"></div>
<div class="modal-sheet" id="modal-sheet">
  <div class="modal-handle"></div>
  <div class="modal-header">
    <div class="modal-store" id="modal-store"></div>
    <div class="modal-meta" id="modal-meta"></div>
  </div>
  <div class="modal-total" id="modal-total"></div>
  <div class="modal-section-title">è³¼å…¥å“ç›®</div>
  <div class="modal-items-list" id="modal-items-list"></div>
  <div class="modal-payment" id="modal-payment"></div>
  <div id="modal-note-wrap"></div>
</div>

<script>
// ===== CONSTANTS =====
const DATA_BASE_URL = 'https://shujiuyeda.github.io/web/data/';
const GH_REPO = 'shujiuyeda/web';
const GH_API  = 'https://api.github.com';

// ===== UTILS =====
function ls(key, val) {
  if (val === undefined) {
    try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
  }
  localStorage.setItem(key, JSON.stringify(val));
}
function ghToken() { return ls('gh_pat') || ''; }
function todayStr() {
  const d = new Date();
  return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
}
function formatDate(ds) {
  // YYYY-MM-DD â†’ MæœˆDæ—¥(æ›œæ—¥)
  const d = new Date(ds + 'T00:00:00');
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${days[d.getDay()]}ï¼‰`;
}
function showToast(msg, ms=2800) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
}
function yen(n) {
  if (!n && n !== 0) return 'â€”';
  return `Â¥${Number(n).toLocaleString()}`;
}

// ===== GITHUB API =====
async function ghGetFileSha(path) {
  try {
    const res = await fetch(`${GH_API}/repos/${GH_REPO}/contents/${path}?_=${Date.now()}`, {
      headers: { 'Authorization': `Bearer ${ghToken()}`, 'Accept': 'application/vnd.github+json' }
    });
    if (!res.ok) return null;
    return (await res.json()).sha || null;
  } catch { return null; }
}
async function ghPutFile(path, content, message) {
  const sha = await ghGetFileSha(path);
  const body = { message, content: btoa(unescape(encodeURIComponent(content))) };
  if (sha) body.sha = sha;
  try {
    const res = await fetch(`${GH_API}/repos/${GH_REPO}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${ghToken()}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    return res.ok;
  } catch { return false; }
}

// ===== DATA =====
let purchasesData = { purchases: [] };

async function loadPurchases() {
  // Try localStorage cache first
  const cached = ls('purchases_cache');
  if (cached) {
    purchasesData = cached;
    renderHistory();
    renderStats();
    renderAnalysis();
  }
  // Fetch from GitHub Pages (advice and purchases in parallel)
  await loadAdvice();
  try {
    const res = await fetch(`${DATA_BASE_URL}purchases.json?_=${Date.now()}`, { cache: 'no-store' });
    if (res.ok) {
      purchasesData = await res.json();
      ls('purchases_cache', purchasesData);
      renderHistory();
      renderStats();
      renderAnalysis();
    }
  } catch { /* use cached */ }
}

async function savePurchase() {
  const date  = document.getElementById('input-date').value;
  const store = document.getElementById('input-store').value.trim();
  const items = document.getElementById('input-items').value.trim();
  const total = document.getElementById('input-total').value;
  const note  = document.getElementById('input-note').value.trim();

  if (!date)  { showToast('âš ï¸ æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!store) { showToast('âš ï¸ åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!items) { showToast('âš ï¸ è³¼å…¥å“ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!ghToken()) { showToast('âš ï¸ GitHubãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®šï¼ˆHealth Hubã§è¨­å®šï¼‰'); return; }

  const btn = document.getElementById('save-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>ä¿å­˜ä¸­...';

  // Build new entry
  const existing = purchasesData.purchases || [];
  let maxId = 0;
  existing.forEach(p => {
    const m = p.id && p.id.match(/^p(\d+)$/);
    if (m) maxId = Math.max(maxId, parseInt(m[1]));
  });

  const parsedItems = items.split('\n').map(s => s.trim()).filter(Boolean).map(s => {
    const m = s.match(/^(.+):(\d+)$/);
    return m ? { name: m[1].trim(), price: parseInt(m[2]) } : { name: s, price: null };
  });

  const entry = {
    id: `p${maxId + 1}`,
    date,
    store,
    items: parsedItems,
    total: total ? parseInt(total) : null,
    note: note || null
  };

  // Prepend (newest first)
  const updated = { purchases: [entry, ...existing] };
  const content = JSON.stringify(updated, null, 2);

  const ok = await ghPutFile('data/purchases.json', content, `kaimono: ${date} ${store}`);

  if (ok) {
    purchasesData = updated;
    ls('purchases_cache', purchasesData);
    renderHistory();
    renderStats();
    renderAnalysis();
    // Clear form (keep date)
    document.getElementById('input-store').value = '';
    document.getElementById('input-items').value = '';
    document.getElementById('input-total').value = '';
    document.getElementById('input-note').value = '';
    btn.innerHTML = 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
    showToast('è³¼è²·è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    setTimeout(() => {
      btn.disabled = false;
      btn.innerHTML = 'ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜';
    }, 2000);
  } else {
    btn.disabled = false;
    btn.innerHTML = 'ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜';
    showToast('âŒ ä¿å­˜å¤±æ•—ã€‚GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
  }
}

// ===== RENDER =====
function renderHistory() {
  const list = document.getElementById('history-list');
  const purchases = purchasesData.purchases || [];
  document.getElementById('history-count').textContent = `${purchases.length}ä»¶`;

  if (purchases.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ğŸ›’</div>
      <div>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </div>`;
    return;
  }

  // Show latest 20
  const recent = purchases.slice(0, 20);
  list.innerHTML = recent.map(p => `
    <div class="history-item" onclick="showDetail('${escHtml(p.id)}')">
      <div class="history-header">
        <div>
          <span class="history-date">${formatDate(p.date)}</span>
          <div class="history-store">${escHtml(p.store)}</div>
        </div>
        <div class="history-total">${p.total ? yen(p.total) : 'â€”'}</div>
      </div>
      <div class="history-items">${escHtml(summarizeItems(p.items))}</div>
    </div>`).join('');
}

function renderStats() {
  const purchases = purchasesData.purchases || [];
  if (purchases.length === 0) {
    document.getElementById('stats-card').style.display = 'none';
    return;
  }

  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const monthPurchases = purchases.filter(p => p.date && p.date.startsWith(thisMonth));
  const totalSpend = monthPurchases.reduce((sum, p) => sum + (p.total || 0), 0);

  const avgSpend = monthPurchases.length > 0 ? Math.round(totalSpend / monthPurchases.length) : 0;
  document.getElementById('stats-row').innerHTML = `
    <div class="stat-box">
      <div class="stat-value">${monthPurchases.length}</div>
      <div class="stat-label">ä»Šæœˆã®å›æ•°</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">${totalSpend ? yen(totalSpend) : 'â€”'}</div>
      <div class="stat-label">ä»Šæœˆã®åˆè¨ˆ</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">${avgSpend ? yen(avgSpend) : 'â€”'}</div>
      <div class="stat-label">å¹³å‡å˜ä¾¡</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">${purchases.length}</div>
      <div class="stat-label">ç·è¨˜éŒ²æ•°</div>
    </div>`;
  document.getElementById('stats-card').style.display = '';
}

// ===== DETAIL MODAL =====
function showDetail(id) {
  const p = (purchasesData.purchases || []).find(x => x.id === id);
  if (!p) return;

  document.getElementById('modal-store').textContent = p.store || 'â€”';

  const meta = [formatDate(p.date), p.time || ''].filter(Boolean).join(' ');
  document.getElementById('modal-meta').textContent = meta;

  document.getElementById('modal-total').textContent = p.total ? yen(p.total) : 'â€”';

  // items: array [{name,price}] or legacy string
  const itemList = parseItems(p.items);
  const hasPrice = Array.isArray(p.items) && p.items.length > 0 && p.items[0].price != null;
  document.getElementById('modal-items-list').innerHTML = itemList.map(item => {
    const priceHtml = hasPrice && item.price != null
      ? `<span style="margin-left:auto;font-weight:600;color:var(--green-dark);white-space:nowrap;">${yen(item.price)}</span>`
      : '';
    return `<div class="modal-item-row"><div class="modal-item-bullet"></div><span style="flex:1;">${escHtml(item.name)}</span>${priceHtml}</div>`;
  }).join('');

  // payment
  const pay = p.payment ? `ğŸ’³ ${p.payment}` : '';
  document.getElementById('modal-payment').textContent = pay;

  // note
  const noteWrap = document.getElementById('modal-note-wrap');
  noteWrap.innerHTML = p.note
    ? `<div class="modal-note">ğŸ“ ${escHtml(p.note)}</div>`
    : '';

  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('modal-sheet').classList.add('open');
}

function closeDetail() {
  document.getElementById('modal-overlay').classList.remove('open');
  document.getElementById('modal-sheet').classList.remove('open');
}

// items ã‚’ [{name, price}] ã®çµ±ä¸€å½¢å¼ã«å¤‰æ›
function parseItems(items) {
  if (!items) return [];
  if (Array.isArray(items)) return items.map(i => typeof i === 'string' ? { name: i, price: null } : i);
  // legacy string: "A / B\nC" â†’ parse "name:price" or plain name
  return items.split(/\s*\/\s*|\n/).map(s => s.trim()).filter(Boolean).map(s => {
    const m = s.match(/^(.+):(\d+)$/);
    return m ? { name: m[1].trim(), price: parseInt(m[2]) } : { name: s, price: null };
  });
}

function summarizeItems(items) {
  const list = parseItems(items);
  if (list.length <= 2) return list.map(i => i.name).join(' / ');
  return `${list[0].name} / ${list[1].name} ã»ã‹${list.length - 2}å“`;
}

function escHtml(s) {
  return String(s || '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// ===== STORE CATEGORY =====
const CATEGORY_INFO = {
  cafe:         { label: 'ã‚«ãƒ•ã‚§',   emoji: 'â˜•', cls: 'cat-cafe' },
  convenience:  { label: 'ã‚³ãƒ³ãƒ“ãƒ‹', emoji: 'ğŸª', cls: 'cat-convenience' },
  super:        { label: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼', emoji: 'ğŸ›’', cls: 'cat-super' },
  restaurant:   { label: 'å¤–é£Ÿ',     emoji: 'ğŸ½', cls: 'cat-restaurant' },
  other:        { label: 'ãã®ä»–',   emoji: 'ğŸ“¦', cls: 'cat-other' }
};

function categorizeStore(name) {
  const n = (name || '').toLowerCase();
  if (/lawson|ãƒ­ãƒ¼ã‚½ãƒ³|ã‚»ãƒ–ãƒ³|seven.?eleven|ãƒ•ã‚¡ãƒŸãƒ|ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ|ministop|ãƒŸãƒ‹ã‚¹ãƒˆãƒƒãƒ—|ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¤ãƒã‚¶ã‚­/.test(n))
    return 'convenience';
  if (/ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹|starbucks|ãƒ‰ãƒˆãƒ¼ãƒ«|ã‚¿ãƒªãƒ¼ã‚º|ã‚³ãƒ¡ãƒ€|ãƒ—ãƒ­ãƒ³ãƒˆ|çˆç²é¤¨|ã‚«ãƒ•ã‚§/.test(n))
    return 'cafe';
  if (/maruetsu|ãƒãƒ«ã‚¨ãƒ„|ãƒ©ã‚¤ãƒ•|ã‚ªãƒ¼ã‚±ãƒ¼|æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼|æˆåŸçŸ³äº•|ã‚¤ã‚ªãƒ³|è¥¿å‹|ã¾ã„ã°ã™ã‘ã£ã¨|ãƒ“ãƒƒã‚°|ãƒ”ã‚¢ã‚´/.test(n))
    return 'super';
  if (/é£Ÿå ‚|å®šé£Ÿ|ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³|ãƒ©ãƒ¼ãƒ¡ãƒ³|å¯¿å¸|ç„¼è‚‰|å±…é…’å±‹|ã™ãå®¶|ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰|å‰é‡å®¶|æ¾å±‹|ãƒãƒ¼ã‚¬ãƒ¼|ã‚µã‚¤ã‚¼/.test(n))
    return 'restaurant';
  return 'other';
}

// ===== ANALYSIS =====
let purchaseAdviceData = null;

async function loadAdvice() {
  try {
    const res = await fetch(`${DATA_BASE_URL}purchase-advice.json?_=${Date.now()}`, { cache: 'no-store' });
    if (res.ok) purchaseAdviceData = await res.json();
  } catch { /* no advice yet */ }
}

function analyzeCategories(purchases) {
  const cats = {};
  purchases.forEach(p => {
    const c = categorizeStore(p.store);
    if (!cats[c]) cats[c] = { total: 0, count: 0 };
    cats[c].total += (p.total || 0);
    cats[c].count++;
  });
  return cats;
}

function detectPatterns(purchases) {
  const patterns = [];
  const cafePurchases = purchases.filter(p => categorizeStore(p.store) === 'cafe');
  const convPurchases = purchases.filter(p => categorizeStore(p.store) === 'convenience');

  // ã‚«ãƒ•ã‚§ç¿’æ…£
  if (cafePurchases.length >= 3) {
    const totalCafe = cafePurchases.reduce((s, p) => s + (p.total || 0), 0);
    const avgCafe = Math.round(totalCafe / cafePurchases.length);
    const monthlyEst = Math.round(avgCafe * (cafePurchases.length / 7) * 30);
    patterns.push({
      emoji: 'â˜•', title: 'ã‚«ãƒ•ã‚§ç¿’æ…£',
      detail: `7æ—¥é–“ã§${cafePurchases.length}å›ã®ã‚«ãƒ•ã‚§åˆ©ç”¨ï¼ˆå¹³å‡Â¥${avgCafe.toLocaleString()}ï¼‰ã€‚æœˆæ›ç®—ã§ç´„Â¥${monthlyEst.toLocaleString()}ã®æ”¯å‡ºè¦‹è¾¼ã¿ã€‚`,
      tip: 'ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’æŒå‚ã™ã‚‹æ—¥ã‚’å¢—ã‚„ã™ã¨æœˆÂ¥3,000ã€œ5,000ã®ç¯€ç´„ã«'
    });
  } else if (cafePurchases.length >= 1) {
    patterns.push({ emoji: 'â˜•', title: 'ã‚«ãƒ•ã‚§ç¿’æ…£', accumulating: true });
  }

  // ã‚³ãƒ³ãƒ“ãƒ‹åˆ©ç”¨
  if (convPurchases.length >= 3) {
    const totalConv = convPurchases.reduce((s, p) => s + (p.total || 0), 0);
    const avgConv = Math.round(totalConv / convPurchases.length);
    patterns.push({
      emoji: 'ğŸª', title: 'ã‚³ãƒ³ãƒ“ãƒ‹åˆ©ç”¨',
      detail: `7æ—¥é–“ã§${convPurchases.length}å›ã®ã‚³ãƒ³ãƒ“ãƒ‹åˆ©ç”¨ï¼ˆåˆè¨ˆÂ¥${totalConv.toLocaleString()}ã€å¹³å‡Â¥${avgConv.toLocaleString()}ï¼‰ã€‚`,
      tip: 'å¿…è¦å“ã‚’ãƒªã‚¹ãƒˆã«ã—ã¦ã‹ã‚‰å…¥åº—ã™ã‚‹ã¨ä½™åˆ†ãªè³¼å…¥ã‚’æ¸›ã‚‰ã›ã‚‹'
    });
  } else if (convPurchases.length >= 1) {
    patterns.push({ emoji: 'ğŸª', title: 'ã‚³ãƒ³ãƒ“ãƒ‹åˆ©ç”¨', accumulating: true });
  }

  // æ™‚é–“å¸¯åˆ†æï¼ˆ17æ™‚ä»¥é™ï¼‰
  const timed = purchases.filter(p => p.time);
  const evening = timed.filter(p => parseInt(p.time.split(':')[0]) >= 17);
  if (timed.length >= 3 && evening.length >= 3) {
    const pct = Math.round(evening.length / timed.length * 100);
    patterns.push({
      emoji: 'ğŸŒ™', title: 'å¤•æ–¹ã€œå¤œã®è²·ã„ç‰©é›†ä¸­',
      detail: `è¨˜éŒ²${timed.length}ä»¶ä¸­${evening.length}ä»¶ï¼ˆ${pct}%ï¼‰ãŒ17æ™‚ä»¥é™ã®è³¼å…¥ã€‚ç©ºè…¹æ™‚ã®è²·ã„ç‰©ã¯è¡å‹•è²·ã„ã«ã¤ãªãŒã‚Šã‚„ã™ã„ã€‚`,
      tip: 'å¤•é£Ÿå‰ã®è²·ã„ç‰©ã¯äº‹å‰ã«ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªã§å“ç›®ã‚’ç¢ºèªã—ã¦ãŠãã¨åŠ¹æœçš„'
    });
  }

  return patterns;
}

function renderAnalysis() {
  const purchases = purchasesData.purchases || [];
  if (purchases.length < 2) {
    document.getElementById('analysis-card').style.display = 'none';
    return;
  }
  document.getElementById('analysis-card').style.display = '';

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºãƒãƒ¼
  const cats = analyzeCategories(purchases);
  const totalAll = Object.values(cats).reduce((s, c) => s + c.total, 0);
  const catOrder = ['cafe', 'convenience', 'super', 'restaurant', 'other'];
  document.getElementById('category-bars').innerHTML = catOrder
    .filter(c => cats[c])
    .map(c => {
      const { total, count } = cats[c];
      const info = CATEGORY_INFO[c];
      const pct = totalAll > 0 ? Math.round(total / totalAll * 100) : 0;
      return `<div class="cat-row">
        <div class="cat-row-header">
          <span class="cat-name">${info.emoji} ${info.label}</span>
          <span class="cat-meta">Â¥${total.toLocaleString()} (${pct}% Â· ${count}å›)</span>
        </div>
        <div class="cat-track"><div class="cat-fill ${info.cls}" style="width:${pct}%"></div></div>
      </div>`;
    }).join('');

  // æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
  const patterns = detectPatterns(purchases);
  document.getElementById('pattern-cards').innerHTML = patterns.map(p => {
    if (p.accumulating) {
      return `<div class="pattern-card">
        <div class="pattern-header">
          <span class="pattern-emoji">${p.emoji}</span>
          <span class="pattern-title">${p.title}</span>
        </div>
        <div class="pattern-accumulating">ãƒ‡ãƒ¼ã‚¿è“„ç©ä¸­â€¦ ã‚‚ã†å°‘ã—è¨˜éŒ²ã‚’ç¶šã‘ã‚‹ã¨åˆ†æã§ãã¾ã™</div>
      </div>`;
    }
    return `<div class="pattern-card">
      <div class="pattern-header">
        <span class="pattern-emoji">${p.emoji}</span>
        <span class="pattern-title">${escHtml(p.title)}</span>
      </div>
      <div class="pattern-detail">${escHtml(p.detail)}</div>
      <div class="pattern-tip">ğŸ’¡ ${escHtml(p.tip)}</div>
    </div>`;
  }).join('');

  // AI ã‚¢ãƒ‰ãƒã‚¤ã‚¹
  const adviceWrap = document.getElementById('ai-advice-wrap');
  if (purchaseAdviceData) {
    const d = purchaseAdviceData;
    const tipsHtml = (d.tips || []).map(t => `<li>${escHtml(t)}</li>`).join('');
    const genDate = d.generated
      ? new Date(d.generated).toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' })
      : '';
    adviceWrap.innerHTML = `<div class="ai-advice-card">
      ${genDate ? `<div class="ai-advice-generated">AIåˆ†æ ${genDate}</div>` : ''}
      <div class="ai-advice-headline">${escHtml(d.headline || '')}</div>
      <ul class="ai-advice-tips">${tipsHtml}</ul>
    </div>`;
  } else {
    adviceWrap.innerHTML = '';
  }
}

// ===== RELOAD =====
let _reloading = false;
async function reloadData() {
  if (_reloading) return;
  _reloading = true;
  const btn = document.getElementById('reload-btn');
  if (btn) btn.classList.add('spinning');
  try {
    await loadPurchases();
  } finally {
    if (btn) btn.classList.remove('spinning');
    _reloading = false;
  }
}

// ===== INIT =====
const today = todayStr();
document.getElementById('today-label').textContent = today;
document.getElementById('input-date').value = today;
loadPurchases();

// iOS ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆï¼ˆcanvas â†’ PNG data URIï¼‰
(function() {
  try {
    const c = document.createElement('canvas');
    c.width = c.height = 180;
    const ctx = c.getContext('2d');
    // èƒŒæ™¯ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ï¼‰
    ctx.fillStyle = '#1A4A6B';
    ctx.beginPath();
    ctx.roundRect(0, 0, 180, 180, 22);
    ctx.fill();
    // çµµæ–‡å­—
    ctx.font = '90px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ğŸ›’', 90, 82);
    // ãƒ†ã‚­ã‚¹ãƒˆ
    ctx.fillStyle = 'white';
    ctx.font = 'bold 21px -apple-system, Hiragino Kaku Gothic ProN, sans-serif';
    ctx.textBaseline = 'alphabetic';
    ctx.fillText('è³¼è²·è¨˜éŒ²', 90, 162);
    const link = document.querySelector("link[rel='apple-touch-icon']") || document.createElement('link');
    link.rel = 'apple-touch-icon';
    link.href = c.toDataURL('image/png');
    document.head.appendChild(link);
  } catch(e) { /* fallback to SVG */ }
})();
</script>
</body>
</html>
