<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1B4332">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ä»Šæ—¥ã®ç…®è¾¼ã¿">
  <title>ğŸ«• ä»Šæ—¥ã®ç…®è¾¼ã¿</title>
  <link rel="manifest" href="nikomi-manifest.json">
  <link rel="apple-touch-icon" href="nikomi-icon.svg">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green-dark: #1B4332;
      --green-mid: #2D6A4F;
      --green-light: #52B788;
      --green-pale: #D8F3DC;
      --bg: #F0F4F0;
      --card: #FFFFFF;
      --text: #1A1A2E;
      --text-muted: #6C757D;
      --border: #DEE2E6;
      --danger: #DC3545;
      --warning: #E5A020;
      --success: #28A745;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    .header {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--green-dark);
      color: white;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 16px;
      padding-top: var(--safe-top);
      height: calc(52px + var(--safe-top));
      z-index: 100;
    }
    .header h1 { font-size: 16px; font-weight: 700; }
    .header-sub { font-size: 12px; opacity: 0.75; }
    .main {
      padding-top: calc(52px + var(--safe-top));
      padding-bottom: calc(24px + var(--safe-bottom));
    }
    .card {
      background: var(--card); border-radius: 14px;
      padding: 14px 16px; margin: 8px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 11px; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.6px; margin-bottom: 12px;
    }
    .btn-primary {
      width: 100%; padding: 16px;
      background: var(--green-mid); color: white;
      border: none; border-radius: 12px;
      font-size: 17px; font-weight: 700;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      transition: opacity 0.15s, transform 0.1s;
    }
    .btn-primary:active { opacity: 0.75; transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.55; cursor: default; transform: none; }
    .btn-secondary {
      width: 100%; padding: 13px;
      background: var(--bg); color: var(--green-mid);
      border: 1.5px solid var(--green-light); border-radius: 12px;
      font-size: 15px; font-weight: 600;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      transition: opacity 0.15s;
    }
    .btn-secondary:active { opacity: 0.7; }
    .btn-success {
      width: 100%; padding: 14px;
      background: var(--success); color: white;
      border: none; border-radius: 12px;
      font-size: 15px; font-weight: 700;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
      transition: opacity 0.15s, transform 0.1s;
    }
    .btn-success:active { opacity: 0.75; transform: scale(0.98); }
    .btn-success:disabled { opacity: 0.5; cursor: default; transform: none; }
    .ingredient-row {
      display: flex; align-items: flex-start; gap: 8px;
      padding: 9px 0; border-bottom: 1px solid var(--border);
    }
    .ingredient-row:last-child { border-bottom: none; }
    .ingredient-left { flex: 1; min-width: 0; }
    .ingredient-name { font-size: 15px; font-weight: 600; color: var(--text); }
    .ingredient-feature { font-size: 11px; color: var(--green-mid); margin-top: 2px; }
    .ingredient-amount { font-size: 13px; color: var(--text-muted); white-space: nowrap; padding-top: 2px; }
    .tag {
      display: inline-block; padding: 1px 7px;
      border-radius: 10px; font-size: 10px; font-weight: 700;
      margin-left: 5px; vertical-align: middle;
    }
    .tag-meat    { background: #FFE4E4; color: #B71C1C; }
    .tag-seafood { background: #E3F2FD; color: #0D47A1; }
    .tag-always  { background: var(--green-pale); color: var(--green-dark); }
    .tag-ferment { background: #E8F5E9; color: #1B5E20; }
    .oil-note {
      background: #FFFDE7; border: 1px solid #FFF176;
      border-radius: 8px; padding: 9px 12px;
      font-size: 13px; color: #6D4C00; margin-top: 8px;
      line-height: 1.5;
    }
    .base-detail {
      background: var(--green-pale); border-radius: 8px;
      padding: 9px 12px; font-size: 13px; color: var(--green-dark);
      margin: 6px 0 4px; line-height: 1.6;
    }
    .base-feature { font-size: 12px; color: var(--text-muted); }
    .hero-emoji { font-size: 72px; line-height: 1; margin-bottom: 12px; }
    .loading-wrap {
      text-align: center; padding: 40px 16px;
    }
    .loading-emoji {
      font-size: 48px;
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.12); } }
    .spinner {
      display: inline-block; width: 15px; height: 15px;
      border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
      border-radius: 50%; animation: spin 0.7s linear infinite;
      vertical-align: middle; margin-right: 5px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast {
      position: fixed; bottom: calc(20px + var(--safe-bottom));
      left: 50%; transform: translateX(-50%);
      background: rgba(20,20,20,0.88); color: white;
      padding: 10px 20px; border-radius: 20px;
      font-size: 14px; white-space: nowrap;
      opacity: 0; transition: opacity 0.3s;
      pointer-events: none; z-index: 999;
    }
    .toast.show { opacity: 1; }
    .back-link {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 13px; color: rgba(255,255,255,0.75);
      text-decoration: none; padding: 4px 0;
    }
    .back-link:active { opacity: 0.6; }
    .section-divider {
      height: 1px; background: var(--border);
      margin: 4px 0 12px;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>ğŸ«• ä»Šæ—¥ã®ç…®è¾¼ã¿</h1>
  <span class="header-sub" id="today-date"></span>
</div>

<div class="main">

  <!-- ===== HERO ===== -->
  <div class="card" id="hero-card">
    <div style="text-align:center; padding: 28px 0 20px;">
      <div class="hero-emoji">ğŸ«•</div>
      <div style="font-size:13px; color:var(--text-muted); margin-bottom:5px;">ã‚¹ãƒˆã‚¦ãƒ– ä¸¸å‹26cmï¼ˆ5Lï¼‰</div>
      <div style="font-size:12px; color:var(--text-muted); margin-bottom:24px;">ç›´è¿‘3æ—¥ã®é£Ÿäº‹ãƒ­ã‚°ã‹ã‚‰è¢«ã‚‰ãªã„é£Ÿæã‚’é¸ã³ã¾ã™</div>
      <button class="btn-primary" id="gen-btn" onclick="generateRecipe()">ä»Šæ—¥ã®ç…®è¾¼ã¿ã¯ï¼Ÿ</button>
    </div>
  </div>

  <!-- ===== LOADING ===== -->
  <div class="card" id="loading-card" style="display:none;">
    <div class="loading-wrap">
      <div class="loading-emoji">ğŸ«•</div>
      <div style="color:var(--text-muted); font-size:14px; margin-top:12px;">é£Ÿäº‹ãƒ­ã‚°ã‚’ç¢ºèªä¸­...</div>
    </div>
  </div>

  <!-- ===== RESULT ===== -->
  <div id="result-section" style="display:none;">

    <!-- Protein -->
    <div class="card">
      <div class="card-title">ğŸ¥© ãŸã‚“ã±ãè³ª</div>
      <div id="protein-content"></div>
    </div>

    <!-- Mushrooms -->
    <div class="card">
      <div class="card-title">ğŸ„ ãã®ã“</div>
      <div id="mushrooms-content"></div>
    </div>

    <!-- Vegetables -->
    <div class="card">
      <div class="card-title">ğŸ¥¬ é‡èœ</div>
      <div id="vegetables-content"></div>
    </div>

    <!-- Base -->
    <div class="card">
      <div class="card-title">ğŸ«• ãƒ™ãƒ¼ã‚¹ï¼ˆå‘³ä»˜ã‘ï¼‰</div>
      <div id="base-content"></div>
    </div>

    <!-- Actions -->
    <div class="card">
      <button class="btn-success" id="shop-btn" onclick="addToShoppingList()">
        ğŸ›’ ã“ã®ææ–™ã§è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ 
      </button>
      <div style="height:8px;"></div>
      <button class="btn-secondary" onclick="generateRecipe()">
        ğŸ”€ åˆ¥ã®çµ„ã¿åˆã‚ã›
      </button>
    </div>

  </div><!-- /result-section -->

</div><!-- /main -->

<div class="toast" id="toast"></div>

<script>
// ===== MASTER DATA =====

const PROTEINS = [
  { id: 'sunagimo',  name: 'ç ‚è‚',           keywords: ['ç ‚è‚'],   type: 'meat',    amount: '500g',            feature: 'é‰„ãƒ»äºœé‰›â—',               needsOil: true  },
  { id: 'gyusuji',   name: 'ç‰›ã™ã˜',          keywords: ['ç‰›ã™ã˜'],  type: 'meat',    amount: '600gï¼ˆèŒ¹ã§ã“ã¼ã—2å›ï¼‰',  feature: 'ã‚³ãƒ©ãƒ¼ã‚²ãƒ³â—ãƒ»ä½è„‚è³ª',         needsOil: false },
  { id: 'torimomo',  name: 'é¶ã‚‚ã‚‚ï¼ˆçš®ãªã—ï¼‰',   keywords: ['é¶ã‚‚ã‚‚'],  type: 'meat',    amount: '500g',            feature: 'ãƒãƒ©ãƒ³ã‚¹å‹',               needsOil: false },
  { id: 'torimune',  name: 'é¶ã‚€ã­ï¼ˆçš®ãªã—ï¼‰',   keywords: ['é¶ã‚€ã­'],  type: 'meat',    amount: '500g',            feature: 'æœ€é«˜PåŠ¹ç‡',               needsOil: true  },
  { id: 'butamomo',  name: 'è±šã‚‚ã‚‚',          keywords: ['è±šã‚‚ã‚‚'],  type: 'meat',    amount: '500g',            feature: 'ãƒ“ã‚¿ãƒŸãƒ³B1â—ï¼ˆç³–è³ªä»£è¬ï¼‰',     needsOil: false },
  { id: 'tebasamoto',name: 'é¶æ‰‹ç¾½å…ƒ',         keywords: ['æ‰‹ç¾½å…ƒ'],  type: 'meat',    amount: '500g',            feature: 'ã‚³ãƒ©ãƒ¼ã‚²ãƒ³ãƒ»ç…®è¾¼ã¿æ—¨å‘³â—',      needsOil: false },
  { id: 'tebasaki',  name: 'é¶æ‰‹ç¾½å…ˆ',         keywords: ['æ‰‹ç¾½å…ˆ'],  type: 'meat',    amount: '500g',            feature: 'ã‚³ãƒ©ãƒ¼ã‚²ãƒ³ãƒ»å‡ºæ±ãŒå‡ºã‚‹â—',      needsOil: false },
  { id: 'ika',       name: 'ã‚¤ã‚«ï¼ˆä¸‹å‡¦ç†æ¸ˆã¿ï¼‰', keywords: ['ã‚¤ã‚«'],   type: 'seafood', amount: '400g',            feature: 'ã‚¿ã‚¦ãƒªãƒ³â—ãƒ»è‚è‡“ã‚µãƒãƒ¼ãƒˆ',      needsOil: true  },
  { id: 'tako',      name: 'ã‚¿ã‚³ï¼ˆã‚†ã§ï¼‰',      keywords: ['ã‚¿ã‚³'],   type: 'seafood', amount: '400g',            feature: 'ã‚¿ã‚¦ãƒªãƒ³â—ãƒ»æœ€ä½è„‚è³ª',         needsOil: true  },
  { id: 'ebi',       name: 'ã‚¨ãƒ“ï¼ˆã‚€ãï¼‰',      keywords: ['ã‚¨ãƒ“'],   type: 'seafood', amount: '400g',            feature: 'é«˜Pãƒ»ã‚¢ã‚¹ã‚¿ã‚­ã‚µãƒ³ãƒãƒ³',        needsOil: true  },
  { id: 'sake',      name: 'é®­ï¼ˆç”Ÿï¼‰',          keywords: ['é®­'],    type: 'seafood', amount: '400gï¼ˆåˆ‡ã‚Šèº«ï¼‰',     feature: 'ã‚ªãƒ¡ã‚¬3ãƒ»ãƒ“ã‚¿ãƒŸãƒ³D',          needsOil: false },
];

const MUSHROOMS = [
  { id: 'maitake',  name: 'ã¾ã„ãŸã‘',      amount: '1è¢‹ï¼ˆ100gï¼‰', feature: 'ãƒ“ã‚¿ãƒŸãƒ³Dæœ€å¼·ãƒ»å…ç–«â—', always: true  },
  { id: 'enoki',    name: 'ãˆã®ã',        amount: '1è¢‹ï¼ˆ200gï¼‰', feature: 'é£Ÿç‰©ç¹Šç¶­â—ãƒ»å®‰ã„',      always: false },
  { id: 'shimeji',  name: 'ã—ã‚ã˜',        amount: '1è¢‹ï¼ˆ100gï¼‰', feature: 'æ—¨å‘³ãƒ»é£Ÿæ„Ÿ',          always: false },
  { id: 'eringi',   name: 'ã‚¨ãƒªãƒ³ã‚®',      amount: '1è¢‹ï¼ˆ100gï¼‰', feature: 'é£Ÿæ„Ÿâ—ãƒ»é£Ÿç‰©ç¹Šç¶­',      always: false },
  { id: 'shiitake', name: 'æ¤èŒ¸',          amount: '1è¢‹ï¼ˆ100gï¼‰', feature: 'æ—¨å‘³ãƒ»ãƒ“ã‚¿ãƒŸãƒ³D',      always: false },
  { id: 'mashroom', name: 'ãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ ', amount: '1è¢‹ï¼ˆ100gï¼‰', feature: 'ã‚«ãƒªã‚¦ãƒ â—ãƒ»æ´‹é¢¨å‘ã',  always: false },
];

// compat: 'all' or array of base IDs
const VEGETABLES = [
  { id: 'tamanegi', name: 'ç‰ã­ã',       amount: 'å¤§1å€‹ï¼ˆ200gï¼‰',    compat: 'all',                                       feature: 'ç”˜ã¿ãƒ»æ—¨å‘³ã®åœŸå°',          always: true  },
  { id: 'tomato',   name: 'ãƒˆãƒãƒˆ',       amount: '2å€‹',              compat: ['curry','tomato','shio'],                   feature: 'æ°´åˆ†ãƒ»ãƒªã‚³ãƒ”ãƒ³â—'                          },
  { id: 'nasu',     name: 'ãƒŠã‚¹',         amount: '2æœ¬',              compat: ['curry','tomato','shio'],                   feature: 'æ°´åˆ†ãƒ»é£Ÿæ„Ÿ'                               },
  { id: 'kyabetsu', name: 'ã‚­ãƒ£ãƒ™ãƒ„',     amount: '1/4ç‰ï¼ˆ300gï¼‰',    compat: ['white','miso','shio'],                     feature: 'ãƒ“ã‚¿ãƒŸãƒ³Cãƒ»é£Ÿç‰©ç¹Šç¶­'                       },
  { id: 'broccoli', name: 'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼', amount: 'å°1æ ªï¼ˆ200gï¼‰',    compat: ['white','curry','tomato','shio'],            feature: 'ãƒ“ã‚¿ãƒŸãƒ³Cãƒ»ã‚¹ãƒ«ãƒ•ã‚©ãƒ©ãƒ•ã‚¡ãƒ³'                },
  { id: 'paprika',  name: 'ãƒ‘ãƒ—ãƒªã‚«ï¼ˆèµ¤ãƒ»é»„ï¼‰', amount: 'å„1å€‹',      compat: 'all',                                       feature: 'ãƒ“ã‚¿ãƒŸãƒ³Cæœ€å¼·ãƒ»å½©ã‚Šâ—'                      },
  { id: 'celery',   name: 'ã‚»ãƒ­ãƒª',       amount: '2æœ¬',              compat: ['white','tomato','shio','demi'],             feature: 'é¦™å‘³ãƒ»ã‚«ãƒªã‚¦ãƒ '                            },
  { id: 'kabocha',  name: 'ã‹ã¼ã¡ã‚ƒ',     amount: '1/4å€‹ï¼ˆ300gï¼‰',    compat: ['white','miso','shoyu'],                    feature: 'Î²-ã‚«ãƒ­ãƒ†ãƒ³ãƒ»ç”˜ã¿'                          },
  { id: 'horenso',  name: 'ã»ã†ã‚Œã‚“è‰',   amount: '1æŸï¼ˆä»•ä¸Šã’ã«æŠ•å…¥ï¼‰',compat: ['white','curry','shoyu','miso'],            feature: 'é‰„ãƒ»Mgï¼ˆä»•ä¸Šã’å°‚ç”¨ï¼‰'                      },
  { id: 'zucchini', name: 'ã‚ºãƒƒã‚­ãƒ¼ãƒ‹',   amount: '1æœ¬',              compat: ['curry','tomato','shio'],                   feature: 'ä½ã‚«ãƒ­ãƒªãƒ¼ãƒ»é£Ÿæ„Ÿ'                          },
  { id: 'ninjin',   name: 'ã«ã‚“ã˜ã‚“',     amount: '1æœ¬',              compat: ['white','demi','shoyu','shio'],              feature: 'Î²-ã‚«ãƒ­ãƒ†ãƒ³'                               },
  { id: 'jagaimo',  name: 'ã˜ã‚ƒãŒã„ã‚‚',   amount: '2å€‹',              compat: ['white','curry','shio','demi'],              feature: 'æº€è…¹æ„Ÿãƒ»ã‚«ãƒªã‚¦ãƒ '                          },
  { id: 'gobo',     name: 'ã”ã¼ã†',       amount: '1/2æœ¬ï¼ˆ100gï¼‰',    compat: ['shoyu','miso'],                            feature: 'é£Ÿç‰©ç¹Šç¶­â—ï¼ˆã‚¤ãƒŒãƒªãƒ³ï¼‰'                     },
  { id: 'daikon',   name: 'å¤§æ ¹',         amount: '1/3æœ¬ï¼ˆ200gï¼‰',    compat: ['shoyu','miso'],                            feature: 'æ¶ˆåŒ–é…µç´ ãƒ»ä½ã‚«ãƒ­ãƒªãƒ¼'                      },
  { id: 'satoimo',  name: 'é‡ŒèŠ‹',         amount: '6å€‹ï¼ˆ300gï¼‰',      compat: ['shoyu','miso'],                            feature: 'ã‚«ãƒªã‚¦ãƒ â—ãƒ»ã¨ã‚ã¿'                         },
];

const BASES = [
  { id: 'curry',  name: 'ã‚«ãƒ¬ãƒ¼',           seasoning: 'ã‚«ãƒ¬ãƒ¼ç²‰ å¤§ã•ã˜2ãƒ»ã‚±ãƒãƒ£ãƒƒãƒ— å°ã•ã˜2ãƒ»ã‚¦ã‚¹ã‚¿ãƒ¼ã‚½ãƒ¼ã‚¹ å¤§ã•ã˜1',  feature: 'å®šç•ªã€‚é£Ÿæ¬²â†‘ã€‚ã«ã‚“ã«ã2ç‰‡ã‚ã‚‹ã¨â—' },
  { id: 'tomato', name: 'ãƒˆãƒãƒˆç…®',          seasoning: 'ãƒˆãƒãƒˆç¼¶ 1ç¼¶ãƒ»ã‚³ãƒ³ã‚½ãƒ¡ 2å€‹ãƒ»ã«ã‚“ã«ã 2ç‰‡',                   feature: 'ã•ã£ã±ã‚Šãƒ»ãƒªã‚³ãƒ”ãƒ³â—' },
  { id: 'white',  name: 'ãƒ›ãƒ¯ã‚¤ãƒˆã‚·ãƒãƒ¥ãƒ¼',  seasoning: 'ç‰›ä¹³ 200mlãƒ»ã‚·ãƒãƒ¥ãƒ¼ãƒ«ãƒ¼ 1/2ç®±ãƒ»ã‚³ãƒ³ã‚½ãƒ¡ 1å€‹',              feature: 'ã‚«ãƒ«ã‚·ã‚¦ãƒ â—' },
  { id: 'demi',   name: 'ãƒ‡ãƒŸã‚°ãƒ©ã‚¹ç³»',      seasoning: 'ãƒ‡ãƒŸã‚°ãƒ©ã‚¹ç¼¶ 1ç¼¶ãƒ»èµ¤ãƒ¯ã‚¤ãƒ³ 50mlãƒ»ã‚±ãƒãƒ£ãƒƒãƒ— å¤§ã•ã˜1',        feature: 'ã‚³ã‚¯ãŒæ·±ã„' },
  { id: 'miso',   name: 'å‘³å™Œç…®è¾¼ã¿',        seasoning: 'å‘³å™Œ å¤§ã•ã˜2ãƒ»ã¿ã‚Šã‚“ å¤§ã•ã˜2ãƒ»ã ã— 200ml',                   feature: 'ç™ºé…µé£Ÿå“â— è…¸æ´»ã‚¹ã‚³ã‚¢â†‘', fermented: true },
  { id: 'shoyu',  name: 'é†¤æ²¹ãƒ™ãƒ¼ã‚¹ï¼ˆç…®ç‰©ï¼‰', seasoning: 'é†¤æ²¹ å¤§ã•ã˜2ãƒ»ã¿ã‚Šã‚“ å¤§ã•ã˜2ãƒ»é…’ å¤§ã•ã˜2ãƒ»ã ã— 200ml',      feature: 'å’Œé£Ÿã®ç‹é“' },
  { id: 'shio',   name: 'å¡©ãƒ™ãƒ¼ã‚¹ï¼ˆãƒãƒˆãƒ•é¢¨ï¼‰',seasoning: 'ã‚³ãƒ³ã‚½ãƒ¡ 2å€‹ãƒ»å¡© å°ã•ã˜1ãƒ»ã«ã‚“ã«ã 2ç‰‡',                   feature: 'ã‚ã£ã•ã‚Šãƒ»ç´ æã®å‘³ãŒæ´»ãã‚‹' },
];

// ===== CONSTANTS =====
const DATA_BASE_URL = 'https://shujiuyeda.github.io/web/data/';
const GH_REPO = 'shujiuyeda/web';
const GH_API  = 'https://api.github.com';

// ===== UTILS =====
function ls(key, val) {
  if (val === undefined) {
    try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
  }
  localStorage.setItem(key, JSON.stringify(val));
}
function ghToken() { return ls('gh_pat') || ''; }
function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function todayStr() {
  const d = new Date();
  return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
}
function dateOffsetStr(offset) {
  const d = new Date(); d.setDate(d.getDate() + offset);
  return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
}
function showToast(msg, ms=2800) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
}

// ===== GITHUB API =====
async function ghGetFileSha(path) {
  try {
    const res = await fetch(`${GH_API}/repos/${GH_REPO}/contents/${path}?_=${Date.now()}`, {
      headers: { 'Authorization': `Bearer ${ghToken()}`, 'Accept': 'application/vnd.github+json' }
    });
    if (!res.ok) return null;
    return (await res.json()).sha || null;
  } catch { return null; }
}
async function ghPutFile(path, content, message) {
  const sha = await ghGetFileSha(path);
  const body = { message, content: btoa(unescape(encodeURIComponent(content))) };
  if (sha) body.sha = sha;
  try {
    const res = await fetch(`${GH_API}/repos/${GH_REPO}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${ghToken()}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    return res.ok;
  } catch { return false; }
}

// ===== MEAL FETCHING =====
async function fetchRecentMealNames() {
  const names = [];
  for (let i = 0; i >= -2; i--) {
    const ds = dateOffsetStr(i);
    try {
      const res = await fetch(`${DATA_BASE_URL}meals-${ds}.json?_=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) continue;
      const data = await res.json();
      if (Array.isArray(data.meals)) {
        data.meals.forEach(m => { if (m.name) names.push(m.name); });
      }
    } catch { /* ignore */ }
  }
  return names;
}

function extractUsedProteinIds(mealNames) {
  const used = new Set();
  mealNames.forEach(name => {
    PROTEINS.forEach(p => {
      if (p.keywords.some(kw => name.includes(kw))) used.add(p.id);
    });
  });
  return used;
}

// ===== RECIPE GENERATION =====
let currentRecipe = null;

async function generateRecipe() {
  const btn = document.getElementById('gen-btn');
  btn.disabled = true;
  document.getElementById('hero-card').style.display = 'none';
  document.getElementById('result-section').style.display = 'none';
  document.getElementById('loading-card').style.display = '';

  // Fetch recent meals
  const mealNames = await fetchRecentMealNames();
  const usedIds = extractUsedProteinIds(mealNames);

  // Select protein
  let available = PROTEINS.filter(p => !usedIds.has(p.id));
  if (available.length === 0) available = [...PROTEINS];
  const protein = rand(available);

  // Select base (avoid last used)
  const lastBaseId = ls('nikomi_last_base');
  const availBases = BASES.filter(b => b.id !== lastBaseId);
  const base = rand(availBases.length ? availBases : BASES);
  ls('nikomi_last_base', base.id);

  // Select mushrooms: always ã¾ã„ãŸã‘ + 1 or 2 others
  const fixedMushrooms = MUSHROOMS.filter(m => m.always);
  const optMushrooms   = shuffle(MUSHROOMS.filter(m => !m.always));
  const extraMush = Math.random() < 0.5 ? 1 : 2;
  const mushrooms = [...fixedMushrooms, ...optMushrooms.slice(0, extraMush)];

  // Select vegetables: always ç‰ã­ã + 2 or 3 compatible
  const fixedVeg = VEGETABLES.filter(v => v.always);
  const compatVeg = shuffle(VEGETABLES.filter(v =>
    !v.always && (v.compat === 'all' || v.compat.includes(base.id))
  ));
  const extraVeg = Math.random() < 0.4 ? 2 : 3;
  const vegetables = [...fixedVeg, ...compatVeg.slice(0, extraVeg)];

  currentRecipe = { protein, mushrooms, vegetables, base };

  // Hide loading, show result
  document.getElementById('loading-card').style.display = 'none';
  document.getElementById('hero-card').style.display = '';
  document.getElementById('result-section').style.display = '';
  btn.disabled = false;

  renderRecipe(currentRecipe);
  // Scroll to result
  setTimeout(() => {
    document.getElementById('result-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 80);
}

// ===== RENDER =====
function renderRecipe({ protein, mushrooms, vegetables, base }) {
  // Protein
  const typeTag = protein.type === 'meat'
    ? '<span class="tag tag-meat">è‚‰</span>'
    : '<span class="tag tag-seafood">é­šä»‹</span>';
  let pHtml = `
    <div class="ingredient-row">
      <div class="ingredient-left">
        <div class="ingredient-name">${protein.name}${typeTag}</div>
        <div class="ingredient-feature">${protein.feature}</div>
      </div>
      <div class="ingredient-amount">${protein.amount}</div>
    </div>`;
  if (protein.needsOil) {
    pHtml += `<div class="oil-note">ğŸ’› ã‚¨ã‚´ãƒæ²¹ å¤§ã•ã˜1 â€” è„‚è³ªãŒå°‘ãªã„ãŸã‚ä»•ä¸Šã’ã«ã‹ã‘ã‚‹ï¼ˆã‚ªãƒ¡ã‚¬3ãƒ»æŠ—ç‚ç—‡ï¼‰</div>`;
  }
  document.getElementById('protein-content').innerHTML = pHtml;

  // Mushrooms
  document.getElementById('mushrooms-content').innerHTML = mushrooms.map(m => `
    <div class="ingredient-row">
      <div class="ingredient-left">
        <div class="ingredient-name">${m.name}${m.always ? '<span class="tag tag-always">å¿…é ˆ</span>' : ''}</div>
        <div class="ingredient-feature">${m.feature}</div>
      </div>
      <div class="ingredient-amount">${m.amount}</div>
    </div>`).join('');

  // Vegetables
  document.getElementById('vegetables-content').innerHTML = vegetables.map(v => `
    <div class="ingredient-row">
      <div class="ingredient-left">
        <div class="ingredient-name">${v.name}</div>
        <div class="ingredient-feature">${v.feature}</div>
      </div>
      <div class="ingredient-amount">${v.amount}</div>
    </div>`).join('');

  // Base
  const fermentTag = base.fermented ? '<span class="tag tag-ferment">ç™ºé…µâ—</span>' : '';
  document.getElementById('base-content').innerHTML = `
    <div style="font-size:17px; font-weight:700; color:var(--green-dark); margin-bottom:6px;">
      ${base.name}${fermentTag}
    </div>
    <div class="base-detail">${base.seasoning}</div>
    <div class="base-feature">${base.feature}</div>`;

  // Reset shop button
  const shopBtn = document.getElementById('shop-btn');
  shopBtn.disabled = false;
  shopBtn.innerHTML = 'ğŸ›’ ã“ã®ææ–™ã§è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ ';
}

// ===== SHOPPING LIST =====
async function addToShoppingList() {
  if (!currentRecipe) return;
  if (!ghToken()) {
    showToast('âš ï¸ GitHubãƒˆãƒ¼ã‚¯ãƒ³æœªè¨­å®šï¼ˆHealth Hubã§è¨­å®šã—ã¦ãã ã•ã„ï¼‰');
    return;
  }

  const shopBtn = document.getElementById('shop-btn');
  shopBtn.disabled = true;
  shopBtn.innerHTML = '<span class="spinner"></span>è¿½åŠ ä¸­...';

  const today = todayStr();
  const { protein, mushrooms, vegetables, base } = currentRecipe;

  // Fetch current shopping.json
  let existing = { updated: today, items: [], checks: {} };
  try {
    const res = await fetch(`${DATA_BASE_URL}shopping.json?_=${Date.now()}`, { cache: 'no-store' });
    if (res.ok) existing = await res.json();
  } catch { /* use default */ }

  const existingItems = existing.items || [];
  let maxId = 0;
  existingItems.forEach(item => {
    const m = item.id && item.id.match(/^s(\d+)$/);
    if (m) maxId = Math.max(maxId, parseInt(m[1]));
  });

  // Build new items
  const candidates = [];
  let counter = maxId + 1;
  candidates.push({ id: `s${counter++}`, name: protein.name, note: protein.amount, category: 'food' });
  mushrooms.forEach(m => candidates.push({ id: `s${counter++}`, name: m.name, note: m.amount, category: 'food' }));
  vegetables.forEach(v => candidates.push({ id: `s${counter++}`, name: v.name, note: v.amount, category: 'food' }));
  if (protein.needsOil) {
    candidates.push({ id: `s${counter++}`, name: 'ã‚¨ã‚´ãƒæ²¹', note: 'å¤§ã•ã˜1ä»¥ä¸Šï¼ˆä»•ä¸Šã’ç”¨ï¼‰', category: 'food' });
  }

  // Dedup by name
  const existingNames = new Set(existingItems.map(i => i.name));
  const toAdd = candidates.filter(c => !existingNames.has(c.name));
  const merged = [...existingItems, ...toAdd];

  const content = JSON.stringify({
    updated: today,
    items: merged,
    checks: existing.checks || {}
  }, null, 2);

  const ok = await ghPutFile('data/shopping.json', content, `nikomi: ingredients ${today}`);

  if (ok) {
    shopBtn.innerHTML = 'âœ… è¿½åŠ ã—ã¾ã—ãŸï¼';
    showToast(`${toAdd.length}å“ã‚’è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`);
  } else {
    shopBtn.disabled = false;
    shopBtn.innerHTML = 'ğŸ›’ ã“ã®ææ–™ã§è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ ';
    showToast('âŒ è¿½åŠ å¤±æ•—ã€‚GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
  }
}

// ===== INIT =====
document.getElementById('today-date').textContent = todayStr();

// iOS ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆï¼ˆcanvas â†’ PNG data URIï¼‰
(function() {
  try {
    const c = document.createElement('canvas');
    c.width = c.height = 180;
    const ctx = c.getContext('2d');
    // èƒŒæ™¯
    ctx.fillStyle = '#1B4332';
    ctx.beginPath();
    ctx.roundRect(0, 0, 180, 180, 22);
    ctx.fill();
    // çµµæ–‡å­—
    ctx.font = '90px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ğŸ«•', 90, 82);
    // ãƒ†ã‚­ã‚¹ãƒˆ
    ctx.fillStyle = 'white';
    ctx.font = 'bold 21px -apple-system, Hiragino Kaku Gothic ProN, sans-serif';
    ctx.textBaseline = 'alphabetic';
    ctx.fillText('ä»Šæ—¥ã®ç…®è¾¼ã¿', 90, 162);
    const link = document.querySelector("link[rel='apple-touch-icon']") || document.createElement('link');
    link.rel = 'apple-touch-icon';
    link.href = c.toDataURL('image/png');
    document.head.appendChild(link);
  } catch(e) { /* fallback to SVG */ }
})();
</script>
</body>
</html>
